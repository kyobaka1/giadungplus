{% extends "products/base_products.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }} - Gia D·ª•ng Plus{% endblock %}

{% block overview %}
<section>
    <h1 class="text-lg font-semibold text-slate-800">{{ title }}</h1>
    <p class="text-xs text-gray-500 mt-1">Ph√¢n t√≠ch gi√° v·ªën, l·ª£i nhu·∫≠n v√† hi·ªáu qu·∫£ kinh doanh theo th·ªùi gian</p>
</section>
{% endblock %}

{% block content %}
<div class="w-full">

    <!-- B·ªò L·ªåC TH·ªúI GIAN -->
    <div class="mb-4 bg-white rounded-lg shadow-sm border border-slate-200 p-4">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold text-slate-700">B·ªô l·ªçc th·ªùi gian</h2>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
            <a href="?period=7days" class="px-4 py-2 rounded-md text-sm font-medium transition {% if period == '7days' %}bg-brand text-white{% else %}bg-slate-100 text-slate-700 hover:bg-slate-200{% endif %}">
                7 ng√†y
            </a>
            <a href="?period=15days" class="px-4 py-2 rounded-md text-sm font-medium transition {% if period == '15days' %}bg-brand text-white{% else %}bg-slate-100 text-slate-700 hover:bg-slate-200{% endif %}">
                15 ng√†y
            </a>
            <a href="?period=30days" class="px-4 py-2 rounded-md text-sm font-medium transition {% if period == '30days' %}bg-brand text-white{% else %}bg-slate-100 text-slate-700 hover:bg-slate-200{% endif %}">
                30 ng√†y
            </a>
        </div>
        <div class="mt-2 text-xs text-slate-500">
            Kho·∫£ng th·ªùi gian: <strong class="text-slate-700">{{ start_date|date:"d/m/Y" }} - {{ end_date|date:"d/m/Y" }}</strong>
        </div>
    </div>

    <!-- H√ÄNG 1: D·ªÆ LI·ªÜU T·ªîNG QU√ÅT -->
    <div class="grid grid-cols-4 gap-4 mb-4">
        <!-- Ph·∫ßn 1 (3/4): Doanh thu/Gi√° v·ªën/L·ª£i nhu·∫≠n g·ªôp -->
        <div class="col-span-3 grid grid-cols-3 gap-4">
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                <div class="text-xs text-slate-500 mb-1">Doanh thu</div>
                <div class="text-2xl font-bold text-slate-800">{{ overview.total_revenue|floatformat:0|intcomma }} ‚Ç´</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                <div class="text-xs text-slate-500 mb-1">Gi√° v·ªën</div>
                <div class="text-2xl font-bold text-red-600">{{ overview.total_cost|floatformat:0|intcomma }} ‚Ç´</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                <div class="text-xs text-slate-500 mb-1">L·ª£i nhu·∫≠n g·ªôp</div>
                <div class="text-2xl font-bold {% if overview.total_profit >= 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
                    {{ overview.total_profit|floatformat:0|intcomma }} ‚Ç´
                </div>
            </div>
        </div>
        
        <!-- Ph·∫ßn 2 (1/4): T·ªâ l·ªá gi√° v·ªën & T·ª∑ l·ªá l·ª£i nhu·∫≠n -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <div class="text-xs text-slate-500 mb-1">T·ª∑ l·ªá gi√° v·ªën / T·ª∑ l·ªá l·ª£i nhu·∫≠n</div>
            <div class="text-2xl font-bold">
                <span class="text-red-600">{{ overview.total_cost_ratio|floatformat:1 }}%</span>
                <span class="text-slate-400 mx-1">/</span>
                <span class="{% if overview.total_profit_margin >= 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
                    {{ overview.total_profit_margin|floatformat:1 }}%
                </span>
            </div>
        </div>
    </div>

    <!-- H√ÄNG 2: BI·ªÇU ƒê·ªí -->
    <div class="grid grid-cols-4 gap-4 mb-4">
        <!-- Ph·∫ßn 1 (3/4): Bi·ªÉu ƒë·ªì Doanh thu/Gi√° v·ªën/L·ª£i nhu·∫≠n g·ªôp -->
        <div class="col-span-3 bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <h3 class="text-sm font-semibold text-slate-700 mb-4">Doanh thu / Gi√° v·ªën / L·ª£i nhu·∫≠n g·ªôp</h3>
            <div style="position: relative; height: 300px;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
        
        <!-- Ph·∫ßn 2 (1/4): Bi·ªÉu ƒë·ªì T·ªâ l·ªá gi√° v·ªën & T·ª∑ l·ªá l·ª£i nhu·∫≠n -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <h3 class="text-sm font-semibold text-slate-700 mb-4">T·ª∑ l·ªá gi√° v·ªën / T·ª∑ l·ªá l·ª£i nhu·∫≠n</h3>
            <div style="position: relative; height: 300px;">
                <canvas id="ratioChart"></canvas>
            </div>
        </div>
    </div>

    <!-- TH·ªêNG K√ä THEO SKU -->
    <div class="mb-4 bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-200">
            <h3 class="text-sm font-semibold text-slate-700">Th·ªëng k√™ theo SKU</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600">SKU</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">SL b√°n</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Doanh thu</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Gi√° v·ªën</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">L·ª£i nhu·∫≠n</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Gi√° b√°n TB</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">T·ª∑ l·ªá gi√° v·ªën</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    {% for sku, stats in overview.sku_stats.items %}
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-2 text-slate-700 font-mono text-xs">{{ stats.sku|default:"N/A" }}</td>
                        <td class="px-4 py-2 text-right text-slate-600">{{ stats.quantity_sold|floatformat:0|intcomma }}</td>
                        <td class="px-4 py-2 text-right text-slate-700 font-medium">{{ stats.revenue|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right text-red-600">{{ stats.cost|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right {% if stats.profit >= 0 %}text-emerald-600{% else %}text-red-600{% endif %} font-medium">
                            {{ stats.profit|floatformat:0|intcomma }} ‚Ç´
                        </td>
                        <td class="px-4 py-2 text-right text-slate-600">{{ stats.avg_selling_price|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right text-slate-600">{{ stats.cost_ratio|floatformat:0 }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-slate-400 text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- TH·ªêNG K√ä THEO KHO H√ÄNG -->
    <div class="mb-4 bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-200">
            <h3 class="text-sm font-semibold text-slate-700">Th·ªëng k√™ theo kho h√†ng</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600">Location ID</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">S·ªë ƒë∆°n</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Doanh thu</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Gi√° v·ªën</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">L·ª£i nhu·∫≠n</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    {% for location_key, stats in overview.location_stats.items %}
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-2 text-slate-700 font-mono text-xs">{{ stats.location_id }}</td>
                        <td class="px-4 py-2 text-right text-slate-600">{{ stats.orders_count }}</td>
                        <td class="px-4 py-2 text-right text-slate-700 font-medium">{{ stats.revenue|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right text-red-600">{{ stats.cost|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right {% if stats.profit >= 0 %}text-emerald-600{% else %}text-red-600{% endif %} font-medium">
                            {{ stats.profit|floatformat:0|intcomma }} ‚Ç´
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-slate-400 text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- TH·ªêNG K√ä THEO NGU·ªíN B√ÅN H√ÄNG -->
    <div class="mb-4 bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-200">
            <h3 class="text-sm font-semibold text-slate-700">Th·ªëng k√™ theo ngu·ªìn b√°n h√†ng</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600">Source ID</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">S·ªë ƒë∆°n</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Doanh thu</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Gi√° v·ªën</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">L·ª£i nhu·∫≠n</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    {% for source_key, stats in overview.source_stats.items %}
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-2 text-slate-700 font-mono text-xs">{{ stats.source_id }}</td>
                        <td class="px-4 py-2 text-right text-slate-600">{{ stats.orders_count }}</td>
                        <td class="px-4 py-2 text-right text-slate-700 font-medium">{{ stats.revenue|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right text-red-600">{{ stats.cost|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right {% if stats.profit >= 0 %}text-emerald-600{% else %}text-red-600{% endif %} font-medium">
                            {{ stats.profit|floatformat:0|intcomma }} ‚Ç´
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-slate-400 text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- TH·ªêNG K√ä THEO SHOP -->
    <div class="mb-4 bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-200">
            <h3 class="text-sm font-semibold text-slate-700">Th·ªëng k√™ theo Shop</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600">Shop</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">S·ªë ƒë∆°n</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Doanh thu</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">Gi√° v·ªën</th>
                        <th class="px-4 py-2 text-right text-xs font-semibold text-slate-600">L·ª£i nhu·∫≠n</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    {% for shop_key, stats in overview.shop_stats.items %}
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-2 text-slate-700 font-medium">{{ stats.shop_name }}</td>
                        <td class="px-4 py-2 text-right text-slate-600">{{ stats.orders_count }}</td>
                        <td class="px-4 py-2 text-right text-slate-700 font-medium">{{ stats.revenue|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right text-red-600">{{ stats.cost|floatformat:0|intcomma }} ‚Ç´</td>
                        <td class="px-4 py-2 text-right {% if stats.profit >= 0 %}text-emerald-600{% else %}text-red-600{% endif %} font-medium">
                            {{ stats.profit|floatformat:0|intcomma }} ‚Ç´
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-slate-400 text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- TH√îNG TIN B·ªî SUNG -->
    <div class="mb-4 bg-slate-50 rounded-lg border border-slate-200 p-4">
        <div class="text-xs text-slate-600">
            <p class="mb-1"><strong>L∆∞u √Ω:</strong></p>
            <ul class="list-disc list-inside space-y-1">
                <li>Ch·ªâ t√≠nh c√°c SKU ƒë√£ c√≥ d·ªØ li·ªáu cost_history (gi√° v·ªën)</li>
                <li>D·ªØ li·ªáu ƒë∆∞·ª£c t√≠nh t·ª´ ƒë∆°n h√†ng ƒë√£ finalized trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn</li>
                <li>Gi√° v·ªën ƒë∆∞·ª£c l·∫•y t·ª´ CostHistory g·∫ßn nh·∫•t tr∆∞·ªõc ho·∫∑c b·∫±ng ng√†y t·∫°o ƒë∆°n</li>
                <li>T·ªïng s·ªë ƒë∆°n h√†ng: <strong>{{ overview.orders_count }}</strong></li>
            </ul>
        </div>
        <div class="mt-3">
            <a href="?period={{ period }}&debug=1" class="text-xs text-blue-600 hover:text-blue-700 underline">
                üîç B·∫≠t ch·∫ø ƒë·ªô Debug
            </a>
            {% if debug_mode %}
            <span class="text-xs text-green-600 ml-2">‚úì Debug mode ƒëang b·∫≠t</span>
            {% endif %}
        </div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// D·ªØ li·ªáu t·ª´ backend
const dailyStats = JSON.parse('{{ daily_stats_json|escapejs }}') || [];

// Chu·∫©n b·ªã d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
const labels = dailyStats.map(item => {
    const date = new Date(item.date);
    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
});

const revenueData = dailyStats.map(item => item.revenue || 0);
const costData = dailyStats.map(item => item.cost || 0);
const profitData = dailyStats.map(item => item.profit || 0);
const costRatioData = dailyStats.map(item => item.cost_ratio || 0);
const profitMarginData = dailyStats.map(item => item.profit_margin || 0);

// Bi·ªÉu ƒë·ªì 1: Doanh thu / Gi√° v·ªën / L·ª£i nhu·∫≠n g·ªôp (3 ƒë∆∞·ªùng)
const revenueCtx = document.getElementById('revenueChart');
if (revenueCtx) {
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Doanh thu',
                    data: revenueData,
                    borderColor: 'rgb(30, 41, 59)',
                    backgroundColor: 'rgba(30, 41, 59, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'Gi√° v·ªën',
                    data: costData,
                    borderColor: 'rgb(220, 38, 38)',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'L·ª£i nhu·∫≠n g·ªôp',
                    data: profitData,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 11,
                            family: 'Averta, sans-serif'
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += new Intl.NumberFormat('vi-VN').format(Math.round(context.parsed.y)) + ' ‚Ç´';
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(0) + 'K';
                            }
                            return value;
                        },
                        font: {
                            size: 10,
                            family: 'Averta, sans-serif'
                        }
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 10,
                            family: 'Averta, sans-serif'
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

// Bi·ªÉu ƒë·ªì 2: T·ªâ l·ªá gi√° v·ªën & T·ª∑ l·ªá l·ª£i nhu·∫≠n (2 ƒë∆∞·ªùng)
const ratioCtx = document.getElementById('ratioChart');
if (ratioCtx) {
    new Chart(ratioCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'T·ª∑ l·ªá gi√° v·ªën',
                    data: costRatioData,
                    borderColor: 'rgb(220, 38, 38)',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'T·ª∑ l·ªá l·ª£i nhu·∫≠n',
                    data: profitMarginData,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 11,
                            family: 'Averta, sans-serif'
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y.toFixed(1) + '%';
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    min: 30,
                    max: 70,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        },
                        font: {
                            size: 10,
                            family: 'Averta, sans-serif'
                        },
                        stepSize: 10
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 10,
                            family: 'Averta, sans-serif'
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}
</script>
{% endblock %}
