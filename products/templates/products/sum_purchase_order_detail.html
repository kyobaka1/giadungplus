{% extends "products/base_products.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }} - Gia Dụng Plus{% endblock %}

{% block overview %}
<div class="flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-slate-800">{{ spo.code }}</h1>
        <p class="text-sm text-slate-500 mt-1">
            SPO <span class="mx-1">•</span> {{ spo.container_template.code }} <span class="mx-1">•</span> {{ spo.created_at|date:"d/m/Y" }}
        </p>
    </div>
    <div class="flex items-center gap-3">
        <span class="px-3 py-1.5 rounded-full text-sm font-semibold shadow-sm border
            {% if spo.status == 'completed' %}bg-green-100 text-green-700 border-green-200
            {% elif spo.status == 'cancelled' %}bg-red-100 text-red-700 border-red-200
            {% elif spo.status == 'draft' %}bg-slate-100 text-slate-700 border-slate-200
            {% else %}bg-blue-100 text-blue-700 border-blue-200{% endif %}">
            {{ spo.get_status_display }}
        </span>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="w-full space-y-6">
    {% if error %}
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
        <span class="text-sm font-medium">{{ error }}</span>
    </div>
    {% endif %}

    <!-- Top Summary Cards -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 1. Route & Schedule -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col justify-between">
            <h3 class="text-xs font-bold uppercase text-slate-400 tracking-wider mb-4">Lộ trình & Thời gian</h3>
            <div class="flex items-center justify-between mb-4">
                <div class="text-center">
                    <div class="text-sm font-semibold text-slate-700">{{ spo.container_template.departure_port|default:"Trung Quốc" }}</div>
                    <div class="text-[10px] text-slate-400 uppercase">Cảng đi</div>
                </div>
                <div class="flex-1 px-4 flex flex-col items-center">
                    <div class="w-full h-0.5 bg-slate-200 relative top-2">
                        <div class="absolute -right-1 -top-1 w-2 h-2 bg-slate-200 rounded-full"></div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-sm font-bold {% if spo.destination_port == 'hcm' %}text-red-600{% elif spo.destination_port == 'haiphong' %}text-blue-600{% endif %}">
                        {{ spo.get_destination_port_display|default:"---" }}
                    </div>
                    <div class="text-[10px] text-slate-400 uppercase">Cảng đến</div>
                </div>
            </div>
            <!-- Thông tin tàu -->
            <div class="mb-3 space-y-2">
                {% if spo.ship_name or spo.ship_tracking_link %}
                <div class="bg-blue-50 rounded-lg p-2.5 border border-blue-100 group/ship">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            {% if spo.ship_name %}
                            <div class="flex items-center gap-2 mb-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                <span class="text-xs font-semibold text-blue-800">Tàu: {{ spo.ship_name }}</span>
                            </div>
                            {% endif %}
                            {% if spo.ship_tracking_link %}
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                </svg>
                                <a href="{{ spo.ship_tracking_link }}" target="_blank" class="text-xs text-blue-600 hover:text-blue-700 hover:underline">
                                    Tracking tàu
                                </a>
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover/ship:opacity-100 transition">
                            <button onclick="openEditShipModal()" class="p-1.5 text-blue-600 hover:text-blue-700 hover:bg-blue-100 rounded transition" title="Sửa">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="deleteShipInfo()" class="p-1.5 text-red-600 hover:text-red-700 hover:bg-red-100 rounded transition" title="Xóa">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <button onclick="openEditShipModal()" 
                        class="w-full bg-slate-50 hover:bg-slate-100 border border-dashed border-slate-300 rounded-lg p-2.5 flex items-center justify-center gap-2 text-xs text-slate-500 hover:text-slate-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Thêm thông tin tàu
                </button>
                {% endif %}
            </div>
            <div class="bg-slate-50 rounded-lg p-3 border border-slate-100 flex items-center gap-3">
                <div class="bg-white p-2 rounded border border-slate-200 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <div>
                    <div class="text-xs text-slate-500">Dự kiến hàng về</div>
                    <div class="font-bold text-slate-800">
                        {% if warehouse_planned_date %}
                            {{ warehouse_planned_date|date:"d/m/Y" }}
                        {% elif spo.expected_arrival_date %}
                            {{ spo.expected_arrival_date|date:"d/m/Y" }}
                        {% else %}
                            <span class="text-slate-400 italic">Chưa xác định</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Capacity & Packing -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col justify-between">
            <h3 class="text-xs font-bold uppercase text-slate-400 tracking-wider mb-4">Dung tích & Đóng gói</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-xs font-medium text-slate-600">Dung tích (CBM)</span>
                        <span class="text-xs font-bold text-slate-800">{{ spo.total_cbm|floatformat:2 }} / {{ spo.container_template.volume_cbm|floatformat:1 }}</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                        {% widthratio spo.total_cbm spo.container_template.volume_cbm 100 as percentage %}
                        <div class="h-full rounded-full transition-all duration-500 
                            {% if percentage|add:0 > 90 %}bg-red-500
                            {% elif percentage|add:0 > 70 %}bg-orange-500
                            {% else %}bg-emerald-500{% endif %}"
                             style="width: {% if percentage|add:0 > 100 %}100{% else %}{{ percentage }}{% endif %}%">
                        </div>
                    </div>
                    <div class="mt-1 text-right text-[10px] text-slate-500">{{ percentage }}% đầy</div>
                </div>
                <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-100">
                    <div>
                        <div class="text-2xl font-bold text-slate-800">{{ total_packages|default:0|intcomma }}</div>
                        <div class="text-[10px] text-slate-500 uppercase font-medium">Số kiện hàng</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-slate-800">{{ total_quantity|default:0|intcomma }}</div>
                        <div class="text-[10px] text-slate-500 uppercase font-medium">Tổng sản phẩm</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Financials -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col justify-between">
            <h3 class="text-xs font-bold uppercase text-slate-400 tracking-wider mb-4">Tài chính (Ước tính)</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                    <div class="flex-1">
                        <div class="text-[10px] text-indigo-500 uppercase font-bold">Giá trị hàng</div>
                        <div class="text-lg font-bold text-indigo-700">
                            {% if total_amount_vnd %}
                                {{ total_amount_vnd|floatformat:0|intcomma }} đ
                            {% else %}
                                {{ total_product_amount_cny|default:0|floatformat:0|intcomma }} CNY
                            {% endif %}
                        </div>
                        {% if total_product_amount_cny %}
                        <div class="text-[10px] text-indigo-400 mt-0.5">
                            ({{ total_product_amount_cny|floatformat:0|intcomma }} CNY
                            {% if avg_exchange_rate %}
                                - Tỷ giá TB: {{ avg_exchange_rate|floatformat:0|intcomma }})
                            {% else %}
                                - chưa có tỷ giá)
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-white p-1.5 rounded-full text-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
                <div class="flex items-center justify-between p-3 bg-amber-50 rounded-lg border border-amber-100">
                    <div class="flex-1">
                        <div class="text-[10px] text-amber-500 uppercase font-bold">Chi phí nhập</div>
                        <div class="text-lg font-bold text-amber-700">{{ total_spo_costs|default:0|floatformat:0|intcomma }} đ</div>
                        {% if total_spo_costs_vnd or total_spo_costs_cny_to_vnd %}
                        <div class="text-[10px] text-amber-400 mt-0.5">
                            {% if total_spo_costs_vnd and total_spo_costs_cny_to_vnd %}
                                (VNĐ: {{ total_spo_costs_vnd|floatformat:0|intcomma }} đ + CNY: {{ total_spo_costs_cny|floatformat:0|intcomma }} CNY)
                            {% elif total_spo_costs_vnd %}
                                (VNĐ: {{ total_spo_costs_vnd|floatformat:0|intcomma }} đ)
                            {% elif total_spo_costs_cny_to_vnd %}
                                (CNY: {{ total_spo_costs_cny|floatformat:0|intcomma }} CNY)
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="bg-white p-1.5 rounded-full text-amber-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Tracking (Redesigned) -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-base font-bold text-slate-800 flex items-center gap-2">
                <span class="w-1.5 h-6 bg-emerald-500 rounded-full"></span>
                Tiến độ Container
            </h2>
            <button onclick="document.getElementById('update-status-modal').classList.remove('hidden')" 
                    class="text-xs font-medium text-emerald-600 hover:text-emerald-700 hover:underline">
                Cập nhật trạng thái thủ công
            </button>
        </div>

        <!-- Compact Timeline Progress (Vietnamese) -->
        <div class="relative w-full px-2 pt-2 pb-2">
            <div class="relative flex justify-between items-center w-full z-10">
                <!-- Background Line -->
                <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-100 -z-10 -translate-y-1/2 rounded-full"></div>
                
                <!-- Active Line (Green theme) -->
                <div id="active-line" class="absolute top-1/2 left-0 h-1 bg-emerald-500 -z-10 -translate-y-1/2 rounded-full transition-all duration-700" style="width: 0%;"></div>

                <!-- Tạo SPO -->
                <div class="timeline-node group relative flex flex-col items-center justify-center cursor-default transition-all duration-300" data-stage="created" data-label="Tạo SPO">
                    <div class="w-6 h-6 rounded-full border-2 bg-white z-20 flex items-center justify-center transition-colors duration-300 shadow-sm node-circle border-slate-300 text-slate-400">
                        <svg class="w-3 h-3 icon-check hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span class="w-1.5 h-1.5 rounded-full bg-current icon-dot"></span>
                    </div>
                    <div class="absolute top-8 text-center w-20 flex flex-col items-center gap-0.5">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors duration-300 node-label leading-tight">Tạo SPO</span>
                        <div class="mt-0.5 flex flex-col items-center gap-0.5 min-h-[32px] node-date-container"></div>
                    </div>
                </div>

                <!-- Gửi NSX -->
                <div class="timeline-node group relative flex flex-col items-center justify-center cursor-default transition-all duration-300" data-stage="sent_to_supplier" data-label="Gửi NSX">
                    <div class="w-6 h-6 rounded-full border-2 bg-white z-20 flex items-center justify-center transition-colors duration-300 shadow-sm node-circle border-slate-300 text-slate-400">
                        <svg class="w-3 h-3 icon-check hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span class="w-1.5 h-1.5 rounded-full bg-current icon-dot"></span>
                    </div>
                    <div class="absolute top-8 text-center w-20 flex flex-col items-center gap-0.5">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors duration-300 node-label leading-tight">Gửi NSX</span>
                        <div class="mt-0.5 flex flex-col items-center gap-0.5 min-h-[32px] node-date-container"></div>
                    </div>
                </div>

                <!-- Đóng cont -->
                <div class="timeline-node group relative flex flex-col items-center justify-center cursor-default transition-all duration-300" data-stage="packed" data-label="Đóng cont">
                    <div class="w-6 h-6 rounded-full border-2 bg-white z-20 flex items-center justify-center transition-colors duration-300 shadow-sm node-circle border-slate-300 text-slate-400">
                        <svg class="w-3 h-3 icon-check hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span class="w-1.5 h-1.5 rounded-full bg-current icon-dot"></span>
                    </div>
                    <div class="absolute top-8 text-center w-20 flex flex-col items-center gap-0.5">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors duration-300 node-label leading-tight">Đóng cont</span>
                        <div class="mt-0.5 flex flex-col items-center gap-0.5 min-h-[32px] node-date-container"></div>
                    </div>
                </div>

                <!-- Rời cảng TQ -->
                <div class="timeline-node group relative flex flex-col items-center justify-center cursor-default transition-all duration-300" data-stage="departed_cn" data-label="Rời cảng TQ">
                    <div class="w-6 h-6 rounded-full border-2 bg-white z-20 flex items-center justify-center transition-colors duration-300 shadow-sm node-circle border-slate-300 text-slate-400">
                        <svg class="w-3 h-3 icon-check hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span class="w-1.5 h-1.5 rounded-full bg-current icon-dot"></span>
                    </div>
                    <div class="absolute top-8 text-center w-20 flex flex-col items-center gap-0.5">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors duration-300 node-label leading-tight">Rời cảng TQ</span>
                        <div class="mt-0.5 flex flex-col items-center gap-0.5 min-h-[32px] node-date-container"></div>
                    </div>
                </div>

                <!-- Tới VN -->
                <div class="timeline-node group relative flex flex-col items-center justify-center cursor-default transition-all duration-300" data-stage="arrived_vn" data-label="Tới VN">
                    <div class="w-6 h-6 rounded-full border-2 bg-white z-20 flex items-center justify-center transition-colors duration-300 shadow-sm node-circle border-slate-300 text-slate-400">
                        <svg class="w-3 h-3 icon-check hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span class="w-1.5 h-1.5 rounded-full bg-current icon-dot"></span>
                    </div>
                    <div class="absolute top-8 text-center w-20 flex flex-col items-center gap-0.5">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors duration-300 node-label leading-tight">Tới VN</span>
                        <div class="mt-0.5 flex flex-col items-center gap-0.5 min-h-[32px] node-date-container"></div>
                    </div>
                </div>

                <!-- Hoàn tất -->
                <div class="timeline-node group relative flex flex-col items-center justify-center cursor-default transition-all duration-300" data-stage="completed" data-label="Hoàn tất">
                    <div class="w-6 h-6 rounded-full border-2 bg-white z-20 flex items-center justify-center transition-colors duration-300 shadow-sm node-circle border-slate-300 text-slate-400">
                        <svg class="w-3 h-3 icon-check hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        <span class="w-1.5 h-1.5 rounded-full bg-current icon-dot"></span>
                    </div>
                    <div class="absolute top-8 text-center w-20 flex flex-col items-center gap-0.5">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide transition-colors duration-300 node-label leading-tight">Hoàn tất</span>
                        <div class="mt-0.5 flex flex-col items-center gap-0.5 min-h-[32px] node-date-container"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Spacing for labels and tags -->
        <div class="h-14"></div>
    </div>

    <!-- Main Content Grid - Restructured -->
    <div class="grid grid-cols-1 xl:grid-cols-10 gap-6">
        <!-- Column 1: Container Progress + Purchase Orders (7/10) -->
        <div class="xl:col-span-7 space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <div class="flex items-center gap-2">
                        <h3 class="font-bold text-slate-700 text-sm">Danh sách Đơn hàng (PO)</h3>
                        <span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-600 text-xs font-bold">{{ purchase_orders|length }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="sync-po-btn" class="px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-100 rounded text-xs font-semibold flex items-center gap-1 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v3.276a1 1 0 01-2 0V13.107a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                            Sync Sapo
                        </button>
                        <button id="add-po-btn" class="px-3 py-1.5 bg-emerald-600 text-white hover:bg-emerald-700 rounded text-xs font-bold shadow-sm transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Thêm PO
                        </button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    {% for po in purchase_orders %}
                    <!-- PO Card (Expandable) -->
                    <div class="bg-white rounded-lg border border-slate-200 overflow-hidden hover:shadow-md transition-shadow" data-po-id="{{ po.po_id }}" data-po-total-cbm="{{ po.total_cbm|default:0 }}">
                        <!-- PO Header Row -->
                        <div class="p-4 border-b border-slate-100">
                            <div class="flex items-center justify-between">
                                <!-- Left: PO Info -->
                                <div class="flex items-center gap-4 flex-1">
                                    <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm">
                                        {{ forloop.counter }}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3">
                                            <div class="font-bold text-slate-800 text-sm">
                                                {{ po.supplier_name }} - 
                                                <a href="https://sisapsan.mysapogo.com/admin/order_suppliers/{{ po.sapo_order_supplier_id }}" 
                                                   target="_blank" 
                                                   class="text-blue-600 hover:text-blue-700 hover:underline font-mono">
                                                    PO {{ po.code }}
                                                </a>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3 mt-1">
                                            <!-- Delivery Status Badge -->
                                            <span class="inline-flex px-2 py-0.5 rounded text-[10px] font-bold
                                                {% if po.delivery_status == 'delivered' %}bg-green-100 text-green-700
                                                {% elif po.delivery_status == 'production' %}bg-blue-100 text-blue-700
                                                {% elif po.delivery_status == 'sent_label' %}bg-amber-100 text-amber-700
                                                {% else %}bg-slate-100 text-slate-600{% endif %}">
                                                {{ po.delivery_status_display|default:"Lên đơn" }}
                                            </span>
                                            <!-- Expected Delivery Date -->
                                            {% if po.expected_delivery_date %}
                                            <span class="text-xs text-slate-500 flex items-center gap-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                Dự kiến: {{ po.expected_delivery_date|date:"d/m/Y" }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right: Financial Summary - Redesigned -->
                                <div class="flex items-center gap-8 text-right">
                                    <!-- Cột 1: Tổng + Tiền hàng & Phí -->
                                    <div class="flex flex-col items-end">
                                        <div class="text-lg font-bold text-indigo-600 mb-1">{{ po.total_amount_cny|floatformat:0|intcomma }} CNY</div>
                                        <div class="flex items-center gap-3 text-xs text-slate-500">
                                            <span>Tiền hàng: <span class="font-semibold text-slate-700">{{ po.product_amount_cny|floatformat:0|intcomma }}</span></span>
                                            <span>•</span>
                                            <span>Phí: <span class="font-semibold text-slate-700">{{ po.total_costs_cny|default:0|floatformat:0|intcomma }}</span></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Cột 2: Đã thanh toán + Còn -->
                                    <div class="flex flex-col items-end">
                                        <div class="text-sm font-bold {% if po.paid_amount_cny >= po.total_amount_cny %}text-green-600{% else %}text-amber-600{% endif %}">
                                            {{ po.paid_amount_cny|floatformat:0|intcomma }} CNY
                                        </div>
                                        {% if po.remaining_amount_cny > 0 %}
                                        <div class="text-xs text-red-500 mt-0.5">Còn: {{ po.remaining_amount_cny|floatformat:0|intcomma }} CNY</div>
                                        {% else %}
                                        <div class="text-xs text-green-600 mt-0.5">Đã thanh toán đủ</div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- CBM -->
                                    <div>
                                        <div class="text-xs text-slate-500 mb-0.5">CBM</div>
                                        <div class="text-sm font-bold text-slate-700">{{ po.total_cbm|floatformat:2 }}</div>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="flex items-center gap-2 ml-4">
                                    <a href="{% url 'products:edit_purchase_order' po.sapo_order_supplier_id %}"
                                       class="text-sky-600 hover:text-sky-700 p-1.5 rounded transition hover:bg-sky-50"
                                       title="Sửa PO này">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M4 20h4.586a1 1 0 00.707-.293l9.439-9.439a1 1 0 000-1.414l-3.536-3.536a1 1 0 00-1.414 0L4.343 14.757A1 1 0 004 15.464V20z" />
                                        </svg>
                                    </a>
                                    <button class="update-delivery-status-btn text-blue-600 hover:text-blue-700 p-1.5 rounded transition hover:bg-blue-50"
                                            data-po-id="{{ po.po_id }}"
                                            data-current-status="{{ po.delivery_status }}"
                                            title="Cập nhật trạng thái">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                    </button>
                                    <a href="{% url 'products:export_po_excel' po.po_id %}" 
                                       class="text-emerald-600 hover:text-emerald-700 p-1.5 rounded transition hover:bg-emerald-50"
                                       title="Xuất Excel">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </a>
                                    <a href="{% url 'products:export_po_labels' po.po_id %}" 
                                       target="_blank"
                                       class="text-purple-600 hover:text-purple-700 p-1.5 rounded transition hover:bg-purple-50"
                                       title="Xuất nhãn phụ">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                    </a>
                                    <button class="expand-po-btn text-slate-400 hover:text-slate-600 p-1.5 rounded transition" title="Xem chi tiết">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <button class="remove-po-btn text-slate-400 hover:text-red-600 p-1.5 rounded transition" title="Xóa khỏi SPO" data-po-id="{{ po.po_id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PO Details (Collapsible) -->
                        <div class="po-details hidden border-t border-slate-100 bg-slate-50">
                            <div class="p-4 space-y-4">
                                <!-- Costs & Payments Grid -->
                                <div class="grid grid-cols-2 gap-4">
                                    <!-- Costs Section -->
                                    <div>
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="text-xs font-bold text-slate-700 uppercase tracking-wider">Chi Phí (CNY)</h4>
                                            <button class="add-cost-btn text-xs font-medium text-emerald-600 hover:text-emerald-700"
                                                    data-po-id="{{ po.po_id }}">
                                                + Thêm chi phí
                                            </button>
                                        </div>
                                        <div class="bg-white rounded-lg border border-slate-200 divide-y divide-slate-100">
                                            {% for cost in po.costs %}
                                            <div class="p-2 flex items-center justify-between hover:bg-slate-50 group/item">
                                                <div class="flex-1">
                                                    <div class="text-xs font-medium text-slate-700">{{ cost.cost_type_display }}</div>
                                                    {% if cost.description %}
                                                    <div class="text-[10px] text-slate-400">{{ cost.description }}</div>
                                                    {% endif %}
                                                    {% if cost.cbm %}
                                                    <div class="text-[10px] text-slate-400">CBM: {{ cost.cbm|floatformat:3 }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <div class="text-right">
                                                        <span class="text-xs font-bold text-slate-700">
                                                            {{ cost.amount_cny|floatformat:0|intcomma }} CNY
                                                            {% if cost.price_per_cbm %}
                                                            <span class="text-[10px] font-normal text-slate-500">({{ cost.price_per_cbm|floatformat:0|intcomma }} CNY/m³)</span>
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <button class="delete-cost-btn text-slate-400 hover:text-red-600 opacity-0 group-hover/item:opacity-100 transition"
                                                            data-cost-ids='{{ cost.cost_ids_json }}'>
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                            {% empty %}
                                            <div class="p-3 text-center text-xs text-slate-400 italic">Chưa có chi phí</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <!-- Payments Section -->
                                    <div>
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="text-xs font-bold text-slate-700 uppercase tracking-wider">Thanh Toán (CNY)</h4>
                                            <button class="add-payment-btn text-xs font-medium text-indigo-600 hover:text-indigo-700"
                                                    data-po-id="{{ po.po_id }}">
                                                + Thêm thanh toán
                                            </button>
                                        </div>
                                        <div class="bg-white rounded-lg border border-slate-200 divide-y divide-slate-100">
                                            {% for payment in po.payments %}
                                            <div class="p-2 flex items-center justify-between hover:bg-slate-50 group/item">
                                                <div class="flex-1">
                                                    <div class="text-xs font-medium text-slate-700">{{ payment.payment_type_display }}</div>
                                                    <div class="text-[10px] text-slate-400">{{ payment.payment_date|date:"d/m/Y" }}</div>
                                                    {% if payment.description %}
                                                    <div class="text-[10px] text-slate-400">{{ payment.description }}</div>
                                                    {% endif %}
                                                    {% if payment.exchange_rate %}
                                                    <div class="text-[10px] text-slate-400">Tỷ giá: {{ payment.exchange_rate|floatformat:0|intcomma }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <div class="text-right">
                                                        <div class="text-xs font-bold text-slate-700">{{ payment.amount_cny|floatformat:0|intcomma }} CNY</div>
                                                        {% if payment.amount_vnd %}
                                                        <div class="text-[10px] text-slate-500">{{ payment.amount_vnd|floatformat:0|intcomma }} VNĐ</div>
                                                        {% endif %}
                                                    </div>
                                                    <button class="delete-payment-btn text-slate-400 hover:text-red-600 opacity-0 group-hover/item:opacity-100 transition"
                                                            data-payment-id="{{ payment.id }}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                            {% empty %}
                                            <div class="p-3 text-center text-xs text-slate-400 italic">Chưa có thanh toán</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="bg-white rounded-lg border border-dashed border-slate-300 p-12 text-center">
                        <div class="flex flex-col items-center justify-center text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                            <p class="text-sm font-medium">Chưa có PO trong container này</p>
                            <p class="text-xs mt-1">Dùng nút "Thêm PO" hoặc "Sync Sapo" để bắt đầu</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Line Items (Collapsible) -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <details class="group">
                    <summary class="flex justify-between items-center font-bold font-sm cursor-pointer list-none p-4 bg-slate-50 border-b border-transparent group-open:border-slate-100 hover:bg-slate-100 transition">
                        <span class="flex items-center gap-2 text-slate-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500 transition-transform group-open:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            Chi tiết sản phẩm (Line Items)
                        </span>
                        <span class="text-xs text-slate-500 font-normal">({{ line_items|length }} SKUs)</span>
                    </summary>
                    <div class="text-neutral-500 text-sm group-open:animate-fadeIn">
                        <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                            <table class="min-w-full divide-y divide-slate-100">
                                <thead class="bg-white sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">SKU</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase">Tên sản phẩm</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-500 uppercase">Số lượng</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-500 uppercase">Giá nhập</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-500 uppercase">CBM</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50 bg-white">
                                    {% for item in line_items %}
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-4 py-2 text-xs font-bold text-slate-700 font-mono">{{ item.sku }}</td>
                                        <td class="px-4 py-2 text-xs text-slate-600">{{ item.product_name|truncatewords:8 }}</td>
                                        <td class="px-4 py-2 text-xs text-right text-slate-800">{{ item.quantity }}</td>
                                        <td class="px-4 py-2 text-xs text-right text-slate-600">{{ item.price|floatformat:0|intcomma }}</td>
                                        <td class="px-4 py-2 text-xs text-right text-slate-600">{{ item.cbm|floatformat:3 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Packing List Section -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-emerald-50 to-white">
                    <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Danh sách đóng gói (Packing List)
                    </h3>
                    <div class="flex items-center gap-2">
                        {% if has_tkhq_document %}
                        <a href="{% url 'products:export_tkhq_info' spo.id %}"
                           class="px-3 py-1.5 bg-blue-600 text-white hover:bg-blue-700 rounded text-xs font-semibold flex items-center gap-1 transition shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h3a1 1 0 110 2H5v12h10V4h-2a1 1 0 110-2h3a1 1 0 011 1v14a2 2 0 01-2 2H5a2 2 0 01-2-2V3zm6.293 5.293a1 1 0 011.414 0L12 9.586V2a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Xuất info TKHQ
                        </a>
                        <button type="button"
                                id="update-packing-list-from-tkhq-btn"
                                class="px-3 py-1.5 bg-purple-600 text-white hover:bg-purple-700 rounded text-xs font-semibold flex items-center gap-1 transition shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v3.276a1 1 0 01-2 0V13.107a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            </svg>
                            Update Packinglist
                        </button>
                        <input type="file" id="tkhq-file-input" accept=".xlsx,.xls" style="display: none;">
                        {% endif %}
                        <a href="{% url 'products:export_spo_packing_list' spo.id %}"
                           class="px-3 py-1.5 bg-emerald-600 text-white hover:bg-emerald-700 rounded text-xs font-semibold flex items-center gap-1 transition shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h3a1 1 0 110 2H5v12h10V4h-2a1 1 0 110-2h3a1 1 0 011 1v14a2 2 0 01-2 2H5a2 2 0 01-2-2V3zm6.293 5.293a1 1 0 011.414 0L12 9.586V2a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Xuất packing list
                        </a>
                    </div>
                </div>
                <div class="p-4">
                    {% if packing_list_items %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 text-xs">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-3 py-2 text-center text-[10px] font-bold text-slate-600 uppercase">Trạng thái</th>
                                    <th class="px-3 py-2 text-left text-[10px] font-bold text-slate-600 uppercase">SKU</th>
                                    <th class="px-3 py-2 text-left text-[10px] font-bold text-slate-600 uppercase">EN NAME</th>
                                    <th class="px-3 py-2 text-left text-[10px] font-bold text-slate-600 uppercase">HSCODE</th>
                                    <th class="px-3 py-2 text-left text-[10px] font-bold text-slate-600 uppercase">Mô tả hàng hóa</th>
                                    <th class="px-3 py-2 text-right text-[10px] font-bold text-slate-600 uppercase">SỐ LƯỢNG</th>
                                    <th class="px-3 py-2 text-right text-[10px] font-bold text-slate-600 uppercase">THUẾ XK (%)</th>
                                    <th class="px-3 py-2 text-right text-[10px] font-bold text-slate-600 uppercase">THUẾ GTGT (%)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-100">
                                {% for item in packing_list_items %}
                                {% comment %} Kiểm tra xem đã match với TKHQ chưa: có hs_code và có thuế được cập nhật {% endcomment %}
                                <tr class="hover:bg-slate-50">
                                    <td class="px-3 py-2 text-center">
                                        {% if item.hs_code and item.hs_code|length > 0 and item.import_tax_rate > 0 %}
                                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-100 text-green-600" title="Đã match với TKHQ">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        {% elif item.hs_code and item.hs_code|length > 0 and item.vat_rate > 0 %}
                                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-100 text-green-600" title="Đã match với TKHQ">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-100 text-red-600" title="Chưa match với TKHQ">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                </svg>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-3 py-2 font-mono font-semibold text-slate-700">{{ item.sku_nhapkhau }}</td>
                                    <td class="px-3 py-2 text-slate-700">{{ item.en_name|default:"" }}</td>
                                    <td class="px-3 py-2 text-slate-700">{{ item.hs_code|default:"" }}</td>
                                    <td class="px-3 py-2 text-slate-700">
                                        {% if item.vn_name %}
                                            {{ item.vn_name }}
                                        {% else %}
                                            {{ item.en_name|default:"" }}
                                        {% endif %}
                                    </td>
                                    <td class="px-3 py-2 text-right text-slate-700">{{ item.quantity|floatformat:0 }}</td>
                                    <td class="px-3 py-2 text-right text-slate-600">-</td>
                                    <td class="px-3 py-2 text-right text-slate-600">{{ item.vat_rate|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-sm">Chưa có danh sách đóng gói</p>
                        <p class="text-xs mt-1">Nhấn nút "Xuất packing list" để tạo danh sách</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Column 2: Costs + Documents (3/10) -->
        <div class="xl:col-span-3 space-y-6">
            <!-- SPO Costs -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-white">
                    <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Chi phí SPO
                    </h3>
                    <button id="add-spo-cost-btn" class="text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 flex items-center gap-1 px-2.5 py-1 rounded shadow-sm transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Thêm
                    </button>
                </div>
                <div class="divide-y divide-slate-100 max-h-[300px] overflow-y-auto">
                    {% for cost in spo_costs %}
                    <div class="p-3 hover:bg-slate-50/50 transition-colors group/item">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <div class="text-xs font-semibold text-slate-800">{{ cost.name }}</div>
                                    <span class="px-1.5 py-0.5 rounded text-[9px] font-semibold 
                                        {% if cost.cost_side == 'china' %}bg-red-100 text-red-700 border border-red-200
                                        {% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
                                        {% if cost.cost_side == 'china' %}Trung Quốc{% else %}Việt Nam{% endif %}
                                    </span>
                                </div>
                                {% if cost.note %}
                                <div class="text-[10px] text-slate-500 line-clamp-1">{{ cost.note }}</div>
                                {% endif %}
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="text-[10px] text-slate-400">Ngày giao dịch: {{ cost.transaction_date|date:"d/m/Y" }}</div>
                                    {% if cost.cost_side == 'china' and cost.balance_transaction %}
                                    <span class="px-1.5 py-0.5 rounded text-[9px] font-semibold bg-emerald-100 text-emerald-700 border border-emerald-200">
                                        Đã thanh toán
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                {% if cost.cost_side == 'china' %}
                                    {% if cost.amount_cny %}
                                    <span class="text-xs font-bold text-red-600">{{ cost.amount_cny|floatformat:0|intcomma }} CNY</span>
                                    {% endif %}
                                    {% if cost.amount_vnd and cost.amount_vnd > 0 %}
                                    <span class="text-[10px] text-slate-500">(≈ {{ cost.amount_vnd|floatformat:0|intcomma }} đ)</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-xs font-bold text-blue-600">{{ cost.amount_vnd|floatformat:0|intcomma }} đ</span>
                                {% endif %}
                                <div class="flex items-center gap-1 opacity-0 group-hover/item:opacity-100 transition">
                                    <button class="edit-spo-cost-btn text-slate-300 hover:text-indigo-600"
                                            data-cost-id="{{ cost.id }}"
                                            data-cost-name="{{ cost.name }}"
                                            data-cost-side="{{ cost.cost_side }}"
                                            data-cost-amount="{% if cost.cost_side == 'china' %}{{ cost.amount_cny|default:0 }}{% else %}{{ cost.amount_vnd|default:0 }}{% endif %}"
                                            data-cost-transaction-date="{{ cost.transaction_date|date:'Y-m-d' }}"
                                            data-cost-note="{{ cost.note }}"
                                            title="Sửa">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button class="delete-spo-cost-btn text-slate-300 hover:text-red-600"
                                            data-cost-id="{{ cost.id }}"
                                            title="Xóa">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-6 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto text-slate-300 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-xs text-slate-400">Chưa có chi phí</p>
                    </div>
                    {% endfor %}
                </div>
                {% if spo_costs %}
                <div class="flex justify-between items-center p-3.5 bg-gradient-to-r from-indigo-50 to-indigo-100/50 border-t-2 border-indigo-200 font-bold">
                    <span class="text-xs text-slate-700 uppercase tracking-wide">Tổng</span>
                    <span class="text-sm text-indigo-700">{{ total_spo_costs|floatformat:0|intcomma }} đ</span>
                </div>
                {% endif %}
            </div>

            <!-- Documents -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-emerald-50 to-white">
                    <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Chứng từ
                    </h3>
                </div>
                <div class="p-4 space-y-3">
                    <!-- Upload Area -->
                    <div id="document-upload-area" class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:border-emerald-400 hover:bg-emerald-50/30 transition cursor-pointer">
                        <input type="file" id="document-file-input" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" multiple>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto text-slate-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="text-xs text-slate-600 font-medium mb-1">Kéo thả file hoặc click để upload</p>
                        <p class="text-[10px] text-slate-400">PDF, DOC, XLS, JPG, PNG</p>
                    </div>

                    <!-- Documents List -->
                    <div class="space-y-2 max-h-[300px] overflow-y-auto">
                        {% for doc in spo_documents %}
                        <div class="flex items-center justify-between p-2.5 bg-slate-50 rounded-lg hover:bg-slate-100 transition group/item">
                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                {% if doc.file_icon %}
                                <img src="{{ doc.file_icon }}" alt="File icon" class="h-4 w-4 flex-shrink-0">
                                {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                {% endif %}
                                <div class="flex-1 min-w-0">
                                    <a href="{{ doc.file_url }}" target="_blank" class="text-xs font-medium text-slate-700 hover:text-emerald-600 truncate block">
                                        {{ doc.name }}
                                    </a>
                                    <div class="text-[10px] text-slate-400">{{ doc.uploaded_at|date:"d/m/Y H:i" }}</div>
                                </div>
                            </div>
                            <button class="delete-spo-document-btn text-slate-300 hover:text-red-600 opacity-0 group-hover/item:opacity-100 transition flex-shrink-0 ml-2"
                                    data-document-id="{{ doc.id }}"
                                    title="Xóa">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <p class="text-xs text-slate-400">Chưa có chứng từ</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            
        </div>
    </div>
</div>

<!-- Modals & Scripts (Preserving core logic with better UI) -->
<!-- Update Status Modal -->
<div id="update-status-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-scaleIn">
        <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Cập nhật Trạng thái SPO</h3>
            <form id="update-status-form">
                <input type="hidden" name="spo_id" value="{{ spo.id }}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Trạng thái mới</label>
                        <select name="status" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                             {% for status_code, status_label in spo.STATUS_CHOICES %}
                             <option value="{{ status_code }}" {% if spo.status == status_code %}selected{% endif %}>{{ status_label }}</option>
                             {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Ngày thực tế</label>
                        <input type="datetime-local" name="actual_date" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Ghi chú</label>
                        <textarea name="note" rows="3" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('update-status-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                    <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-sm">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Planned Date Modal -->
<div id="planned-date-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full animate-scaleIn">
        <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-1">Đặt ngày dự kiến</h3>
            <p class="text-xs text-slate-500 mb-4 font-mono uppercase bg-slate-100 px-2 py-1 inline-block rounded" id="modal-stage-name"></p>
            <form id="planned-date-form">
                <input type="hidden" id="modal-stage" name="stage">
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1">Ngày dự kiến *</label>
                    <input type="date" name="planned_date" required class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('planned-date-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                    <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-sm">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add/Edit Ship Info Modal -->
<div id="add-ship-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-scaleIn">
        <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4" id="ship-modal-title">Thêm thông tin tàu</h3>
            <form id="add-ship-form">
                <input type="hidden" name="spo_id" value="{{ spo.id }}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Tên tàu</label>
                        <input type="text" name="ship_name" id="ship-name-input" value="{{ spo.ship_name|default:'' }}" placeholder="Ví dụ: MV Ever Given" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Link tracking tàu</label>
                        <input type="url" name="ship_tracking_link" id="ship-tracking-input" value="{{ spo.ship_tracking_link|default:'' }}" placeholder="https://..." class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeShipModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                    <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-sm">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add PO Modal -->
<div id="add-po-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-scaleIn">
        <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Thêm PO vào Container</h3>
            <form id="add-po-form">
                <input type="hidden" name="spo_id" value="{{ spo.id }}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Tag (Sapo)</label>
                        <input type="text" name="tag" placeholder="Ví dụ: TEMP_HCM" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                        <p class="text-[10px] text-slate-500 mt-1">Hệ thống sẽ tìm tất cả PO có tag này</p>
                    </div>
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-slate-200"></div>
                        </div>
                        <div class="relative flex justify-center text-xs uppercase">
                            <span class="bg-white px-2 text-slate-500">Hoặc nhập ID</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Chọn PO từ danh sách</label>
                        <div id="valid-pos-list" class="max-h-60 overflow-y-auto border border-slate-300 rounded-lg divide-y divide-slate-200">
                            <div class="p-3 text-center text-xs text-slate-400">Đang tải danh sách PO...</div>
                        </div>
                        <p class="text-[10px] text-slate-500 mt-1">Danh sách PO hợp lệ: chưa thuộc SPO, status pending, NSX thuộc Container Template</p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('add-po-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                    <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-sm">Thêm PO</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals for PO Management -->
<!-- Update Delivery Status Modal -->
<div id="update-delivery-status-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-scaleIn">
        <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Cập nhật Trạng thái Giao Hàng</h3>
            <form id="update-delivery-status-form">
                <input type="hidden" name="po_id" id="modal-po-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Trạng thái mới</label>
                        <select name="delivery_status" id="modal-delivery-status" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                            <option value="ordered">Lên đơn</option>
                            <option value="sent_label">Gửi đơn & Label</option>
                            <option value="production">Sản xuất</option>
                            <option value="delivered">Giao hàng</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Ngày</label>
                        <input type="date" name="date" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Ghi chú</label>
                        <textarea name="note" rows="3" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('update-delivery-status-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                    <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-sm">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Cost Modal -->
<div id="add-cost-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-scaleIn">
        <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Thêm Chi Phí</h3>
            <form id="add-cost-form">
                <input type="hidden" name="po_id" id="modal-cost-po-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Loại chi phí</label>
                        <select name="cost_type" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                            <option value="domestic_shipping_cn">Giao hàng nội địa TQ</option>
                            <option value="packing_fee">Phí đóng hàng</option>
                            <option value="other">Chi phí khác</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Số tiền (CNY) *</label>
                        <input type="number" id="cost-amount-cny" name="amount_cny" step="0.01" required class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                        <input type="hidden" id="cost-total-cbm" value="0">
                        <div id="cost-price-per-cbm" class="mt-2 text-xs text-emerald-600 font-medium hidden">
                            Chi phí trên mỗi m³ là: <span class="font-bold" id="cost-price-value">0</span> CNY/m³
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Mô tả</label>
                        <textarea name="description" rows="2" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('add-cost-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                    <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-sm">Thêm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div id="add-payment-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-scaleIn">
        <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Thêm Thanh Toán</h3>
            <form id="add-payment-form">
                <input type="hidden" name="po_id" id="modal-payment-po-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Loại thanh toán</label>
                        <select name="payment_type" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                            <option value="deposit">Cọc sản xuất</option>
                            <option value="payment">Thanh toán đơn hàng</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Số tiền (CNY) *</label>
                        <input type="number" id="payment-amount-cny" name="amount_cny" step="0.01" required class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                        <p class="text-[10px] text-slate-400 mt-1">Số tiền sẽ tự động trừ từ số dư nhân dân tệ</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Ngày thanh toán</label>
                        <input type="date" id="payment-date" name="payment_date" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Mô tả</label>
                        <textarea name="description" rows="2" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('add-payment-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                    <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm">Thêm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add SPO Cost Modal -->
<div id="add-spo-cost-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full animate-scaleIn">
        <div class="p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Thêm Chi Phí SPO</h3>
            <form id="add-spo-cost-form">
                <input type="hidden" name="cost_id" value="">
                <input type="hidden" name="spo_id" value="{{ spo.id }}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Tên chi phí *</label>
                        <input type="text" name="name" required placeholder="Ví dụ: Phí vận chuyển, Phí bảo hiểm..." class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Phía chi phí *</label>
                        <select name="cost_side" id="cost-side-select" required class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="china">Phía Trung Quốc (CNY - trừ từ số dư)</option>
                            <option value="vietnam">Phía Việt Nam (VNĐ - không trừ từ số dư)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1" id="amount-label">Số tiền (CNY) *</label>
                        <input type="text" name="amount" id="amount-input" required placeholder="0" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" autocomplete="off">
                        <p class="text-[10px] text-slate-500 mt-1" id="amount-hint">Nhập số tiền, dấu phẩy sẽ tự động được thêm</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Ngày giao dịch *</label>
                        <input type="date" name="transaction_date" id="transaction-date-input" required value="{% now 'Y-m-d' %}" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Ghi chú</label>
                        <textarea name="note" rows="3" placeholder="Mô tả chi tiết..." class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('add-spo-cost-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                    <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm">Thêm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const spoId = parseInt('{{ spo.id|default:0 }}');

    // === TIMELINE LOGIC (Redesigned) ===
    const activeLine = document.getElementById('active-line');
    const nodes = document.querySelectorAll('.timeline-node');
    
    // Config: Fixed Order
    const stagesOrder = ['created', 'sent_to_supplier', 'packed', 'departed_cn', 'arrived_vn', 'completed'];
    
    // Current Status from DB (injected via template)
    const currentStatus = '{{ spo.status }}';
    
    // Mapping Timeline Data
    // We need to map actual/planned dates from spo.timeline (JSON) to our fixed nodes
    const timelineData = {};
    {% for stage in spo.timeline %}
        timelineData['{{ stage.stage }}'] = {
            planned: '{{ stage.planned_date|default:"" }}',
            actual: '{{ stage.actual_date|default:"" }}',
            note: `{{ stage.note|escapejs }}`
        };
    {% endfor %}

    // Determine Active Index based on Status
    let activeIndex = stagesOrder.indexOf(currentStatus);
    if(activeIndex === -1) {
        if(currentStatus === 'draft') activeIndex = -1;
        else activeIndex = 0; // Default or fallback
    }

    // Render Nodes
    nodes.forEach((node, index) => {
        const stageCode = node.dataset.stage;
        const circle = node.querySelector('.node-circle');
        const iconCheck = node.querySelector('.icon-check');
        const iconDot = node.querySelector('.icon-dot');
        const label = node.querySelector('.node-label');
        const dateContainer = node.querySelector('.node-date-container');
        
        // Data for this stage
        const stageData = timelineData[stageCode] || {};
        const isCompleted = index <= activeIndex;
        const isFuture = index > activeIndex;
        
        // 1. Style Node (Green theme)
        if (index < activeIndex) {
            // Completed Past (Green)
            circle.classList.add('bg-emerald-500', 'border-emerald-500', 'text-white');
            circle.classList.remove('bg-white', 'border-slate-300', 'text-slate-400');
            iconCheck.classList.remove('hidden');
            iconDot.classList.add('hidden');
            label.classList.add('text-emerald-600');
            label.classList.remove('text-slate-400');
        } else if (index === activeIndex) {
            // Current Active (Green ring)
            circle.classList.add('bg-white', 'border-emerald-500', 'text-emerald-500', 'ring-4', 'ring-emerald-100');
            circle.classList.remove('bg-white', 'border-slate-300', 'text-slate-400');
            iconCheck.classList.add('hidden');
            iconDot.classList.remove('hidden');
            iconDot.classList.add('bg-emerald-500', 'w-2', 'h-2');
            label.classList.add('text-emerald-600', 'font-extrabold');
            label.classList.remove('text-slate-400');
        } else {
            // Future
            // Default styles are fine
        }
        
        // 2. Render Dates & Tags
        let dateHtml = '';
        
        // ACTUAL DATE
        if (stageData.actual) {
            const dateObj = new Date(stageData.actual);
            const dateStr = dateObj.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'});
            dateHtml += `<span class="text-[10px] font-bold text-slate-700">${dateStr}</span>`;
            
            // Tag: Compare actual vs planned
            if (stageData.planned) {
                const plannedObj = new Date(stageData.planned);
                const daysDiff = Math.floor((dateObj - plannedObj) / (1000 * 60 * 60 * 24));
                if (daysDiff <= 0) {
                    dateHtml += `<span class="text-[9px] px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 font-bold">Đúng hẹn</span>`;
                } else {
                    dateHtml += `<span class="text-[9px] px-1.5 py-0.5 rounded bg-red-100 text-red-700 font-bold">Trễ ${daysDiff} ngày</span>`;
                }
            }
        } 
        // PLANNED DATE (Show if no actual)
        else if (stageData.planned) {
            const dateObj = new Date(stageData.planned);
            const dateStr = dateObj.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'});
            
            // Check deadline vs today
            const today = new Date();
            today.setHours(0,0,0,0);
            dateObj.setHours(0,0,0,0);
            const daysDiff = Math.floor((dateObj - today) / (1000 * 60 * 60 * 24));
            
            let colorClass = 'text-slate-500';
            let tagHtml = '';
            
            if (daysDiff > 0) {
                colorClass = 'text-blue-600';
                tagHtml = `<span class="text-[9px] px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 font-bold">Còn ${daysDiff} ngày</span>`;
            } else if (daysDiff < 0) {
                colorClass = 'text-red-600';
                tagHtml = `<span class="text-[9px] px-1.5 py-0.5 rounded bg-red-100 text-red-700 font-bold">Trễ deadline ${Math.abs(daysDiff)} ngày</span>`;
            } else {
                colorClass = 'text-amber-600';
                tagHtml = `<span class="text-[9px] px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 font-bold">Hôm nay</span>`;
            }
            
            dateHtml += `<span class="text-[10px] font-medium ${colorClass} cursor-pointer hover:text-emerald-600 border-b border-dashed border-slate-300 hover:border-emerald-500 transition-colors update-date-btn" data-stage="${stageCode}" data-date="${stageData.planned.split('T')[0]}" title="Dự kiến">${dateStr}</span>`;
            dateHtml += tagHtml;
        } 
        // NO DATE -> Add Button
        else {
             dateHtml += `<button class="text-slate-300 hover:text-emerald-500 text-lg leading-none transition-colors update-date-btn" data-stage="${stageCode}" title="Đặt ngày dự kiến">+</button>`;
        }
        
        dateContainer.innerHTML = dateHtml;
    });

    // 3. Update Line Progress
    // We want the line to go up to the active step.
    if (activeLine && nodes.length > 1) {
        const progress = (activeIndex / (nodes.length - 1)) * 100;
        activeLine.style.width = `${Math.max(0, Math.min(100, progress))}%`;
    }

    // === INTERACTIVE HANDLERS ===
    
    // 1. Add Planned Date
    const plannedDateModal = document.getElementById('planned-date-modal');
    document.addEventListener('click', function(e) {
        if (e.target.closest('.update-date-btn')) {
            const btn = e.target.closest('.update-date-btn');
            const stage = btn.getAttribute('data-stage');
            const currentVal = btn.getAttribute('data-date');
            
            document.getElementById('modal-stage').value = stage;
            document.getElementById('modal-stage-name').textContent = stage; // Could map to Label if needed
            if(currentVal) document.querySelector('input[name="planned_date"]').value = currentVal;
            else document.querySelector('input[name="planned_date"]').value = ''; // Reset
            
            plannedDateModal.classList.remove('hidden');
        }
    });

    // Form: Submit Planned Date
    document.getElementById('planned-date-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = {
            spo_id: spoId,
            stage: document.getElementById('modal-stage').value,
            planned_date: e.target.planned_date.value
        };
        fetch('{% url "products:update_timeline_planned_date" %}', {
            method: 'POST', body: JSON.stringify(data),
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') window.location.reload();
            else alert(d.message);
        });
    });

    // 2. Next Step Trigger
    document.querySelectorAll('.next-step-trigger').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation(); // prevent bubbling
            const statusModal = document.getElementById('update-status-modal');
            statusModal.classList.remove('hidden');
        });
    });

    // 3. Add PO & Sync PO Buttons
    document.getElementById('add-po-btn')?.addEventListener('click', async () => {
        const modal = document.getElementById('add-po-modal');
        const validPosList = document.getElementById('valid-pos-list');
        
        // Load valid POs
        validPosList.innerHTML = '<div class="p-3 text-center text-xs text-slate-400">Đang tải danh sách PO...</div>';
        modal.classList.remove('hidden');
        
        try {
            const response = await fetch(`/products/sum-purchase-orders/${spoId}/get-valid-pos/`);
            const data = await response.json();
            
            if (data.status === 'success' && data.valid_pos && data.valid_pos.length > 0) {
                validPosList.innerHTML = data.valid_pos.map(po => `
                    <label class="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" name="po_ids" value="${po.sapo_order_supplier_id}" class="rounded border-slate-300 text-emerald-600 focus:ring-emerald-500">
                        <div class="flex-1">
                            <div class="text-xs font-semibold text-slate-800">${po.code || 'N/A'}</div>
                            <div class="text-[10px] text-slate-500">${po.supplier_name || 'N/A'}</div>
                            <div class="text-[10px] text-slate-400 mt-0.5">
                                ${po.total_amount_cny.toLocaleString('vi-VN')} CNY • ${po.total_cbm.toFixed(2)} CBM • ${po.total_quantity} sản phẩm
                            </div>
                        </div>
                    </label>
                `).join('');
            } else {
                validPosList.innerHTML = '<div class="p-3 text-center text-xs text-slate-400">Không có PO hợp lệ nào</div>';
            }
        } catch (error) {
            validPosList.innerHTML = '<div class="p-3 text-center text-xs text-red-500">Lỗi khi tải danh sách PO</div>';
        }
    });
    
    document.getElementById('sync-po-btn')?.addEventListener('click', async () => {
        if(!confirm('Bạn có chắc chắn muốn đồng bộ dữ liệu tất cả PO từ Sapo không? (Chỉ lấy PO có tag trùng với SPO và status pending/partial/completed)')) return;
        
        // Lấy tag từ SPO (ví dụ: SPO-2025-001)
        const spoTag = '{{ spo.code }}';
        
        try {
            const response = await fetch('{% url "products:sync_po_from_sapo" %}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({tag: spoTag})
            });
            const data = await response.json();
            
            if(data.status === 'success') {
                // Sau khi sync, tự động thêm các PO vào SPO
                if(data.po_list && data.po_list.length > 0) {
                    const poIds = data.po_list.map(po => po.sapo_order_supplier_id);
                    const addResponse = await fetch('{% url "products:add_po_to_spo" %}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                        body: JSON.stringify({spo_id: spoId, po_ids: poIds})
                    });
                    const addData = await addResponse.json();
                    if(addData.status === 'success') {
                        alert(`Đã sync và thêm ${addData.added_count || poIds.length} PO vào SPO`);
                        window.location.reload();
                    } else {
                        alert('Đã sync nhưng có lỗi khi thêm PO: ' + addData.message);
                    }
                } else {
                    alert('Không tìm thấy PO nào có tag ' + spoTag);
                }
            } else {
                alert('Lỗi khi sync: ' + data.message);
            }
        } catch (error) {
            alert('Lỗi: ' + error.message);
        }
    });

    // Form: Add PO
    document.getElementById('add-po-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        
        // Handle PO IDs from checkboxes
        const checkboxes = document.querySelectorAll('input[name="po_ids"]:checked');
        if (checkboxes.length > 0) {
            data.po_ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
        } else if (data.po_ids) {
            // Fallback: handle comma-separated string
            data.po_ids = data.po_ids.split(',').map(s => s.trim()).filter(s => s).map(s => parseInt(s));
        }
        
        fetch('{% url "products:add_po_to_spo" %}', {
            method: 'POST', body: JSON.stringify(data),
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') { alert(d.message); window.location.reload(); }
            else alert(d.message);
        });
    });
    
    // Ship Info Modal Functions
    window.openEditShipModal = function() {
        const modal = document.getElementById('add-ship-modal');
        const title = document.getElementById('ship-modal-title');
        const shipNameInput = document.getElementById('ship-name-input');
        const shipTrackingInput = document.getElementById('ship-tracking-input');
        
        // Set current values
        shipNameInput.value = '{{ spo.ship_name|default:""|escapejs }}';
        shipTrackingInput.value = '{{ spo.ship_tracking_link|default:""|escapejs }}';
        
        // Update title based on whether info exists
        if ('{{ spo.ship_name|default:"" }}' || '{{ spo.ship_tracking_link|default:"" }}') {
            title.textContent = 'Sửa thông tin tàu';
        } else {
            title.textContent = 'Thêm thông tin tàu';
        }
        
        modal.classList.remove('hidden');
    }
    
    window.closeShipModal = function() {
        document.getElementById('add-ship-modal').classList.add('hidden');
    }
    
    window.deleteShipInfo = function() {
        if (!confirm('Bạn có chắc muốn xóa thông tin tàu này?')) {
            return;
        }
        
        const data = {
            ship_name: '',
            ship_tracking_link: ''
        };
        
        fetch(`/products/sum-purchase-orders/${spoId}/update-ship-info/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') {
                window.location.reload();
            } else {
                alert(d.message || 'Lỗi khi xóa thông tin tàu');
            }
        }).catch(err => {
            alert('Lỗi: ' + err.message);
        });
    }
    
    // Form: Add/Edit Ship Info
    document.getElementById('add-ship-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        
        fetch(`/products/sum-purchase-orders/${spoId}/update-ship-info/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') {
                window.location.reload();
            } else {
                alert(d.message || 'Lỗi khi cập nhật thông tin tàu');
            }
        }).catch(err => {
            alert('Lỗi: ' + err.message);
        });
    });

    // Form: Update Status
    document.getElementById('update-status-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        fetch('{% url "products:update_spo_status" %}', {
            method: 'POST', body: JSON.stringify(Object.fromEntries(fd)),
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') window.location.reload();
            else alert(d.message);
        });
    });
    
    // ========== PO MANAGEMENT ==========
    
    // Expand/Collapse PO Details
    document.querySelectorAll('.expand-po-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const card = this.closest('[data-po-id]');
            const details = card.querySelector('.po-details');
            const icon = this.querySelector('svg');
            
            if(details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        });
    });
    
    // Update Delivery Status
    document.querySelectorAll('.update-delivery-status-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const poId = this.getAttribute('data-po-id');
            const currentStatus = this.getAttribute('data-current-status');
            
            document.getElementById('modal-po-id').value = poId;
            document.getElementById('modal-delivery-status').value = currentStatus;
            document.getElementById('update-delivery-status-modal').classList.remove('hidden');
        });
    });
    
    document.getElementById('update-delivery-status-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        data.date = data.date || new Date().toISOString().split('T')[0];
        
        fetch(`/products/purchase-orders/${data.po_id}/update-delivery-status/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') window.location.reload();
            else alert(d.message);
        });
    });
    
    // Add Cost
    document.querySelectorAll('.add-cost-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const poId = this.getAttribute('data-po-id');
            const poCard = this.closest('[data-po-id]');
            const totalCbm = parseFloat(poCard.getAttribute('data-po-total-cbm')) || 0;
            
            document.getElementById('modal-cost-po-id').value = poId;
            document.getElementById('cost-total-cbm').value = totalCbm.toFixed(3);
            document.getElementById('cost-amount-cny').value = '';
            const priceValue = document.getElementById('cost-price-value');
            if (priceValue) priceValue.textContent = '0';
            const pricePerCbmDiv = document.getElementById('cost-price-per-cbm');
            if (pricePerCbmDiv) pricePerCbmDiv.classList.add('hidden');
            document.getElementById('add-cost-modal').classList.remove('hidden');
        });
    });
    
    // Tính giá/m³ khi nhập số tiền
    document.getElementById('cost-amount-cny')?.addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        const totalCbmInput = document.getElementById('cost-total-cbm');
        const totalCbm = totalCbmInput ? parseFloat(totalCbmInput.value) || 0 : 0;
        const pricePerCbmDiv = document.getElementById('cost-price-per-cbm');
        const priceValue = document.getElementById('cost-price-value');
        
        if (amount > 0 && totalCbm > 0 && priceValue && pricePerCbmDiv) {
            const pricePerCbm = (amount / totalCbm).toFixed(2);
            priceValue.textContent = pricePerCbm;
            pricePerCbmDiv.classList.remove('hidden');
        } else if (pricePerCbmDiv) {
            pricePerCbmDiv.classList.add('hidden');
        }
    });
    
    document.getElementById('add-cost-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        data.amount_cny = parseFloat(data.amount_cny);
        // Không gửi cbm, server sẽ tự động tính từ total_cbm của PO
        
        fetch(`/products/purchase-orders/${data.po_id}/costs/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') {
                window.location.reload();
            } else {
                alert(d.message);
            }
        });
    });
    
    // Delete Cost (xóa tất cả costs cùng loại)
    document.querySelectorAll('.delete-cost-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if(!confirm('Bạn có chắc muốn xóa tất cả chi phí cùng loại này?')) return;
            const costIds = JSON.parse(this.getAttribute('data-cost-ids') || '[]');
            const poId = this.closest('[data-po-id]').getAttribute('data-po-id');
            
            // Xóa từng cost (có thể có nhiều costs cùng loại)
            const deletePromises = costIds.map(costId => 
                fetch(`/products/purchase-orders/${poId}/costs/${costId}/`, {
                    method: 'DELETE',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                }).then(r => r.json())
            );
            
            Promise.all(deletePromises).then(results => {
                const allSuccess = results.every(r => r.status === 'success');
                if(allSuccess) {
                    window.location.reload();
                } else {
                    alert('Có lỗi xảy ra khi xóa một số chi phí');
                }
            });
        });
    });
    
    // Add Payment
    document.querySelectorAll('.add-payment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const poId = this.getAttribute('data-po-id');
            document.getElementById('modal-payment-po-id').value = poId;
            
            // Set ngày thanh toán mặc định là hôm nay
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            // Reset các trường
            document.getElementById('payment-amount-cny').value = '';
            
            document.getElementById('add-payment-modal').classList.remove('hidden');
        });
    });
    
    // Không cần tính toán real-time nữa vì chỉ nhập số tiền CNY
    
    document.getElementById('add-payment-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        
        // Parse số tiền CNY
        const amountCny = parseFloat(data.amount_cny) || 0;
        
        // Validate: phải có số tiền CNY
        if (amountCny <= 0) {
            alert('Vui lòng nhập số tiền nhân dân tệ (CNY) lớn hơn 0');
            return;
        }
        
        // Set ngày thanh toán mặc định nếu chưa có
        if (!data.payment_date) {
            data.payment_date = new Date().toISOString().split('T')[0];
        }
        
        // Gửi dữ liệu (chỉ gửi amount_cny và payment_date)
        const submitData = {
            po_id: data.po_id,
            payment_type: data.payment_type,
            amount_cny: amountCny,
            payment_date: data.payment_date,
            description: data.description || ''
        };
        
        fetch(`/products/purchase-orders/${data.po_id}/payments/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(submitData)
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') window.location.reload();
            else alert(d.message);
        });
    });
    
    // Delete Payment
    document.querySelectorAll('.delete-payment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if(!confirm('Bạn có chắc muốn xóa thanh toán này?')) return;
            const paymentId = this.getAttribute('data-payment-id');
            const poId = this.closest('[data-po-id]').getAttribute('data-po-id');
            
            fetch(`/products/purchase-orders/${poId}/payments/${paymentId}/`, {
                method: 'DELETE',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            }).then(r => r.json()).then(d => {
                if(d.status === 'success') window.location.reload();
                else alert(d.message);
            });
        });
    });
    
    // Remove PO from SPO
    document.querySelectorAll('.remove-po-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if(!confirm('Bạn có chắc muốn xóa PO này khỏi SPO? (PO sẽ không bị xóa, chỉ xóa khỏi container này)')) return;
            const poId = this.getAttribute('data-po-id');
            
            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
            
            fetch(`/products/sum-purchase-orders/${spoId}/remove-po/${poId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                }
            }).then(r => r.json()).then(d => {
                if(d.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Lỗi: ' + (d.message || 'Không thể xóa PO khỏi SPO'));
                }
            }).catch(error => {
                alert('Lỗi: ' + error.message);
            });
        });
    });
    
    // Close modals on click outside
    ['update-delivery-status-modal', 'add-cost-modal', 'add-payment-modal', 'add-spo-cost-modal'].forEach(modalId => {
        const modal = document.getElementById(modalId);
        if(modal) {
            modal.addEventListener('click', (e) => {
                if(e.target === modal) modal.classList.add('hidden');
            });
        }
    });
    
    // ========== SPO COSTS MANAGEMENT ==========
    
    // Add SPO Cost Button
    document.getElementById('add-spo-cost-btn')?.addEventListener('click', () => {
        document.getElementById('add-spo-cost-modal').classList.remove('hidden');
        // Reset form
        document.getElementById('add-spo-cost-form').reset();
        updateAmountLabel();
    });
    
    // Update amount label based on cost side
    function updateAmountLabel() {
        const costSide = document.getElementById('cost-side-select')?.value;
        const amountLabel = document.getElementById('amount-label');
        const amountHint = document.getElementById('amount-hint');
        
        if (costSide === 'china') {
            amountLabel.textContent = 'Số tiền (CNY) *';
            amountHint.textContent = 'Nhập số tiền bằng nhân dân tệ, sẽ trừ từ số dư. Dấu phẩy sẽ tự động được thêm.';
        } else {
            amountLabel.textContent = 'Số tiền (VNĐ) *';
            amountHint.textContent = 'Nhập số tiền bằng đồng Việt Nam, không trừ từ số dư. Dấu phẩy sẽ tự động được thêm.';
        }
    }
    
    // Format amount input with commas
    function formatAmountInput(input) {
        const costSide = document.getElementById('cost-side-select')?.value;
        // Remove all non-digit characters except decimal point
        let value = input.value.replace(/[^\d.]/g, '');
        
        // Split by decimal point if exists
        const parts = value.split('.');
        let integerPart = parts[0];
        
        // For CNY (China side), allow 2 decimal places; for VND (Vietnam side), no decimals
        let decimalPart = '';
        if (costSide === 'china' && parts.length > 1) {
            decimalPart = '.' + parts[1].slice(0, 2); // Max 2 decimal places for CNY
        } else if (costSide === 'vietnam' && parts.length > 1) {
            // For VND, ignore decimal part
            decimalPart = '';
        }
        
        // Add commas to integer part
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        // Update input value
        input.value = integerPart + decimalPart;
    }
    
    // Event listeners for cost side and amount input
    document.getElementById('cost-side-select')?.addEventListener('change', function() {
        updateAmountLabel();
        // Clear and reformat amount when side changes
        const amountInput = document.getElementById('amount-input');
        if (amountInput.value) {
            formatAmountInput(amountInput);
        }
    });
    document.getElementById('amount-input')?.addEventListener('input', function() {
        formatAmountInput(this);
    });
    
    // Form: Add/Edit SPO Cost
    document.getElementById('add-spo-cost-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const costId = data.cost_id;
        
        // Remove commas from amount and convert to number
        const amountStr = data.amount.replace(/,/g, '');
        if (!amountStr || isNaN(parseFloat(amountStr))) {
            alert('Vui lòng nhập số tiền hợp lệ');
            return;
        }
        
        data.amount = amountStr; // Send as string without commas
        
        // Remove cost_id from data (it's in the URL for edit)
        delete data.cost_id;
        
        let url = '{% url "products:add_spo_cost" %}';
        if (costId) {
            url = `/products/sum-purchase-orders/costs/${costId}/edit/`;
        }
        
        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        }).then(r => r.json()).then(d => {
            if(d.status === 'success') {
                window.location.reload();
            } else {
                alert(d.message);
            }
        }).catch(err => {
            alert('Lỗi: ' + err.message);
        });
    });
    
    // Edit SPO Cost
    document.querySelectorAll('.edit-spo-cost-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const costId = this.getAttribute('data-cost-id');
            const costName = this.getAttribute('data-cost-name');
            const costSide = this.getAttribute('data-cost-side');
            const costAmount = this.getAttribute('data-cost-amount');
            const costTransactionDate = this.getAttribute('data-cost-transaction-date');
            const costNote = this.getAttribute('data-cost-note') || '';
            
            // Fill form
            const form = document.getElementById('add-spo-cost-form');
            form.querySelector('input[name="cost_id"]').value = costId;
            form.querySelector('input[name="name"]').value = costName;
            form.querySelector('select[name="cost_side"]').value = costSide;
            form.querySelector('input[name="transaction_date"]').value = costTransactionDate;
            form.querySelector('textarea[name="note"]').value = costNote;
            
            // Set amount
            const amountInput = document.getElementById('amount-input');
            if (costAmount) {
                amountInput.value = parseFloat(costAmount).toLocaleString('vi-VN');
            } else {
                amountInput.value = '';
            }
            
            // Update label and hint
            updateAmountLabel();
            
            // Change modal title
            document.querySelector('#add-spo-cost-modal h3').textContent = 'Sửa Chi Phí SPO';
            document.querySelector('#add-spo-cost-form button[type="submit"]').textContent = 'Lưu';
            
            // Show modal
            document.getElementById('add-spo-cost-modal').classList.remove('hidden');
        });
    });
    
    // Delete SPO Cost
    document.querySelectorAll('.delete-spo-cost-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if(!confirm('Bạn có chắc muốn xóa chi phí này?')) return;
            const costId = this.getAttribute('data-cost-id');
            
            fetch(`/products/sum-purchase-orders/costs/${costId}/delete/`, {
                method: 'DELETE',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            }).then(r => r.json()).then(d => {
                if(d.status === 'success') window.location.reload();
                else alert(d.message);
            });
        });
    });
    
    // Reset form when opening add modal
    document.getElementById('add-spo-cost-btn')?.addEventListener('click', function() {
        const form = document.getElementById('add-spo-cost-form');
        form.reset();
        form.querySelector('input[name="cost_id"]').value = '';
        form.querySelector('input[name="transaction_date"]').value = '{% now "Y-m-d" %}';
        document.querySelector('#add-spo-cost-modal h3').textContent = 'Thêm Chi Phí SPO';
        document.querySelector('#add-spo-cost-form button[type="submit"]').textContent = 'Thêm';
        updateAmountLabel();
    });
    
    // ========== UPDATE PACKING LIST FROM TKHQ ==========
    const updatePackingListBtn = document.getElementById('update-packing-list-from-tkhq-btn');
    const tkhqFileInput = document.getElementById('tkhq-file-input');
    
    if (updatePackingListBtn && tkhqFileInput) {
        updatePackingListBtn.addEventListener('click', function() {
            tkhqFileInput.click();
        });
        
        tkhqFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            
            if (!confirm('Bạn có chắc muốn cập nhật packing list từ file TKHQ đã điền SKU?')) {
                tkhqFileInput.value = '';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const originalBtnText = updatePackingListBtn.innerHTML;
            updatePackingListBtn.disabled = true;
            updatePackingListBtn.innerHTML = '<span class="inline-block animate-spin mr-1">⟳</span> Đang xử lý...';
            
            fetch(`{% url 'products:update_packing_list_from_tkhq' spo.id %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`✅ ${data.message}\n\nĐã cập nhật ${data.updated_count || 0} dòng packing list.`);
                    window.location.reload();
                } else {
                    alert(`❌ Lỗi: ${data.message || 'Không thể cập nhật packing list'}`);
                    updatePackingListBtn.disabled = false;
                    updatePackingListBtn.innerHTML = originalBtnText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi cập nhật packing list');
                updatePackingListBtn.disabled = false;
                updatePackingListBtn.innerHTML = originalBtnText;
            })
            .finally(() => {
                tkhqFileInput.value = '';
            });
        });
    }
    
    // ========== SPO DOCUMENTS MANAGEMENT ==========
    
    // Document Upload Area
    const uploadArea = document.getElementById('document-upload-area');
    const fileInput = document.getElementById('document-file-input');
    
    uploadArea?.addEventListener('click', () => {
        fileInput?.click();
    });
    
    uploadArea?.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-emerald-500', 'bg-emerald-50');
    });
    
    uploadArea?.addEventListener('dragleave', () => {
        uploadArea.classList.remove('border-emerald-500', 'bg-emerald-50');
    });
    
    uploadArea?.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-emerald-500', 'bg-emerald-50');
        const files = e.dataTransfer.files;
        if(files.length > 0) {
            handleFileUpload(files);
        }
    });
    
    fileInput?.addEventListener('change', (e) => {
        if(e.target.files.length > 0) {
            handleFileUpload(e.target.files);
        }
    });
    
    function handleFileUpload(files) {
        const spoId = parseInt('{{ spo.id }}');
        
        Array.from(files).forEach(file => {
            const formData = new FormData();
            formData.append('spo_id', spoId);
            formData.append('file', file);
            formData.append('name', file.name);
            
            fetch('{% url "products:upload_spo_document" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                body: formData
            }).then(r => r.json()).then(d => {
                if(d.status === 'success') {
                    window.location.reload();
                } else {
                    alert(d.message);
                }
            }).catch(err => {
                alert('Lỗi khi upload file: ' + err.message);
            });
        });
    }
    
    // Delete SPO Document
    document.querySelectorAll('.delete-spo-document-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if(!confirm('Bạn có chắc muốn xóa chứng từ này?')) return;
            const docId = this.getAttribute('data-document-id');
            
            fetch(`/products/sum-purchase-orders/documents/${docId}/delete/`, {
                method: 'DELETE',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            }).then(r => r.json()).then(d => {
                if(d.status === 'success') window.location.reload();
                else alert(d.message);
            });
        });
    });
});
</script>

<style>
/* Custom animations */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
@keyframes shimmer {
    from { transform: translateX(-100%) skewX(-12deg); }
    to { transform: translateX(200%) skewX(-12deg); }
}

.animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
.animate-scaleIn { animation: scaleIn 0.2s ease-out forwards; }
.animate-shimmer { animation: shimmer 2.5s infinite linear; }
</style>
{% endblock %}
