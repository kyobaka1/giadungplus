{% extends "products/base_products.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }} - Gia D·ª•ng Plus{% endblock %}

{% block overview %}
<section>
    <h1 class="text-lg font-semibold text-slate-800">{{ title }}</h1>
    <p class="text-xs text-gray-500 mt-1">Qu·∫£n l√Ω v√† xem th√¥ng tin t·∫•t c·∫£ ph√¢n lo·∫°i s·∫£n ph·∫©m</p>
</section>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-100">
    <div class="max-w-[95%] mx-auto">

        <!-- B·ªò L·ªåC V√Ä T√åM KI·∫æM -->
        <div class="mb-3 bg-white rounded-lg shadow-sm border border-slate-200 p-3">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xs font-semibold text-slate-700">T√¨m ki·∫øm & L·ªçc</h2>
                <!-- Action Buttons -->
                <div class="flex items-center gap-2">
                    <!-- Export Excel -->
                    <a href="{% url 'products:export_variants_excel' %}" 
                       id="export-excel-btn"
                       class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 transition text-xs font-medium flex items-center gap-1.5">
                        <span>üì•</span>
                        <span>Export Excel</span>
                    </a>
                    <!-- Import Excel -->
                    <label for="import-excel-input" 
                           class="px-3 py-1.5 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition text-xs font-medium flex items-center gap-1.5 cursor-pointer">
                        <span>üì§</span>
                        <span>Import Excel</span>
                    </label>
                    <input type="file" 
                           id="import-excel-input" 
                           accept=".xlsx,.xls" 
                           class="hidden">
                    <!-- Brand Settings Link -->
                    <a href="{% url 'products:brand_settings' %}" 
                       class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-xs font-medium flex items-center gap-1.5">
                        <span>‚öôÔ∏è</span>
                        <span>C√†i ƒë·∫∑t nh√£n hi·ªáu</span>
                    </a>
                </div>
            </div>
            <!-- B·ªô l·ªçc Nh√£n hi·ªáu -->
            <div class="mb-2">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-[10px] text-slate-600 font-medium">Nh√£n hi·ªáu:</span>
                    <div class="flex flex-wrap gap-1.5">
                        {% for brand in brands %}
                        <button type="button"
                                class="brand-filter-btn px-2.5 py-1.5 text-xs rounded-md border transition font-medium {% if brand.id == selected_brand_id %}bg-orange-500 text-white border-orange-500{% else %}bg-slate-50 text-slate-700 border-slate-300 hover:bg-slate-100{% endif %}"
                                data-brand-id="{{ brand.id }}"
                                data-brand-name="{{ brand.name }}">
                            {{ brand.name }} <span class="text-[10px] opacity-75">({{ brand.id }})</span>
                        </button>
                        {% endfor %}
                    </div>
                    <span class="text-[10px] text-slate-500 ml-2">T·ªïng: {{ total }} variants</span>
                </div>
            </div>
            
            <!-- B·ªô l·ªçc Tr·∫°ng th√°i -->
            <div class="mb-2">
                <div class="flex items-center gap-1 flex-wrap">
                    <span class="text-[10px] text-slate-600 font-medium mr-1">Tr·∫°ng th√°i:</span>
                    <button id="filter-status-all" 
                            class="filter-btn filter-status-btn active px-1.5 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-[10px] text-slate-700 font-medium hover:bg-slate-100 transition"
                            data-filter-type="status"
                            data-filter-value="all">
                        T·∫•t c·∫£ (<span id="filter-status-all-count">0</span>)
                    </button>
                    <div id="filter-status-container" class="flex flex-wrap gap-1">
                        {% for status_item in statuses %}
                        <button class="filter-btn filter-status-btn px-1.5 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-[10px] text-slate-700 font-medium hover:bg-slate-100 transition"
                                data-filter-type="status"
                                data-filter-value="{{ status_item }}">
                            {% if status_item == "active" %}Ho·∫°t ƒë·ªông{% elif status_item == "inactive" %}Ng·ª´ng ho·∫°t ƒë·ªông{% else %}{{ status_item }}{% endif %} (<span class="filter-status-count" data-status="{{ status_item }}">0</span>)
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- T√¨m ki·∫øm -->
            <div class="flex items-center gap-3 flex-wrap">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" 
                           id="variant-search-input"
                           name="search" 
                           value=""
                           placeholder="T√¨m ki·∫øm theo SKU..." 
                           class="w-full px-2 py-1.5 text-xs border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                </div>

                <!-- Reset -->
                <button type="button" 
                        id="reset-filters-btn"
                        class="px-3 py-1.5 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 transition text-xs font-medium">
                    ƒê·∫∑t l·∫°i
                </button>
            </div>
        </div>

        <!-- TH√îNG B√ÅO L·ªñI -->
        {% if error %}
        <div class="mb-3 bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg">
            <p class="text-xs font-medium">L·ªói: {{ error }}</p>
        </div>
        {% endif %}

        <!-- B·∫¢NG DANH S√ÅCH PH√ÇN LO·∫†I -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200 text-xs">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">SKU</th>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">T√™n ph√¢n lo·∫°i</th>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">Gi√° b√°n</th>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">T·ªìn kho</th>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">Th√¥ng tin th√πng</th>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">Mua h√†ng TQ</th>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">SKU nh·∫≠p kh·∫©u</th>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">Tr·∫°ng th√°i</th>
                            <th class="px-2 py-2 text-left text-[10px] font-semibold text-slate-700 uppercase tracking-wider">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200" id="variants-tbody">
                        {% if variants %}
                            {% for variant in variants %}
                            <tr class="js-variant-row hover:bg-slate-50 transition"
                                data-brand="{{ variant.brand|default:'' }}"
                                data-status="{{ variant.status|default:'' }}"
                                data-variant-id="{{ variant.id }}">
                                <!-- SKU -->
                                <td class="px-2 py-2">
                                    <div class="font-mono text-[11px] text-slate-800 font-medium">{{ variant.sku }}</div>
                                    {% if variant.opt2 or variant.opt3 %}
                                    <div class="flex gap-0.5 mt-0.5 flex-wrap">
                                        {% if variant.opt2 %}
                                        <span class="text-[9px] px-1 py-0.5 bg-green-50 text-green-700 rounded">{{ variant.opt2 }}</span>
                                        {% endif %}
                                        {% if variant.opt3 %}
                                        <span class="text-[9px] px-1 py-0.5 bg-purple-50 text-purple-700 rounded">{{ variant.opt3 }}</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </td>
                                
                                <!-- T√™n ph√¢n lo·∫°i (opt1) -->
                                <td class="px-2 py-2">
                                    {% if variant.opt1 %}
                                    <div class="text-[11px] text-slate-700 font-medium">{{ variant.opt1 }}</div>
                                    {% else %}
                                    <span class="text-slate-400 text-[10px]">-</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Gi√° b√°n -->
                                <td class="px-2 py-2 text-[11px] text-slate-700">
                                    <div class="font-medium">{{ variant.variant_retail_price|floatformat:0|intcomma }} ƒë</div>
                                </td>
                                
                                <!-- T·ªìn kho -->
                                <td class="px-2 py-2 text-center">
                                    <div class="flex flex-col items-center">
                                        <span class="text-[11px] font-medium {% if variant.total_available < 10 %}text-red-600{% elif variant.total_available < 50 %}text-orange-600{% else %}text-green-600{% endif %}">
                                            {{ variant.total_available|floatformat:0|intcomma }}
                                        </span>
                                        <span class="text-[9px] text-slate-400">/ {{ variant.total_inventory|floatformat:0|intcomma }}</span>
                                    </div>
                                </td>
                                
                                <!-- Th√¥ng tin th√πng -->
                                <td class="px-2 py-2 text-[10px] text-slate-600">
                                    {% if variant.box_info %}
                                        {% if variant.box_info.full_box %}
                                        <div><span class="font-medium"><b>{{ variant.box_info.full_box }}</b></span> c√°i/th√πng</div>
                                        {% endif %}
                                        {% if variant.box_info.length_cm or variant.box_info.width_cm or variant.box_info.height_cm %}
                                        <div class="text-[9px] text-slate-500">
                                            {{ variant.box_info.length_cm|default:"-" }} √ó {{ variant.box_info.width_cm|default:"-" }} √ó {{ variant.box_info.height_cm|default:"-" }} cm
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-slate-400">-</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Mua h√†ng TQ -->
                                <td class="px-2 py-2 text-[10px] text-slate-600">
                                    {% if variant.price_tq or variant.sku_tq or variant.name_tq %}
                                        {% if variant.price_tq %}
                                        <div class="font-medium text-red-600"><b>{{ variant.price_tq|floatformat:2 }}</b> <small>CNY</small></div>
                                        {% endif %}
                                        {% if variant.sku_tq %}
                                        <div class="text-[9px] text-slate-500 font-mono mt-0.5 max-w-[180px] overflow-hidden text-ellipsis whitespace-nowrap">SKU: {{ variant.sku_tq }}</div>
                                        {% endif %}
                                        {% if variant.name_tq %}
                                        <div class="text-[9px] text-slate-600 mt-0.5 max-w-[180px] overflow-hidden text-ellipsis whitespace-nowrap">{{ variant.name_tq }}</div>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-slate-400">-</span>
                                    {% endif %}
                                </td>
                                
                                <!-- SKU nh·∫≠p kh·∫©u -->
                                <td class="px-2 py-2 text-[10px] text-slate-600">
                                    {% if variant.sku_model_xnk %}
                                        <span class="font-mono text-slate-700">{{ variant.sku_model_xnk }}</span>
                                    {% else %}
                                        <span class="text-slate-400">-</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Tr·∫°ng th√°i -->
                                <td class="px-2 py-2">
                                    {% if variant.status == "active" %}
                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-medium bg-green-100 text-green-800">
                                            Ho·∫°t ƒë·ªông
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-medium bg-red-100 text-red-800">
                                            Ng·ª´ng
                                        </span>
                                    {% endif %}
                                </td>
                                
                                <!-- Thao t√°c -->
                                <td class="px-2 py-2">
                                    <div class="flex items-center gap-1">
                                        <button type="button"
                                                class="variant-edit-btn text-[9px] px-1.5 py-0.5 bg-green-50 text-green-700 rounded hover:bg-green-100 transition"
                                                data-variant-id="{{ variant.id }}"
                                                data-variant-sku="{{ variant.sku }}"
                                                data-variant-box-full-box="{{ variant.box_info.full_box|default:'' }}"
                                                data-variant-box-length="{{ variant.box_info.length_cm|default:'' }}"
                                                data-variant-box-width="{{ variant.box_info.width_cm|default:'' }}"
                                                data-variant-box-height="{{ variant.box_info.height_cm|default:'' }}"
                                                data-variant-price-tq="{{ variant.price_tq|default:'' }}"
                                                data-variant-sku-tq="{{ variant.sku_tq|default:'' }}"
                                                data-variant-name-tq="{{ variant.name_tq|default:'' }}"
                                                data-variant-sku-xnk="{{ variant.sku_model_xnk|default:'' }}">
                                            S·ª≠a
                                        </button>
                                        <a href="{% url 'products:variant_detail' variant.id %}" 
                                           class="text-[9px] px-1.5 py-0.5 bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition">
                                            Xem
                                        </a>
                                        <a href="https://sisapsan.mysapogo.com/admin/variants/{{ variant.id }}" 
                                           target="_blank"
                                           class="text-[9px] px-1.5 py-0.5 bg-slate-50 text-slate-700 rounded hover:bg-slate-100 transition">
                                            Sapo
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-xs text-slate-500">
                                    Ch∆∞a c√≥ ph√¢n lo·∫°i n√†o
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- SUMMARY -->
            {% if variants %}
            <div class="px-3 py-2 bg-slate-50 border-t border-slate-200">
                <div class="text-xs text-slate-600">
                    <strong>T·ªïng s·ªë ph√¢n lo·∫°i:</strong> {{ total_variants|default:total|default:variants|length }} ph√¢n lo·∫°i
                </div>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- MODAL EDIT VARIANT -->
<div id="variant-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-xl overflow-hidden flex flex-col max-h-[95vh]">
        <div class="flex-shrink-0 bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between">
            <h2 class="text-base font-semibold text-slate-800">S·ª≠a th√¥ng tin ph√¢n lo·∫°i</h2>
            <button type="button" id="variant-edit-modal-close" class="text-slate-400 hover:text-slate-600 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto px-4 py-3">
            <!-- Variant Info -->
            <div class="mb-3 pb-3 border-b border-slate-200">
                <div class="text-xs text-slate-600">
                    <span class="font-medium">SKU:</span> <span class="font-mono" id="modal-variant-sku">-</span>
                </div>
                <div class="text-[10px] text-slate-500 mt-0.5">
                    <span class="font-medium">ID:</span> <span id="modal-variant-id">-</span>
                </div>
            </div>
            
            <!-- Form -->
            <form id="variant-edit-form">
                <input type="hidden" id="modal-variant-id-input" name="variant_id">
                
                <!-- Th√¥ng tin th√πng -->
                <div class="mb-3">
                    <h3 class="text-xs font-semibold text-slate-700 mb-1.5">Th√¥ng tin th√πng</h3>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-[10px] text-slate-600 mb-0.5">S·ªë c√°i/th√πng</label>
                            <input type="number" 
                                   id="modal-box-full-box"
                                   name="full_box"
                                   class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-600 mb-0.5">K√≠ch th∆∞·ªõc (D√†i √ó R·ªông √ó Cao - cm)</label>
                            <div class="flex gap-1.5">
                                <input type="number" 
                                       step="0.1"
                                       id="modal-box-length"
                                       name="box_length_cm"
                                       placeholder="D√†i"
                                       class="flex-1 px-2 py-1 text-xs border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <input type="number" 
                                       step="0.1"
                                       id="modal-box-width"
                                       name="box_width_cm"
                                       placeholder="R·ªông"
                                       class="flex-1 px-2 py-1 text-xs border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <input type="number" 
                                       step="0.1"
                                       id="modal-box-height"
                                       name="box_height_cm"
                                       placeholder="Cao"
                                       class="flex-1 px-2 py-1 text-xs border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mua h√†ng TQ -->
                <div class="mb-3">
                    <h3 class="text-xs font-semibold text-slate-700 mb-1.5">Mua h√†ng Trung Qu·ªëc</h3>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-[10px] text-slate-600 mb-0.5">Gi√° (CNY)</label>
                            <input type="number" 
                                   step="0.01"
                                   id="modal-price-tq"
                                   name="price_tq"
                                   class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-600 mb-0.5">SKU TQ</label>
                            <input type="text" 
                                   id="modal-sku-tq"
                                   name="sku_tq"
                                   class="w-full px-2 py-1 text-xs border border-slate-300 rounded font-mono focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-600 mb-0.5">T√™n s·∫£n ph·∫©m TQ</label>
                            <input type="text" 
                                   id="modal-name-tq"
                                   name="name_tq"
                                   class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- SKU nh·∫≠p kh·∫©u -->
                <div class="mb-3">
                    <h3 class="text-xs font-semibold text-slate-700 mb-1.5">SKU nh·∫≠p kh·∫©u</h3>
                    <div class="relative">
                        <input type="text" 
                               id="modal-sku-xnk"
                               name="sku_model_xnk"
                               placeholder="T√¨m ki·∫øm SKU, t√™n EN ho·∫∑c VN..."
                               class="w-full px-2 py-1 text-xs border border-slate-300 rounded font-mono focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <!-- Search Results Dropdown -->
                        <div id="modal-xnk-search-results" class="absolute z-50 w-full mt-1 bg-white border border-slate-300 rounded shadow-lg max-h-48 overflow-y-auto hidden">
                            <!-- Results will be inserted here -->
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Footer -->
        <div class="flex-shrink-0 bg-slate-50 border-t border-slate-200 px-4 py-2.5 flex items-center justify-end gap-2">
            <button type="button" 
                    id="variant-edit-modal-cancel"
                    class="px-3 py-1.5 text-xs font-medium text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50 transition">
                ƒê√≥ng
            </button>
            <button type="button" 
                    id="variant-edit-modal-save"
                    class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 transition">
                L∆∞u
            </button>
        </div>
    </div>
</div>


<!-- JS: B·ªò L·ªåC PH√ÇN LO·∫†I -->
<script>
    // ==================== CONFIG ====================
    let totalVariantsCount = 0; // S·∫Ω ƒë∆∞·ª£c set khi load
    
    // Debug mode - log performance metrics (t·∫Øt m·∫∑c ƒë·ªãnh)
    const DEBUG_PERFORMANCE = false;
    
    function debugLog(message, data = null) {
        if (DEBUG_PERFORMANCE) {
            console.log(`[Performance] ${message}`, data || '');
        }
    }
    
    // ==================== STATE & CACHE ====================
    // State c·ªßa b·ªô l·ªçc (brand ƒë√£ ƒë∆∞·ª£c filter ·ªü server-side)
    let activeFilters = {
        status: null
    };
    
    // Cache DOM elements ƒë·ªÉ t·ªëi ∆∞u performance
    let allRowsCache = null;
    let searchInputCache = null;
    
    // Cache text content cho search (thay v√¨ d√πng innerHTML - ch·∫≠m h∆°n)
    let rowsTextCache = null;
    
    // Search debounce timer (c·∫ßn ·ªü global scope ƒë·ªÉ gi·ªØ l·∫°i gi·ªØa c√°c l·∫ßn g√µ)
    let searchDebounce = null;
    

    // Thu th·∫≠p s·ªë l∆∞·ª£ng t·ª´ T·∫§T C·∫¢ variants (t·ªëi ∆∞u: cache rows)
    function collectAllData() {
        const startTime = performance.now();
        
        if (!allRowsCache) {
            allRowsCache = Array.from(document.querySelectorAll('.js-variant-row'));
        }
        
        const brands = new Map(); // {brandName: count}
        const statuses = new Map(); // {statusName: count}
        let totalCount = 0;

        // Ki·ªÉm tra search query
        if (!searchInputCache) {
            searchInputCache = document.getElementById('variant-search-input');
        }
        const searchQuery = searchInputCache ? (searchInputCache.value || '').trim().toLowerCase() : '';

        // T·ªëi ∆∞u: Cache text content n·∫øu ch∆∞a c√≥ ho·∫∑c search query thay ƒë·ªïi
        if (!rowsTextCache || searchQuery) {
            rowsTextCache = new Map();
            allRowsCache.forEach((row, index) => {
                // D√πng textContent thay v√¨ innerHTML - nhanh h∆°n nhi·ªÅu
                rowsTextCache.set(index, (row.textContent || '').toLowerCase());
            });
        }

        allRowsCache.forEach((row, index) => {
            // Ki·ªÉm tra search query v·ªõi cached text content
            const rowText = rowsTextCache.get(index) || '';
            const matchesSearch = !searchQuery || rowText.includes(searchQuery);
            
            if (!matchesSearch) return; // B·ªè qua n·∫øu kh√¥ng match search

            // ƒê·∫øm t·ª´ t·∫•t c·∫£ variants (brand ƒë√£ ƒë∆∞·ª£c filter ·ªü server)
            const statusName = row.dataset.status || '';

            if (statusName) {
                statuses.set(statusName, (statuses.get(statusName) || 0) + 1);
            }
            totalCount++;
        });

        const endTime = performance.now();
        debugLog(`collectAllData: ${(endTime - startTime).toFixed(2)}ms`, { total: totalCount });

        return { brands, statuses, total: totalCount };
    }

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong c√°c filter buttons (debounced)
    let updateCountsTimeout = null;
    function updateFilterCounts() {
        // Debounce ƒë·ªÉ tr√°nh update qu√° nhi·ªÅu l·∫ßn
        if (updateCountsTimeout) {
            clearTimeout(updateCountsTimeout);
        }
        updateCountsTimeout = setTimeout(() => {
            const startTime = performance.now();
            const data = collectAllData();
            
            // Update "T·∫•t c·∫£" counts (brand ƒë√£ ƒë∆∞·ª£c filter ·ªü server)
            const statusAllCount = document.getElementById('filter-status-all-count');
            if (statusAllCount) statusAllCount.textContent = data.total;
            
            // Update status counts
            document.querySelectorAll('.filter-status-count').forEach(span => {
                const status = span.dataset.status;
                const count = data.statuses.get(status) || 0;
                span.textContent = count;
            });
            
            const endTime = performance.now();
            debugLog(`updateFilterCounts: ${(endTime - startTime).toFixed(2)}ms`);
        }, 100);
    }

    // Toggle filter (ch·ªâ status, brand ƒë√£ ƒë∆∞·ª£c filter ·ªü server)
    function toggleFilter(filterType, filterValue) {
        if (filterValue === 'all') {
            activeFilters[filterType] = null;
        } else {
            // N·∫øu click v√†o filter ƒëang active -> b·ªè filter
            if (activeFilters[filterType] === filterValue) {
                activeFilters[filterType] = null;
            } else {
                activeFilters[filterType] = filterValue;
            }
        }
        
        applyFilters();
        updateFilterButtons();
    }

    // Update filter button states (ch·ªâ status, brand ƒë√£ ƒë∆∞·ª£c filter ·ªü server)
    function updateFilterButtons() {
        const statusAllBtn = document.getElementById('filter-status-all');
        const statusButtons = document.querySelectorAll('.filter-status-btn');

        // Reset status buttons
        statusButtons.forEach(btn => {
            btn.classList.remove('active', 'bg-orange-500', 'text-white', 'border-orange-500');
            btn.classList.add('bg-slate-50', 'text-slate-700', 'border-slate-300');
        });

        // Activate status "T·∫•t c·∫£" if no status filter
        if (!activeFilters.status) {
            if (statusAllBtn) {
                statusAllBtn.classList.add('active', 'bg-orange-500', 'text-white', 'border-orange-500');
                statusAllBtn.classList.remove('bg-slate-50', 'text-slate-700', 'border-slate-300');
            }
        } else {
            // Activate specific status filter button
            statusButtons.forEach(btn => {
                const filterValue = btn.dataset.filterValue;
                if (filterValue === activeFilters.status) {
                    btn.classList.add('active', 'bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.remove('bg-slate-50', 'text-slate-700', 'border-slate-300');
                }
            });
        }
    }

    // Apply filters to rows (t·ªëi ∆∞u - ƒë∆°n gi·∫£n v√† nhanh)
    // Brand filter ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü server-side, ch·ªâ filter status v√† search ·ªü client
    let filterTimeout = null;
    function applyFilters(immediate = false) {
        // Clear timeout n·∫øu c√≥
        if (filterTimeout) {
            clearTimeout(filterTimeout);
            filterTimeout = null;
        }
        
        // N·∫øu immediate = true, ch·∫°y ngay kh√¥ng debounce (cho Enter key)
        if (immediate) {
            executeFilter();
            return;
        }
        
        // Debounce filter
        filterTimeout = setTimeout(() => {
            executeFilter();
        }, 50);
    }
    
    function executeFilter() {
            const startTime = performance.now();
            
            if (!allRowsCache) {
                const cacheStart = performance.now();
                allRowsCache = Array.from(document.querySelectorAll('.js-variant-row'));
                debugLog(`DOM Query: ${(performance.now() - cacheStart).toFixed(2)}ms`, { count: allRowsCache.length });
            }
            
            if (!searchInputCache) {
                searchInputCache = document.getElementById('variant-search-input');
            }
            const searchQuery = searchInputCache ? (searchInputCache.value || '').trim().toLowerCase() : '';

            // T·ªëi ∆∞u: Cache text content n·∫øu ch∆∞a c√≥
            if (!rowsTextCache) {
                const cacheStart = performance.now();
                rowsTextCache = new Map();
                allRowsCache.forEach((row, index) => {
                    // D√πng textContent thay v√¨ innerHTML - nhanh h∆°n nhi·ªÅu
                    rowsTextCache.set(index, (row.textContent || '').toLowerCase());
                });
                debugLog(`Text Cache: ${(performance.now() - cacheStart).toFixed(2)}ms`);
            }

            let visibleCount = 0;
            const changes = []; // Batch DOM changes
            
            // L·ªçc nhanh: ch·ªâ duy·ªát 1 l·∫ßn, ki·ªÉm tra t·∫•t c·∫£ ƒëi·ªÅu ki·ªán
            allRowsCache.forEach((row, index) => {
                const statusName = row.dataset.status || '';
                // T·ªëi ∆∞u: D√πng cached text content thay v√¨ innerHTML
                const rowText = rowsTextCache.get(index) || '';

                // Check filter conditions - brand ƒë√£ ƒë∆∞·ª£c filter ·ªü server
                const matchesStatus = !activeFilters.status || statusName === activeFilters.status;
                const matchesSearch = !searchQuery || rowText.includes(searchQuery);

                // Batch DOM changes
                if (matchesStatus && matchesSearch) {
                    if (row.classList.contains('hidden')) {
                        changes.push({ row, action: 'show' });
                    }
                    visibleCount++;
                } else {
                    if (!row.classList.contains('hidden')) {
                        changes.push({ row, action: 'hide' });
                    }
                }
            });
            
            // Apply DOM changes (t·ªëi ∆∞u: d√πng requestAnimationFrame)
            const domStart = performance.now();
            if (changes.length > 50) {
                // Batch v·ªõi requestAnimationFrame cho nhi·ªÅu changes
                requestAnimationFrame(() => {
                    changes.forEach(({ row, action }) => {
                        if (action === 'show') {
                            row.classList.remove('hidden');
                        } else {
                            row.classList.add('hidden');
                        }
                    });
                });
            } else {
                // Apply ngay l·∫≠p t·ª©c cho √≠t changes
                changes.forEach(({ row, action }) => {
                    if (action === 'show') {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
            }
            debugLog(`DOM Updates: ${(performance.now() - domStart).toFixed(2)}ms`, { changes: changes.length });
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            debugLog(`applyFilters: ${duration.toFixed(2)}ms`, { 
                total: allRowsCache.length, 
                visible: visibleCount,
                changes: changes.length 
            });
            
            // Update filter button counts sau khi filter (debounced)
            updateFilterCounts();
    }

    // Import Excel handler
    function handleImportExcel(file) {
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        // Show loading
        const importBtn = document.querySelector('label[for="import-excel-input"]');
        const originalText = importBtn.innerHTML;
        importBtn.innerHTML = '<span>‚è≥</span><span>ƒêang x·ª≠ l√Ω...</span>';
        importBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        
        // Upload file
        fetch('{% url "products:import_variants_excel" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const result = data.result;
                const message = `Import th√†nh c√¥ng!\n` +
                    `- T·ªïng d√≤ng: ${result.total_rows}\n` +
                    `- ƒê√£ x·ª≠ l√Ω: ${result.processed}\n` +
                    `- Th√†nh c√¥ng: ${result.success}\n` +
                    `- B·ªè qua: ${result.skipped}\n` +
                    `- L·ªói: ${result.errors}`;
                
                if (result.errors > 0 && result.error_details.length > 0) {
                    const errorMsg = result.error_details.slice(0, 5).join('\n');
                    alert(message + '\n\nChi ti·∫øt l·ªói:\n' + errorMsg);
                } else {
                    alert(message);
                }
                
                // Reload page sau 1s ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu
                if (result.success > 0) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            } else {
                alert('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ import file'));
            }
        })
        .catch(error => {
            alert('L·ªói: ' + error.message);
        })
        .finally(() => {
            // Restore button
            importBtn.innerHTML = originalText;
            importBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            // Reset file input
            document.getElementById('import-excel-input').value = '';
        });
    }
    
    // Initialize filters
    document.addEventListener('DOMContentLoaded', function() {
        const initStart = performance.now();
        
        // Cache rows ngay t·ª´ ƒë·∫ßu ƒë·ªÉ t·ªëi ∆∞u
        const cacheStart = performance.now();
        allRowsCache = Array.from(document.querySelectorAll('.js-variant-row'));
        totalVariantsCount = allRowsCache.length;
        debugLog(`DOM Query (init): ${(performance.now() - cacheStart).toFixed(2)}ms`, { 
            count: totalVariantsCount
        });
        
        searchInputCache = document.getElementById('variant-search-input');
        
        // Update counts l·∫ßn ƒë·∫ßu
        updateFilterCounts();
        updateFilterButtons();
        
        debugLog(`Total init time: ${(performance.now() - initStart).toFixed(2)}ms`);
        
        // Brand filter buttons - reload page khi ch·ªçn brand kh√°c
        document.querySelectorAll('.brand-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const selectedBrandId = this.dataset.brandId;
                const url = new URL(window.location.href);
                url.searchParams.set('brand_id', selectedBrandId);
                window.location.href = url.toString();
            });
        });
        
        // Status filter buttons
        document.querySelectorAll('.filter-status-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterValue = btn.dataset.filterValue;
                toggleFilter('status', filterValue);
            });
        });
        
        // Search input - filter real-time ho·∫∑c khi Enter (t√πy s·ªë l∆∞·ª£ng variants)
        if (searchInputCache) {
            // Remove any existing listeners first (n·∫øu c√≥)
            const newInput = searchInputCache.cloneNode(true);
            searchInputCache.parentNode.replaceChild(newInput, searchInputCache);
            searchInputCache = newInput;
            
            // Real-time search
            searchInputCache.addEventListener('input', () => {
                applyFilters();
            });
            debugLog('Search mode: Real-time');
        }
        
        // Reset button
        const resetBtn = document.getElementById('reset-filters-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                activeFilters.status = null;
                if (searchInputCache) searchInputCache.value = '';
                applyFilters();
                updateFilterButtons();
            });
        }
        
        // Import Excel input
        const importInput = document.getElementById('import-excel-input');
        if (importInput) {
            importInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleImportExcel(file);
                }
            });
        }
        
        // Export Excel - th√™m brand_id v√†o URL
        const exportBtn = document.getElementById('export-excel-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent default navigation
                
                // L·∫•y brand_id t·ª´ URL hi·ªán t·∫°i (query param)
                const urlParams = new URLSearchParams(window.location.search);
                const brandId = urlParams.get('brand_id') || '';
                
                // Build URL v·ªõi brand_id
                let exportUrl = exportBtn.getAttribute('href');
                const params = new URLSearchParams();
                
                if (brandId) {
                    params.append('brand_id', brandId);
                }
                
                if (params.toString()) {
                    exportUrl += '?' + params.toString();
                }
                
                // Navigate ƒë·∫øn URL m·ªõi
                window.location.href = exportUrl;
            });
        }
        
        // ==================== VARIANT EDIT MODAL ====================
        const variantEditModal = document.getElementById('variant-edit-modal');
        const variantEditModalClose = document.getElementById('variant-edit-modal-close');
        const variantEditModalCancel = document.getElementById('variant-edit-modal-cancel');
        const variantEditModalSave = document.getElementById('variant-edit-modal-save');
        let currentEditingVariantId = null;
        
        // Helper function ƒë·ªÉ get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // M·ªü modal v√† load data variant
        function openVariantEditModal(btn) {
            const variantId = parseInt(btn.dataset.variantId);
            currentEditingVariantId = variantId;
            
            // Load data t·ª´ data attributes
            document.getElementById('modal-variant-id').textContent = variantId;
            document.getElementById('modal-variant-id-input').value = variantId;
            document.getElementById('modal-variant-sku').textContent = btn.dataset.variantSku || '-';
            
            // Box info
            document.getElementById('modal-box-full-box').value = btn.dataset.variantBoxFullBox || '';
            document.getElementById('modal-box-length').value = btn.dataset.variantBoxLength || '';
            document.getElementById('modal-box-width').value = btn.dataset.variantBoxWidth || '';
            document.getElementById('modal-box-height').value = btn.dataset.variantBoxHeight || '';
            
            // TQ info
            document.getElementById('modal-price-tq').value = btn.dataset.variantPriceTq || '';
            document.getElementById('modal-sku-tq').value = btn.dataset.variantSkuTq || '';
            document.getElementById('modal-name-tq').value = btn.dataset.variantNameTq || '';
            
            // XNK
            document.getElementById('modal-sku-xnk').value = btn.dataset.variantSkuXnk || '';
            
            // Show modal
            variantEditModal.classList.remove('hidden');
        }
        
        // ƒê√≥ng modal
        function closeVariantEditModal() {
            variantEditModal.classList.add('hidden');
            currentEditingVariantId = null;
            // Clear search results
            document.getElementById('modal-xnk-search-results').classList.add('hidden');
        }
        
        // Edit button click - m·ªü modal
        document.querySelectorAll('.variant-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                openVariantEditModal(this);
            });
        });
        
        // Close modal handlers
        if (variantEditModalClose) {
            variantEditModalClose.addEventListener('click', closeVariantEditModal);
        }
        if (variantEditModalCancel) {
            variantEditModalCancel.addEventListener('click', closeVariantEditModal);
        }
        
        // Close modal khi click outside
        variantEditModal.addEventListener('click', function(e) {
            if (e.target === variantEditModal) {
                closeVariantEditModal();
            }
        });
        
        // Save variant metadata
        if (variantEditModalSave) {
            variantEditModalSave.addEventListener('click', function() {
                if (!currentEditingVariantId) return;
                
                // Collect data from modal inputs
                const data = {};
                
                // Box info
                const fullBox = document.getElementById('modal-box-full-box').value.trim();
                const boxLength = document.getElementById('modal-box-length').value.trim();
                const boxWidth = document.getElementById('modal-box-width').value.trim();
                const boxHeight = document.getElementById('modal-box-height').value.trim();
                
                if (fullBox !== '') data.full_box = parseInt(fullBox);
                if (boxLength !== '') data.box_length_cm = parseFloat(boxLength);
                if (boxWidth !== '') data.box_width_cm = parseFloat(boxWidth);
                if (boxHeight !== '') data.box_height_cm = parseFloat(boxHeight);
                
                // TQ info
                const priceTq = document.getElementById('modal-price-tq').value.trim();
                const skuTq = document.getElementById('modal-sku-tq').value.trim();
                const nameTq = document.getElementById('modal-name-tq').value.trim();
                
                if (priceTq !== '') data.price_tq = parseFloat(priceTq);
                if (skuTq !== '') data.sku_tq = skuTq;
                if (nameTq !== '') data.name_tq = nameTq;
                
                // XNK
                const skuXnk = document.getElementById('modal-sku-xnk').value.trim();
                if (skuXnk !== '') data.sku_model_xnk = skuXnk;
                
                const csrftoken = getCookie('csrftoken');
                
                // Show loading state
                const originalText = variantEditModalSave.innerHTML;
                variantEditModalSave.innerHTML = '‚è≥ ƒêang l∆∞u...';
                variantEditModalSave.disabled = true;
                
                // Send request
                fetch(`{% url 'products:update_variant_metadata' 0 %}`.replace('0', currentEditingVariantId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        // Update row display (reload page ƒë·ªÉ ƒë·∫£m b·∫£o data m·ªõi nh·∫•t)
                        window.location.reload();
                    } else {
                        // Show error message
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50 text-sm';
                        errorMsg.textContent = '‚úó L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu');
                        document.body.appendChild(errorMsg);
                        setTimeout(() => {
                            if (errorMsg.parentNode) {
                                errorMsg.remove();
                            }
                        }, 3000);
                        
                        // Restore button state
                        variantEditModalSave.innerHTML = originalText;
                        variantEditModalSave.disabled = false;
                    }
                })
                .catch(error => {
                    // Show error message
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50 text-sm';
                    errorMsg.textContent = '‚úó L·ªói: ' + error.message;
                    document.body.appendChild(errorMsg);
                    setTimeout(() => {
                        if (errorMsg.parentNode) {
                            errorMsg.remove();
                        }
                    }, 3000);
                    
                    // Restore button state
                    variantEditModalSave.innerHTML = originalText;
                    variantEditModalSave.disabled = false;
                });
            });
        }
        
        // XNK Model Search Handler trong modal
        const modalXnkInput = document.getElementById('modal-sku-xnk');
        const modalXnkResults = document.getElementById('modal-xnk-search-results');
        let modalSearchTimeout = null;
        
        if (modalXnkInput && modalXnkResults) {
            modalXnkInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                // Clear previous timeout
                if (modalSearchTimeout) {
                    clearTimeout(modalSearchTimeout);
                }
                
                // Hide results if query is empty
                if (!query) {
                    modalXnkResults.classList.add('hidden');
                    return;
                }
                
                // Debounce search
                modalSearchTimeout = setTimeout(() => {
                    searchXNKModels(query, modalXnkResults, modalXnkInput);
                }, 300);
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!modalXnkInput.contains(e.target) && !modalXnkResults.contains(e.target)) {
                    modalXnkResults.classList.add('hidden');
                }
            });
        }
        
        function searchXNKModels(query, resultsDiv, inputElement) {
            if (!resultsDiv || !inputElement) return;
            
            // Show loading
            resultsDiv.innerHTML = '<div class="px-2 py-1 text-[10px] text-slate-500">ƒêang t√¨m ki·∫øm...</div>';
            resultsDiv.classList.remove('hidden');
            
            // Scroll modal content to show search results
            const modalContent = variantEditModal.querySelector('.flex-1.overflow-y-auto');
            if (modalContent) {
                // Scroll to bottom of modal content to show dropdown
                setTimeout(() => {
                    modalContent.scrollTop = modalContent.scrollHeight;
                }, 50);
            }
            
            // Call API
            fetch(`{% url 'products:api_xnk_search' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.results && data.results.length > 0) {
                        // Display results
                        let html = '';
                        data.results.slice(0, 10).forEach(model => {
                            const sku = model.sku || '-';
                            const enName = model.en_name || model.name_en || model.name_english || '';
                            const vnName = model.vn_name || model.name_vn || '';
                            
                            html += `
                                <div class="xnk-search-result-item px-2 py-1.5 hover:bg-blue-50 cursor-pointer border-b border-slate-100 last:border-b-0" 
                                     data-sku="${sku}">
                                    <div class="font-mono text-[10px] font-semibold text-slate-800">${sku}</div>
                                    ${enName ? `<div class="text-[9px] text-slate-600 mt-0.5">EN: ${enName}</div>` : ''}
                                    ${vnName ? `<div class="text-[9px] text-slate-500 mt-0.5">VN: ${vnName.substring(0, 50)}${vnName.length > 50 ? '...' : ''}</div>` : ''}
                                </div>
                            `;
                        });
                        
                        if (data.results.length > 10) {
                            html += `<div class="px-2 py-1 text-[9px] text-slate-400 text-center">... v√† ${data.results.length - 10} k·∫øt qu·∫£ kh√°c</div>`;
                        }
                        
                        resultsDiv.innerHTML = html;
                        
                        // Scroll again after results are rendered
                        if (modalContent) {
                            setTimeout(() => {
                                modalContent.scrollTop = modalContent.scrollHeight;
                            }, 100);
                        }
                        
                        // Add click handlers
                        resultsDiv.querySelectorAll('.xnk-search-result-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const selectedSku = this.dataset.sku;
                                inputElement.value = selectedSku;
                                resultsDiv.classList.add('hidden');
                                
                                // Trigger input event to update the value
                                inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                            });
                        });
                    } else {
                        resultsDiv.innerHTML = '<div class="px-2 py-1 text-[10px] text-slate-400">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
                        
                        // Scroll to show "no results" message
                        if (modalContent) {
                            setTimeout(() => {
                                modalContent.scrollTop = modalContent.scrollHeight;
                            }, 100);
                        }
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    resultsDiv.innerHTML = '<div class="px-2 py-1 text-[10px] text-red-500">L·ªói khi t√¨m ki·∫øm</div>';
                    
                    // Scroll to show error message
                    if (modalContent) {
                        setTimeout(() => {
                            modalContent.scrollTop = modalContent.scrollHeight;
                        }, 100);
                    }
                });
        }
    });
</script>
{% endblock %}
