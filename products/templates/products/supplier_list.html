{% extends "products/base_products.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }} - Gia D·ª•ng Plus{% endblock %}

{% block overview %}
<section>
    <h1 class="text-lg font-semibold text-slate-800">{{ title }}</h1>
    <p class="text-xs text-gray-500 mt-1">Qu·∫£n l√Ω v√† xem th√¥ng tin t·∫•t c·∫£ nh√† cung c·∫•p</p>
</section>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-100">
    <div class="max-w-7xl mx-auto">

        <!-- B·ªò L·ªåC V√Ä T√åM KI·∫æM -->
        <div class="mb-4 bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold text-slate-700">T√¨m ki·∫øm & L·ªçc</h2>
            </div>
            
            <!-- B·ªô l·ªçc Nh√≥m -->
            <div class="mb-3">
                <div class="flex items-center gap-1.5 flex-wrap">
                    <span class="text-[11px] text-slate-600 font-medium mr-1">Nh√≥m:</span>
                    <button id="filter-group-all" 
                            class="filter-btn filter-group-btn active px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-[11px] text-slate-700 font-medium hover:bg-slate-100 transition"
                            data-filter-type="group"
                            data-filter-value="all">
                        T·∫•t c·∫£ (<span id="filter-group-all-count">0</span>)
                    </button>
                    <div id="filter-group-container" class="flex flex-wrap gap-1.5">
                        {% for group_name in group_names %}
                        <button class="filter-btn filter-group-btn px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-[11px] text-slate-700 font-medium hover:bg-slate-100 transition"
                                data-filter-type="group"
                                data-filter-value="{{ group_name }}">
                            {{ group_name }} (<span class="filter-group-count" data-group="{{ group_name }}">0</span>)
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            {% csrf_token %}
            <!-- T√¨m ki·∫øm -->
            <div class="flex items-center gap-4 flex-wrap">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" 
                           id="supplier-search-input"
                           name="search" 
                           value=""
                           placeholder="T√¨m ki·∫øm nh√† cung c·∫•p..." 
                           class="w-full px-3 py-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent">
                </div>

                <!-- Reset -->
                <button type="button" 
                        id="reset-filters-btn"
                        class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 transition text-sm font-medium">
                    ƒê·∫∑t l·∫°i
                </button>
            </div>
        </div>

        <!-- TH√îNG B√ÅO L·ªñI -->
        {% if error %}
        <div class="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
            <p class="text-sm font-medium">L·ªói: {{ error }}</p>
        </div>
        {% endif %}

        <!-- DANH S√ÅCH NH√Ä CUNG C·∫§P -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4 items-stretch">
                {% if suppliers %}
                    {% for supplier in suppliers %}
                    <div class="js-supplier-card border border-slate-100 rounded-lg p-4 hover:shadow-md transition relative overflow-hidden flex flex-col h-full"
                         data-group="{{ supplier.group_name|default:'' }}"
                         data-name="{{ supplier.name|upper }}"
                         data-code="{{ supplier.code|upper }}">
                        <!-- Tag ƒê·ªôc quy·ªÅn/Ph√¢n ph·ªëi - G√≥c tr√™n b√™n ph·∫£i, ch√©o -->
                        {% if supplier.group_name %}
                        <div class="absolute top-0 right-0 w-40 h-40 pointer-events-none overflow-hidden z-10">
                            <div class="absolute top-6 -right-10 transform rotate-45 origin-center
                                {% if supplier.group_name == 'ƒê·ªòC QUY·ªÄN' %}
                                    bg-red-600 border-2 border-red-700
                                {% else %}
                                    bg-blue-400 border-2 border-blue-500
                                {% endif %}
                                px-10 py-1.5 shadow-lg">
                                <span class="text-white font-bold text-xs whitespace-nowrap block">
                                    {{ supplier.group_name }}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Header: Logo v√† T√™n -->
                        <div class="flex items-start gap-3 mb-3">
                            <!-- Logo -->
                            <div class="relative flex-shrink-0">
                                {% if supplier.logo_path %}
                                    <img id="logo-{{ supplier.id }}" 
                                         src="{{ supplier.logo_path }}" 
                                         alt="{{ supplier.name }}"
                                         class="w-16 h-16 object-contain rounded-md border border-slate-200 bg-white">
                                {% else %}
                                    <div id="logo-placeholder-{{ supplier.id }}" class="w-16 h-16 rounded-md border border-slate-200 bg-slate-100 flex items-center justify-center">
                                        <span class="text-xs text-slate-400">{{ supplier.code|slice:":2" }}</span>
                                    </div>
                                {% endif %}
                                <!-- Button th√™m/ƒë·ªïi logo -->
                                <label class="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-blue-600 transition cursor-pointer"
                                       title="Th√™m/ƒê·ªïi logo">
                                    <input type="file" 
                                           class="hidden" 
                                           accept="image/jpeg,image/jpg,image/png"
                                           data-supplier-id="{{ supplier.id }}"
                                           onchange="uploadSupplierLogo(this, {{ supplier.id }})">
                                    +
                                </label>
                            </div>
                            
                            <!-- T√™n (link ƒë·∫øn Sapo, kh√¥ng underline) -->
                            <div class="flex-1 min-w-0">
                                <a href="https://sisapsan.mysapogo.com/admin/suppliers/{{ supplier.id }}" 
                                   target="_blank"
                                   class="font-semibold text-sm text-slate-900 truncate block hover:text-blue-600 transition no-underline"
                                   title="{{ supplier.name }}">
                                    {{ supplier.name }}
                                </a>
                            </div>
                        </div>
                        
                        <!-- Th√¥ng tin chi ti·∫øt -->
                        <div class="space-y-2 text-xs flex-grow">
                            <!-- V√πng (T·ªânh) -->
                            {% if supplier.province %}
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">üìç</span>
                                <span class="text-slate-700">{{ supplier.province }}</span>
                            </div>
                            {% endif %}
                            
                            <!-- T√™n c√¥ng ty -->
                            {% if supplier.company_name %}
                            <div class="flex items-center gap-2">
                                <span class="text-slate-500">üè¢</span>
                                <span class="text-slate-700 truncate" title="{{ supplier.company_name }}">{{ supplier.company_name }}</span>
                            </div>
                            {% endif %}
                            
                            <!-- Tags -->
                            {% if supplier.tags %}
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-slate-500">#</span>
                                {% for tag in supplier.tags %}
                                <span class="px-1.5 py-0.5 rounded text-[10px] bg-slate-100 text-slate-700">{{ tag }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <!-- Websites -->
                            <div class="flex items-center gap-2 flex-wrap" id="websites-container-{{ supplier.id }}">
                                <span class="text-slate-500">üåê</span>
                                {% if supplier.websites %}
                                    {% for site_type, site_url in supplier.websites.items %}
                                        {% if site_type == '1688' or '1688' in site_url %}
                                            <a href="{{ site_url }}" target="_blank" class="inline-flex items-center gap-1">
                                                <img src="/static/1688-logo.png" alt="1688" class="w-4 h-4" onerror="this.style.display='none'">
                                            </a>
                                        {% elif site_type == 'tmall' or 'tmall' in site_url %}
                                            <a href="{{ site_url }}" target="_blank" class="inline-flex items-center gap-1">
                                                <img src="/static/tmall-logo.png" alt="Tmall" class="w-4 h-4" onerror="this.style.display='none'">
                                            </a>
                                        {% elif site_type == 'taobao' or 'taobao' in site_url %}
                                            <a href="{{ site_url }}" target="_blank" class="inline-flex items-center gap-1">
                                                <img src="/static/taobao-logo.png" alt="Taobao" class="w-4 h-4" onerror="this.style.display='none'">
                                            </a>
                                        {% elif site_type == 'douyin' or 'douyin' in site_url %}
                                            <a href="{{ site_url }}" target="_blank" class="inline-flex items-center gap-1">
                                                <img src="/static/douyin-logo.png" alt="Douyin" class="w-4 h-4" onerror="this.style.display='none'">
                                            </a>
                                        {% else %}
                                            <a href="{{ site_url }}" target="_blank" class="text-blue-600 hover:underline text-[10px]" title="{{ site_url }}">
                                                {{ site_type|default:"Link" }}
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                <!-- Button th√™m website -->
                                <button class="w-4 h-4 bg-green-500 text-white rounded-full flex items-center justify-center text-[10px] hover:bg-green-600 transition cursor-pointer"
                                        onclick="showAddWebsitePanel({{ supplier.id }})"
                                        title="Th√™m website">
                                    +
                                </button>
                            </div>
                            
                            <!-- Panel th√™m website (·∫©n m·∫∑c ƒë·ªãnh) -->
                            <div id="add-website-panel-{{ supplier.id }}" class="hidden mt-2 p-2 bg-slate-50 rounded-md border border-slate-200">
                                <div class="flex items-center gap-2">
                                    <select id="website-type-{{ supplier.id }}" class="flex-1 px-2 py-1 text-[10px] border border-slate-300 rounded">
                                        <option value="1688">1688</option>
                                        <option value="tmall">Tmall</option>
                                        <option value="taobao">Taobao</option>
                                        <option value="douyin">Douyin</option>
                                        <option value="other">Kh√°c</option>
                                    </select>
                                    <input type="text" 
                                           id="website-url-{{ supplier.id }}" 
                                           placeholder="URL..."
                                           class="flex-2 px-2 py-1 text-[10px] border border-slate-300 rounded">
                                    <button onclick="addSupplierWebsite({{ supplier.id }})"
                                            class="px-2 py-1 bg-blue-500 text-white text-[10px] rounded hover:bg-blue-600 transition">
                                        Th√™m
                                    </button>
                                    <button onclick="hideAddWebsitePanel({{ supplier.id }})"
                                            class="px-2 py-1 bg-slate-400 text-white text-[10px] rounded hover:bg-slate-500 transition">
                                        H·ªßy
                                    </button>
                                </div>
                            </div>
                            
                            <!-- M√¥ t·∫£ -->
                            {% if supplier.description %}
                            <div class="pt-1 border-t border-slate-100">
                                <p class="text-slate-600 text-[11px] line-clamp-2" title="{{ supplier.description }}">
                                    {{ supplier.description }}
                                </p>
                            </div>
                            {% endif %}
                            
                            <!-- S·ªë s·∫£n ph·∫©m -->
                            <div class="pt-2 border-t border-slate-200 flex items-center justify-between">
                                <span class="text-slate-500">S·∫£n ph·∫©m:</span>
                                <span class="font-semibold text-slate-900">{{ supplier.product_count|intcomma }}</span>
                            </div>
                        </div>
                        
                        <!-- G·ª£i √Ω nh·∫≠p h√†ng - ƒê·∫∑t ·ªü ƒë√°y -->
                        {% if supplier.purchase_suggestion %}
                        <div class="pt-2 border-t border-slate-200 bg-gradient-to-r from-indigo-50 to-blue-50 rounded-md p-2 mt-auto">
                            <div class="text-[10px] text-indigo-600 font-semibold mb-1 uppercase">G·ª£i √Ω nh·∫≠p (60N)</div>
                            <div class="text-sm font-bold text-indigo-700">
                                {{ supplier.purchase_suggestion.total_pcs|intcomma }} pcs ({{ supplier.purchase_suggestion.total_cbm|floatformat:1 }} m¬≥)
                            </div>
                        </div>
                        {% else %}
                        <!-- Placeholder ƒë·ªÉ gi·ªØ chi·ªÅu cao ƒë·ªìng ƒë·ªÅu -->
                        <div class="pt-2 border-t border-slate-200 mt-auto">
                            <div class="text-[10px] text-slate-400 font-semibold mb-1 uppercase">G·ª£i √Ω nh·∫≠p (60N)</div>
                            <div class="text-sm font-bold text-slate-300">
                                - pcs (- m¬≥)
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-span-full px-4 py-8 text-center text-sm text-slate-500">
                        Ch∆∞a c√≥ nh√† cung c·∫•p n√†o
                    </div>
                {% endif %}
            </div>

            <!-- SUMMARY -->
            {% if suppliers %}
            <div class="px-4 py-3 bg-slate-50 border-t border-slate-200">
                <div class="text-sm text-slate-600">
                    <strong>T·ªïng s·ªë nh√† cung c·∫•p:</strong> {{ total|default:suppliers|length }} nh√† cung c·∫•p
                </div>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- JS: B·ªò L·ªåC NH√Ä CUNG C·∫§P -->
<script>
    // State c·ªßa b·ªô l·ªçc
    let activeFilters = {
        group: null
    };
    
    // Cache DOM elements
    let allCardsCache = null;
    let searchInputCache = null;

    // Thu th·∫≠p s·ªë l∆∞·ª£ng t·ª´ T·∫§T C·∫¢ nh√† cung c·∫•p
    function collectAllData() {
        if (!allCardsCache) {
            allCardsCache = Array.from(document.querySelectorAll('.js-supplier-card'));
        }
        
        const groups = new Map(); // {groupName: count}
        let totalCount = 0;

        // Ki·ªÉm tra search query
        if (!searchInputCache) {
            searchInputCache = document.getElementById('supplier-search-input');
        }
        const searchQuery = searchInputCache ? (searchInputCache.value || '').trim().toLowerCase() : '';

        allCardsCache.forEach(card => {
            // Ki·ªÉm tra search query v·ªõi innerHTML
            const cardHTML = (card.innerHTML || '').toLowerCase();
            const cardName = (card.dataset.name || '').toLowerCase();
            const cardCode = (card.dataset.code || '').toLowerCase();
            const matchesSearch = !searchQuery || 
                                  cardHTML.includes(searchQuery) || 
                                  cardName.includes(searchQuery) || 
                                  cardCode.includes(searchQuery);
            
            if (!matchesSearch) return; // B·ªè qua n·∫øu kh√¥ng match search

            // ƒê·∫øm t·ª´ t·∫•t c·∫£ nh√† cung c·∫•p
            const groupName = card.dataset.group || '';

            if (groupName) {
                groups.set(groupName, (groups.get(groupName) || 0) + 1);
            }
            totalCount++;
        });

        return { groups, total: totalCount };
    }

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong c√°c filter buttons (debounced)
    let updateCountsTimeout = null;
    function updateFilterCounts() {
        // Debounce ƒë·ªÉ tr√°nh update qu√° nhi·ªÅu l·∫ßn
        if (updateCountsTimeout) {
            clearTimeout(updateCountsTimeout);
        }
        updateCountsTimeout = setTimeout(() => {
            const data = collectAllData();
            
            // Update "T·∫•t c·∫£" counts
            const groupAllCount = document.getElementById('filter-group-all-count');
            if (groupAllCount) groupAllCount.textContent = data.total;
            
            // Update group counts
            document.querySelectorAll('.filter-group-count').forEach(span => {
                const group = span.dataset.group;
                const count = data.groups.get(group) || 0;
                span.textContent = count;
            });
        }, 100);
    }

    // Toggle filter
    function toggleFilter(filterType, filterValue) {
        if (filterValue === 'all') {
            activeFilters[filterType] = null;
        } else {
            // N·∫øu click v√†o filter ƒëang active -> b·ªè filter
            if (activeFilters[filterType] === filterValue) {
                activeFilters[filterType] = null;
            } else {
                activeFilters[filterType] = filterValue;
            }
        }
        
        applyFilters();
        updateFilterButtons();
    }

    // Update filter button states
    function updateFilterButtons() {
        const groupAllBtn = document.getElementById('filter-group-all');
        const groupButtons = document.querySelectorAll('.filter-group-btn');

        // Reset group buttons
        groupButtons.forEach(btn => {
            btn.classList.remove('active', 'bg-orange-500', 'text-white', 'border-orange-500');
            btn.classList.add('bg-slate-50', 'text-slate-700', 'border-slate-300');
        });

        // Activate group "T·∫•t c·∫£" if no group filter
        if (!activeFilters.group) {
            if (groupAllBtn) {
                groupAllBtn.classList.add('active', 'bg-orange-500', 'text-white', 'border-orange-500');
                groupAllBtn.classList.remove('bg-slate-50', 'text-slate-700', 'border-slate-300');
            }
        } else {
            // Activate specific group filter button
            groupButtons.forEach(btn => {
                const filterValue = btn.dataset.filterValue;
                if (filterValue === activeFilters.group) {
                    btn.classList.add('active', 'bg-orange-500', 'text-white', 'border-orange-500');
                    btn.classList.remove('bg-slate-50', 'text-slate-700', 'border-slate-300');
                }
            });
        }
    }

    // Apply filters to cards (t·ªëi ∆∞u - ƒë∆°n gi·∫£n v√† nhanh)
    let filterTimeout = null;
    function applyFilters() {
        // Clear timeout n·∫øu c√≥
        if (filterTimeout) {
            clearTimeout(filterTimeout);
        }
        
        // Debounce ng·∫Øn ƒë·ªÉ tr√°nh lag khi g√µ nhi·ªÅu
        filterTimeout = setTimeout(() => {
            if (!allCardsCache) {
                allCardsCache = Array.from(document.querySelectorAll('.js-supplier-card'));
            }
            
            if (!searchInputCache) {
                searchInputCache = document.getElementById('supplier-search-input');
            }
            const searchQuery = searchInputCache ? (searchInputCache.value || '').trim().toLowerCase() : '';

            let visibleCount = 0;
            
            // L·ªçc nhanh: ch·ªâ duy·ªát 1 l·∫ßn, ki·ªÉm tra t·∫•t c·∫£ ƒëi·ªÅu ki·ªán
            allCardsCache.forEach(card => {
                const groupName = card.dataset.group || '';
                const cardHTML = (card.innerHTML || '').toLowerCase();
                const cardName = (card.dataset.name || '').toLowerCase();
                const cardCode = (card.dataset.code || '').toLowerCase();

                // Check filter conditions - ƒë∆°n gi·∫£n v√† nhanh
                const matchesGroup = !activeFilters.group || groupName === activeFilters.group;
                const matchesSearch = !searchQuery || 
                                     cardHTML.includes(searchQuery) || 
                                     cardName.includes(searchQuery) || 
                                     cardCode.includes(searchQuery);

                // Show/hide card - ƒë∆°n gi·∫£n, browser t·ª± t·ªëi ∆∞u
                if (matchesGroup && matchesSearch) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });
            
            // Update filter button counts sau khi filter (debounced)
            updateFilterCounts();
        }, 50); // Debounce ng·∫Øn 50ms ƒë·ªÉ responsive h∆°n
    }

    // Initialize filters
    document.addEventListener('DOMContentLoaded', function() {
        // Cache cards ngay t·ª´ ƒë·∫ßu
        allCardsCache = Array.from(document.querySelectorAll('.js-supplier-card'));
        searchInputCache = document.getElementById('supplier-search-input');
        
        // Update counts l·∫ßn ƒë·∫ßu
        updateFilterCounts();
        updateFilterButtons();
        
        // Group filter buttons
        document.querySelectorAll('.filter-group-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterValue = btn.dataset.filterValue;
                toggleFilter('group', filterValue);
            });
        });
        
        // Search input - filter real-time
        if (searchInputCache) {
            searchInputCache.addEventListener('input', () => {
                // Filter ngay l·∫≠p t·ª©c, kh√¥ng c·∫ßn enter
                applyFilters();
            });
        }
        
        // Reset button
        const resetBtn = document.getElementById('reset-filters-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                activeFilters.group = null;
                if (searchInputCache) searchInputCache.value = '';
                applyFilters();
                updateFilterButtons();
            });
        }
    });
</script>

<!-- JS: UPLOAD SUPPLIER LOGO -->
<script>
    function uploadSupplierLogo(input, supplierId) {
        const file = input.files[0];
        if (!file) {
            return;
        }
        
        // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!allowedTypes.includes(file.type)) {
            alert('Ch·ªâ ch·∫•p nh·∫≠n file JPG ho·∫∑c PNG');
            input.value = ''; // Reset input
            return;
        }
        
        // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (t·ªëi ƒëa 5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            alert('File qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 5MB');
            input.value = ''; // Reset input
            return;
        }
        
        // Hi·ªÉn th·ªã loading
        const logoImg = document.getElementById(`logo-${supplierId}`);
        const logoPlaceholder = document.getElementById(`logo-placeholder-${supplierId}`);
        const originalSrc = logoImg ? logoImg.src : null;
        
        if (logoImg) {
            logoImg.style.opacity = '0.5';
        }
        
        // T·∫°o FormData
        const formData = new FormData();
        formData.append('file', file);
        
        // L·∫•y CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        
        // G·ªçi API upload
        fetch(`{% url 'products:upload_supplier_logo' 0 %}`.replace('0', supplierId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // C·∫≠p nh·∫≠t logo hi·ªÉn th·ªã
                if (logoImg) {
                    logoImg.src = data.logo_path;
                    logoImg.style.opacity = '1';
                } else if (logoPlaceholder) {
                    // T·∫°o img element m·ªõi n·∫øu ch∆∞a c√≥
                    const newImg = document.createElement('img');
                    newImg.id = `logo-${supplierId}`;
                    newImg.src = data.logo_path;
                    newImg.alt = 'Logo';
                    newImg.className = 'w-16 h-16 object-contain rounded-md border border-slate-200 bg-white';
                    logoPlaceholder.parentNode.replaceChild(newImg, logoPlaceholder);
                }
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50';
                successMsg.textContent = 'Upload logo th√†nh c√¥ng!';
                document.body.appendChild(successMsg);
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            } else {
                alert('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ upload logo'));
                if (logoImg && originalSrc) {
                    logoImg.src = originalSrc;
                    logoImg.style.opacity = '1';
                }
            }
        })
        .catch(error => {
            console.error('Error uploading logo:', error);
            alert('L·ªói khi upload logo. Vui l√≤ng th·ª≠ l·∫°i.');
            if (logoImg && originalSrc) {
                logoImg.src = originalSrc;
                logoImg.style.opacity = '1';
            }
        })
        .finally(() => {
            // Reset input ƒë·ªÉ c√≥ th·ªÉ upload l·∫°i file c√πng t√™n
            input.value = '';
        });
    }
    
    // Functions ƒë·ªÉ th√™m website
    function showAddWebsitePanel(supplierId) {
        const panel = document.getElementById(`add-website-panel-${supplierId}`);
        if (panel) {
            panel.classList.remove('hidden');
            // Focus v√†o input URL
            const urlInput = document.getElementById(`website-url-${supplierId}`);
            if (urlInput) {
                setTimeout(() => urlInput.focus(), 100);
            }
        }
    }
    
    function hideAddWebsitePanel(supplierId) {
        const panel = document.getElementById(`add-website-panel-${supplierId}`);
        if (panel) {
            panel.classList.add('hidden');
            // Clear inputs
            const urlInput = document.getElementById(`website-url-${supplierId}`);
            const typeSelect = document.getElementById(`website-type-${supplierId}`);
            if (urlInput) urlInput.value = '';
            if (typeSelect) typeSelect.value = '1688';
        }
    }
    
    function addSupplierWebsite(supplierId) {
        const typeSelect = document.getElementById(`website-type-${supplierId}`);
        const urlInput = document.getElementById(`website-url-${supplierId}`);
        
        if (!typeSelect || !urlInput) {
            alert('Kh√¥ng t√¨m th·∫•y form th√™m website');
            return;
        }
        
        const websiteType = typeSelect.value.trim();
        const websiteUrl = urlInput.value.trim();
        
        if (!websiteUrl) {
            alert('Vui l√≤ng nh·∫≠p URL');
            urlInput.focus();
            return;
        }
        
        // Validate URL format
        if (!websiteUrl.match(/^https?:\/\//) && !websiteUrl.match(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)) {
            alert('URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p URL ƒë·∫ßy ƒë·ªß (v√≠ d·ª•: https://example.com)');
            urlInput.focus();
            return;
        }
        
        // Disable button v√† inputs
        const addBtn = typeSelect.parentElement.querySelector('button[onclick*="addSupplierWebsite"]');
        if (addBtn) addBtn.disabled = true;
        typeSelect.disabled = true;
        urlInput.disabled = true;
        
        // L·∫•y CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        
        // G·ªçi API
        fetch(`{% url 'products:add_supplier_website' 0 %}`.replace('0', supplierId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                website_type: websiteType,
                website_url: websiteUrl
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // C·∫≠p nh·∫≠t UI: th√™m website m·ªõi v√†o container
                const container = document.getElementById(`websites-container-${supplierId}`);
                if (container && data.websites) {
                    // X√≥a t·∫•t c·∫£ websites hi·ªán t·∫°i (tr·ª´ icon v√† button +)
                    const existingLinks = container.querySelectorAll('a');
                    existingLinks.forEach(link => link.remove());
                    
                    // Th√™m l·∫°i t·∫•t c·∫£ websites (bao g·ªìm website m·ªõi)
                    Object.entries(data.websites).forEach(([siteType, siteUrl]) => {
                        const link = createWebsiteLink(siteType, siteUrl);
                        // Insert tr∆∞·ªõc button +
                        const addBtn = container.querySelector('button[onclick*="showAddWebsitePanel"]');
                        if (addBtn) {
                            container.insertBefore(link, addBtn);
                        } else {
                            container.appendChild(link);
                        }
                    });
                }
                
                // ·∫®n panel
                hideAddWebsitePanel(supplierId);
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50';
                successMsg.textContent = 'Th√™m website th√†nh c√¥ng!';
                document.body.appendChild(successMsg);
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            } else {
                alert('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ th√™m website'));
            }
        })
        .catch(error => {
            console.error('Error adding website:', error);
            alert('L·ªói khi th√™m website. Vui l√≤ng th·ª≠ l·∫°i.');
        })
        .finally(() => {
            // Enable l·∫°i button v√† inputs
            if (addBtn) addBtn.disabled = false;
            typeSelect.disabled = false;
            urlInput.disabled = false;
        });
    }
    
    function createWebsiteLink(siteType, siteUrl) {
        const link = document.createElement('a');
        link.href = siteUrl;
        link.target = '_blank';
        link.className = 'inline-flex items-center gap-1';
        
        // T·∫°o icon/logo t√πy theo lo·∫°i website
        if (siteType === '1688' || siteUrl.includes('1688')) {
            const img = document.createElement('img');
            img.src = '/static/1688_logo.png';
            img.alt = '1688';
            img.className = 'w-4 h-4';
            img.onerror = function() { this.style.display = 'none'; };
            link.appendChild(img);
        } else if (siteType === 'tmall' || siteUrl.includes('tmall')) {
            const img = document.createElement('img');
            img.src = '/static/tmall_logo.png';
            img.alt = 'Tmall';
            img.className = 'w-4 h-4';
            img.onerror = function() { this.style.display = 'none'; };
            link.appendChild(img);
        } else if (siteType === 'taobao' || siteUrl.includes('taobao')) {
            const img = document.createElement('img');
            img.src = '/static/taobao_logo.png';
            img.alt = 'Taobao';
            img.className = 'w-4 h-4';
            img.onerror = function() { this.style.display = 'none'; };
            link.appendChild(img);
        } else if (siteType === 'douyin' || siteUrl.includes('douyin')) {
            const img = document.createElement('img');
            img.src = '/static/douyin_logo.png';
            img.alt = 'Douyin';
            img.className = 'w-4 h-4';
            img.onerror = function() { this.style.display = 'none'; };
            link.appendChild(img);
        } else {
            // Link th√¥ng th∆∞·ªùng
            link.className = 'text-blue-600 hover:underline text-[10px]';
            link.textContent = siteType;
            link.title = siteUrl;
        }
        
        return link;
    }
</script>
{% endblock %}
