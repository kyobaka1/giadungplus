{% extends "marketing/base_marketing.html" %}
{% load static %}

{% block title %}{{ title }} - Gia Dụng Plus{% endblock %}

{% block overview %}
<section class="px-4 mb-4">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl md:text-lg font-semibold text-slate-800">{{ title }}</h1>
            <p class="text-sm md:text-xs text-gray-500 mt-1">Import/Export KOC/KOL Database</p>
        </div>
        <div>
            <a href="{% url 'marketing:booking_creator_list' %}" 
               class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-sm">
                ← Quay lại
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="flex-1 min-w-0 overflow-x-hidden space-y-6">
    
    <!-- Import Section -->
    <div class="bg-white border rounded-xl shadow-sm p-6">
        <h2 class="text-base font-semibold text-gray-800 mb-4">Import</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-2">Chọn loại import</label>
                <select id="importType" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="creators">Creators</option>
                    <option value="channels">Channels</option>
                    <option value="contacts">Contacts</option>
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-2">Download Template</label>
                <div class="flex flex-wrap gap-2">
                    <a href="{% url 'marketing:booking_export_template' %}?type=creators" 
                       class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
                        Template Creators (CSV)
                    </a>
                    <a href="{% url 'marketing:booking_export_template' %}?type=channels" 
                       class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
                        Template Channels (CSV)
                    </a>
                    <a href="{% url 'marketing:booking_export_template' %}?type=contacts" 
                       class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
                        Template Contacts (CSV)
                    </a>
                </div>
            </div>
            
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-2">Upload File (CSV hoặc XLSX)</label>
                <form id="importForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="file" id="importFile" accept=".csv,.xlsx" required 
                           class="w-full px-3 py-2 border rounded-lg text-sm mb-2">
                    <div class="mb-3">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="dryRun" checked>
                            <span class="text-xs text-gray-700">Dry-run mode (chỉ xem preview, không lưu)</span>
                        </label>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition font-semibold">
                        Import
                    </button>
                </form>
            </div>
            
            <div id="importResult" class="hidden mt-4 p-4 rounded-lg"></div>
        </div>
    </div>
    
    <!-- Export Section -->
    <div class="bg-white border rounded-xl shadow-sm p-6">
        <h2 class="text-base font-semibold text-gray-800 mb-4">Export</h2>
        <p class="text-xs text-gray-600 mb-4">
            Export sẽ sử dụng các bộ lọc hiện tại từ trang Creator List.
        </p>
        <div class="flex gap-2">
            <a href="{% url 'marketing:booking_export' %}?format=csv" 
               class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition font-semibold">
                Export CSV
            </a>
            <a href="{% url 'marketing:booking_export' %}?format=xlsx" 
               class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition font-semibold">
                Export XLSX
            </a>
        </div>
    </div>
</div>

<script>
document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('file', document.getElementById('importFile').files[0]);
    formData.append('import_type', document.getElementById('importType').value);
    formData.append('dry_run', document.getElementById('dryRun').checked);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    const resultDiv = document.getElementById('importResult');
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = '<p class="text-sm text-gray-600">Đang xử lý...</p>';
    
    try {
        const response = await fetch('{% url "marketing:booking_import_process" %}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            resultDiv.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-lg';
            resultDiv.innerHTML = `
                <p class="text-sm font-medium text-green-800">${result.message}</p>
                <div class="mt-2 text-xs text-green-700 space-y-1">
                    <p>Tạo mới: ${result.created}</p>
                    <p>Cập nhật: ${result.updated}</p>
                    <p>Bỏ qua: ${result.skipped}</p>
                    <p>Lỗi: ${result.errors.length}</p>
                </div>
                ${result.errors.length > 0 ? `
                    <div class="mt-3 pt-3 border-t border-green-300">
                        <p class="text-xs font-medium text-red-800 mb-2">Chi tiết lỗi:</p>
                        <ul class="text-xs text-red-700 list-disc list-inside space-y-0.5">
                            ${result.errors.map(e => `<li>Dòng ${e.row}: ${e.error}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        } else {
            resultDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
            resultDiv.innerHTML = `<p class="text-sm font-medium text-red-800">${result.message || 'Có lỗi xảy ra'}</p>`;
        }
    } catch (error) {
        resultDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
        resultDiv.innerHTML = `<p class="text-sm font-medium text-red-800">Lỗi: ${error.message}</p>`;
    }
});
</script>
{% endblock %}
