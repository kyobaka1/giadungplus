{% extends "chamcong/base_chamcong.html" %}
{% load group_tags %}

{% block title %}Ch·∫•m c√¥ng h√¥m nay{% endblock %}

{% block overview %}
<section class="space-y-1">
    <h1 class="text-xl md:text-2xl font-semibold text-slate-800">
        Ch·∫•m c√¥ng h√¥m nay
    </h1>
    <p class="text-sm text-gray-500">
        Ng√†y {{ today|date:"d/m/Y" }} &middot; H√£y b·∫≠t GPS v√† ch·ª•p selfie r√µ m·∫∑t.
    </p>
</section>
{% endblock %}

{% block content %}
<section class="grid md:grid-cols-2 gap-4 md:gap-6">
    <!-- Th√¥ng tin nh√¢n vi√™n + tr·∫°ng th√°i -->
    <div class="bg-white border border-slate-100 rounded-2xl shadow-sm p-4 md:p-6 space-y-4">
        <!-- Th√¥ng tin nh√¢n vi√™n -->
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full overflow-hidden bg-slate-100 border border-slate-200 flex-shrink-0">
                <img src="/static/nhanvien/{{ request.user.username }}.png"
                     alt="·∫¢nh nh√¢n vi√™n"
                     class="w-full h-full object-cover">
            </div>
            <div class="min-w-0">
                <div class="text-sm font-semibold text-slate-900 truncate">
                    {{ request.user.first_name|default:request.user.username }}
                </div>
                <div class="flex flex-wrap items-center gap-1 mt-0.5 text-[11px] text-slate-500">
                    {% if request.user.last_name %}
                        <span class="px-1.5 py-0.5 rounded border bg-slate-50 {{ request.user.last_name|position_tag_class }}">
                            {{ request.user.last_name }}
                        </span>
                    {% endif %}
                    {% if record.group_name %}
                        <span class="px-1.5 py-0.5 rounded border border-emerald-100 bg-emerald-50 text-emerald-700">
                            {{ record.group_name }}
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tr·∫°ng th√°i h√¥m nay -->
        <div class="mt-4 space-y-3">
            <div>
                <div class="text-xs uppercase tracking-wide text-slate-400 mb-1">
                    Tr·∫°ng th√°i h√¥m nay
                </div>
                <div class="text-base font-semibold text-slate-800">
                    {% if record.check_in_time and record.check_out_time %}
                        ƒê√£ ho√†n th√†nh ch·∫•m c√¥ng
                    {% elif record.check_in_time %}
                        ƒêang l√†m vi·ªác
                    {% else %}
                        Ch∆∞a ch·∫•m c√¥ng
                    {% endif %}
                </div>
                {% if record.shift %}
                    <div class="text-xs text-emerald-700 mt-0.5">
                        Ca hi·ªán t·∫°i:
                        {% if record.shift == "morning" %}
                            Ca s√°ng
                        {% elif record.shift == "afternoon" %}
                            Ca chi·ªÅu
                        {% elif record.shift == "evening" %}
                            Ca t·ªëi
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="rounded-xl bg-slate-50 px-3 py-2">
                    <div class="text-xs text-slate-400 mb-1">Check-in</div>
                    <div class="font-medium text-slate-800">
                        {% if record.check_in_time %}
                            {{ record.check_in_time|date:"H:i" }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                </div>
                <div class="rounded-xl bg-slate-50 px-3 py-2">
                    <div class="text-xs text-slate-400 mb-1">Check-out</div>
                    <div class="font-medium text-slate-800">
                        {% if record.check_out_time %}
                            {{ record.check_out_time|date:"H:i" }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="rounded-xl bg-emerald-50/60 px-3 py-2 text-xs text-emerald-800 border border-emerald-100">
                <div class="font-semibold mb-0.5">L∆∞u √Ω</div>
                <ul class="list-disc list-inside space-y-0.5">
                    <li>B·∫≠t ƒë·ªãnh v·ªã (GPS) tr∆∞·ªõc khi ch·∫•m c√¥ng.</li>
                    <li>·∫¢nh nh√¢n vi√™n c·∫ßn r√µ m·∫∑t, kh√¥ng che khu·∫•t.</li>
                    <li>N·∫øu l√†m vi·ªác ngo√†i ƒë·ªãa ƒëi·ªÉm cho ph√©p, c·∫ßn b√°o tr∆∞·ªõc cho qu·∫£n l√Ω.</li>
                </ul>
            </div>
        </div>

        <!-- L·ªãch s·ª≠ ch·∫•m c√¥ng h√¥m nay -->
        <div class="mt-4 pt-4 border-t border-slate-100 space-y-2 text-xs">
            <div class="flex items-center justify-between">
                <span class="font-semibold text-slate-800">L·ªãch s·ª≠ h√¥m nay</span>
                <span class="text-[11px] text-slate-400">
                    {% if current_shift == "morning" %}
                        Ca s√°ng
                    {% elif current_shift == "afternoon" %}
                        Ca s√°ng / chi·ªÅu
                    {% else %}
                        Ca s√°ng / chi·ªÅu / t·ªëi
                    {% endif %}
                </span>
            </div>

            <div class="space-y-1.5">
                {% for r in today_records %}
                    {% if current_shift == "morning" %}
                        {% if r.shift == "morning" %}
                        <div class="flex items-center justify-between rounded-lg bg-slate-50 px-3 py-1.5">
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                <span class="text-[11px] text-slate-600">Ca s√°ng</span>
                            </div>
                            <div class="text-[11px] text-slate-500">
                                In: {% if r.check_in_time %}{{ r.check_in_time|date:"H:i" }}{% else %}‚Äî{% endif %}
                                ¬∑ Out: {% if r.check_out_time %}{{ r.check_out_time|date:"H:i" }}{% else %}‚Äî{% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% elif current_shift == "afternoon" %}
                        {% if r.shift == "morning" or r.shift == "afternoon" %}
                        <div class="flex items-center justify-between rounded-lg bg-slate-50 px-3 py-1.5">
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full {% if r.shift == 'morning' %}bg-emerald-500{% else %}bg-amber-500{% endif %}"></span>
                                <span class="text-[11px] text-slate-600">
                                    {% if r.shift == "morning" %}Ca s√°ng{% else %}Ca chi·ªÅu{% endif %}
                                </span>
                            </div>
                            <div class="text-[11px] text-slate-500">
                                In: {% if r.check_in_time %}{{ r.check_in_time|date:"H:i" }}{% else %}‚Äî{% endif %}
                                ¬∑ Out: {% if r.check_out_time %}{{ r.check_out_time|date:"H:i" }}{% else %}‚Äî{% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        {# Ca t·ªëi: hi·ªán t·∫•t c·∫£ #}
                        <div class="flex items-center justify-between rounded-lg bg-slate-50 px-3 py-1.5">
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full {% if r.shift == 'morning' %}bg-emerald-500{% elif r.shift == 'afternoon' %}bg-amber-500{% else %}bg-sky-500{% endif %}"></span>
                                <span class="text-[11px] text-slate-600">
                                    {% if r.shift == "morning" %}
                                        Ca s√°ng
                                    {% elif r.shift == "afternoon" %}
                                        Ca chi·ªÅu
                                    {% elif r.shift == "evening" %}
                                        Ca t·ªëi
                                    {% else %}
                                        Kh√¥ng x√°c ƒë·ªãnh
                                    {% endif %}
                                </span>
                            </div>
                            <div class="text-[11px] text-slate-500">
                                In: {% if r.check_in_time %}{{ r.check_in_time|date:"H:i" }}{% else %}‚Äî{% endif %}
                                ¬∑ Out: {% if r.check_out_time %}{{ r.check_out_time|date:"H:i" }}{% else %}‚Äî{% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% empty %}
                    <div class="text-[11px] text-slate-400">
                        Ch∆∞a c√≥ l·ªãch s·ª≠ ch·∫•m c√¥ng trong ng√†y.
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Form ch·∫•m c√¥ng -->
    <div class="bg-white border border-slate-100 rounded-2xl shadow-sm p-4 md:p-6 space-y-4">
        <div>
            <div class="text-xs uppercase tracking-wide text-slate-400 mb-1">
                Thao t√°c
            </div>
            <div class="text-base font-semibold text-slate-800">
                Ch·∫•m c√¥ng v·ªõi GPS + Selfie
            </div>
        </div>

        <!-- Django messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="rounded-xl {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-700{% elif message.tags == 'success' %}bg-emerald-50 border border-emerald-200 text-emerald-700{% else %}bg-amber-50 border border-amber-200 text-amber-700{% endif %} px-3 py-2 text-xs">
                    <div class="font-semibold mb-0.5">
                        {% if message.tags == 'error' %}‚ö†Ô∏è L·ªói{% elif message.tags == 'success' %}‚úì Th√†nh c√¥ng{% else %}‚ÑπÔ∏è Th√¥ng b√°o{% endif %}
                    </div>
                    <div>{{ message }}</div>
                </div>
            {% endfor %}
        {% endif %}

        <form id="attendance-form" method="post" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="latitude" id="field-latitude">
            <input type="hidden" name="longitude" id="field-longitude">
            <input type="hidden" name="address" id="field-address">
            <input type="hidden" name="action" id="field-action">

            <div class="space-y-2">
                <label class="block text-xs font-medium text-slate-600">
                    ·∫¢nh selfie
                </label>
                <label for="field-photo"
                       class="flex items-center justify-between gap-3 px-3 py-2 rounded-xl border border-dashed border-slate-300 bg-slate-50 hover:bg-slate-100 cursor-pointer text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-slate-500">
                            üì∑
                        </div>
                        <div class="text-left">
                            <div class="font-medium text-slate-800">
                                Ch·ªçn ·∫£nh ho·∫∑c ch·ª•p tr·ª±c ti·∫øp
                            </div>
                            <div class="text-xs text-slate-500">
                                ∆Øu ti√™n ch·ª•p b·∫±ng camera tr∆∞·ªõc
                            </div>
                        </div>
                    </div>
                    <div id="photo-selected-label" class="text-xs text-emerald-600 hidden">
                        ƒê√£ ch·ªçn ·∫£nh
                    </div>
                </label>
                <input id="field-photo" name="photo" type="file" accept="image/*" capture="user" class="hidden">
            </div>

            <div class="space-y-1 text-xs text-slate-500">
                <div class="flex items-center justify-between">
                    <span>
                        V·ªã tr√≠:
                        <span id="location-label" class="font-medium text-slate-700">ƒêang x√°c ƒë·ªãnh‚Ä¶</span>
                    </span>
                    <button type="button"
                            id="btn-refresh-location"
                            class="px-2 py-1 rounded-full border border-slate-200 text-[11px] text-slate-600 hover:bg-slate-50">
                        L·∫•y l·∫°i v·ªã tr√≠
                    </button>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 pt-2">
                {% if record.approval_status == "approved" or record.approval_status == "rejected" %}
                    <div class="flex-1 rounded-xl bg-amber-50 border border-amber-200 px-4 py-2.5 text-sm text-amber-700 text-center">
                        Ch·∫•m c√¥ng ƒë√£ {% if record.approval_status == "approved" %}duy·ªát{% else %}t·ª´ ch·ªëi{% endif %}. Kh√¥ng th·ªÉ ch·ªânh s·ª≠a.
                    </div>
                {% else %}
                    <button type="button"
                            id="btn-checkin"
                            {% if record.check_in_time %}disabled{% endif %}
                            class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-full text-sm font-semibold text-white
                                   {% if record.check_in_time %}bg-slate-300 cursor-not-allowed{% else %}bg-emerald-600 hover:bg-emerald-700 shadow-sm{% endif %}">
                        <span>Check-in</span>
                    </button>
                    <button type="button"
                            id="btn-checkout"
                            {% if not record.check_in_time %}disabled{% endif %}
                            class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-full text-sm font-semibold text-emerald-700 border border-emerald-200
                                   {% if not record.check_in_time %}bg-slate-50 cursor-not-allowed text-slate-400 border-slate-200{% else %}bg-emerald-50 hover:bg-emerald-100{% endif %}">
                        <span>Check-out</span>
                    </button>
                {% endif %}
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const fieldLat = document.getElementById('field-latitude');
        const fieldLng = document.getElementById('field-longitude');
        const fieldAddr = document.getElementById('field-address');
        const fieldAction = document.getElementById('field-action');
        const form = document.getElementById('attendance-form');
        const btnCheckin = document.getElementById('btn-checkin');
        const btnCheckout = document.getElementById('btn-checkout');
        const btnRefresh = document.getElementById('btn-refresh-location');
        const locationLabel = document.getElementById('location-label');
        const photoInput = document.getElementById('field-photo');
        const photoSelectedLabel = document.getElementById('photo-selected-label');

        if (!navigator.geolocation) {
            locationLabel.textContent = 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS';
            locationLabel.classList.add('text-red-600');
        } else {
            const updateLocation = () => {
                locationLabel.textContent = 'ƒêang l·∫•y v·ªã tr√≠‚Ä¶';
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude.toFixed(6);
                        const lng = pos.coords.longitude.toFixed(6);
                        fieldLat.value = lat;
                        fieldLng.value = lng;
                        locationLabel.textContent = `${lat}, ${lng}`;
                        locationLabel.classList.remove('text-red-600');
                        locationLabel.classList.add('text-emerald-700');
                    },
                    (err) => {
                        console.warn('Geolocation error', err);
                        locationLabel.textContent = 'Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. H√£y b·∫≠t GPS v√† cho ph√©p truy c·∫≠p v·ªã tr√≠.';
                        locationLabel.classList.add('text-red-600');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
                );
            };

            updateLocation();
            if (btnRefresh) {
                btnRefresh.addEventListener('click', updateLocation);
            }
        }

        if (photoInput && photoSelectedLabel) {
            photoInput.addEventListener('change', function () {
                if (photoInput.files && photoInput.files.length > 0) {
                    photoSelectedLabel.classList.remove('hidden');
                } else {
                    photoSelectedLabel.classList.add('hidden');
                }
            });
        }

        // Th√¥ng b√°o l·ªói
        const showError = (message) => {
            // X√≥a th√¥ng b√°o c≈© n·∫øu c√≥
            const existingError = document.getElementById('attendance-error');
            if (existingError) {
                existingError.remove();
            }
            
            // T·∫°o th√¥ng b√°o m·ªõi
            const errorDiv = document.createElement('div');
            errorDiv.id = 'attendance-error';
            errorDiv.className = 'rounded-xl bg-red-50 border border-red-200 px-3 py-2 text-xs text-red-700';
            errorDiv.innerHTML = '<div class="font-semibold mb-0.5">‚ö†Ô∏è L·ªói</div><div>' + message + '</div>';
            
            // Ch√®n v√†o tr∆∞·ªõc form
            if (form && form.parentNode) {
                form.parentNode.insertBefore(errorDiv, form);
            }
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        };

        const submitAction = (actionName) => {
            if (!form) return;
            
            // Ki·ªÉm tra GPS
            const lat = fieldLat.value.trim();
            const lng = fieldLng.value.trim();
            if (!lat || !lng || lat === '0' || lng === '0') {
                showError('Vui l√≤ng b·∫≠t GPS v√† cho ph√©p truy c·∫≠p v·ªã tr√≠ tr∆∞·ªõc khi ch·∫•m c√¥ng. Nh·∫•n "L·∫•y l·∫°i v·ªã tr√≠" n·∫øu c·∫ßn.');
                return;
            }
            
            // Ki·ªÉm tra ·∫£nh
            if (!photoInput.files || photoInput.files.length === 0) {
                showError('Vui l√≤ng ch·ªçn ho·∫∑c ch·ª•p ·∫£nh selfie tr∆∞·ªõc khi ch·∫•m c√¥ng.');
                return;
            }
            
            // N·∫øu ƒë·ªß ƒëi·ªÅu ki·ªán, submit form
            fieldAction.value = actionName;
            form.submit();
        };

        if (btnCheckin) {
            btnCheckin.addEventListener('click', function () {
                {% if not record.check_in_time %}
                submitAction('checkin');
                {% endif %}
            });
        }
        if (btnCheckout) {
            btnCheckout.addEventListener('click', function () {
                {% if record.check_in_time %}
                submitAction('checkout');
                {% endif %}
            });
        }
    })();
</script>
{% endblock %}


