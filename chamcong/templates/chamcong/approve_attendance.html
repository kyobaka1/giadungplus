{% extends "chamcong/base_chamcong.html" %}

{% block title %}Duyệt chấm công{% endblock %}

{% block overview %}
<section class="space-y-1">
    <h1 class="text-xl md:text-2xl font-semibold text-slate-800">
        Duyệt chấm công
    </h1>
    <p class="text-sm text-gray-500">
        Xem và duyệt giờ làm của nhân viên theo quyền của bạn.
    </p>
</section>
{% endblock %}

{% block content %}
<section class="space-y-4">
    <div class="rounded-2xl bg-amber-50/70 border border-amber-100 px-3 py-2 text-xs text-amber-800">
        <div class="font-semibold mb-0.5">
            Quyền của bạn:
        </div>
        <ul class="list-disc list-inside space-y-0.5">
            {% if is_admin %}
                <li>Admin: duyệt chấm công cho tất cả nhân sự.</li>
            {% elif is_warehouse_manager %}
                <li>WarehouseManager: duyệt chấm công cho bộ phận Kho.</li>
            {% elif is_cskh_manager %}
                <li>CSKHManager: duyệt chấm công cho CSKHStaff.</li>
            {% elif is_marketing_manager %}
                <li>MarketingManager: duyệt chấm công cho MarketingStaff &amp; MarketingIntern.</li>
            {% else %}
                <li>Bạn không có quyền duyệt chấm công.</li>
            {% endif %}
        </ul>
    </div>

    <div class="bg-white border border-slate-100 rounded-2xl shadow-sm overflow-hidden">
        <table class="min-w-full text-xs sm:text-sm">
            <thead class="bg-slate-50 text-slate-500">
                <tr>
                    <th class="px-3 py-2 text-left font-medium">Nhân viên</th>
                    <th class="px-3 py-2 text-left font-medium">Ngày / Ca</th>
                    <th class="px-3 py-2 text-left font-medium">Thông tin</th>
                    <th class="px-3 py-2 text-left font-medium">Giờ làm</th>
                    <th class="px-3 py-2 text-center font-medium">Trạng thái</th>
                    <th class="px-3 py-2 text-right font-medium">Thao tác</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% if records_with_location %}
                    {% for item in records_with_location %}
                    {% with r=item.record %}
                    <tr class="hover:bg-slate-50/60">
                        <td class="px-3 py-2">
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-10 rounded-full overflow-hidden bg-slate-100 border border-slate-200 flex-shrink-0">
                                    <img src="/static/nhanvien/{{ r.user.username }}.png"
                                         alt="Ảnh nhân viên"
                                         class="w-full h-full object-cover"
                                         onerror="this.src='/static/kho-avatar.png'">
                                </div>
                                <div class="min-w-0">
                                    <div class="font-medium text-slate-800">
                                        {{ r.user.first_name|default:r.user.username }}
                                    </div>
                                    <div class="text-[11px] text-slate-400">
                                        {{ r.department }} • {{ r.group_name }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-3 py-2 text-slate-800">
                            <div class="text-sm font-medium text-slate-800">
                                {{ r.work_date|date:"d/m/Y" }}
                            </div>
                            <div class="text-[11px] text-emerald-700 mt-0.5">
                                {% if r.shift == "morning" %}
                                    Ca sáng
                                {% elif r.shift == "afternoon" %}
                                    Ca chiều
                                {% elif r.shift == "evening" %}
                                    Ca tối
                                {% else %}
                                    Không xác định
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-3 py-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <!-- Khối Check-in -->
                                <div class="rounded-xl border border-slate-100 bg-slate-50/60 px-2.5 py-2 space-y-1.5">
                                    <div class="flex items-center justify-between gap-2">
                                        <div class="text-[11px] font-semibold text-slate-700 uppercase tracking-wide">
                                            Check-in
                                        </div>
                                        <div class="text-[11px] text-slate-500">
                                            {% if r.check_in_time %}{{ r.check_in_time|date:"H:i" }}{% else %}—{% endif %}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        {% if r.check_in_photo %}
                                            <button type="button"
                                                    class="flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-slate-200 hover:border-emerald-400 transition cursor-pointer"
                                                    data-photo-url="{{ r.check_in_photo.url }}"
                                                    onclick="openPhotoModal(this)">
                                                <img src="{{ r.check_in_photo.url }}"
                                                     alt="Ảnh check-in"
                                                     class="w-full h-full object-cover">
                                            </button>
                                        {% else %}
                                            <div class="flex-shrink-0 w-10 h-10 rounded-lg border border-dashed border-slate-200 flex items-center justify-center text-[10px] text-slate-300">
                                                Không ảnh
                                            </div>
                                        {% endif %}
                                        <div class="flex-1 min-w-0 space-y-0.5">
                                            <div class="flex items-center gap-1 text-[10px] {% if item.location_valid %}text-emerald-700{% else %}text-amber-600{% endif %}">
                                                {% if item.location_valid and item.location_name %}
                                                    <span>Vị trí: {{ item.location_name }}</span>
                                                {% else %}
                                                    <span>Vị trí: Chưa xác định</span>
                                                    {% if r.check_in_latitude and r.check_in_longitude %}
                                                        <button type="button"
                                                                class="inline-flex items-center px-1.5 py-0.5 rounded-full border border-amber-200 bg-white text-[10px] text-amber-700 hover:bg-amber-50"
                                                                data-lat="{{ r.check_in_latitude }}"
                                                                data-lng="{{ r.check_in_longitude }}"
                                                                onclick="openMapPanel(this)">
                                                            Xem
                                                        </button>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                           
                                        </div>
                                    </div>
                                </div>

                                <!-- Khối Check-out -->
                                <div class="rounded-xl border border-slate-100 bg-slate-50/60 px-2.5 py-2 space-y-1.5">
                                    <div class="flex items-center justify-between gap-2">
                                        <div class="text-[11px] font-semibold text-slate-700 uppercase tracking-wide">
                                            Check-out
                                        </div>
                                        <div class="text-[11px] text-slate-500">
                                            {% if r.check_out_time %}{{ r.check_out_time|date:"H:i" }}{% else %}—{% endif %}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        {% if r.check_out_photo %}
                                            <button type="button"
                                                    class="flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-slate-200 hover:border-emerald-400 transition cursor-pointer"
                                                    data-photo-url="{{ r.check_out_photo.url }}"
                                                    onclick="openPhotoModal(this)">
                                                <img src="{{ r.check_out_photo.url }}"
                                                     alt="Ảnh check-out"
                                                     class="w-full h-full object-cover">
                                            </button>
                                        {% else %}
                                            <div class="flex-shrink-0 w-10 h-10 rounded-lg border border-dashed border-slate-200 flex items-center justify-center text-[10px] text-slate-300">
                                                Không ảnh
                                            </div>
                                        {% endif %}
                                        <div class="flex-1 min-w-0 space-y-0.5">
                                            <div class="flex items-center gap-1 text-[10px] {% if item.location_valid %}text-emerald-700{% else %}text-amber-600{% endif %}">
                                                {% if item.location_valid and item.location_name %}
                                                    <span>Vị trí: {{ item.location_name }}</span>
                                                {% else %}
                                                    <span>Vị trí: Chưa xác định</span>
                                                    {% if r.check_out_latitude and r.check_out_longitude %}
                                                        <button type="button"
                                                                class="inline-flex items-center px-1.5 py-0.5 rounded-full border border-amber-200 bg-white text-[10px] text-amber-700 hover:bg-amber-50"
                                                                data-lat="{{ r.check_out_latitude }}"
                                                                data-lng="{{ r.check_out_longitude }}"
                                                                onclick="openMapPanel(this)">
                                                            Xem
                                                        </button>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                           
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-3 py-2 text-slate-800">
                            {% if r.total_minutes %}
                                {% if item.total_hours > 0 %}
                                    {{ item.total_hours }} giờ
                                    {% if item.total_remaining_minutes > 0 %}{{ item.total_remaining_minutes }} phút{% endif %}
                                {% else %}
                                    {{ r.total_minutes }} phút
                                {% endif %}
                            {% else %}
                                —
                            {% endif %}
                            {% if r.overtime_minutes %}
                                <div class="text-[11px] text-amber-600">
                                    + {% if item.overtime_hours > 0 %}
                                        {{ item.overtime_hours }} giờ
                                        {% if item.overtime_remaining_minutes > 0 %}{{ item.overtime_remaining_minutes }} phút{% endif %}
                                    {% else %}
                                        {{ r.overtime_minutes }} phút
                                    {% endif %} tăng ca
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-center">
                            {% if r.approval_status == "approved" %}
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">
                                    <span class="text-[10px]">●</span> Đã duyệt
                                </span>
                            {% elif r.approval_status == "rejected" %}
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-100">
                                    <span class="text-[10px]">●</span> Từ chối
                                </span>
                            {% else %}
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-50 text-slate-600 border border-slate-200">
                                    <span class="text-[10px]">●</span> Chờ duyệt
                                </span>
                            {% endif %}
                            {% if r.approved_by %}
                                <div class="mt-0.5 text-[11px] text-slate-400">
                                    bởi {{ r.approved_by.first_name|default:r.approved_by.username }}
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-right">
                            {% if r.approval_status == "pending" %}
                                <form method="post" class="inline-flex items-center gap-1">
                                    {% csrf_token %}
                                    <input type="hidden" name="record_id" value="{{ r.id }}">
                                    <input type="hidden" name="note" value="">
                                    <button type="submit"
                                            name="action"
                                            value="approve"
                                            class="px-2 py-1 rounded-full bg-emerald-600 text-white text-[11px] font-semibold hover:bg-emerald-700">
                                        Duyệt
                                    </button>
                                    <button type="submit"
                                            name="action"
                                            value="reject"
                                            class="px-2 py-1 rounded-full bg-red-50 text-red-600 border border-red-100 text-[11px] font-semibold hover:bg-red-100">
                                        Từ chối
                                    </button>
                                    <button type="submit"
                                            name="action"
                                            value="delete"
                                            class="px-2 py-1 rounded-full bg-slate-50 text-slate-500 border border-slate-200 text-[11px] hover:bg-slate-100"
                                            onclick="return confirm('Bạn chắc chắn muốn xoá bản ghi chấm công này?');">
                                        Xoá
                                    </button>
                                </form>
                            {% else %}
                                <span class="text-[11px] text-slate-400">
                                    Đã {% if r.approval_status == "approved" %}duyệt{% else %}từ chối{% endif %}
                                </span>
                            {% endif %}
                        </td>
                        </tr>
                        {% endwith %}
                    {%endfor%}
                {% else %}
                    <tr>
                        <td colspan="6" class="px-3 py-6 text-center text-slate-400">
                            Không có bản ghi chấm công nào cần duyệt.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Panel xem Google Maps -->
    <div id="map-panel"
         class="fixed bottom-4 right-4 w-full max-w-md h-72 bg-white border border-slate-200 rounded-2xl shadow-xl z-40 hidden">
        <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100">
            <div class="text-xs font-semibold text-slate-700">
                Vị trí trên bản đồ
            </div>
            <button type="button"
                    class="w-7 h-7 rounded-full bg-slate-100 text-slate-600 text-xs flex items-center justify-center hover:bg-slate-200"
                    onclick="closeMapPanel()">
                ✕
            </button>
        </div>
        <div class="w-full h-[calc(100%-40px)]">
            <iframe id="map-iframe"
                    class="w-full h-full rounded-b-2xl"
                    style="border:0;"
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
            </iframe>
        </div>
    </div>

    <!-- Modal xem ảnh -->
    <div id="photo-modal"
         class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-[90vw] max-h-[90vh]">
            <button type="button"
                    class="absolute -top-3 -right-3 w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-slate-700 text-sm font-bold"
                    onclick="closePhotoModal()">
                ✕
            </button>
            <img id="photo-modal-img"
                 src=""
                 alt="Ảnh chấm công"
                 class="max-w-[90vw] max-h-[90vh] rounded-xl border border-slate-200 bg-black object-contain">
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    function openPhotoModal(btn) {
        const url = btn.getAttribute('data-photo-url');
        const modal = document.getElementById('photo-modal');
        const img = document.getElementById('photo-modal-img');
        if (!url || !modal || !img) return;
        img.src = url;
        modal.classList.remove('hidden');
    }
    function closePhotoModal() {
        const modal = document.getElementById('photo-modal');
        const img = document.getElementById('photo-modal-img');
        if (modal) {
            modal.classList.add('hidden');
        }
        if (img) {
            img.src = '';
        }
    }
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closePhotoModal();
        }
    });
    document.addEventListener('click', function (e) {
        const modal = document.getElementById('photo-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        if (e.target === modal) {
            closePhotoModal();
        }
    });
    function openMapPanel(btn) {
        const lat = btn.getAttribute('data-lat');
        const lng = btn.getAttribute('data-lng');
        if (!lat || !lng) return;
        const panel = document.getElementById('map-panel');
        const iframe = document.getElementById('map-iframe');
        if (!panel || !iframe) return;
        const url = `https://www.google.com/maps?q=${lat},${lng}&z=18&output=embed`;
        iframe.src = url;
        panel.classList.remove('hidden');
    }
    function closeMapPanel() {
        const panel = document.getElementById('map-panel');
        const iframe = document.getElementById('map-iframe');
        if (panel) {
            panel.classList.add('hidden');
        }
        if (iframe) {
            iframe.src = '';
        }
    }
</script>
{% endblock %}



