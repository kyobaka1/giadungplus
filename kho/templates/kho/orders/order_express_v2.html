{% extends "kho/base_kho.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block overview %}
<section>
  <h1 class="text-lg font-semibold text-slate-800">Hoả Tốc Shopee</h1>
  <p class="text-xs text-gray-500 mt-1">Đơn hoả tốc & tự động tìm lại shipper khi hết thời hạn.</p>
</section>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-100">
    <div class="max-w-6xl mx-auto">
        <!-- Tiêu đề + filter -->
        <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-3 text-sm">
                <!-- Ô tìm kiếm mã đơn -->
                <form method="get" class="relative">
                    <input type="text"
                           id="order-search-input"
                           name="q"
                           value="{{ request.GET.q }}"
                           placeholder="Tìm mã đơn / người mua"
                           oninput="filterOrders()"
                           class="pl-8 pr-3 py-1.5 text-sm rounded border border-slate-200 bg-white focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-orange-500">
                    <span class="absolute left-2 top-1.5 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z" />
                        </svg>
                    </span>
                </form>
            </div>
        </div>

        <!-- Khung danh sách -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
            <!-- Header cột -->
            <div class="flex items-center bg-slate-50 border-b border-slate-200 text-xs font-medium text-slate-600">
                <div class="w-10 flex items-center justify-center py-3"></div>
                <div class="flex-1 grid grid-cols-[minmax(220px,2fr),minmax(140px,1.2fr),minmax(150px,1.2fr),minmax(170px,1.4fr),minmax(230px,1.6fr)] gap-4 px-4">
                    <div>Sản phẩm</div>
                    <div>Mã đơn hàng</div>
                    <div>Người mua</div>
                    <div>Đơn vị vận chuyển</div>
                    <div class="text-right">Thời gian xác nhận & trạng thái</div>
                </div>
            </div>

            {% if orders %}
                {% for order in orders %}
                    {% with first_product=order.products.0 %}
                    <div class="flex border-t border-slate-100 hover:bg-slate-50/60 js-order-row" data-order-id="{{ order.id }}">
                        <!-- Tùy chỉnh content row order tại đây... shortened for brevity -->
                        <!-- ... -->
                    </div>
                    {% endwith %}
                {% endfor %}
            {% else %}
                <div class="py-10 text-center text-sm text-slate-500">
                    Hiện chưa có đơn hoả tốc nào cần xử lý.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function removeOrderRow(orderId) {
    const row = document.querySelector(`.js-order-row[data-order-id="${orderId}"]`);
    if (row) {
        row.style.transition = 'opacity 0.3s ease-out';
        row.style.opacity = '0';
        setTimeout(() => {
            row.remove();
            const remainingRows = document.querySelectorAll('.js-order-row');
            if (remainingRows.length === 0) {
                const container = document.querySelector('.bg-white.rounded-lg');
                if (container) {
                    container.innerHTML = '<div class="py-10 text-center text-sm text-slate-500">✅ Đã xử lý toàn bộ đơn hàng!</div>';
                }
            }
        }, 300);
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.transition = 'opacity 0.3s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function timShip(mp_order_id,event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!mp_order_id) return;
    const url = `/kho/orders/print_now/?ids=${mp_order_id}&print=no`;
    const btn = event ? event.target : null;
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Đang xử lý...';
    }
    fetch(url, { method: "GET" })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                showToast('✅ Tìm ship thành công!', 'success');
                removeOrderRow(mp_order_id);
            } else {
                let msg = "Không rõ lỗi";
                if (Array.isArray(data.errors) && data.errors.length > 0) {
                    const firstErr = data.errors[0];
                    msg = firstErr.error || `Đơn ${firstErr.channel_order_number || ""} lỗi`;
                } else if (data.message) {
                    msg = data.message;
                }
                showToast('❌ ' + msg, 'error');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Tìm ship';
                }
            }
        })
        .catch(err => {
            showToast('❌ Lỗi hệ thống', 'error');
            console.error(err);
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Tìm ship';
            }
        });
    return false;
}

function inDon(mp_order_id, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!mp_order_id) return;
    const url = `/kho/orders/print_now/?ids=${mp_order_id}&print=yes`;
    const btn = event ? event.target : null;
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Đang in...';
    }
    // Fetch PDF và mở trong tab mới
    fetch(url, { method: "GET" })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.blob();
        })
        .then(blob => {
            const pdfUrl = URL.createObjectURL(blob);
            const newWindow = window.open(pdfUrl, '_blank');
            if (newWindow) {
                setTimeout(() => URL.revokeObjectURL(pdfUrl), 1000);
                showToast('✅ Đã gửi yêu cầu in đơn!', 'success');
                removeOrderRow(mp_order_id);
            } else {
                showToast('❌ Vui lòng cho phép popup', 'error');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'In Đơn';
                }
            }
        })
        .catch(err => {
            console.error('Print error:', err);
            showToast('❌ Lỗi khi in đơn', 'error');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'In Đơn';
            }
        });
    return false;
}

function filterOrders() {
    const input = document.getElementById('order-search-input');
    if (!input) return;
    const q = (input.value || '').trim().toLowerCase();
    const rows = document.querySelectorAll('.js-order-row');
    if (!rows.length) return;
    if (!q) {
        rows.forEach(row => row.classList.remove('hidden'));
        return;
    }
    rows.forEach(row => {
        const text = (row.innerText || '').toLowerCase();
        if (text.includes(q)) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
}

document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('order-search-input');
    if (input && (input.value || '').trim() !== '') {
        filterOrders();
    }
});
</script>

{% endblock %}
