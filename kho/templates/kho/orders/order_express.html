{% extends "kho/base_kho.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block overview %}
<section>
  <h1 class="text-lg font-semibold text-slate-800">Hoả Tốc Shopee</h1>
  <p class="text-xs text-gray-500 mt-1">Đơn hoả tốc & tự động tìm lại shipper khi hết thời hạn.</p>
</section>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-100">
    <div class="max-w-6xl mx-auto">
        <!-- Tiêu đề + filter -->
        <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-3 text-sm">
                <!-- Ô tìm kiếm mã đơn (tuỳ anh xử lý backend) -->
                <form method="get" class="relative">
                    <input type="text"
                           id="order-search-input"
                           name="q"
                           value="{{ request.GET.q }}"
                           placeholder="Tìm mã đơn / người mua"
                           oninput="filterOrders()"
                           class="pl-8 pr-3 py-1.5 text-sm rounded border border-slate-200 bg-white focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-orange-500">
                    <span class="absolute left-2 top-1.5 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                             viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z" />
                        </svg>
                    </span>
                </form>
            </div>
        </div>

        <!-- Khung danh sách -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
            <!-- Header cột -->
            <div class="flex items-center bg-slate-50 border-b border-slate-200 text-xs font-medium text-slate-600">
                <div class="w-10 flex items-center justify-center py-3">
                    <input type="checkbox" class="rounded border-slate-300">
                </div>
                <div class="flex-1 grid grid-cols-[minmax(220px,2fr),minmax(140px,1.2fr),minmax(150px,1.2fr),minmax(170px,1.4fr),minmax(230px,1.6fr)] gap-4 px-4">
                    <div>Sản phẩm</div>
                    <div>Mã đơn hàng</div>
                    <div>Người mua</div>
                    <div>Đơn vị vận chuyển</div>
                    <div class="text-right">Thời gian xác nhận &amp; trạng thái</div>
                </div>
            </div>

            {% if orders %}
                {% for order in orders %}
                    {# Lấy sản phẩm đầu tiên cho phần thumbnail #}
                    {% with first_product=order.products.0 %}
                    <div class="flex border-t border-slate-100 hover:bg-slate-50/60 js-order-row">
                        <!-- Checkbox -->
                        <div class="w-10 flex items-start justify-center pt-4">
                            <input type="checkbox" class="mt-1 rounded border-slate-300">
                        </div>

                        <!-- Nội dung đơn -->
                        <div class="flex-1 px-3 py-3">
                            <div class="grid grid-cols-[minmax(220px,2fr),minmax(140px,1.2fr),minmax(150px,1.2fr),minmax(170px,1.4fr),minmax(230px,1.6fr)] gap-4 text-sm">

                                <!-- Sản phẩm -->
                                <div class="flex gap-3">
                                    <div class="shrink-0">
    <div class="w-20 h-20 border border-slate-200 rounded bg-white overflow-hidden relative">
        {% with prods=order.products %}

            {% if prods|length == 1 %}
                {% with p=prods.0 %}
                    {% if p.image %}
                        <div class="relative w-full h-full">
                            <img src="{{ p.image }}"
                                 title="{{ p.sku }}"
                                 class="w-full h-full object-contain p-0.5 rounded border border-slate-200">

                            {% if p.quantity > 0 %}
                                <span class="absolute top-0 right-0 text-[11px] px-1.5
                                             bg-red-600 text-white font-semibold rounded-full
                                             border border-white shadow">
                                    {{ p.quantity }}
                                </span>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endwith %}

            {% elif prods|length == 2 %}
                <div class="grid grid-cols-2 w-full h-full gap-0.5 p-0.5">
                    {% for p in prods|slice:":2" %}
                        <div class="relative flex items-center justify-center bg-white rounded border border-slate-200 overflow-hidden">
                            {% if p.image %}
                                <img src="{{ p.image }}"
                                     title="{{ p.sku }}"
                                     class="max-w-full max-h-full object-contain rounded">
                            {% endif %}

                            {% if p.quantity > 0 %}
                                <span class="absolute top-0 right-0 text-[11px] px-1.5
                                             bg-red-600 text-white font-semibold rounded-full
                                             border border-white shadow">
                                    {{ p.quantity }}
                                </span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

            {% elif prods|length == 3 %}
                <div class="grid grid-cols-2 grid-rows-2 w-full h-full gap-0.5 p-0.5">
                    {% for p in prods|slice:":3" %}
                        {% if forloop.first %}
                            <div class="relative col-span-2 flex items-center justify-center bg-white rounded border border-slate-200 overflow-hidden">
                                {% if p.image %}
                                    <img src="{{ p.image }}"
                                         title="{{ p.sku }}"
                                         class="max-w-full max-h-full object-contain rounded">
                                {% endif %}

                                {% if p.quantity > 0 %}
                                    <span class="absolute top-0 right-0 text-[11px] px-1.5
                                                 bg-red-600 text-white font-semibold rounded-full
                                                 border border-white shadow">
                                        {{ p.quantity }}
                                    </span>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="relative flex items-center justify-center bg-white rounded border border-slate-200 overflow-hidden">
                                {% if p.image %}
                                    <img src="{{ p.image }}
                                         " title="{{ p.sku }}"
                                         class="max-w-full max-h-full object-contain rounded">
                                {% endif %}

                                {% if p.quantity > 0 %}
                                    <span class="absolute top-0 right-0 text-[11px] px-1.5
                                                 bg-red-600 text-white font-semibold rounded-full
                                                 border border-white shadow">
                                        {{ p.quantity }}
                                    </span>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

            {% else %}
                <div class="grid grid-cols-2 grid-rows-2 w-full h-full gap-0.5 p-0.5">
                    {% for p in prods|slice:":4" %}
                        <div class="relative flex items-center justify-center bg-white rounded border border-slate-200 overflow-hidden">
                            {% if p.image %}
                                <img src="{{ p.image }}"
                                     title="{{ p.sku }}"
                                     class="max-w-full max-h-full object-contain rounded">
                            {% endif %}

                            {% if p.quantity > 0 %}
                                <span class="absolute top-0 right-0 text-[11px] px-1.5
                                             bg-red-600 text-white font-semibold rounded-full
                                             border border-white shadow">
                                    {{ p.quantity }}
                                </span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

        {% endwith %}
    </div>
</div>


                                    <div class="flex-1">
    <!-- Tag tất cả phân loại trong đơn -->
    <div class="mt-1 text-[11px] text-slate-500">
        <div class="mt-1 flex flex-wrap gap-1">
            {% for p in order.products %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-full border border-slate-200 bg-slate-50 text-[11px] text-slate-700">
                    {{ p.sku }}
                </span>
            {% endfor %}
        </div>
    </div>
</div>

                                </div>

                                <!-- Mã đơn hàng -->
                                <div class="flex flex-col justify-center">
                                    <p class="text-[13px] font-semibold text-sky-700">
                                        {{ order.channel_order_number }}
                                    </p>
                                    <p class="mt-1 text-xs text-slate-500">
                                        Mã Sapo: {{ order.sapo_order_code }}
                                    </p>
                                    <!-- Shop / Brand -->
<div class="flex items-center gap-2 mt-1">

    {# Chuẩn hoá tên shop về chữ thường, tránh None #}
    {% with shop_lower=order.shop_name|default_if_none:""|lower %}

        {# LOGO THEO BRAND #}
        <img
            src="{% if 'lteng' in shop_lower %}
                    /static/logo-lteng.jpg
                  {% elif 'phaledo' in shop_lower %}
                    /static/logo-phaledo.jpg
                  {% else %}
                    /static/giaodiensang.png
                  {% endif %}"
            class="w-5 h-5 rounded-sm border border-slate-200 object-contain bg-white"
            alt="logo"
        >

        {# NỀN / VIỀN / MÀU CHỮ THEO BRAND #}
        <span
            class="px-2 py-0.5 text-[11px] font-medium rounded border
                   {% if 'lteng' in shop_lower %}
                       bg-orange-50 border-orange-300 text-orange-700
                   {% elif 'phaledo' in shop_lower %}
                       bg-amber-50 border-amber-300 text-amber-700
                   {% else %}
                       bg-sky-50 border-sky-300 text-sky-700
                   {% endif %}"
        >
            {{ order.shop_name }}
        </span>

    {% endwith %}

</div>




                                </div>

                                <!-- Người mua -->
                                <div class="flex flex-col justify-center">
                                    <p class="text-[13px] font-medium text-slate-800">
                                        {{ order.customer.user_name }}
                                    </p>
                                    <p class="mt-1 text-xs text-slate-500">
                                        {{ order.customer.full_name }}
                                    </p>
                                    <p class="mt-1 text-xs text-slate-500">
                                        {{ order.customer.district }}, {{ order.customer.city }}
                                    </p>
                                </div>

                                <!-- Đơn vị vận chuyển -->
<div class="flex flex-col justify-center">

    {# Logo DVVC + tên thương hiệu #}
    <div class="flex items-center gap-2">
        {% if order.shipping_carrier_name == 'GrabExpress' %}
            <img src="/static/grab-logo.png" class="w-8 h-auto rounded" />
        {% elif order.shipping_carrier_name == 'beDelivery' %}
            <img src="/static/bee-logo.jpeg" class="w-8 h-auto rounded" />
        {% elif order.shipping_carrier_name == 'AhaMove' %}
            <img src="/static/aha-logo.png" class="w-8 h-auto rounded" />
        {% elif order.shipping_carrier_name == 'SPX Instant' %}
            <img src="/static/spx_logo.png" class="w-8 h-auto rounded" />
        {% else %}
            <img src="/static/nowship.jpg" class="w-8 h-auto rounded" />
        {% endif %}

        <p class="text-[13px] font-medium text-slate-800">
            {{ order.shipping_carrier_name }}
        </p>
    </div>

    <p class="mt-1 text-xs text-slate-500">
        MVD: {{ order.tracking_code }}
    </p>
</div>


                                <!-- Thời gian & trạng thái -->
                                <div class="flex flex-col items-end justify-center text-right">
                                   <div class="flex items-center justify-end gap-2">
    <!-- Thời gian chuẩn -->
    <p class="text-[13px] font-medium text-slate-800">
        {{ order.issued_dt|date:"H:i d/m/Y" }}
    </p>

    <!-- Badge 'mấy giờ trước' -->
    <span class="inline-flex items-center px-2 py-0.5 text-[11px] font-medium
                 bg-yellow-50 text-yellow-700 border border-yellow-300 rounded">
        {{ order.issued_ago }}
    </span>
</div>



                                    {# Nhãn trạng thái giống Shopee #}
<div class="mt-2">
    {% if not order.tracking_code %}
        <div class="flex items-center gap-2">

            {# Nhãn #}
            <span class="inline-flex px-2 py-0.5 rounded text-[11px] font-semibold bg-red-50 text-red-600 border border-red-300">
                Chưa xử lý
            </span>

            {# Nút Tìm ship #}
            <button
                class="px-2 py-0.5 text-[11px] font-semibold border border-blue-400 text-blue-600 rounded hover:bg-blue-50 transition"
                onclick="timShip('{{ order.id }}')">
                Tìm ship
            </button>
            <button
                class="px-2 py-0.5 text-[11px] font-semibold border border-blue-400 text-blue-600 rounded hover:bg-blue-50 transition"
                onclick="inDon('{{ order.id }}')">
                In Đơn
            </button>
        </div>

        <p class="mt-1 text-xs text-slate-500 max-w-xs">
            Đơn chưa có mã vận đơn.
        </p>

    {% else %}
        <span class="inline-flex px-2 py-0.5 rounded text-[11px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-300">
            Đang tìm shipper
        </span>
        <button
                class="px-2 py-0.5 text-[11px] font-semibold border border-blue-400 text-blue-600 rounded hover:bg-blue-50 transition"
                onclick="inDon('{{ order.id }}')">
                In Đơn
            </button>

        <p class="mt-1 text-xs text-slate-500 max-w-xs">
            <b>Note</b>: Yêu cầu shipper chuyển trạng thái trước khi mang đơn đi.
        </p>
    {% endif %}
</div>

                                </div>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            {% else %}
                <div class="py-10 text-center text-sm text-slate-500">
                    Hiện chưa có đơn hoả tốc nào cần xử lý.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- File: templates/kho/orders/express.html -->
<script>
function timShip(mp_order_id) {
    if (!mp_order_id) return;

    const url = `/kho/orders/print_now/?ids=${mp_order_id}&print=no`;

    fetch(url, { method: "GET" })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                alert("Đã gửi yêu cầu tìm ship thành công!");
                location.reload();
            } else {
                let msg = "Không rõ lỗi";

                if (Array.isArray(data.errors) && data.errors.length > 0) {
                    const firstErr = data.errors[0];
                    msg = firstErr.error || `Đơn ${firstErr.channel_order_number || ""} lỗi`;
                } else if (data.message) {
                    msg = data.message;
                }
                alert("Gửi yêu cầu thất bại: " + msg);
            }
        })
        .catch(err => {
            alert("Lỗi hệ thống.");
            console.error(err);
        });
}
</script>
<script>
function inDon(mp_order_id) {
    if (!mp_order_id) return;
    const url = `/kho/orders/print_now/?ids=${mp_order_id}&print=yes`;
    window.open(url);
}
</script>

<script>
/**
 * Lọc tất cả đơn hàng theo nội dung nhập ở ô search.
 * So khớp trên toàn bộ text của từng dòng đơn (innerText).
 */
function filterOrders() {
    const input = document.getElementById('order-search-input');
    if (!input) return;

    const q = (input.value || '').trim().toLowerCase();
    const rows = document.querySelectorAll('.js-order-row');

    if (!rows.length) return;

    if (!q) {
        // Không nhập gì -> hiện tất cả
        rows.forEach(row => row.classList.remove('hidden'));
        return;
    }

    rows.forEach(row => {
        const text = (row.innerText || '').toLowerCase();
        if (text.includes(q)) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
}

// Nếu có sẵn ?q= trên URL thì load xong auto filter luôn
document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('order-search-input');
    if (input && (input.value || '').trim() !== '') {
        filterOrders();
    }
});
</script>

{% endblock %}
