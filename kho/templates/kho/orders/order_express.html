{% extends "kho/base_kho.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block overview %}
<section>
    <h1 class="text-lg font-semibold text-slate-800">Hoả Tốc Shopee</h1>
    <p class="text-xs text-gray-500 mt-1">Đơn hoả tốc & tự động tìm lại shipper khi hết thời hạn.</p>
</section>
{% endblock %}

{% block main_content %}
<style>
    /* Hiệu ứng gạch xanh lá chéo cho đơn đang tìm shipper (packing_status = 1) */
    .order-finding-shipper {
        position: relative;
        /* Nền trắng với sọc xanh lá nhạt chéo */
        background: repeating-linear-gradient(135deg,
                #ffffff 0px,
                #ffffff 8px,
                rgba(34, 197, 94, 0.08) 8px,
                rgba(34, 197, 94, 0.08) 10px);
    }

    /* Border xanh lá ở trên cho đơn đang tìm shipper */
    .order-finding-shipper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background-color: #22c55e;
        z-index: 9;
    }

    /* Badge "Đang tìm shipper" ở giữa dòng xanh lá */
    .order-finding-shipper::after {
        content: 'Đã in đơn';
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #22c55e;
        color: white;
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
        z-index: 10;
        white-space: nowrap;
        line-height: 1.2;
    }

    /* Hiệu ứng gạch đỏ chéo cho đơn đã đóng gói (packing_status >= 4) */
    .order-packed {
        position: relative;
        /* Nền trắng với sọc đỏ nhạt chéo */
        background: repeating-linear-gradient(135deg,
                #ffffff 0px,
                #ffffff 8px,
                rgba(239, 68, 68, 0.08) 8px,
                rgba(239, 68, 68, 0.08) 10px);
    }

    /* Border đỏ ở trên cho đơn đã đóng gói */
    .order-packed::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background-color: #ef4444;
        z-index: 9;
    }

    /* Badge "Đã gói" ở giữa dòng đỏ */
    .order-packed::after {
        content: 'Đã gói';
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ef4444;
        color: white;
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
        z-index: 10;
        white-space: nowrap;
        line-height: 1.2;
    }

    /* Style cho filter button active */
    .filter-express-btn.active {
        background-color: rgb(239 246 255);
        border-color: rgb(96 165 250);
        color: rgb(29 78 216);
        font-weight: 600;
    }
</style>
<div class="min-h-screen bg-slate-100">
    <!-- BỘ LỌC ĐƠN HỎA TỐC -->
    <div class="mb-3 bg-white rounded-lg shadow-sm border border-slate-200 p-3">
        <div class="flex items-center gap-1.5 flex-wrap">
            <span class="text-[11px] text-slate-600 font-medium mr-1">Loại đơn:</span>
            <button id="filter-express-all" 
                    class="filter-btn filter-express-btn active px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-[11px] text-slate-700 font-medium hover:bg-slate-100 transition"
                    data-filter-type="express"
                    data-filter-value="all">
                Tất cả (<span id="filter-express-all-count">0</span>)
            </button>
            <button id="filter-express-don-gap" 
                    class="filter-btn filter-express-btn px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-[11px] text-slate-700 font-medium hover:bg-slate-100 transition"
                    data-filter-type="express"
                    data-filter-value="don-gap">
                Đơn gấp (<span id="filter-express-don-gap-count">0</span>)
            </button>
            <button id="filter-express-don-trong-ngay" 
                    class="filter-btn filter-express-btn px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-[11px] text-slate-700 font-medium hover:bg-slate-100 transition"
                    data-filter-type="express"
                    data-filter-value="don-trong-ngay">
                Đơn trong ngày (<span id="filter-express-don-trong-ngay-count">0</span>)
            </button>
        </div>
    </div>

    <!-- Tiêu đề + filter -->
    <div class="mb-4 flex items-center justify-between">
        <div class="flex items-center gap-3 text-sm">
            <!-- Ô tìm kiếm mã đơn (tuỳ anh xử lý backend) -->
            <form method="get" class="relative">
                <input type="text" id="order-search-input" name="q" value="{{ request.GET.q }}"
                    placeholder="Tìm mã đơn / người mua" oninput="filterOrders()"
                    class="pl-8 pr-3 py-1.5 text-sm rounded border border-slate-200 bg-white focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-orange-500">
                <span class="absolute left-2 top-1.5 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z" />
                    </svg>
                </span>
            </form>
        </div>
    </div>

    <!-- Khung danh sách -->
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        <!-- Header cột -->
        <div class="flex items-center bg-slate-50 border-b border-slate-200 text-xs font-medium text-slate-600">
            <div class="w-10 flex items-center justify-center py-3">
                <input type="checkbox" class="rounded border-slate-300">
            </div>
            <div
                class="flex-1 grid grid-cols-[minmax(220px,2fr),minmax(140px,1.2fr),minmax(150px,1.2fr),minmax(170px,1.4fr),minmax(230px,1.6fr)] gap-4 px-4">
                <div>Sản phẩm</div>
                <div>Mã đơn hàng</div>
                <div>Người mua</div>
                <div>Đơn vị vận chuyển</div>
                <div class="text-right">Thời gian xác nhận &amp; trạng thái</div>
            </div>
        </div>

        {% if orders %}
        {% for order in orders %}
        {# Lấy sản phẩm đầu tiên cho phần thumbnail #}
        {% with first_product=order.products.0 %}
        {% with carrier_name=order.shipping_carrier_name|default:""|lower %}
        <div class="flex border-t border-slate-100 hover:bg-slate-50/60 js-order-row{% if order.packing_status == 3 %} order-finding-shipper{% elif order.packing_status >= 4 %} order-packed{% endif %}"
            data-order-id="{{ order.id }}"
            data-express-type="{% if 'trong ngày' in carrier_name or 'giao trong ngày' in carrier_name %}don-trong-ngay{% else %}don-gap{% endif %}">
            <!-- Checkbox -->
            <div class="w-10 flex items-start justify-center pt-4">
                <input type="checkbox" class="mt-1 rounded border-slate-300 js-order-checkbox"
                    data-order-id="{{ order.id }}">
            </div>

            <!-- Nội dung đơn -->
            <div class="flex-1 px-3 py-3">
                <div
                    class="grid grid-cols-[minmax(220px,2fr),minmax(140px,1.2fr),minmax(150px,1.2fr),minmax(170px,1.4fr),minmax(230px,1.6fr)] gap-4 text-sm">

                    <!-- Sản phẩm -->
                    <div class="flex gap-3">
                        <div class="shrink-0">
                            <div class="w-20 h-20 border border-slate-200 rounded bg-white overflow-hidden relative">
                                {% with prods=order.products %}

                                {% if prods|length == 1 %}
                                {% with p=prods.0 %}
                                {% if p.image %}
                                <div class="relative w-full h-full">
                                    <img src="{{ p.image }}" title="{{ p.sku }}"
                                        class="w-full h-full object-contain p-0.5 rounded border border-slate-200">

                                    {% if p.quantity > 0 %}
                                    <span class="absolute top-0 right-0 text-[11px] px-1.5
                                             bg-red-600 text-white font-semibold rounded-full
                                             border border-white shadow">
                                        {{ p.quantity }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endwith %}

                                {% elif prods|length == 2 %}
                                <div class="grid grid-cols-2 w-full h-full gap-0.5 p-0.5">
                                    {% for p in prods|slice:":2" %}
                                    <div
                                        class="relative flex items-center justify-center bg-white rounded border border-slate-200 overflow-hidden">
                                        {% if p.image %}
                                        <img src="{{ p.image }}" title="{{ p.sku }}"
                                            class="max-w-full max-h-full object-contain rounded">
                                        {% endif %}

                                        {% if p.quantity > 0 %}
                                        <span class="absolute top-0 right-0 text-[11px] px-1.5
                                             bg-red-600 text-white font-semibold rounded-full
                                             border border-white shadow">
                                            {{ p.quantity }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>

                                {% elif prods|length == 3 %}
                                <div class="grid grid-cols-2 grid-rows-2 w-full h-full gap-0.5 p-0.5">
                                    {% for p in prods|slice:":3" %}
                                    {% if forloop.first %}
                                    <div
                                        class="relative col-span-2 flex items-center justify-center bg-white rounded border border-slate-200 overflow-hidden">
                                        {% if p.image %}
                                        <img src="{{ p.image }}" title="{{ p.sku }}"
                                            class="max-w-full max-h-full object-contain rounded">
                                        {% endif %}

                                        {% if p.quantity > 0 %}
                                        <span class="absolute top-0 right-0 text-[11px] px-1.5
                                                 bg-red-600 text-white font-semibold rounded-full
                                                 border border-white shadow">
                                            {{ p.quantity }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div
                                        class="relative flex items-center justify-center bg-white rounded border border-slate-200 overflow-hidden">
                                        {% if p.image %}
                                        <img src="{{ p.image }}" title="{{ p.sku }}"
                                            class="max-w-full max-h-full object-contain rounded">
                                        {% endif %}

                                        {% if p.quantity > 0 %}
                                        <span class="absolute top-0 right-0 text-[11px] px-1.5
                                                 bg-red-600 text-white font-semibold rounded-full
                                                 border border-white shadow">
                                            {{ p.quantity }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>

                                {% else %}
                                <div class="grid grid-cols-2 grid-rows-2 w-full h-full gap-0.5 p-0.5">
                                    {% for p in prods|slice:":4" %}
                                    <div
                                        class="relative flex items-center justify-center bg-white rounded border border-slate-200 overflow-hidden">
                                        {% if p.image %}
                                        <img src="{{ p.image }}" title="{{ p.sku }}"
                                            class="max-w-full max-h-full object-contain rounded">
                                        {% endif %}

                                        {% if p.quantity > 0 %}
                                        <span class="absolute top-0 right-0 text-[11px] px-1.5
                                             bg-red-600 text-white font-semibold rounded-full
                                             border border-white shadow">
                                            {{ p.quantity }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                {% endwith %}
                            </div>
                        </div>


                        <div class="flex-1">
                            <!-- Tag tất cả phân loại trong đơn -->
                            <div class="mt-1 text-[11px] text-slate-500">
                                <div class="mt-1 flex flex-wrap gap-1">
                                    {% for p in order.products %}
                                    <span
                                        class="inline-flex items-center px-1.5 py-0.5 rounded-full border border-slate-200 bg-slate-50 text-[11px] text-slate-700">
                                        {{ p.sku }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Mã đơn hàng -->
                    <div class="flex flex-col justify-center">
                        <p class="text-[13px] font-semibold text-sky-700">
                            {{ order.channel_order_number }}
                        </p>
                        <p class="mt-1 text-xs text-slate-500">
                            Sapo: <a href="https://sisapsan.mysapogo.com/admin/orders/{{order.sapo_order_id}}"
                                target="_blank"> {{ order.sapo_order_code }} </a>
                        </p>
                        <!-- Shop / Brand -->
                        <div class="flex items-center gap-2 mt-1">

                            {# Chuẩn hoá tên shop về chữ thường, tránh None #}
                            {% with shop_lower=order.shop_name|default_if_none:""|lower %}

                            {# LOGO THEO BRAND #}
                            <img src="{% if 'lteng' in shop_lower %}
                    /static/logo-lteng.jpg
                  {% elif 'phaledo' in shop_lower %}
                    /static/logo-phaledo.jpg
                  {% else %}
                    /static/giaodiensang.png
                  {% endif %}" class="w-5 h-5 rounded-sm border border-slate-200 object-contain bg-white" alt="logo">

                            {# NỀN / VIỀN / MÀU CHỮ THEO BRAND #}
                            <span class="px-2 py-0.5 text-[11px] font-medium rounded border
                   {% if 'lteng' in shop_lower %}
                       bg-orange-50 border-orange-300 text-orange-700
                   {% elif 'phaledo' in shop_lower %}
                       bg-amber-50 border-amber-300 text-amber-700
                   {% else %}
                       bg-sky-50 border-sky-300 text-sky-700
                   {% endif %}">
                                {{ order.shop_name }}
                            </span>

                            {% endwith %}

                        </div>




                    </div>

                    <!-- Người mua -->
                    <div class="flex flex-col justify-center">
                        <p class="text-[13px] font-medium text-slate-800">
                            {% if order.customer and order.customer.user_name %}
                                {{ order.customer.user_name }}
                            {% else %}
                                {{ order.customer_name|default:"" }}
                            {% endif %}
                        </p>
                        <p class="text-[13px] font-medium text-slate-800">
                            {% if order.shipping_address_line %}
                                {{ order.shipping_address_line }}
                            {% elif order.customer and order.customer.addresses and order.customer.addresses.0 and order.customer.addresses.0.address1 %}
                                {{ order.customer.addresses.0.address1 }}
                            {% elif order.customer and order.customer.address %}
                                {{ order.customer.address }}
                            {% endif %}
                        </p>
                        <p class="mt-1 text-xs text-slate-500">
                            {% if order.customer and order.customer.district or order.customer and order.customer.city %}
                                {% if order.customer.district %}{{ order.customer.district }}{% endif %}{% if order.customer.district and order.customer.city %} - {% endif %}{% if order.customer.city %}{{ order.customer.city }}{% endif %}
                            {% endif %}
                        </p>
                    </div>

                    <!-- Đơn vị vận chuyển -->
                    <div class="flex flex-col justify-center">

                        {# Logo DVVC + tên thương hiệu #}
                        <div class="flex items-center gap-2">
                            {% if order.shipping_carrier_name == 'GrabExpress' %}
                            <img src="/static/grab-logo.png" class="w-8 h-auto rounded" />
                            {% elif order.shipping_carrier_name == 'beDelivery' %}
                            <img src="/static/bee-logo.jpeg" class="w-8 h-auto rounded" />
                            {% elif order.shipping_carrier_name == 'AhaMove' %}
                            <img src="/static/aha-logo.png" class="w-8 h-auto rounded" />
                            {% elif order.shipping_carrier_name == 'SPX Instant' %}
                            <img src="/static/spx_logo.png" class="w-8 h-auto rounded" />
                            {% else %}
                            <img src="/static/nowship.jpg" class="w-8 h-auto rounded" />
                            {% endif %}

                            <p class="text-[13px] font-medium text-slate-800">
                                {{ order.shipping_carrier_name }}
                            </p>
                        </div>

                        <p class="mt-1 text-xs text-slate-500">
                            MVD: {{ order.tracking_code }}
                        </p>
                    </div>


                    <!-- Thời gian & trạng thái -->
                    <div class="flex flex-col items-end justify-center text-right">
                        <div class="flex items-center justify-end gap-2">
                            <!-- Thời gian chuẩn -->
                            <p class="text-[13px] font-medium text-slate-800">
                                {{ order.issued_dt|date:"H:i d/m/Y" }}
                            </p>

                            <!-- Badge 'mấy giờ trước' -->
                            <span class="inline-flex items-center px-2 py-0.5 text-[11px] font-medium
                 bg-yellow-50 text-yellow-700 border border-yellow-300 rounded">
                                {{ order.issued_ago }}
                            </span>
                        </div>



                        {# Nhãn trạng thái giống Shopee #}
                        <div class="mt-2">
                            {% if not order.tracking_code %}
                            <div class="flex items-center gap-2">

                                {# Nhãn #}
                                <span
                                    class="inline-flex px-2 py-0.5 rounded text-[11px] font-semibold bg-red-50 text-red-600 border border-red-300">
                                    Chưa xử lý
                                </span>

                                {# Nút Tìm ship #}
                                <button
                                    class="px-2 py-0.5 text-[11px] font-semibold border border-blue-400 text-blue-600 rounded hover:bg-blue-50 transition"
                                    onclick="timShip('{{ order.id }}')">
                                    Tìm ship
                                </button>
                                <button
                                    class="px-2 py-0.5 text-[11px] font-semibold border border-blue-400 text-blue-600 rounded hover:bg-blue-50 transition"
                                    onclick="inDon('{{ order.id }}')">
                                    In Đơn
                                </button>
                            </div>

                            <p class="mt-1 text-xs text-slate-500 max-w-xs">
                                Đơn chưa có mã vận đơn.
                            </p>

                            {% else %}
                            <span
                                class="inline-flex px-2 py-0.5 rounded text-[11px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-300">
                                Đang tìm shipper
                            </span>
                            <button
                                class="px-2 py-0.5 text-[11px] font-semibold border border-blue-400 text-blue-600 rounded hover:bg-blue-50 transition"
                                onclick="inDon('{{ order.id }}')">
                                In Đơn
                            </button>

                            <p class="mt-1 text-xs text-slate-500 max-w-xs">
                                <b>Note</b>: Yêu cầu shipper chuyển trạng thái trước khi mang đơn đi.
                            </p>
                            {% endif %}
                        </div>

                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endwith %}
        {% endfor %}
        {% else %}
        <div class="py-10 text-center text-sm text-slate-500">
            Hiện chưa có đơn hoả tốc nào cần xử lý.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- File: templates/kho/orders/express.html -->
<script>
    /**
     * Xóa row đơn hàng khỏi DOM sau khi xử lý thành công
     */
    function removeOrderRow(orderId) {
        const row = document.querySelector(`.js-order-row[data-order-id="${orderId}"]`);
        if (row) {
            // Fade out animation
            row.style.transition = 'opacity 0.3s ease-out';
            row.style.opacity = '0';

            setTimeout(() => {
                row.remove();

                // Kiểm tra nếu không còn đơn nào
                const remainingRows = document.querySelectorAll('.js-order-row');
                if (remainingRows.length === 0) {
                    const container = document.querySelector('.bg-white.rounded-lg');
                    if (container) {
                        container.innerHTML = `
                        <div class="py-10 text-center text-sm text-slate-500">
                            ✅ Đã xử lý toàn bộ đơn hàng. Tuyệt vời!
                        </div>
                    `;
                    }
                }
            }, 300);
        }
    }

    /**
     * Hiển thị toast notification
     */
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 
        ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.transition = 'opacity 0.3s';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function timShip(mp_order_id) {
        if (!mp_order_id) return;

        // Sử dụng format=json endpoint theo logic mới của print_now
        const url = `/kho/orders/print_now/?ids=${mp_order_id}&print=no&format=json`;

        // Disable button to prevent double click
        const btn = event.target;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Đang xử lý...';

        fetch(url, { method: "GET" })
            .then(res => res.json())
            .then(data => {
                if (data.status === "ok") {
                    const successCount = data.success || 0;
                    const failedCount = data.failed || 0;
                    const total = data.total || 1;
                    
                    if (successCount > 0 && failedCount === 0) {
                        showToast('✅ Tìm ship thành công!', 'success');
                    } else if (successCount > 0 && failedCount > 0) {
                        showToast(`⚠️ Tìm ship: ${successCount}/${total} thành công, ${failedCount} thất bại`, 'error');
                    } else {
                        showToast('❌ Tìm ship thất bại', 'error');
                    }
                    
                    // Enable lại button sau khi xử lý
                    btn.disabled = false;
                    btn.textContent = originalText;
                } else {
                    let msg = "Không rõ lỗi";

                    if (Array.isArray(data.errors) && data.errors.length > 0) {
                        const firstErr = data.errors[0];
                        msg = firstErr.reason || firstErr.error || `Đơn ${firstErr.channel_order_number || ""} lỗi`;
                    } else if (data.message) {
                        msg = data.message;
                    }
                    showToast('❌ ' + msg, 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            })
            .catch(err => {
                showToast('❌ Lỗi hệ thống: ' + err.message, 'error');
                console.error('Error in timShip:', err);
                btn.disabled = false;
                btn.textContent = originalText;
            });
    }
</script>
<script>
    function inDon(mp_order_id) {
        if (!mp_order_id) return;

        // Mở tab mới với URL print_now theo logic mới (giống shopee_orders)
        const url = `/kho/orders/print_now/?ids=${encodeURIComponent(mp_order_id)}&print=yes`;
        const newWindow = window.open(url, '_blank');
        
        if (newWindow) {
            // Hiển thị toast thông báo
            showToast('✅ Đã mở trang in đơn!', 'success');
        } else {
            showToast('Vui lòng cho phép popup để mở trang in', 'error');
        }
    }
</script>

<script>
    // Bộ lọc đơn hỏa tốc
    let activeExpressFilter = null; // null = tất cả, 'don-gap' = đơn gấp, 'don-trong-ngay' = đơn trong ngày

    /**
     * Thu thập số lượng đơn theo express type
     */
    window.collectExpressData = function() {
        const allRows = document.querySelectorAll('.js-order-row');
        let totalCount = 0;
        let donGapCount = 0;
        let donTrongNgayCount = 0;

        allRows.forEach((row) => {
            const expressType = row.getAttribute('data-express-type') || '';
            totalCount++;
            
            if (expressType === 'don-gap') {
                donGapCount++;
            } else if (expressType === 'don-trong-ngay') {
                donTrongNgayCount++;
            }
        });

        return {
            total: totalCount,
            donGap: donGapCount,
            donTrongNgay: donTrongNgayCount
        };
    };

    /**
     * Cập nhật số đếm trên các button filter
     */
    window.updateExpressFilterCounts = function() {
        const data = window.collectExpressData();
        
        const allCount = document.getElementById('filter-express-all-count');
        const donGapCount = document.getElementById('filter-express-don-gap-count');
        const donTrongNgayCount = document.getElementById('filter-express-don-trong-ngay-count');
        
        if (allCount) allCount.textContent = data.total;
        if (donGapCount) donGapCount.textContent = data.donGap;
        if (donTrongNgayCount) donTrongNgayCount.textContent = data.donTrongNgay;
    };

    /**
     * Toggle filter khi click button
     */
    window.toggleExpressFilter = function(filterValue) {
        // Remove active class từ tất cả buttons
        document.querySelectorAll('.filter-express-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Set active class cho button được chọn
        const btn = document.querySelector(`.filter-express-btn[data-filter-value="${filterValue}"]`);
        if (btn) {
            btn.classList.add('active');
        }

        // Cập nhật filter active
        activeExpressFilter = filterValue === 'all' ? null : filterValue;

        // Áp dụng filter
        window.applyFilters();
    };

    /**
     * Áp dụng filter cho tất cả đơn hàng
     */
    window.applyFilters = function() {
        const rows = document.querySelectorAll('.js-order-row');
        const searchInput = document.getElementById('order-search-input');
        const searchQuery = searchInput ? (searchInput.value || '').trim().toLowerCase() : '';

        rows.forEach((row) => {
            // Check express type filter
            const expressType = row.getAttribute('data-express-type') || '';
            let matchesExpress = true;
            
            if (activeExpressFilter) {
                matchesExpress = expressType === activeExpressFilter;
            }

            // Check search query
            const rowText = (row.innerText || row.textContent || '').toLowerCase();
            const matchesSearch = !searchQuery || rowText.includes(searchQuery);

            // Show/hide row
            if (matchesExpress && matchesSearch) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        });
    };

    /**
     * Khởi tạo filter buttons với event listeners
     */
    window.initExpressFilters = function() {
        // Set click handlers cho các button
        document.querySelectorAll('.filter-express-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filterValue = this.getAttribute('data-filter-value');
                window.toggleExpressFilter(filterValue);
            });
        });

        // Cập nhật số đếm
        window.updateExpressFilterCounts();
    };

    // Khởi tạo khi DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            window.initExpressFilters();
        }, 100);
    });

    /**
     * Lọc tất cả đơn hàng theo nội dung nhập ở ô search.
     * So khớp trên toàn bộ text của từng dòng đơn (innerText hoặc textContent).
     */
    function filterOrders() {
        // Sử dụng hàm applyFilters để áp dụng cả search và express filter
        window.applyFilters();
    }

    // Nếu có sẵn ?q= trên URL thì load xong auto filter luôn
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('order-search-input');
        if (input && (input.value || '').trim() !== '') {
            filterOrders();
        }
    });
</script>
{% endblock %}