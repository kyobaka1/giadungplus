{% extends "kho/base_kho.html" %}
{% load static %}
{% load humanize %}
{% load kho_filters %}

{% block title %}Th·ªëng K√™ Kho - Gia D·ª•ng Plus {% endblock %}

{% block overview %}
<section>
    <h1 class="text-lg font-semibold text-slate-800">Th·ªëng k√™ kho h√†ng</h1>
    <p class="text-xs text-gray-500 mt-1">Dashboard th·ªëng k√™ ho·∫°t ƒë·ªông kho h√†ng, doanh s·ªë ƒë∆°n g√≥i, hi·ªáu su·∫•t nh√¢n vi√™n</p>
</section>
{% endblock %}

{% block main_content %}
<div class="min-h-screen bg-slate-100 space-y-6 p-4">
    
    <!-- Form ch·ªçn th·ªùi gian -->
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
        <form method="get" id="myform" class="flex flex-wrap items-center gap-3">
            <label class="text-sm text-slate-600 whitespace-nowrap">B·∫Øt ƒë·∫ßu:</label>
            <input name="time" type="datetime-local" 
                   class="px-4 py-2 border border-slate-300 rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" 
                   value="{% if start_date %}{{ start_date|date:'Y-m-d' }}T{{ start_date|date:'H:i' }}{% endif %}">
            <label class="text-sm text-slate-600 whitespace-nowrap">K·∫øt th√∫c:</label>
            <input name="end_time" type="datetime-local" 
                   class="px-4 py-2 border border-slate-300 rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" 
                   value="{% if end_date %}{{ end_date|date:'Y-m-d' }}T{{ end_date|date:'H:i' }}{% endif %}">
            <button class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 text-sm font-medium whitespace-nowrap" type="submit">
                Xem b√°o c√°o
            </button>
            
            <div class="flex items-center gap-2 ml-auto">
                <a href="?time=today" 
                   class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 whitespace-nowrap {% if time_filter == 'today' %}bg-emerald-50 border-emerald-500 text-emerald-700 font-semibold{% else %}bg-white text-slate-700{% endif %}">
                    Ng√†y h√¥m nay
                </a>
                <a href="?time=yesterday" 
                   class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 whitespace-nowrap {% if time_filter == 'yesterday' %}bg-emerald-50 border-emerald-500 text-emerald-700 font-semibold{% else %}bg-white text-slate-700{% endif %}">
                    Ng√†y h√¥m qua
                </a>
                <a href="?time=7days" 
                   class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 whitespace-nowrap {% if time_filter == '7days' %}bg-emerald-50 border-emerald-500 text-emerald-700 font-semibold{% else %}bg-white text-slate-700{% endif %}">
                    7 ng√†y
                </a>
                <a href="?time=30days" 
                   class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 whitespace-nowrap {% if time_filter == '30days' %}bg-emerald-50 border-emerald-500 text-emerald-700 font-semibold{% else %}bg-white text-slate-700{% endif %}">
                    30 ng√†y
                </a>
            </div>
        </form>
    </div>

    <!-- H√ÄNG NGANG ƒê·∫¶U TI√äN - 4 C·ªòT -->
    {% if stats %}
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
        <div class="mb-4">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                <i class="text-emerald-600">üìä</i>
                K·∫øt qu·∫£ ho·∫°t ƒë·ªông kho h√†ng
            </h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- C·ªôt 1: T·ªïng ƒë∆°n h√†ng ƒë√£ g√≥i -->
            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="w-6 h-6 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
                    <span class="text-xs">üì¶</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs text-slate-600 uppercase font-medium mb-1">T·ªîNG ƒê∆†N H√ÄNG ƒê√É G√ìI</div>
                    <div class="text-2xl font-bold text-slate-800">{{ stats.sum_data.sodonhang|default:0|intcomma }} ƒë∆°n</div>
                    <div class="text-sm text-slate-600 mt-1">
                        S·∫£n ph·∫©m: {{ stats.sum_data.sosanpham|default:0|intcomma }} 
                        ({{ stats.ty_le_sp_don|default:0|floatformat:2 }} / ƒë∆°n)
                    </div>
                </div>
            </div>
            
            <!-- C·ªôt 2: Doanh s·ªë -->
            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="w-6 h-6 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <span class="text-xs">üí∞</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs text-slate-600 uppercase font-medium mb-1">DOANH S·ªê</div>
                    <div class="text-2xl font-bold text-slate-800">{{ stats.doanhso_shipment|default:0|format_currency }} ‚Ç´</div>

                </div>
            </div>
            
            <!-- C·ªôt 3: Hi·ªáu su·∫•t l√†m vi·ªác -->
            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                    <span class="text-xs">‚ö°</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs text-slate-600 uppercase font-medium mb-1">HI·ªÜU SU·∫§T L√ÄM VI·ªÜC</div>
                    <div class="text-2xl font-bold text-slate-800">{{ stats.hieu_suat.doanhso_h|default:0|format_currency }} ‚Ç´/h</div>
                    <div class="text-sm text-slate-600 mt-1">
                        T·ªïng {{ stats.hieu_suat.tong_gio|default:0|intcomma }} gi·ªù: {{ stats.hieu_suat.doanhso_h|default:0|format_currency }} ‚Ç´/h
                    </div>
                </div>
            </div>
            
            <!-- C·ªôt 4: T·ªïng ticket -->
            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0">
                    <span class="text-xs">üé´</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs text-slate-600 uppercase font-medium mb-1">T·ªîNG TICKET</div>
                    <div class="text-2xl font-bold text-slate-800">{{ stats.ticket_stats.total|default:0|intcomma }}</div>
                    <div class="text-sm text-slate-600 mt-1">
                        Ch∆∞a x·ª≠ l√Ω: {{ stats.ticket_stats.unprocessed|default:0|intcomma }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- H√ÄNG NGANG TH·ª® HAI - 2 C·ªòT -->
    {% if stats %}
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- C·ªôt 1: X·ª≠ l√Ω ƒë∆°n -->
            <div>
                <h3 class="text-base font-semibold text-slate-800 mb-2">X·ª≠ l√Ω ƒë∆°n</h3>
                <p class="text-xs text-slate-600 mb-4">T·ªïng quan v·ªÅ x·ª≠ l√Ω ƒë∆°n h√†ng</p>
                
                <!-- T·ªïng s·ªë ƒë∆°n v√† thanh progress -->
                {% with total_don=stats.don_chua_goi.total_don_can_xu_ly_hom_nay|default:0 %}
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium text-slate-700">T·ªïng s·ªë ƒë∆°n c·∫ßn x·ª≠ l√Ω h√¥m nay</div>
                        <div class="text-lg font-bold text-slate-800">{{ total_don|intcomma }} ƒë∆°n</div>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-3">
                        <div class="bg-emerald-600 h-3 rounded-full transition-all duration-300" 
                             style="width: {{ stats.don_da_goi.percent|default:0 }}%">
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-1 text-xs text-slate-600">
                        <span>ƒê√£ g√≥i: {{ stats.don_da_goi.sodonhang|default:0|intcomma }} ƒë∆°n ({{ stats.don_da_goi.percent|default:0|floatformat:1 }}%)</span>
                        <span>Ch∆∞a g√≥i: {{ stats.don_chua_goi.sodonhang_hom_nay|default:0|intcomma }} ƒë∆°n ({{ stats.don_chua_goi.percent|default:0|floatformat:1 }}%)</span>
                    </div>
                </div>
                {% endwith %}
                
                <!-- Deadline stats - 1 h√†ng -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 text-center">
                        <div class="text-xs text-slate-600 mb-1">Giao tr∆∞·ªõc 12H</div>
                        <div class="text-sm font-bold text-slate-800">{{ stats.deadline_stats.before_12h.sodonhang|default:0|intcomma }}</div>
                        <div class="text-xs text-slate-500 mt-1">{{ stats.deadline_stats.before_12h.doanhso|default:0|format_currency }} ‚Ç´</div>
                    </div>
                    
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 text-center">
                        <div class="text-xs text-slate-600 mb-1">Giao tr∆∞·ªõc 24H</div>
                        <div class="text-sm font-bold text-slate-800">{{ stats.deadline_stats.before_24h.sodonhang|default:0|intcomma }}</div>
                        <div class="text-xs text-slate-500 mt-1">{{ stats.deadline_stats.before_24h.doanhso|default:0|format_currency }} ‚Ç´</div>
                    </div>
                    
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 text-center">
                        <div class="text-xs text-slate-600 mb-1">Tr∆∞a mai</div>
                        <div class="text-sm font-bold text-slate-800">{{ stats.deadline_stats.trua_mai.sodonhang|default:0|intcomma }}</div>
                        <div class="text-xs text-slate-500 mt-1">{{ stats.deadline_stats.trua_mai.doanhso|default:0|format_currency }} ‚Ç´</div>
                    </div>
                </div>
            </div>
            
            <!-- C·ªôt 2: Hi·ªáu su·∫•t trong ng√†y -->
            <div>
                <h3 class="text-base font-semibold text-slate-800 mb-2">Hi·ªáu su·∫•t trong ng√†y</h3>
                <p class="text-xs text-slate-600 mb-4">Ph√¢n b·ªï theo m·ªëc th·ªùi gian g√≥i h√†ng</p>
                
                <!-- Bi·ªÉu ƒë·ªì ƒë√≥ng g√≥i theo gi·ªù -->
                <div id="hourlyChart" style="width: 100%; height: 200px;"></div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- H√ÄNG D·ªÆ LI·ªÜU TH·ª® 3 - 3 C·ªòT -->
    {% if stats %}
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- C·ªôt 1: Categories (2/5) -->
            <div class="lg:col-span-2">
                <h3 class="text-base font-semibold text-slate-800 mb-2">Categories</h3>
                <p class="text-xs text-slate-600 mb-4">Ph√¢n lo·∫°i s·∫£n ph·∫©m ƒë√£ g√≥i theo ƒë·ªô kh√≥</p>
                
                <!-- Flex categories - hi·ªÉn th·ªã h·∫øt n·ªôi dung -->
                <div class="flex flex-wrap gap-2">
                    {% for cat_name, cat_data in stats.per_category.items|slice:":9" %}
                    {% with forloop.counter0|add:0 as index %}
                    <div class="p-2 bg-slate-50 rounded border border-slate-200 flex-shrink-0">
                        <!-- Header v·ªõi ch·∫•m m√†u v√† t√™n category -->
                        <div class="flex items-center gap-1.5 mb-1">
                            <!-- Ch·∫•m m√†u -->
                            <div class="w-2 h-2 rounded-full flex-shrink-0
                                {% if index == 0 %}bg-purple-500
                                {% elif index == 1 %}bg-blue-400
                                {% elif index == 2 %}bg-green-500
                                {% elif index == 3 %}bg-red-500
                                {% elif index == 4 %}bg-yellow-500
                                {% elif index == 5 %}bg-cyan-500
                                {% elif index == 6 %}bg-pink-500
                                {% elif index == 7 %}bg-purple-400
                                {% else %}bg-teal-400
                                {% endif %}">
                            </div>
                            <!-- T√™n category v√† ph·∫ßn trƒÉm -->
                            <div class="flex items-center gap-1">
                                <span class="text-xs font-medium text-slate-800">{{ cat_name }}</span>
                                <span class="text-xs font-bold text-red-600">({{ cat_data.percent|default:0|floatformat:2 }}%)</span>
                            </div>
                            <!-- Label TOP cho category ƒë·∫ßu ti√™n -->
                            {% if forloop.first %}
                            <span class="px-1.5 py-0.5 text-[10px] font-semibold text-white bg-blue-500 rounded-full whitespace-nowrap ml-1">TOP</span>
                            {% endif %}
                        </div>
                        <!-- Doanh s·ªë v√† s·ªë s·∫£n ph·∫©m -->
                        <div class="text-xs text-slate-700">
                            <span class="font-medium">{{ cat_data.doanhso|default:0|format_currency }}‚Ç´</span>
                            <span class="text-[10px] text-slate-600"> - {{ cat_data.sosanpham|default:0|intcomma }} sp</span>
                        </div>
                    </div>
                    {% endwith %}
                    {% empty %}
                    <div class="w-full text-center py-4 text-slate-500 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- C·ªôt 2: Giao ƒë√∫ng h·∫°n (1/5) -->
            <div class="lg:col-span-1">
                <h3 class="text-base font-semibold text-slate-800 mb-2">Giao ƒë√∫ng h·∫°n</h3>
                <p class="text-xs text-slate-600 mb-4">Qu·∫£n l√Ω giao ƒë√∫ng h·∫°n m√† s√†n ƒë∆∞a ra</p>
                
                <div class="space-y-3">
                    <!-- Ch∆∞a giao, tr·ªÖ ‚ö†Ô∏è -->
                    <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-amber-800">Ch∆∞a giao, tr·ªÖ ‚ö†Ô∏è</span>
                            <span class="text-sm font-bold text-amber-800">{{ stats.delivery_stats.not_shipped_late.percent|default:0|floatformat:2 }}%</span>
                        </div>
                        <div class="text-xs text-amber-600">{{ stats.delivery_stats.not_shipped_late.sodonhang|default:0|intcomma }} ƒë∆°n</div>
                    </div>
                    
                    <!-- ƒê√£ giao, tr·ªÖ ‚è∞ -->
                    <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-orange-800">ƒê√£ giao, tr·ªÖ ‚è∞</span>
                            <span class="text-sm font-bold text-orange-800">{{ stats.delivery_stats.shipped_late.percent|default:0|floatformat:2 }}%</span>
                        </div>
                        <div class="text-xs text-orange-600">{{ stats.delivery_stats.shipped_late.sodonhang|default:0|intcomma }} ƒë∆°n</div>
                    </div>
                    
                    <!-- Giao ƒë√∫ng h·∫°n ‚úÖ -->
                    <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-emerald-800">Giao ƒë√∫ng h·∫°n ‚úÖ</span>
                            <span class="text-sm font-bold text-emerald-800">{{ stats.delivery_stats.shipped_on_time.percent|default:0|floatformat:2 }}%</span>
                        </div>
                        <div class="text-xs text-emerald-600">{{ stats.delivery_stats.shipped_on_time.sodonhang|default:0|intcomma }} ƒë∆°n</div>
                    </div>
                </div>
            </div>
            
            <!-- C·ªôt 3: ƒê∆°n l·ªói/sai s√≥t (2/5) -->
            <div class="lg:col-span-2">
                <h3 class="text-base font-semibold text-slate-800 mb-2">ƒê∆°n l·ªói/ sai s√≥t</h3>
                <p class="text-xs text-slate-600 mb-4">T·ªâ l·ªá/ thi·ªát h·∫°i v√† ph√¢n lo·∫°i l√Ω do</p>
                
                <div class="space-y-3">
                    <!-- T·ªïng thi·ªát h·∫°i -->
                    <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                        <div class="text-sm text-red-700 mb-1">T·ªïng thi·ªát h·∫°i (s·ªë ƒë∆°n h√†ng)</div>
                        <div class="text-2xl font-bold text-red-800">{{ stats.error_stats.total_damage|default:0|intcomma }}</div>
                        <div class="text-xs text-red-600 mt-1">T·ªïng s·ªë ƒë∆°n: {{ stats.error_stats.total_orders|default:0|intcomma }}</div>
                    </div>
                    
                    <!-- Ph√¢n lo·∫°i theo l√Ω do -->
                    {% if stats.error_stats.by_reason %}
                    <div class="mt-4">
                        <div class="text-sm font-medium text-slate-700 mb-2">Ph√¢n lo·∫°i theo l√Ω do:</div>
                        <div class="space-y-2">
                            {% for reason, count in stats.error_stats.by_reason.items %}
                            <div class="flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-200">
                                <span class="text-sm text-slate-800">{{ reason }}</span>
                                <span class="text-sm font-bold text-slate-800">{{ count|intcomma }} ƒë∆°n</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-slate-500 text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- H√ÄNG D·ªÆ LI·ªÜU TH·ª® 4 - Hi·ªáu su·∫•t nh√¢n s·ª± (1/2 c·ªôt) -->
    {% if stats %}
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- C·ªôt 1: Hi·ªáu su·∫•t nh√¢n s·ª± -->
            <div>
                <div class="mb-4">
                    <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                        <i class="text-emerald-600">üë•</i>
                        Hi·ªáu su·∫•t nh√¢n s·ª±
                    </h2>
                    <p class="text-xs text-slate-600 mt-1">Gi√°m s√°t hi·ªáu qu·∫£ s·ª≠ d·ª•ng nh√¢n s·ª±</p>
                </div>
                
                <!-- B·∫£ng hi·ªáu su·∫•t nh√¢n s·ª± -->
                <div class="space-y-2">
                    {% for user_name, user_data in stats.per_user.items %}
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 {% if user_name == stats.top1_doanhso_user|default:'' or user_name == stats.top1_hieu_suat_user|default:'' %}ring-2 ring-yellow-400 ring-opacity-50 shadow-md{% endif %}">
                        <div class="grid grid-cols-10 gap-3">
                            <!-- C·ªôt 1: Th√¥ng tin v√† ch·ªâ s·ªë (70% = 7/10) -->
                            <div class="col-span-7">
                                <!-- Header: Avatar v√† t√™n nh√¢n s·ª± -->
                                <div class="flex items-center gap-2 mb-2">
                                    <!-- Avatar -->
                                    {% with username=user_data.username|default:'chuaco' %}
                                    <img src="/static/nhanvien/{{ username }}.png" 
                                         alt="{{ user_data.real_name|default:user_name }}"
                                         class="w-10 h-10 rounded-full object-cover border-2 {% if user_name == stats.top1_doanhso_user|default:'' or user_name == stats.top1_hieu_suat_user|default:'' %}border-yellow-400 shadow-lg{% else %}border-slate-300{% endif %}"
                                         onerror="this.src='/static/nhanvien/chuaco.png'">
                                    {% endwith %}
                                    <!-- T√™n v√† tags -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-1.5 flex-wrap">
                                            {% if user_data.kho_name %}
                                            <span class="px-1.5 py-0.5 text-[10px] font-semibold text-white bg-blue-500 rounded">{{ user_data.kho_name }}</span>
                                            {% endif %}
                                            <span class="text-sm font-semibold text-slate-800">{{ user_data.real_name|default:user_name }}</span>
                                            
                                            {% comment %} Badge TOP 1 DOANH S·ªê {% endcomment %}
                                            {% if user_name == stats.top1_doanhso_user|default:'' %}
                                            <span class="inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-bold text-white rounded-full bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600 shadow-lg transform hover:scale-105 transition-all duration-200 animate-pulse">
                                                <span class="text-xs">üèÜ</span>
                                                <span>TOP 1 DOANH S·ªê</span>
                                            </span>
                                            {% endif %}
                                            
                                            {% comment %} Badge TOP 1 HI·ªÜU SU·∫§T {% endcomment %}
                                            {% if user_name == stats.top1_hieu_suat_user|default:'' %}
                                            <span class="inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-bold text-white rounded-full bg-gradient-to-r from-emerald-400 via-emerald-500 to-emerald-600 shadow-lg transform hover:scale-105 transition-all duration-200 animate-pulse">
                                                <span class="text-xs">‚ö°</span>
                                                <span>TOP 1 HI·ªÜU SU·∫§T</span>
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Th√¥ng tin ch√≠nh: Gi·ªù l√†m, G√≥i ƒë∆∞·ª£c, Doanh s·ªë, Hi·ªáu su·∫•t -->
                                <div class="grid grid-cols-4 gap-2">
                                    <div>
                                        <div class="text-[10px] text-slate-600 mb-0.5">Gi·ªù l√†m</div>
                                        <div class="text-xs font-bold text-slate-800">{{ user_data.working_hours|default:0|floatformat:1 }}h</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-600 mb-0.5">G√≥i ƒë∆∞·ª£c</div>
                                        <div class="text-xs font-bold text-slate-800">{{ user_data.total_order|default:0|intcomma }}</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-600 mb-0.5">Doanh s·ªë</div>
                                        <div class="text-xs font-bold text-slate-800">{{ user_data.total_money|default:0|format_currency }}‚Ç´</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-600 mb-0.5">Hi·ªáu su·∫•t</div>
                                        <div class="text-xs font-bold text-emerald-600">{{ user_data.efficiency|default:0|intcomma }}‚Ç´/h</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- C·ªôt 2: Xu h∆∞·ªõng ph√¢n lo·∫°i g√≥i (30% = 3/10) -->
                            <div class="col-span-3 border-l border-slate-300 pl-3">
                                {% if user_data.top3_categories %}
                                <div class="space-y-1.5">
                                    {% for cat in user_data.top3_categories %}
                                    <div class="inline-flex items-center px-2 py-1 text-xs font-medium text-slate-800 bg-white border border-slate-300 rounded-md shadow-sm">
                                        <span class="mr-1.5">{{ cat.name }}</span>
                                        <span class="font-bold text-slate-600">{{ cat.percent }}%</span>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-[10px] text-slate-400">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4 text-slate-500 text-xs">
                        <p>Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™ nh√¢n s·ª±</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- C·ªôt 2: ƒê·ªÉ tr·ªëng -->
            <div></div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Form handling
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('myform');
    const timeInput = document.querySelector('input[name="time"]');
    const endTimeInput = document.querySelector('input[name="end_time"]');
    
    // Clear datetime inputs when clicking filter buttons
    const filterLinks = document.querySelectorAll('a[href*="?time="]');
    filterLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (timeInput) timeInput.value = '';
            if (endTimeInput) endTimeInput.value = '';
        });
    });
    
    // When submitting form with datetime, remove time filter from form data
    if (form) {
        form.addEventListener('submit', function(e) {
            // If datetime inputs have values, remove time filter from URL params
            if (timeInput && timeInput.value && endTimeInput && endTimeInput.value) {
                // Remove time filter from URL if present
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('time') && ['today', 'yesterday', '7days', '30days'].includes(urlParams.get('time'))) {
                    urlParams.delete('time');
                    const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                    form.action = newUrl;
                }
            }
        });
    }
});

// Bi·ªÉu ƒë·ªì theo gi·ªù
{% if stats and hourly_data_json %}
document.addEventListener('DOMContentLoaded', function() {
    var hourlyData = {{ hourly_data_json|safe }};
    var hourlyCategories = {{ hourly_categories_json|safe }};
    
    var options = {
        series: [{
            name: "ƒê√£ g√≥i",
            data: hourlyData
        }],
        chart: {
            height: 200,
            type: 'line',
            dropShadow: {
                enabled: true,
                color: '#000',
                top: 18,
                left: 7,
                blur: 10,
                opacity: 0.2
            },
            zoom: {
                enabled: false
            },
            toolbar: {
                show: false
            }
        },
        colors: ['#10b981'],
        dataLabels: {
            enabled: true,
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        grid: {
            borderColor: '#e7e7e7',
            row: {
                colors: ['#f3f3f3', 'transparent'],
                opacity: 0.5
            },
        },
        markers: {
            size: 4
        },
        xaxis: {
            categories: hourlyCategories,
            title: {
                text: 'Theo gi·ªù'
            }
        },
        yaxis: {
            title: {
                text: 'S·ªë ƒë∆°n ƒë√£ g√≥i'
            },
            min: 0
        },
        legend: {
            position: 'top',
            horizontalAlign: 'right',
            floating: true,
            offsetY: -25,
            offsetX: -5
        }
    };

    var chart = new ApexCharts(document.querySelector("#hourlyChart"), options);
    chart.render();
});
{% endif %}
</script>
{% endblock %}
