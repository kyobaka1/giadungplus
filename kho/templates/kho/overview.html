{% extends "kho/base_kho.html" %}
{% load static %}
{% load humanize %}

{% block title %}Th·ªëng K√™ Kho - Gia D·ª•ng Plus {% endblock %}

{% block overview %}
<section>
    <h1 class="text-lg font-semibold text-slate-800">Th·ªëng k√™ kho h√†ng</h1>
    <p class="text-xs text-gray-500 mt-1">Dashboard th·ªëng k√™ ho·∫°t ƒë·ªông kho h√†ng, doanh s·ªë ƒë∆°n g√≥i, hi·ªáu su·∫•t nh√¢n vi√™n</p>
</section>
{% endblock %}

{% block main_content %}
<div class="min-h-screen bg-slate-100 space-y-6 p-4">
    
    <!-- Form ch·ªçn th·ªùi gian -->
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
        <form method="get" id="myform" class="flex flex-wrap items-center gap-3">
            <input name="time" type="text" class="px-4 py-2 border border-slate-300 rounded-md bg-white text-sm" 
                   autocomplete="off" data-toggle="datepicker" placeholder="B·∫Øt ƒë·∫ßu" readonly>
            <input name="end_time" type="text" class="px-4 py-2 border border-slate-300 rounded-md bg-white text-sm" 
                   autocomplete="off" data-toggle="datepicker" placeholder="K·∫øt th√∫c" readonly>
            <button class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 text-sm font-medium" type="submit">
                Xem b√°o c√°o
            </button>
        </form>
        
        <div class="mt-3 flex flex-wrap gap-2">
            <a href="?time=today" 
               class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 {% if time_filter == 'today' %}bg-emerald-50 border-emerald-500 text-emerald-700 font-semibold{% else %}bg-white text-slate-700{% endif %}">
                Ng√†y h√¥m nay
            </a>
            <a href="?time=yesterday" 
               class="px-3 py-1.5 text-sm border border-slate-300 rounded-md hover:bg-slate-50 {% if time_filter == 'yesterday' %}bg-emerald-50 border-emerald-500 text-emerald-700 font-semibold{% else %}bg-white text-slate-700{% endif %}">
                Ng√†y h√¥m qua
            </a>
        </div>
    </div>

    <!-- K·∫øt qu·∫£ ho·∫°t ƒë·ªông kho h√†ng - T·ªïng quan -->
    {% if stats %}
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
        <div class="mb-4">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                <i class="text-emerald-600">üìä</i>
                K·∫øt qu·∫£ ho·∫°t ƒë·ªông kho h√†ng
            </h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- S·ªë ƒë∆°n ƒë√£ g√≥i -->
            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg">
                <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center">
                    <span class="text-2xl">üì¶</span>
                </div>
                <div class="flex-1">
                    <div class="text-xs text-slate-600 uppercase font-medium mb-1">S·ªê ƒê∆†N ƒê√É G√ìI</div>
                    <div class="text-2xl font-bold text-slate-800">{{ stats.sum_data.sodonhang|default:0|intcomma }}</div>
                    <div class="text-xs text-slate-500 mt-1">ƒë∆°n h√†ng</div>
                </div>
            </div>
            
            <!-- T·ªïng doanh s·ªë -->
            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                    <span class="text-2xl">üí∞</span>
                </div>
                <div class="flex-1">
                    <div class="text-xs text-slate-600 uppercase font-medium mb-1">T·ªîNG DOANH S·ªê</div>
                    <div class="text-2xl font-bold text-slate-800">{{ stats.sum_data.doanhso|default:0|intcomma }}</div>
                    <div class="text-xs text-slate-500 mt-1">vi·ªát nam ƒë·ªìng</div>
                </div>
            </div>
            
            <!-- T·ªïng s·∫£n ph·∫©m -->
            <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg">
                <div class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center">
                    <span class="text-2xl">üéÅ</span>
                </div>
                <div class="flex-1">
                    <div class="text-xs text-slate-600 uppercase font-medium mb-1">T·ªîNG S·∫¢N PH·∫®M</div>
                    <div class="text-2xl font-bold text-emerald-600">{{ stats.sum_data.sosanpham|default:0|intcomma }}</div>
                    <div class="text-xs text-slate-500 mt-1">s·∫£n ph·∫©m</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Th·ªëng k√™ theo kho -->
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
        <div class="mb-4">
            <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                <i class="text-emerald-600">üè¢</i>
                {% if current_kho == 'geleximco' %}KHO GELEXIMCO - H√Ä N·ªòI{% else %}KHO T√î K√ù - S√ÄI G√íN{% endif %}
            </h2>
        </div>
        
        <!-- C·∫ßn g√≥i -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                <div class="text-sm text-slate-700 mb-1">C·∫ßn g√≥i h√¥m nay</div>
                <div class="text-2xl font-bold text-emerald-700">
                    {{ stats.pending_sum.sodonhang|default:0|intcomma }}
                </div>
                <div class="text-xs text-slate-600 mt-1">S·ªë ƒë∆°n</div>
            </div>
            
            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="text-sm text-slate-700 mb-1">C·∫ßn g√≥i (ƒë∆°n sau 18h)</div>
                <div class="text-2xl font-bold text-amber-600">
                    {{ stats.pending_deadlines.after_18.sodonhang|default:0|intcomma }}
                </div>
                <div class="text-xs text-slate-600 mt-1">S·ªë ƒë∆°n</div>
            </div>
        </div>
        
        <!-- T·ªïng ƒë∆°n, doanh s·ªë, s·∫£n ph·∫©m -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="p-4 border border-slate-200 rounded-lg">
                <div class="text-xs text-slate-600 uppercase font-medium mb-2">T·ªîNG ƒê∆†N</div>
                <div class="text-xl font-bold text-slate-800">{{ stats.sum_data.sodonhang|default:0|intcomma }}</div>
            </div>
            
            <div class="p-4 border border-slate-200 rounded-lg">
                <div class="text-xs text-slate-600 uppercase font-medium mb-2">T·ªîNG DOANH S·ªê</div>
                <div class="text-xl font-bold text-slate-800">{{ stats.sum_data.doanhso|default:0|intcomma }}</div>
            </div>
            
            <div class="p-4 border border-slate-200 rounded-lg">
                <div class="text-xs text-slate-600 uppercase font-medium mb-2">T·ªîNG S·∫¢N PH·∫®M</div>
                <div class="text-xl font-bold text-slate-800">{{ stats.sum_data.sosanpham|default:0|intcomma }}</div>
            </div>
        </div>
        
        <hr class="my-6">
        
        <!-- Bi·ªÉu ƒë·ªì theo gi·ªù -->
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-slate-700 mb-3">Bi·ªÉu ƒë·ªì ƒë√≥ng g√≥i theo gi·ªù</h3>
            <div id="hourlyChart" style="width: 100%; height: 300px;"></div>
        </div>
        
        <!-- B·∫£ng th·ªëng k√™ ng∆∞·ªùi g√≥i -->
        <div class="mt-6">
            <h3 class="text-sm font-semibold text-slate-700 mb-3 uppercase">B·∫£ng th·ªëng k√™ ng∆∞·ªùi g√≥i</h3>
            <div class="space-y-2">
                {% for key, value in stats.per_user.items %}
                <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:bg-slate-50">
                    <div class="flex items-center gap-3 flex-1">
                        <img width="42" height="42" class="rounded-full" src="/static/22185873824_536529798.jpg" alt="">
                        <div class="flex-1">
                            <div class="font-semibold text-slate-800">{{ key }}</div>
                            <div class="text-xs text-slate-600">
                                {{ value.total_order|default:0|intcomma }} ƒë∆°n - {{ value.total_quantity|default:0|intcomma }} s·∫£n ph·∫©m
                            </div>
                            {% if value.cato %}
                            <div class="text-xs text-slate-500 mt-1">
                                {% for lv_key, lv_value in value.cato.items %}
                                    <span class="inline-block mr-2">{{ lv_key }}: {{ lv_value|floatformat:0 }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-slate-800">{{ value.total_money|default:0|intcomma }}</div>
                        <div class="text-xs text-slate-500">VNƒê</div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-slate-500">
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-8 text-center">
        <p class="text-slate-500">Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™. Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian ƒë·ªÉ xem b√°o c√°o.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Bi·ªÉu ƒë·ªì theo gi·ªù
{% if stats and hourly_data_json %}
document.addEventListener('DOMContentLoaded', function() {
    var hourlyData = {{ hourly_data_json|safe }};
    var hourlyCategories = {{ hourly_categories_json|safe }};
    
    var options = {
        series: [{
            name: "ƒê√£ g√≥i",
            data: hourlyData
        }],
        chart: {
            height: 300,
            type: 'line',
            dropShadow: {
                enabled: true,
                color: '#000',
                top: 18,
                left: 7,
                blur: 10,
                opacity: 0.2
            },
            zoom: {
                enabled: false
            },
            toolbar: {
                show: false
            }
        },
        colors: ['#10b981'],
        dataLabels: {
            enabled: true,
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        grid: {
            borderColor: '#e7e7e7',
            row: {
                colors: ['#f3f3f3', 'transparent'],
                opacity: 0.5
            },
        },
        markers: {
            size: 4
        },
        xaxis: {
            categories: hourlyCategories,
            title: {
                text: 'Theo gi·ªù'
            }
        },
        yaxis: {
            title: {
                text: 'S·ªë ƒë∆°n ƒë√£ g√≥i'
            },
            min: 0
        },
        legend: {
            position: 'top',
            horizontalAlign: 'right',
            floating: true,
            offsetY: -25,
            offsetX: -5
        }
    };

    var chart = new ApexCharts(document.querySelector("#hourlyChart"), options);
    chart.render();
});
{% endif %}
</script>
{% endblock %}
