{% extends "kho/base_kho.html" %}
{% load static %}
{% load humanize %}

{% block title %}Overview Kho - Gia Dụng Plus {% endblock %}

{% block overview %}
<section>
    <h1 class="text-lg font-semibold text-slate-800">Tổng quan kho hàng</h1>
    <p class="text-xs text-gray-500 mt-1">Dashboard với công việc cần xử lý, doanh số đơn gói, toplist hiệu suất, KPI</p>
</section>
{% endblock %}

{% block main_content %}
<div class="min-h-screen bg-slate-100 space-y-6">
        
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                <div class="text-xs text-gray-500 mb-1">Đơn hôm nay</div>
                <div class="text-2xl font-bold text-slate-800">{{ kpi.orders_today|default:0 }}</div>
                <div class="text-xs text-gray-400 mt-1">Theo kho hiện tại</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                <div class="text-xs text-gray-500 mb-1">Đã đóng gói</div>
                <div class="text-2xl font-bold text-emerald-600">{{ kpi.orders_packed|default:0 }}</div>
                <div class="text-xs text-gray-400 mt-1">Hôm nay</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                <div class="text-xs text-gray-500 mb-1">Hoả tốc chưa xử lý</div>
                <div class="text-2xl font-bold text-red-600">{{ kpi.orders_express|default:0 }}</div>
                <div class="text-xs text-gray-400 mt-1">Cần xử lý gấp</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                <div class="text-xs text-gray-500 mb-1">Chờ pickup</div>
                <div class="text-2xl font-bold text-orange-600">{{ kpi.orders_pickup|default:0 }}</div>
                <div class="text-xs text-gray-400 mt-1">Đã gói, chờ lấy</div>
            </div>
        </div>

        <!-- Công việc cần xử lý -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <h2 class="text-sm font-semibold text-slate-800 mb-3">Công việc cần xử lý</h2>
            <div class="space-y-2 text-sm">
                <div class="flex items-center justify-between p-2 hover:bg-slate-50 rounded">
                    <span>Đơn Shopee chưa xử lý</span>
                    <span class="text-red-600 font-semibold">0</span>
                </div>
                <div class="flex items-center justify-between p-2 hover:bg-slate-50 rounded">
                    <span>Đơn Sapo chưa xử lý</span>
                    <span class="text-red-600 font-semibold">0</span>
                </div>
                <div class="flex items-center justify-between p-2 hover:bg-slate-50 rounded">
                    <span>Ticket chưa xử lý</span>
                    <span class="text-red-600 font-semibold">0</span>
                </div>
            </div>
        </div>

        <!-- Toplist hiệu suất -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <h2 class="text-sm font-semibold text-slate-800 mb-3">Toplist hiệu suất</h2>
            <div class="text-sm text-gray-500">
                <p>Dữ liệu sẽ được cập nhật sau khi có logic tính toán.</p>
            </div>
        </div>

        <!-- Danh sách đơn theo trạng thái -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <h2 class="text-sm font-semibold text-slate-800 mb-3">Đơn hàng theo trạng thái</h2>
            <div class="text-sm text-gray-500">
                <p>Dữ liệu sẽ được cập nhật sau khi có logic lấy đơn từ Sapo.</p>
            </div>
        </div>

        <!-- Quản trị nhân viên gói hàng -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
            <h2 class="text-sm font-semibold text-slate-800 mb-4">Quản trị nhân viên gói hàng</h2>
            <p class="text-xs text-gray-500 mb-4">Bật/tắt tính năng đóng gói hàng cho nhân viên thông thường (WarehousePacker) theo từng kho</p>
            
            <div class="space-y-4">
                <!-- Kho HCM -->
                <div class="flex items-center justify-between p-4 border border-slate-200 rounded-lg">
                    <div class="flex-1">
                        <div class="text-sm font-semibold text-slate-800">Kho HCM (Geleximco & Toky)</div>
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="status-hcm" class="inline-block px-2 py-1 rounded text-xs font-medium {% if packing_settings.KHO_HCM.is_active %}bg-emerald-100 text-emerald-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                                {% if packing_settings.KHO_HCM.is_active %}Hoạt động{% else %}Tạm dừng{% endif %}
                            </span>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            class="sr-only peer" 
                            id="toggle-hcm"
                            data-warehouse="KHO_HCM"
                            {% if packing_settings.KHO_HCM.is_active %}checked{% endif %}
                        >
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                    </label>
                </div>

                <!-- Kho HN -->
                <div class="flex items-center justify-between p-4 border border-slate-200 rounded-lg">
                    <div class="flex-1">
                        <div class="text-sm font-semibold text-slate-800">Kho Hà Nội (Geleximco)</div>
                        <div class="text-xs text-gray-500 mt-1">
                            <span id="status-hn" class="inline-block px-2 py-1 rounded text-xs font-medium {% if packing_settings.KHO_HN.is_active %}bg-emerald-100 text-emerald-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                                {% if packing_settings.KHO_HN.is_active %}Hoạt động{% else %}Tạm dừng{% endif %}
                            </span>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            class="sr-only peer" 
                            id="toggle-hn"
                            data-warehouse="KHO_HN"
                            {% if packing_settings.KHO_HN.is_active %}checked{% endif %}
                        >
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                    </label>
                </div>
            </div>
        </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Get CSRF token function - try multiple methods
function getCSRFToken() {
    // Method 1: Try from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Try cookie first
    let token = getCookie('csrftoken');
    if (token) {
        return token;
    }
    
    // Method 2: Try from hidden input (if csrf_token tag was used)
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        token = csrfInput.value;
        return token;
    }
    
    console.error('[CSRF] Token not found!');
    return null;
}

// Toggle packing setting function
async function togglePackingSetting(warehouseCode, isActive) {
    
    // Map warehouse code to element ID suffix (hcm or hn)
    const idSuffix = warehouseCode === 'KHO_HCM' ? 'hcm' : 'hn';
    
    const statusElement = document.getElementById(`status-${idSuffix}`);
    const toggleElement = document.getElementById(`toggle-${idSuffix}`);
    
    if (!statusElement || !toggleElement) {
        console.error(`[PackingSettings] Cannot find elements for ${warehouseCode}`);
        return;
    }
    
    // Disable toggle while processing
    toggleElement.disabled = true;
    
    // Get CSRF token
    const csrftoken = getCSRFToken();
    
    if (!csrftoken) {
        alert('Lỗi: Không tìm thấy CSRF token. Vui lòng tải lại trang.');
        toggleElement.checked = !isActive;
        toggleElement.disabled = false;
        return;
    }
    
    try {
        const response = await fetch('/kho/management/packing_settings/toggle/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                warehouse_code: warehouseCode,
                is_active: isActive
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update status badge
            if (isActive) {
                statusElement.textContent = 'Hoạt động';
                statusElement.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-emerald-100 text-emerald-700';
            } else {
                statusElement.textContent = 'Tạm dừng';
                statusElement.className = 'inline-block px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700';
            }
        } else {
            // Revert toggle on error
            toggleElement.checked = !isActive;
            alert('Lỗi: ' + (data.error || 'Không thể cập nhật cài đặt'));
            console.error(`[PackingSettings] Error:`, data.error);
        }
    } catch (error) {
        // Revert toggle on error
        toggleElement.checked = !isActive;
        alert('Lỗi: Không thể kết nối đến server');
        console.error('[PackingSettings] Exception:', error);
    } finally {
        // Re-enable toggle
        toggleElement.disabled = false;
    }
}

// Initialize event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    
    // Setup toggle for KHO_HCM
    const toggleHcm = document.getElementById('toggle-hcm');
    if (toggleHcm) {
        toggleHcm.addEventListener('change', function() {
            togglePackingSetting('KHO_HCM', this.checked);
        });
    } else {
    }
    
    // Setup toggle for KHO_HN
    const toggleHn = document.getElementById('toggle-hn');
    if (toggleHn) {
        toggleHn.addEventListener('change', function() {
            togglePackingSetting('KHO_HN', this.checked);
        });
    } else {
    }
});
</script>
{% endblock %}
