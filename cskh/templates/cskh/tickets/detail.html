{% extends "cskh/base_cskh.html" %}
{% load humanize %}

{% block title %}Chi ti·∫øt Ticket {{ ticket.ticket_number }} ‚Äì CSKH{% endblock %}

{% block overview %}
<section class="flex items-center justify-between">
    <div>
        <h1 class="text-xl md:text-lg font-semibold text-slate-800">Ticket {{ ticket.ticket_number }}</h1>
        <p class="text-sm md:text-xs text-gray-500 mt-1">{{ ticket.get_ticket_type_display|default:"-" }}</p>
    </div>
    <div class="flex gap-2">
        <a href="{% url 'cskh:ticket_list' %}"
            class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-sm">
            ‚Üê Quay l·∫°i
        </a>
        <button id="btnSaveTicket"
            class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm font-semibold">
            L∆∞u ticket
        </button>
    </div>
</section>
{% endblock %}

{% block main_content %}
<style>
    /* Hi·ªáu ·ª©ng s·ªçc ƒë·ªè ch√©o cho s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c t√≠ch (kh√¥ng li√™n quan ƒë·∫øn ticket) */
    .variant-item.variant-not-selected {
        position: relative;
        /* N·ªÅn tr·∫Øng v·ªõi s·ªçc ƒë·ªè nh·∫°t ch√©o */
        background: repeating-linear-gradient(135deg,
                #ffffff 0px,
                #ffffff 8px,
                rgba(239, 68, 68, 0.1) 8px,
                rgba(239, 68, 68, 0.1) 10px);
    }
</style>
<div class="flex-1 min-w-0 overflow-x-hidden">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- C·ªòT TR√ÅI -->
        <div class="space-y-6">
            <!-- Upload ·∫£nh/video -->
            <div class="bg-white border rounded-xl p-6 shadow-sm">
                <h3 class="text-base font-semibold text-gray-800 mb-3">Upload ·∫£nh/video</h3>
                <div class="flex items-center gap-2 flex-wrap">
                    <!-- D·∫•u + ƒë·ªÉ upload -->
                    <label for="images" class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-gray-400 transition bg-gray-50">
                        <span class="text-3xl text-gray-400">+</span>
                    </label>
                    <input type="file" name="images" id="images" multiple accept="image/*,video/*" 
                        class="hidden">
                    
                    <!-- Preview ·∫£nh/video -->
                    <div id="imagePreview" class="flex items-center gap-2 flex-wrap">
                        {% if ticket.images %}
                            {% for image_path in ticket.images %}
                            {% with path_lower=image_path|lower %}
                            <div class="relative ticket-media-item cursor-pointer group w-20 h-20"
                                 data-media-src="/static/{{ image_path }}"
                                 data-media-type="{% if '.mp4' in path_lower or '.mov' in path_lower or '.webm' in path_lower %}video{% else %}image{% endif %}">
                                {% if '.mp4' in path_lower or '.mov' in path_lower or '.webm' in path_lower %}
                                    <video src="/static/{{ image_path }}"
                                           class="w-full h-full object-cover rounded border border-gray-200 bg-black"
                                           muted preload="metadata"></video>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <span class="px-1.5 py-0.5 text-[10px] bg-black/60 text-white rounded">Video</span>
                                    </div>
                                {% else %}
                                    <img src="/static/{{ image_path }}" alt="Ticket image" 
                                         class="w-full h-full object-cover rounded border border-gray-200">
                                {% endif %}
                            </div>
                            {% endwith %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Trouble & Event timeline -->
            <div class="bg-white border rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-base font-semibold text-gray-800">Trouble & Event</h3>
                        <p class="text-xs text-gray-500 mt-1">Timeline l√†m vi·ªác v·ªõi kh√°ch h√†ng (theo th·ªùi gian).</p>
                    </div>
                </div>
                
                <!-- Danh s√°ch event - Chat style -->
                <div id="eventList" class="space-y-4 max-h-[70vh] overflow-y-auto pr-1">
                    {% for ev in events %}
                        {% if 'CHUY·ªÇN B·ªò PH·∫¨N: KHO' in ev.tag_list %}
                            <!-- Event chuy·ªÉn b·ªô ph·∫≠n: hi·ªÉn th·ªã d·∫°ng th√¥ng b√°o ƒë·ªè full width -->
                            <div class="w-full bg-red-600 text-white rounded-lg px-3 py-2 shadow-sm text-xs md:text-sm">
                                <div class="font-semibold tracking-wide">CSKH CHUY·ªÇN TICKET SANG KHO X·ª¨ L√ù</div>
                                {% if ev.content %}
                                <div class="mt-1 whitespace-pre-line">{{ ev.content }}</div>
                                {% endif %}
                                <div class="mt-1 text-[10px] opacity-80">
                                    {% comment %}DEBUG MODE: D√πng th·ªùi gian t·∫°o ticket{% endcomment %}
                                    {{ ticket.created_at|date:"d/m H:i" }}
                                    {% if ev.created_by %}
                                        - {{ ev.created_by.first_name|default:ev.created_by.username }}
                                    {% endif %}
                                </div>
                            </div>
                        {% elif ev.created_by and ev.created_by.id == request.user.id %}
                            <!-- Event c·ªßa m√¨nh - b√™n ph·∫£i, background xanh nh·∫°t -->
                            <div class="flex justify-end">
                                <div class="max-w-[75%] flex flex-col items-end">
                                    <div class="bg-blue-100 rounded-lg px-3 py-2 shadow-sm">
                                        {% if ev.tag_list %}
                                        <div class="mb-1.5 flex flex-wrap gap-1 justify-end">
                                            {% for tag in ev.tag_list %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-200 text-blue-800 border border-blue-300 text-[10px] font-medium">
                                                {{ tag }}
                                            </span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="text-gray-800 whitespace-pre-line text-sm">{{ ev.content }}</div>
                                    </div>
                                    <div class="text-[10px] text-gray-500 mt-1 mr-1">
                                        {% comment %}DEBUG MODE: D√πng th·ªùi gian t·∫°o ticket{% endcomment %}
                                        {{ ticket.created_at|date:"d/m H:i" }}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Event c·ªßa ng∆∞·ªùi kh√°c - b√™n tr√°i, c√≥ avatar -->
                            <div class="flex justify-start gap-2">
                                {% if ev.show_avatar %}
                                <!-- Ch·ªâ hi·ªÉn th·ªã avatar ·ªü event ƒë·∫ßu ti√™n trong nh√≥m -->
                                <div class="flex-shrink-0">
                                    {% if ev.created_by %}
                                        <img src="/static/nhanvien/{{ ev.created_by.username }}.png" 
                                             alt="{{ ev.created_by.username }}"
                                             class="w-10 h-10 rounded-full object-cover border border-gray-200"
                                             onerror="this.src='/static/nhanvien/kho-avatar.png';">
                                    {% else %}
                                        <img src="/static/nhanvien/kho-avatar.png" 
                                             alt="H·ªá th·ªëng"
                                             class="w-10 h-10 rounded-full object-cover border border-gray-200">
                                    {% endif %}
                                </div>
                                {% else %}
                                <!-- Event ti·∫øp theo trong nh√≥m - ch·ªâ c√≥ kho·∫£ng tr·ªëng ƒë·ªÉ align -->
                                <div class="flex-shrink-0 w-10"></div>
                                {% endif %}
                                <div class="flex-1 max-w-[75%]">
                                    {% if ev.show_avatar %}
                                    <!-- Ch·ªâ hi·ªÉn th·ªã name v√† dept ·ªü event ƒë·∫ßu ti√™n trong nh√≥m -->
                                    <div class="mb-1">
                                        {% if ev.created_by %}
                                            {% with dept=ev.created_by.last_name|default_if_none:"" name=ev.created_by.first_name|default:ev.created_by.username %}
                                                <div class="flex items-center gap-2">
                                                    <span class="font-semibold text-sm text-gray-800">{{ name }}</span>
                                                    {% if dept %}
                                                        <span class="px-1.5 py-0.5 rounded-full border text-[10px] font-semibold
                                                            {% if dept == 'KHO_HN' %}
                                                                bg-orange-50 border-orange-300 text-orange-700
                                                            {% elif dept == 'KHO_HCM' %}
                                                                bg-emerald-50 border-emerald-300 text-emerald-700
                                                            {% elif dept == 'CSKH' %}
                                                                bg-sky-50 border-sky-300 text-sky-700
                                                            {% elif dept == 'QU·∫¢N TR·ªä VI√äN' %}
                                                                bg-purple-50 border-purple-300 text-purple-700
                                                            {% else %}
                                                                bg-slate-50 border-slate-300 text-slate-700
                                                            {% endif %}">
                                                                {{ dept }}
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                {% endwith %}
                                            {% else %}
                                                <span class="font-semibold text-sm text-gray-800">H·ªá th·ªëng</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        <div class="bg-white border border-gray-200 rounded-lg px-3 py-2 shadow-sm">
                                            {% if ev.tag_list %}
                                            <div class="mb-1.5 flex flex-wrap gap-1">
                                                {% for tag in ev.tag_list %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-sky-50 text-sky-700 border border-sky-200 text-[10px] font-medium">
                                                    {{ tag }}
                                                </span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            <div class="text-gray-800 whitespace-pre-line text-sm">{{ ev.content }}</div>
                                        </div>
                                        <div class="text-[10px] text-gray-500 mt-1 ml-1">
                                            {% comment %}DEBUG MODE: D√πng th·ªùi gian t·∫°o ticket{% endcomment %}
                                            {{ ticket.created_at|date:"d/m H:i" }}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                        <p class="text-xs text-gray-400 italic text-center py-4">Ch∆∞a c√≥ event n√†o cho ticket n√†y.</p>
                        {% endfor %}
                    </div>
                    
                    <!-- Th√™m event m·ªõi -->
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-xs font-semibold text-gray-700">Th√™m event m·ªõi</h4>
                        </div>
                        <textarea id="event_content" rows="3"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-sm mb-2"
                            placeholder="VD: ƒê√£ g·ªçi l·∫°i cho kh√°ch, kh√°ch x√°c nh·∫≠n nh·∫≠n ƒë·ªß h√†ng, h·∫πn ng√†y ki·ªÉm tra l·∫°i..."></textarea>
                        
                        <!-- Tags preset -->
                        <div class="mb-2 flex flex-wrap gap-2 text-[10px]">
                            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-full border border-red-300 bg-red-50 text-red-700 cursor-pointer">
                                <input type="checkbox" class="event-tag-option w-3 h-3" value="G·∫§P G·∫§P G·∫§P!!!">
                                <span>G·∫§P G·∫§P G·∫§P!!!</span>
                            </label>
                            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-full border border-amber-300 bg-amber-50 text-amber-700 cursor-pointer">
                                <input type="checkbox" class="event-tag-option w-3 h-3" value="CH·ªú KH√ÅCH PH·∫¢N H·ªíI">
                                <span>CH·ªú KH√ÅCH PH·∫¢N H·ªíI</span>
                            </label>
                            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-full border border-slate-300 bg-slate-50 text-slate-700 cursor-pointer">
                                <input type="checkbox" class="event-tag-option w-3 h-3" value="KH√ÅCH KH√ì T√çNH">
                                <span>KH√ÅCH KH√ì T√çNH</span>
                            </label>
                            {% if ticket.depart == 'cskh' %}
                            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-full border border-orange-400 bg-orange-50 text-orange-700 cursor-pointer">
                                <input type="checkbox" class="event-tag-option w-3 h-3" value="CHUY·ªÇN B·ªò PH·∫¨N: KHO">
                                <span>CHUY·ªÇN B·ªò PH·∫¨N: KHO</span>
                            </label>
                            {% endif %}
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="button" id="btnAddEvent"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-xs font-medium">
                                + Th√™m event
                            </button>
                        </div>
                    </div>
                </div>
            
                 <!-- Th√¥ng tin s·∫£n ph·∫©m -->
            <div class="bg-white border rounded-xl p-6 shadow-sm">
                <h3 class="text-base font-semibold text-gray-800 mb-4">S·∫£n ph·∫©m li√™n quan</h3>
                
                {% if variants %}
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    {% for variant in variants %}
                    <div class="flex items-center gap-3 p-3 border rounded-lg variant-item hover:bg-gray-50 {% if variant.is_selected %}bg-blue-50 border-blue-200{% else %}variant-not-selected{% endif %}"
                         data-variant-id="{{ variant.variant_id }}"
                         data-product-name="{{ variant.product_name|default:variant.variant_name }}"
                         data-variant-name="{{ variant.variant_name|default:'' }}"
                         data-sku="{{ variant.sku|default:'' }}"
                         data-price="{{ variant.price|default:0 }}"
                         data-quantity="{{ variant.quantity|default:0 }}">
                        <input type="checkbox" 
                            name="variants_issue" 
                            value="{{ variant.variant_id }}"
                            class="variant-checkbox w-4 h-4 text-brand focus:ring-brand border-gray-300 rounded"
                            {% if variant.is_selected %}checked{% endif %}>
                        <div class="w-12 h-12 rounded overflow-hidden bg-gray-100 flex-shrink-0">
                            {% if variant.image_url %}
                            <img src="{{ variant.image_url }}" alt="·∫¢nh"
                                 class="w-full h-full object-cover"
                                 onerror="this.style.display='none'; this.parentElement.classList.add('bg-gray-200');">
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-sm">
                                {{ variant.product_name|default:variant.variant_name }}
                            </div>
                            <div class="text-xs text-gray-500">
                                SKU: {{ variant.sku|default:"-" }}
                                {% if variant.price %}
                                    ¬∑ Gi√°: {{ variant.price|floatformat:0|intcomma }} ƒë
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500">Ch∆∞a c√≥ th√¥ng tin s·∫£n ph·∫©m</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Thi·ªát h·∫°i - Ticket Cost -->
            <div class="bg-white border rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-base font-semibold text-gray-800">Thi·ªát h·∫°i</h3>
                    <button id="btnAddCost" class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm">
                        + Th√™m thi·ªát h·∫°i
                    </button>
                </div>
                
                <div id="costsList" class="space-y-2">
                    {% for cost in costs %}
                    <div class="p-3 bg-gray-50 rounded-lg space-y-1 border border-gray-100 text-xs md:text-sm"
                         data-cost-id="{{ cost.id }}"
                         data-cost-type="{{ cost.cost_type }}"
                         data-cost-amount="{{ cost.amount }}"
                         data-cost-note="{{ cost.note|default:'' }}"
                         data-cost-variant-id="{{ cost.variant_id|default:'' }}"
                         data-cost-quantity="{{ cost.quantity|default:'' }}"
                         data-cost-unit-price="{{ cost.unit_price|default:'' }}"
                         data-cost-payment-date="{{ cost.payment_date|date:'Y-m-d'|default:'' }}">
                        <div class="flex items-start justify-between gap-3">
                            <div class="space-y-1">
                                <div class="flex flex-wrap items-center gap-1">
                                    <span class="font-semibold text-gray-800">{{ cost.cost_type }}</span>
                                </div>
                                <div class="flex flex-wrap items-center gap-1 text-gray-600">
                                    {% if cost.person %}
                                        <span>- {{ cost.person.first_name|default:cost.person.username }}</span>
                                        {% if cost.person.last_name %}
                                            {% with dept=cost.person.last_name %}
                                            <span class="px-1.5 py-0.5 rounded-full border text-[9px] font-semibold leading-none align-middle
                                                         {% if dept == 'KHO_HN' %}
                                                             bg-orange-50 border-orange-300 text-orange-700
                                                         {% elif dept == 'KHO_HCM' %}
                                                             bg-emerald-50 border-emerald-300 text-emerald-700
                                                         {% elif dept == 'CSKH' %}
                                                             bg-sky-50 border-sky-300 text-sky-700
                                                         {% elif dept == 'MARKETING' %}
                                                             bg-purple-50 border-purple-300 text-purple-700
                                                         {% elif dept == 'QU·∫¢N TR·ªä VI√äN' %}
                                                             bg-rose-50 border-rose-300 text-rose-700
                                                         {% else %}
                                                             bg-slate-50 border-slate-300 text-slate-700
                                                         {% endif %}">
                                                {{ dept }}
                                            </span>
                                            {% endwith %}
                                        {% endif %}
                                    {% endif %}
                                    <span>
                                        thanh to√°n
                                        {% comment %}DEBUG MODE: D√πng th·ªùi gian t·∫°o ticket{% endcomment %}
                                        {{ ticket.created_at|date:"d/m/Y" }}
                                        {{ ticket.created_at|date:"H:i" }}
                                    </span>
                                </div>
                                {% if cost.variant_id %}
                                <div class="text-xs text-gray-600">
                                    <span class="font-semibold">SP:</span>
                                    {{ cost.product_name|default:cost.variant_name|default:"(Kh√¥ng r√µ s·∫£n ph·∫©m)" }}
                                    {% if cost.sku %}- SKU: {{ cost.sku }}{% endif %}
                                </div>
                                <div class="text-xs text-gray-600">
                                    {% if cost.quantity and cost.unit_price %}
                                        {{ cost.quantity }} x {{ cost.unit_price|floatformat:0|intcomma }}ƒë
                                    {% elif cost.quantity %}
                                        S·ªë l∆∞·ª£ng: {{ cost.quantity }}
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% if cost.note %}
                                <div class="text-gray-700">
                                    {{ cost.note }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-base font-semibold text-red-600">
                                    {{ cost.amount|floatformat:0|intcomma }}ƒë
                                </div>
                                <div class="mt-2 flex gap-1">
                                    <button type="button"
                                            class="px-2 py-1 text-[11px] border rounded bg-white text-blue-700 hover:bg-blue-50 transition cost-edit-trigger"
                                            data-cost-id="{{ cost.id }}"
                                            title="S·ª≠a thi·ªát h·∫°i">
                                        ‚úèÔ∏è S·ª≠a
                                    </button>
                                    <button type="button"
                                            class="px-2 py-1 text-[11px] border rounded bg-white text-red-700 hover:bg-red-50 transition cost-delete-trigger"
                                            data-cost-id="{{ cost.id }}"
                                            title="X√≥a thi·ªát h·∫°i">
                                        üóëÔ∏è X√≥a
                                    </button>
                                    <button type="button"
                                            class="px-2 py-1 text-[11px] border rounded bg-white text-gray-700 hover:bg-gray-100 transition cost-upload-trigger"
                                            data-cost-id="{{ cost.id }}">
                                        üì∑ Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% if cost.images %}
                        <div class="grid grid-cols-4 gap-2 mt-1">
                            {% for img_path in cost.images %}
                            {% with path_lower=img_path|lower %}
                            <div class="relative ticket-media-item cursor-pointer"
                                 data-media-src="/static/{{ img_path }}"
                                 data-media-type="image">
                                <img src="/static/{{ img_path }}" alt="Bill image"
                                     class="w-full h-16 object-cover rounded border border-gray-200">
                            </div>
                            {% endwith %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-sm text-gray-500">Ch∆∞a c√≥ thi·ªát h·∫°i n√†o</p>
                    {% endfor %}
                </div>

                <!-- Khu v·ª±c upload ·∫£nh ch·ª©ng t·ª´ cho thi·ªát h·∫°i -->
                <div class="mt-4 pt-3 border-t border-dashed">
                    <p class="text-xs text-gray-500 mb-2">
                        Ch·ªçn m·ªôt kho·∫£n thi·ªát h·∫°i ·ªü tr√™n r·ªìi b·∫•m <span class="font-semibold">Upload ·∫£nh ch·ª©ng t·ª´</span>,
                        sau ƒë√≥ c√≥ th·ªÉ ch·ªçn file ho·∫∑c d√°n (Ctrl+V) ·∫£nh ƒë·ªÉ l∆∞u v√†o <code>assets/billhoantien</code>.
                    </p>
                    <input type="file" id="costImagesInput" multiple accept="image/*"
                           class="hidden">
                    <div id="costImagesPreview" class="grid grid-cols-6 gap-1 text-[10px] text-gray-500"></div>
                </div>
                
                {% if costs %}
                <div class="mt-4 pt-4 border-t">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">T·ªïng thi·ªát h·∫°i:</span>
                        <span class="text-xl font-bold text-red-600">{{ total_cost|floatformat:0|intcomma }}ƒë</span>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- L·ªãch s·ª≠ x·ª≠ l√Ω -->
            <div class="bg-white border rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base font-semibold text-gray-800">L·ªãch s·ª≠ x·ª≠ l√Ω</h3>
                    <button type="button" id="btnToggleLogs"
                            class="text-xs text-sky-700 hover:text-sky-900 flex items-center gap-1">
                        <span id="btnToggleLogsText">Xem th√™m</span>
                        <span id="btnToggleLogsIcon">‚ñº</span>
                    </button>
                </div>
                <div id="logsContainer" class="space-y-4 max-h-64 overflow-y-hidden transition-all duration-300 ease-in-out">
                    {% for log in logs %}
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                            <span class="text-xs font-semibold text-blue-600">{{ log.user|first|upper }}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-sm">{{ log.user }}</span>
                                <span class="text-xs text-gray-500">
                                    {% if log.formatted_time %}
                                        {{ log.formatted_time }}
                                    {% elif log.timestamp %}
                                        {{ log.timestamp|date:"d/m/Y H:i" }}
                                    {% else %}
                                        {{ ticket.created_at|date:"d/m/Y H:i" }}
                                    {% endif %}
                                </span>
                            </div>
                            <div class="text-sm text-gray-700 mt-1">
                                <strong>{{ log.action|default:"Thao t√°c" }}</strong>
                                {% if log.details %}
                                <span class="text-gray-500">- {{ log.details|safe }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-sm text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠</p>
                    {% endfor %}
                </div>
            </div>
            
        </div>
        
        <!-- C·ªòT PH·∫¢I -->
        <div class="space-y-6">
            
            <!-- Th√¥ng tin ƒë∆°n h√†ng -->
            <div class="bg-white border rounded-xl p-6 shadow-sm space-y-5">
                <div>
                    <h3 class="text-base font-semibold text-gray-800 mb-4">Th√¥ng tin ƒë∆°n h√†ng</h3>
                    
                    {% if order_info %}
                    <div class="p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <!-- C·ªôt 1: M√£ ƒë∆°n + Tr·∫°ng th√°i -->
                            <div class="space-y-2">
                                <div>
                                    <strong>M√£ ƒë∆°n:</strong>
                                    {% if ticket.order_id %}
                                    <a href="https://sisapsan.mysapogo.com/admin/orders/{{ ticket.order_id }}" 
                                       target="_blank"
                                       class="text-sky-700 hover:text-sky-900 font-medium underline">
                                        {{ order_info.order_code|default:order_info.reference_number }}
                                    </a>
                                    {% else %}
                                    <span class="text-gray-700">{{ order_info.order_code|default:order_info.reference_number }}</span>
                                    {% endif %}
                                </div>
                                
                                <!-- Tr·∫°ng th√°i ƒë∆°n h√†ng v√† giao h√†ng -->
                                <div class="space-y-1.5">
                                    {% if order_info.order_status %}
                                    <div class="text-xs">
                                        <span class="font-semibold text-gray-700">Tr·∫°ng th√°i ƒë∆°n:</span>
                                        <span class="px-2 py-0.5 rounded-full font-medium ml-1
                                            {% if order_info.order_status == 'finalized' %}bg-blue-100 text-blue-700
                                            {% elif order_info.order_status == 'completed' %}bg-green-100 text-green-700
                                            {% elif order_info.order_status == 'cancelled' %}bg-red-100 text-red-700
                                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                                            {{ order_info.order_status_label|default:order_info.order_status }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if order_info.fulfillment_status %}
                                    <div class="text-xs">
                                        <span class="font-semibold text-gray-700">Giao h√†ng:</span>
                                        <span class="px-2 py-0.5 rounded-full font-medium ml-1
                                            {% if order_info.fulfillment_status == 'shipped' %}bg-green-100 text-green-700
                                            {% elif order_info.fulfillment_status == 'unshipped' %}bg-yellow-100 text-yellow-700
                                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                                            {{ order_info.fulfillment_status_label|default:order_info.fulfillment_status }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    <!-- ƒê√≥ng g√≥i t·∫°i kho -->
                                    <div class="text-xs">
                                        <span class="font-semibold text-gray-700">ƒê√≥ng g√≥i t·∫°i kho:</span>
                                        {% if order_info.packing_status %}
                                            {% if order_info.packing_status >= 3 %}
                                                <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-green-100 text-green-700">
                                                    ƒê√£ ƒë√≥ng g√≥i
                                                </span>
                                                {% if order_info.nguoi_goi %}
                                                    <span class="text-gray-600 ml-1">(Ng∆∞·ªùi g√≥i: {{ order_info.nguoi_goi }})</span>
                                                {% endif %}
                                            {% elif order_info.packing_status == 2 %}
                                                <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-yellow-100 text-yellow-700">
                                                    ƒêang ƒë√≥ng g√≥i
                                                </span>
                                            {% elif order_info.packing_status == 1 %}
                                                <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-blue-100 text-blue-700">
                                                    ƒê√£ in nh√£n
                                                </span>
                                            {% else %}
                                                <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-gray-100 text-gray-700">
                                                    Ch∆∞a ƒë√≥ng g√≥i
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-gray-100 text-gray-700">
                                                Ch∆∞a ƒë√≥ng g√≥i
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- C·ªôt 2: Kho/Shop, T√™n/SƒêT, ƒê·ªãa ch·ªâ -->
                            <div class="space-y-2">
                                <!-- Kho h√†ng / Shop c√πng 1 c·ªôt -->
                                <div>
                                    <strong>Kho h√†ng:</strong> <span class="text-gray-700">{{ order_info.warehouse|default:"-" }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-sm text-gray-700">Shop:</span>
                                    {% with shop_lower=order_info.shop|default_if_none:""|lower %}
                                    <div class="flex items-center gap-2">
                                        <img src="{% if 'lteng' in shop_lower %}
                                                        /static/logo-lteng.jpg
                                                      {% elif 'phaledo' in shop_lower %}
                                                        /static/logo-phaledo.jpg
                                                      {% else %}
                                                        /static/giaodiensang.png
                                                      {% endif %}"
                                             class="w-5 h-5 rounded-sm border border-slate-200 object-contain bg-white"
                                             alt="logo">

                                        <span class="px-2 py-0.5 text-[11px] font-medium rounded border
                                                       {% if 'lteng' in shop_lower %}
                                                           bg-orange-50 border-orange-300 text-orange-700
                                                       {% elif 'phaledo' in shop_lower %}
                                                           bg-amber-50 border-amber-300 text-amber-700
                                                       {% else %}
                                                           bg-sky-50 border-sky-300 text-sky-700
                                                       {% endif %}">
                                            {{ order_info.shop|default:"-" }}
                                        </span>
                                    </div>
                                    {% endwith %}
                                </div>
                                
                                <!-- T√™n / SƒêT c√πng 1 c·ªôt -->
                                <div>
                                    <strong>T√™n kh√°ch:</strong>
                                    <span class="text-gray-700">
                                        {{ order_info.customer_name|default:"-" }}
                                        {% if order_info.customer_username %}
                                            <span class="text-xs text-gray-500">
                                                ({{ order_info.customer_username }})
                                            </span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div>
                                    <strong>SƒêT:</strong>
                                    <span class="text-gray-700">
                                        {{ order_info.customer_phone|default:"-" }}
                                        {% if order_info.customer_email %}
                                            <span class="text-xs text-gray-500">
                                                ({{ order_info.customer_email }})
                                            </span>
                                        {% endif %}
                                    </span>
                                </div>
                                
                                <!-- ƒê·ªãa ch·ªâ 1 c·ªôt -->
                                <div>
                                    <strong>ƒê·ªãa ch·ªâ:</strong> <span class="text-gray-700">{{ order_info.customer_address|default:"-" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="p-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <p class="mt-2 text-sm text-gray-500">Kh√¥ng c√≥ th√¥ng tin ƒë∆°n h√†ng</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Th√¥ng tin ƒë∆°n x·ª≠ l√Ω (order_process) -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-base font-semibold text-gray-800">Th√¥ng tin ƒë∆°n x·ª≠ l√Ω</h3>
                        {% if ticket.process_order_code %}
                        <span class="text-xs text-gray-500">ƒêang g·∫Øn: <strong>{{ ticket.process_order_code }}</strong></span>
                        {% endif %}
                    </div>

                    <!-- T√¨m & g·∫Øn ƒë∆°n x·ª≠ l√Ω -->
                    <div class="mb-3 flex flex-col gap-2">
                        <div class="flex gap-2 items-center">
                            <input type="text" id="search_process_order"
                                   class="flex-1 px-3 py-1.5 border rounded-lg text-sm"
                                   placeholder="Nh·∫≠p m√£ SON ho·∫∑c m√£ s√†n ƒë·ªÉ g·∫Øn ƒë∆°n x·ª≠ l√Ω...">
                            <button type="button" id="btnSearchProcessOrder"
                                    class="px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700">
                                T√¨m ƒë∆°n
                            </button>
                        </div>
                        <!-- Danh s√°ch nhi·ªÅu ƒë∆°n h√†ng tr√πng ƒë·ªÉ ch·ªçn l√†m ƒë∆°n x·ª≠ l√Ω -->
                        <div id="processOrderSearchResults" class="space-y-1 hidden"></div>
                    </div>

                    <div id="processOrderResult" class="hidden mb-2 p-3 bg-slate-50 border border-dashed border-slate-300 rounded-lg text-xs"></div>

                    {% if process_order_info %}
                    <div id="processOrderInfo" class="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <!-- C·ªôt 1: M√£ ƒë∆°n + Tr·∫°ng th√°i -->
                            <div class="space-y-2">
                                <div>
                                    <strong>M√£ ƒë∆°n x·ª≠ l√Ω:</strong>
                                    {% if ticket.process_order_id %}
                                    <a href="https://sisapsan.mysapogo.com/admin/orders/{{ ticket.process_order_id }}" 
                                       target="_blank"
                                       class="text-sky-700 hover:text-sky-900 font-medium underline">
                                        {{ process_order_info.order_code|default:process_order_info.reference_number }}
                                    </a>
                                    {% else %}
                                    <span class="text-gray-800">
                                        {{ process_order_info.order_code|default:process_order_info.reference_number }}
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Tr·∫°ng th√°i ƒë∆°n h√†ng v√† giao h√†ng -->
                                <div class="space-y-1.5">
                                    {% if process_order_info.order_status %}
                                    <div class="text-xs">
                                        <span class="font-semibold text-gray-700">Tr·∫°ng th√°i ƒë∆°n:</span>
                                        <span class="px-2 py-0.5 rounded-full font-medium ml-1
                                            {% if process_order_info.order_status == 'finalized' %}bg-blue-100 text-blue-700
                                            {% elif process_order_info.order_status == 'completed' %}bg-green-100 text-green-700
                                            {% elif process_order_info.order_status == 'cancelled' %}bg-red-100 text-red-700
                                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                                            {{ process_order_info.order_status_label|default:process_order_info.order_status }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if process_order_info.fulfillment_status %}
                                    <div class="text-xs">
                                        <span class="font-semibold text-gray-700">Giao h√†ng:</span>
                                        <span class="px-2 py-0.5 rounded-full font-medium ml-1
                                            {% if process_order_info.fulfillment_status == 'shipped' %}bg-green-100 text-green-700
                                            {% elif process_order_info.fulfillment_status == 'unshipped' %}bg-yellow-100 text-yellow-700
                                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                                            {{ process_order_info.fulfillment_status_label|default:process_order_info.fulfillment_status }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    <!-- ƒê√≥ng g√≥i t·∫°i kho -->
                                    <div class="text-xs">
                                        <span class="font-semibold text-gray-700">ƒê√≥ng g√≥i t·∫°i kho:</span>
                                        {% if process_order_info.packing_status %}
                                            {% if process_order_info.packing_status >= 3 %}
                                                <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-green-100 text-green-700">
                                                    ƒê√£ ƒë√≥ng g√≥i
                                                </span>
                                                {% if process_order_info.nguoi_goi %}
                                                    <span class="text-gray-600 ml-1">(Ng∆∞·ªùi g√≥i: {{ process_order_info.nguoi_goi }})</span>
                                                {% endif %}
                                            {% elif process_order_info.packing_status == 2 %}
                                                <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-yellow-100 text-yellow-700">
                                                    ƒêang ƒë√≥ng g√≥i
                                                </span>
                                            {% elif process_order_info.packing_status == 1 %}
                                                <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-blue-100 text-blue-700">
                                                    ƒê√£ in nh√£n
                                                </span>
                                            {% else %}
                                                <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-gray-100 text-gray-700">
                                                    Ch∆∞a ƒë√≥ng g√≥i
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="px-2 py-0.5 rounded-full font-medium ml-1 bg-gray-100 text-gray-700">
                                                Ch∆∞a ƒë√≥ng g√≥i
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- C·ªôt 2: Kho, Ngu·ªìn -->
                            <div class="space-y-2">
                                <div>
                                    <strong>Kho:</strong> <span class="text-gray-700">{{ process_order_info.warehouse|default:"-" }}</span>
                                </div>
                                <div>
                                    <strong>Ngu·ªìn:</strong> <span class="text-gray-700">{{ process_order_info.channel|default:"-" }}</span>
                                </div>
                                {% if process_order_info.freight_amount %}
                                <div>
                                    <strong>Chi ph√≠ g·ª≠i ƒë∆°n:</strong>
                                    <span class="text-gray-700">
                                        {{ process_order_info.freight_amount|floatformat:0|intcomma }}ƒë
                                    </span>
                                </div>
                                {% endif %}
                                {% if process_order_info.shop %}
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-sm text-gray-700">Shop:</span>
                                    {% with shop_lower=process_order_info.shop|default_if_none:""|lower %}
                                    <div class="flex items-center gap-2">
                                        <img src="{% if 'lteng' in shop_lower %}
                                                        /static/logo-lteng.jpg
                                                      {% elif 'phaledo' in shop_lower %}
                                                        /static/logo-phaledo.jpg
                                                      {% else %}
                                                        /static/giaodiensang.png
                                                      {% endif %}"
                                             class="w-5 h-5 rounded-sm border border-slate-200 object-contain bg-white"
                                             alt="logo">

                                        <span class="px-2 py-0.5 text-[11px] font-medium rounded border
                                                       {% if 'lteng' in shop_lower %}
                                                           bg-orange-50 border-orange-300 text-orange-700
                                                       {% elif 'phaledo' in shop_lower %}
                                                           bg-amber-50 border-amber-300 text-amber-700
                                                       {% else %}
                                                           bg-sky-50 border-sky-300 text-sky-700
                                                       {% endif %}">
                                            {{ process_order_info.shop|default:"-" }}
                                        </span>
                                    </div>
                                    {% endwith %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div id="processOrderInfo" class="p-4 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300 text-center text-xs text-gray-500">
                        Ch∆∞a c√≥ ƒë∆°n x·ª≠ l√Ω ƒë∆∞·ª£c g·∫Øn v·ªõi ticket n√†y.
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Th√¥ng tin b·ªï sung -->
            <div class="bg-white border rounded-xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-base font-semibold text-gray-800">Th√¥ng tin b·ªï sung</h3>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </div>
                
                <div class="space-y-3" id="ticketMetaForm">
                    <!-- B·ªô ph·∫≠n x·ª≠ l√Ω -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-gray-700 w-32 flex-shrink-0">B·ªô ph·∫≠n x·ª≠ l√Ω</label>
                        <div class="flex-1 flex items-center gap-2">
                            <span class="px-3 py-1 text-sm rounded-full border font-semibold
                                {% if ticket.depart == 'cskh' %}bg-sky-50 text-sky-700 border-sky-200
                                {% elif ticket.depart == 'warehouse' %}bg-orange-50 text-orange-700 border-orange-200
                                {% else %}bg-slate-50 text-slate-700 border-slate-200{% endif %}">
                                {% if ticket.depart == 'cskh' %}CSKH{% elif ticket.depart == 'warehouse' %}KHO{% else %}{{ ticket.depart|upper|default:"-" }}{% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Lo·∫°i v·∫•n ƒë·ªÅ - label v√† select c√πng h√†ng (l·∫•y t·ª´ config: loai_van_de) -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-gray-700 w-32 flex-shrink-0">Lo·∫°i v·∫•n ƒë·ªÅ</label>
                        <select id="ticket_type"
                            class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand">
                            <option value="">-- Ch·ªçn lo·∫°i v·∫•n ƒë·ªÅ --</option>
                            {% for value in issue_type_options %}
                            <option value="{{ value }}" {% if ticket.ticket_type == value %}selected{% endif %}>
                                {{ value }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Ngu·ªìn l·ªói - label v√† select c√πng h√†ng -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-gray-700 w-32 flex-shrink-0">Ngu·ªìn l·ªói</label>
                        <select id="source_reason"
                            class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand">
                            <option value="">-- Ch·ªçn ngu·ªìn l·ªói --</option>
                            {% for source in reason_sources %}
                            <option value="{{ source }}" {% if ticket.source_reason == source %}selected{% endif %}>{{ source }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Lo·∫°i l·ªói - label v√† select c√πng h√†ng -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-gray-700 w-32 flex-shrink-0">Lo·∫°i l·ªói</label>
                        <select id="reason_type"
                            class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand">
                            <option value="">-- Ch·ªçn lo·∫°i l·ªói --</option>
                        </select>
                    </div>
                    
                    <!-- Tr·∫°ng th√°i - label v√† select c√πng h√†ng -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-gray-700 w-32 flex-shrink-0">Tr·∫°ng th√°i</label>
                        <select id="ticket_status"
                            class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand">
                            {% for value, label in status_choices %}
                                {% if value != 'new' or ticket.ticket_status == 'new' %}
                                    <option value="{{ value }}" {% if ticket.ticket_status == value %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Ngu·ªìn ticket (readonly) - label v√† select c√πng h√†ng -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-gray-700 w-32 flex-shrink-0">Ngu·ªìn ticket</label>
                        <select disabled
                            class="flex-1 px-4 py-2 border rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
                            <option>{{ ticket.get_source_ticket_display }}</option>
                        </select>
                    </div>
                    <!-- Ng∆∞·ªùi t·∫°o ticket (readonly) - label v√† select c√πng h√†ng -->
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium text-gray-700 w-32 flex-shrink-0">Ng∆∞·ªùi t·∫°o ticket</label>
                        <select disabled
                            class="flex-1 px-4 py-2 border rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
                            <option>{% if ticket.created_by %}{{ ticket.created_by.first_name|default:ticket.created_by.username }}
                            {% else %}-{% endif %}</option>
                        </select>
                    </div>
                </div>
                
                <!-- H∆∞·ªõng x·ª≠ l√Ω (Sugget process) -->
                <div class="mt-4 pt-3 border-t border-dashed border-slate-200">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-700">H∆∞·ªõng x·ª≠ l√Ω</span>
                            <span class="text-[10px] text-gray-400">(Sugget process)</span>
                        </div>
                        <button type="button"
                                id="btnToggleSuggetForm"
                                class="text-xs text-sky-700 hover:text-sky-900">
                            {% if sugget_process %}
                                S·ª≠a h∆∞·ªõng x·ª≠ l√Ω
                            {% else %}
                                + Th√™m h∆∞·ªõng x·ª≠ l√Ω
                            {% endif %}
                        </button>
                    </div>

                    {% if not sugget_process %}
                        <p class="text-xs text-gray-500 italic mb-2">
                            Ch∆∞a c√≥ h∆∞·ªõng x·ª≠ l√Ω cho ticket.
                        </p>
                    {% else %}
                        <div id="suggetSummary"
                             class="mb-2 p-3 rounded-lg bg-slate-50 border border-slate-200 text-xs space-y-1">
                            {% comment %}DEBUG MODE: D√πng th·ªùi gian t·∫°o ticket{% endcomment %}
                            <div class="text-[11px] text-gray-500 mb-0.5">
                                {{ ticket.created_at|date:"d/m/Y H:%M" }}
                            </div>
                            <div class="flex flex-wrap items-center gap-1 text-gray-800">
                                <span class="font-semibold">
                                    {{ sugget_process.user_name|default:"(Kh√¥ng r√µ ng∆∞·ªùi t·∫°o)" }}
                                </span>
                                {% if sugget_process.department %}
                                <span class="px-1.5 py-0.5 rounded-full border text-[9px] font-semibold leading-none align-middle
                                             {% if sugget_process.department == 'KHO_HN' %}
                                                 bg-orange-50 border-orange-300 text-orange-700
                                             {% elif sugget_process.department == 'KHO_HCM' %}
                                                 bg-emerald-50 border-emerald-300 text-emerald-700
                                             {% elif sugget_process.department == 'CSKH' %}
                                                 bg-sky-50 border-sky-300 text-sky-700
                                             {% elif sugget_process.department == 'MARKETING' %}
                                                 bg-purple-50 border-purple-300 text-purple-700
                                             {% elif sugget_process.department == 'QU·∫¢N TR·ªä VI√äN' %}
                                                 bg-rose-50 border-rose-300 text-rose-700
                                             {% else %}
                                                 bg-slate-50 border-slate-300 text-slate-700
                                             {% endif %}">
                                    {{ sugget_process.department }}
                                </span>
                                {% endif %}
                                <span class="text-gray-700">
                                    ƒë∆∞a ra h∆∞·ªõng x·ª≠ l√Ω:
                                </span>
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[13px] font-semibold
                                             bg-amber-50 border-amber-300 text-amber-800">
                                    {{ sugget_process.sugget_main }}
                                </span>
                            </div>
                            {% if sugget_process.description %}
                            <div class="mt-1">
                                <div class="inline-block w-full px-3 py-2 rounded-lg border text-[13px] text-gray-800 whitespace-pre-line
                                            bg-amber-50 border-amber-300">
                                    {{ sugget_process.description }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Form nh·ªè ƒë·ªÉ th√™m/s·ª≠a h∆∞·ªõng x·ª≠ l√Ω -->
                    <div id="suggetFormContainer" class="mt-1 {% if sugget_process %}hidden{% endif %}">
                        <div class="grid grid-cols-1 gap-2 text-xs">
                            <div class="flex items-center gap-2">
                                <label for="sugget_main"
                                       class="w-28 flex-shrink-0 text-[11px] font-medium text-gray-700">
                                    H∆∞·ªõng x·ª≠ l√Ω
                                </label>
                                <select id="sugget_main"
                                        class="flex-1 px-2.5 py-1.5 border rounded-lg focus:outline-none focus:ring-1 focus:ring-brand text-xs">
                                    <option value="">-- Ch·ªçn h∆∞·ªõng x·ª≠ l√Ω --</option>
                                    {% for hx in huong_xu_ly_list %}
                                    <option value="{{ hx }}"
                                            {% if sugget_process.sugget_main == hx %}selected{% endif %}>
                                        {{ hx }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="flex items-start gap-2">
                                <label for="sugget_description"
                                       class="w-28 flex-shrink-0 text-[11px] font-medium text-gray-700 mt-1">
                                    M√¥ t·∫£ ng·∫Øn
                                </label>
                                <textarea id="sugget_description" rows="2"
                                          class="flex-1 px-2.5 py-1.5 border rounded-lg focus:outline-none focus:ring-1 focus:ring-brand text-xs"
                                          placeholder="L√Ω do ch·ªçn h∆∞·ªõng x·ª≠ l√Ω n√†y, ghi ng·∫Øn g·ªçn...">{% if sugget_process.description %}{{ sugget_process.description }}{% endif %}</textarea>
                            </div>
                            <div class="flex justify-end mt-1">
                                <button type="button"
                                        id="btnSaveSuggetProcess"
                                        class="px-3 py-1.5 bg-brand text-white rounded-lg hover:bg-red-700 transition text-[11px] font-medium">
                                    L∆∞u h∆∞·ªõng x·ª≠ l√Ω
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- N√∫t h√†nh ƒë·ªông ƒë√£ gom th√†nh n√∫t L∆∞u ticket ·ªü header -->
            </div>
            
            <!-- Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám 
            <div class="bg-white border rounded-xl p-4 shadow-sm">
                <h3 class="text-sm font-semibold text-gray-800 mb-3">L·ªói sai do ai</h3>
                
                {% if not ticket.responsible_user and not ticket.responsible_department and not ticket.responsible_note %}
                    <p class="text-xs text-gray-500 italic mb-3">Ch∆∞a c√≥ ai ch·ªãu tr√°ch nhi·ªám cho l·ªói sai n√†y.</p>
                {% endif %}
                
                <div class="space-y-3">
                   
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">B·ªô ph·∫≠n</label>
                            <select id="responsible_department" class="w-full px-2.5 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-xs">
                                <option value="">-- Ch·ªçn b·ªô ph·∫≠n --</option>
                                {% for dept in departments %}
                                <option value="{{ dept }}" {% if ticket.responsible_department == dept %}selected{% endif %}>{{ dept }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Nh√¢n vi√™n</label>
                            <select id="responsible_user" class="w-full px-2.5 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-xs">
                                <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" 
                                        data-department="{{ user.department|default:'' }}"
                                        {% if ticket.responsible_user and ticket.responsible_user.id == user.id %}selected{% endif %}>
                                    {{ user.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Ghi ch√∫</label>
                        <textarea id="responsible_note" rows="2" 
                                  class="w-full px-2.5 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-xs"
                                  placeholder="Ghi ch√∫ v·ªÅ tr√°ch nhi·ªám...">{{ ticket.responsible_note|default:'' }}</textarea>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="button" id="btnSaveResponsible"
                                class="px-3 py-1.5 bg-brand text-white rounded-lg hover:bg-red-700 transition text-xs font-medium">
                            L∆∞u
                        </button>
                    </div>
                </div>
            </div>
            -->

            <!-- Lightbox xem ·∫£nh/video -->
            <div id="mediaLightbox" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center">
                <div class="relative max-w-5xl w-full h-full flex items-center justify-center px-4">
                    <button type="button" id="mediaCloseBtn"
                        class="absolute top-4 right-6 text-white text-2xl font-bold">
                        √ó
                    </button>
                    <button type="button" id="mediaPrevBtn"
                        class="absolute left-4 md:left-10 text-white text-3xl font-bold select-none">
                        ‚Äπ
                    </button>
                    <button type="button" id="mediaNextBtn"
                        class="absolute right-4 md:right-10 text-white text-3xl font-bold select-none">
                        ‚Ä∫
                    </button>
                    <div id="mediaContent" class="max-h-[90vh] max-w-full flex items-center justify-center">
                        <!-- ·∫¢nh / video l·ªõn s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- Modal th√™m thi·ªát h·∫°i -->
<div id="modalAddCost" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-4 max-w-md w-full mx-4 text-sm">
        <h3 class="text-base font-semibold mb-3">Th√™m thi·ªát h·∫°i</h3>
        <form id="formAddCost">
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1.5">Lo·∫°i chi ph√≠ *</label>
                    <select id="cost_type" required class="w-full px-3 py-1.5 border rounded-lg text-sm">
                        <option value="">-- Ch·ªçn lo·∫°i chi ph√≠ --</option>
                        {% for cost_type in cost_types %}
                        <option value="{{ cost_type }}">{{ cost_type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="damage_product_section" class="space-y-2 hidden">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1.5">S·∫£n ph·∫©m h·ªèng v·ª°</label>
                        <select id="cost_variant_id" class="w-full px-3 py-1.5 border rounded-lg text-xs">
                            <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                        </select>
                        <p class="mt-0.5 text-[10px] text-gray-500">
                            Danh s√°ch l·∫•y t·ª´ c√°c s·∫£n ph·∫©m trong ƒë∆°n h√†ng c·ªßa ticket n√†y.
                        </p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë l∆∞·ª£ng h·ªèng v·ª°</label>
                            <input type="number" id="cost_quantity" min="1" step="1" value="1"
                                   class="w-full px-4 py-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ƒê∆°n gi√° (ƒë)</label>
                            <input type="number" id="cost_unit_price" min="0" step="1"
                                   class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="T·ª± ƒë·ªông t·ª´ Sapo / ƒë∆°n h√†ng">
                        </div>
                    </div>
                    <p class="text-[11px] text-gray-500">
                        Gi√° tr·ªã thi·ªát h·∫°i s·∫Ω ƒë∆∞·ª£c auto-fill = S·ªë l∆∞·ª£ng √ó ƒê∆°n gi√°, b·∫°n v·∫´n c√≥ th·ªÉ ch·ªânh s·ª≠a th·ªß c√¥ng √¥ s·ªë ti·ªÅn b√™n d∆∞·ªõi.
                    </p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1.5">S·ªë ti·ªÅn *</label>
                    <input type="number" id="cost_amount" required step="0.01" min="0"
                        class="w-full px-3 py-1.5 border rounded-lg text-sm" placeholder="0">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1.5">Ng√†y thanh to√°n</label>
                    <input type="date" id="cost_payment_date"
                           class="w-full px-3 py-1.5 border rounded-lg text-xs">
                    <p class="mt-0.5 text-[10px] text-gray-500">
                        M·∫∑c ƒë·ªãnh l√† ng√†y hi·ªán t·∫°i, c√≥ th·ªÉ ch·ªçn l·∫°i n·∫øu thanh to√°n v√†o ng√†y kh√°c.
                    </p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1.5">Ghi ch√∫</label>
                    <textarea id="cost_note" rows="3" class="w-full px-3 py-1.5 border rounded-lg text-sm"></textarea>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button type="submit" class="flex-1 px-3 py-1.5 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm">
                    Th√™m
                </button>
                <button type="button" id="btnCloseModal" class="flex-1 px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
                    Hu·ª∑
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal s·ª≠a thi·ªát h·∫°i -->
<div id="modalEditCost" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-4 max-w-md w-full mx-4 text-sm">
        <h3 class="text-base font-semibold mb-3">S·ª≠a thi·ªát h·∫°i</h3>
        <form id="formEditCost">
            <input type="hidden" id="edit_cost_id">
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1.5">Lo·∫°i chi ph√≠ *</label>
                    <select id="edit_cost_type" required class="w-full px-3 py-1.5 border rounded-lg text-sm">
                        <option value="">-- Ch·ªçn lo·∫°i chi ph√≠ --</option>
                        {% for cost_type in cost_types %}
                        <option value="{{ cost_type }}">{{ cost_type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="edit_damage_product_section" class="space-y-2 hidden">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1.5">S·∫£n ph·∫©m h·ªèng v·ª°</label>
                        <select id="edit_cost_variant_id" class="w-full px-3 py-1.5 border rounded-lg text-xs">
                            <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                        </select>
                        <p class="mt-0.5 text-[10px] text-gray-500">
                            Danh s√°ch l·∫•y t·ª´ c√°c s·∫£n ph·∫©m trong ƒë∆°n h√†ng c·ªßa ticket n√†y.
                        </p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë l∆∞·ª£ng h·ªèng v·ª°</label>
                            <input type="number" id="edit_cost_quantity" min="1" step="1" value="1"
                                   class="w-full px-4 py-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ƒê∆°n gi√° (ƒë)</label>
                            <input type="number" id="edit_cost_unit_price" min="0" step="1"
                                   class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="T·ª± ƒë·ªông t·ª´ Sapo / ƒë∆°n h√†ng">
                        </div>
                    </div>
                    <p class="text-[11px] text-gray-500">
                        Gi√° tr·ªã thi·ªát h·∫°i s·∫Ω ƒë∆∞·ª£c auto-fill = S·ªë l∆∞·ª£ng √ó ƒê∆°n gi√°, b·∫°n v·∫´n c√≥ th·ªÉ ch·ªânh s·ª≠a th·ªß c√¥ng √¥ s·ªë ti·ªÅn b√™n d∆∞·ªõi.
                    </p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1.5">S·ªë ti·ªÅn *</label>
                    <input type="number" id="edit_cost_amount" required step="0.01" min="0"
                        class="w-full px-3 py-1.5 border rounded-lg text-sm" placeholder="0">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1.5">Ng√†y thanh to√°n</label>
                    <input type="date" id="edit_cost_payment_date"
                           class="w-full px-3 py-1.5 border rounded-lg text-xs">
                    <p class="mt-0.5 text-[10px] text-gray-500">
                        M·∫∑c ƒë·ªãnh l√† ng√†y hi·ªán t·∫°i, c√≥ th·ªÉ ch·ªçn l·∫°i n·∫øu thanh to√°n v√†o ng√†y kh√°c.
                    </p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1.5">Ghi ch√∫</label>
                    <textarea id="edit_cost_note" rows="3" class="w-full px-3 py-1.5 border rounded-lg text-sm"></textarea>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button type="submit" class="flex-1 px-3 py-1.5 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm">
                    L∆∞u
                </button>
                <button type="button" id="btnCancelEditCost" class="flex-1 px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
                    Hu·ª∑
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceReasonSelect = document.getElementById('source_reason');
    const reasonTypeSelect = document.getElementById('reason_type');
    const ticketStatusSelect = document.getElementById('ticket_status');
    const imagesInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');
    const btnSaveTicket = document.getElementById('btnSaveTicket');
    const btnUploadImages = document.getElementById('btnUploadImages');
    const btnAddEvent = document.getElementById('btnAddEvent');
    const eventContentInput = document.getElementById('event_content');
    const processOrderSearchInput = document.getElementById('search_process_order');
    const btnSearchProcessOrder = document.getElementById('btnSearchProcessOrder');
    const processOrderResult = document.getElementById('processOrderResult');
    const processOrderSearchResults = document.getElementById('processOrderSearchResults');
    const btnSaveResponsible = document.getElementById('btnSaveResponsible');
    const responsibleUserSelect = document.getElementById('responsible_user');
    const responsibleDepartmentSelect = document.getElementById('responsible_department');
    const responsibleNoteTextarea = document.getElementById('responsible_note');
    const logsContainer = document.getElementById('logsContainer');
    const btnToggleLogs = document.getElementById('btnToggleLogs');
    const btnToggleLogsText = document.getElementById('btnToggleLogsText');
    const btnToggleLogsIcon = document.getElementById('btnToggleLogsIcon');
    const btnToggleSuggetForm = document.getElementById('btnToggleSuggetForm');
    const suggetFormContainer = document.getElementById('suggetFormContainer');
    const btnSaveSuggetProcess = document.getElementById('btnSaveSuggetProcess');
    const suggetMainSelect = document.getElementById('sugget_main');
    const suggetDescriptionInput = document.getElementById('sugget_description');
    
    // L·ªçc nh√¢n vi√™n theo b·ªô ph·∫≠n
    if (responsibleDepartmentSelect && responsibleUserSelect) {
        // L∆∞u t·∫•t c·∫£ options ban ƒë·∫ßu
        const allUserOptions = Array.from(responsibleUserSelect.options).map(opt => ({
            value: opt.value,
            text: opt.text,
            department: opt.dataset.department || '',
            element: opt.cloneNode(true)
        }));
        
        function filterUsersByDepartment() {
            const selectedDept = responsibleDepartmentSelect.value;
            const currentValue = responsibleUserSelect.value;
            
            // X√≥a t·∫•t c·∫£ options (tr·ª´ option ƒë·∫ßu ti√™n "-- Ch·ªçn nh√¢n vi√™n --")
            responsibleUserSelect.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
            
            // Th√™m l·∫°i c√°c options ph√π h·ª£p
            allUserOptions.forEach(userOpt => {
                if (!selectedDept || userOpt.department === selectedDept || !userOpt.value) {
                    responsibleUserSelect.appendChild(userOpt.element.cloneNode(true));
                }
            });
            
            // Gi·ªØ l·∫°i gi√° tr·ªã ƒë√£ ch·ªçn n·∫øu v·∫´n c√≤n trong danh s√°ch
            if (currentValue) {
                const optionExists = Array.from(responsibleUserSelect.options).some(opt => opt.value === currentValue);
                if (optionExists) {
                    responsibleUserSelect.value = currentValue;
                } else {
                    responsibleUserSelect.value = '';
                }
            }
        }
        
        // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi b·ªô ph·∫≠n
        responsibleDepartmentSelect.addEventListener('change', filterUsersByDepartment);
        
        // Filter ngay khi page load n·∫øu ƒë√£ c√≥ b·ªô ph·∫≠n ƒë∆∞·ª£c ch·ªçn
        if (responsibleDepartmentSelect.value) {
            filterUsersByDepartment();
        }
    }
    
    // Load reason types
    function loadReasonTypes(source) {
        reasonTypeSelect.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i l·ªói --</option>';
        if (source) {
            fetch(`{% url 'cskh:api_get_reason_types' %}?source_reason=${encodeURIComponent(source)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        data.types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            if (type === '{{ ticket.reason_type }}') {
                                option.selected = true;
                            }
                            reasonTypeSelect.appendChild(option);
                        });
                    }
                });
        }
    }
    
    // Load reason types khi page load
    if (sourceReasonSelect.value) {
        loadReasonTypes(sourceReasonSelect.value);
    }
    
    sourceReasonSelect.addEventListener('change', function() {
        loadReasonTypes(this.value);
    });

    // =======================
    // T√åM & G·∫ÆN ƒê∆†N X·ª¨ L√ù
    // =======================
    function renderProcessOrderResult(order) {
        if (!processOrderResult) return;
        processOrderResult.classList.remove('hidden');

        // L∆∞u t·∫°m th√¥ng tin ƒë∆°n x·ª≠ l√Ω v√†o data-* ƒë·ªÉ d√πng khi b·∫•m "L∆∞u ticket"
        processOrderResult.dataset.orderId = order.order_id || '';
        processOrderResult.dataset.orderCode = order.order_code || '';
        processOrderResult.dataset.referenceNumber = order.reference_number || '';

        processOrderResult.innerHTML = `
            <div class="flex items-center justify-between gap-2">
                <div class="space-y-0.5">
                    <div><span class="font-semibold">ƒê∆°n t√¨m th·∫•y:</span> ${order.order_code || order.reference_number || '-'}</div>
                    <div class="text-[11px] text-gray-600">
                        Kho: ${order.warehouse || '-'} ¬∑ Ngu·ªìn: ${order.channel || '-'}
                    </div>
                </div>
                <button type="button" id="btnAttachProcessOrder"
                        class="px-2.5 py-1 bg-emerald-600 text-white text-xs rounded-lg hover:bg-emerald-700">
                    G·∫Øn l√†m ƒë∆°n x·ª≠ l√Ω
                </button>
            </div>
        `;

        const btnAttach = document.getElementById('btnAttachProcessOrder');
        if (btnAttach) {
            btnAttach.addEventListener('click', function() {
                fetch(`{% url 'cskh:api_update_process_order' ticket.id %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: order.order_id,
                        order_code: order.order_code,
                        reference_number: order.reference_number,
                    }),
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('ƒê√£ g·∫Øn ƒë∆°n x·ª≠ l√Ω cho ticket');
                        location.reload();
                    } else {
                        alert('L·ªói g·∫Øn ƒë∆°n x·ª≠ l√Ω: ' + (data.error || ''));
                    }
                })
                .catch(err => {
                    alert('L·ªói g·∫Øn ƒë∆°n x·ª≠ l√Ω: ' + err);
                });
            });
        }
    }

    function renderProcessOrderCandidates(orders) {
        if (!processOrderSearchResults) return;

        if (!orders || orders.length === 0) {
            processOrderSearchResults.classList.add('hidden');
            processOrderSearchResults.innerHTML = '';
            return;
        }

        // Ch·ªâ hi·ªÉn th·ªã danh s√°ch n·∫øu c√≥ t·ª´ 2 ƒë∆°n tr·ªü l√™n
        if (orders.length === 1) {
            processOrderSearchResults.classList.add('hidden');
            processOrderSearchResults.innerHTML = '';
            // V·ªõi 1 ƒë∆°n duy nh·∫•t, v·∫´n render chi ti·∫øt b√™n d∆∞·ªõi ƒë·ªÉ g·∫Øn
            renderProcessOrderResult(orders[0]);
            return;
        }

        processOrderSearchResults.classList.remove('hidden');
        processOrderSearchResults.innerHTML = '';

        orders.forEach(order => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left px-3 py-1.5 text-[11px] border border-slate-200 rounded-md bg-white hover:bg-slate-50 flex flex-col md:flex-row md:items-center md:justify-between gap-1';

            const code = order.order_code || order.reference_number || '';
            const branch = order.warehouse || '-';
            const channel = order.channel || '-';
            const status = order.order_status_label || order.order_status || '-';

            let totalText = '';
            if (typeof order.total_to_pay === 'number') {
                try {
                    totalText = order.total_to_pay.toLocaleString('vi-VN') + 'ƒë';
                } catch (e) {
                    totalText = order.total_to_pay + 'ƒë';
                }
            }

            btn.innerHTML = `
                <span class="font-semibold text-gray-800">${code}</span>
                <span class="text-[11px] text-gray-600 flex-1 md:text-right">
                    ${branch} ¬∑ ${channel} ¬∑ ${status}
                    ${totalText ? ' ¬∑ Kh√°ch ph·∫£i tr·∫£: ' + totalText : ''}
                </span>
            `;

            btn.addEventListener('click', function () {
                // Khi ch·ªçn 1 ƒë∆°n trong danh s√°ch: ·∫©n danh s√°ch v√† render chi ti·∫øt b√™n d∆∞·ªõi
                if (processOrderSearchResults) {
                    processOrderSearchResults.classList.add('hidden');
                    processOrderSearchResults.innerHTML = '';
                }
                renderProcessOrderResult(order);
            });

            processOrderSearchResults.appendChild(btn);
        });
    }

    function searchProcessOrderList() {
        if (!processOrderSearchInput) return;
        const key = (processOrderSearchInput.value || '').trim();
        if (!key) {
            alert('Vui l√≤ng nh·∫≠p m√£ ƒë∆°n x·ª≠ l√Ω (SON ho·∫∑c m√£ s√†n)');
            return;
        }

        fetch(`{% url 'cskh:api_search_order_multi' %}?q=${encodeURIComponent(key)}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.orders && data.orders.length) {
                    renderProcessOrderCandidates(data.orders);
                } else {
                    alert('Kh√¥ng t√¨m th·∫•y ƒë∆°n x·ª≠ l√Ω: ' + (data.error || ''));
                    if (processOrderSearchResults) {
                        processOrderSearchResults.classList.add('hidden');
                        processOrderSearchResults.innerHTML = '';
                    }
                }
            })
            .catch(err => {
                alert('L·ªói khi t√¨m ƒë∆°n x·ª≠ l√Ω: ' + err);
            });
    }

    if (btnSearchProcessOrder && processOrderSearchInput) {
        btnSearchProcessOrder.addEventListener('click', searchProcessOrderList);
        processOrderSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchProcessOrderList();
            }
        });
    }
    
    // Visual feedback khi tick/untick checkbox s·∫£n ph·∫©m
    document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const item = this.closest('.variant-item');
            if (this.checked) {
                item.classList.add('bg-blue-50', 'border-blue-200');
                item.classList.remove('hover:bg-gray-50', 'variant-not-selected');
            } else {
                item.classList.remove('bg-blue-50', 'border-blue-200');
                item.classList.add('hover:bg-gray-50', 'variant-not-selected');
            }
        });
    });
    
    // H√†m th·ª±c hi·ªán g·ªçi API l∆∞u ticket
    function doSaveTicket() {
        // Thu th·∫≠p c√°c variant_id ƒë√£ ƒë∆∞·ª£c tick
        const checkedVariants = [];
        document.querySelectorAll('.variant-checkbox:checked').forEach(checkbox => {
            checkedVariants.push(parseInt(checkbox.value));
        });

        const payload = {
            ticket_type: "{{ ticket.ticket_type }}",
            source_reason: sourceReasonSelect.value || "",
            reason_type: reasonTypeSelect.value || "",
            ticket_status: ticketStatusSelect.value || "",
            variants_issue: checkedVariants
        };

        fetch(`{% url 'cskh:api_save_ticket' ticket.id %}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('L∆∞u ticket th√†nh c√¥ng');
                location.reload();
            } else {
                alert('L·ªói: ' + (data.error || ''));
            }
        });
    }

    // L∆∞u to√†n b·ªô ticket
    btnSaveTicket.addEventListener('click', function() {
        // N·∫øu ng∆∞·ªùi d√πng v·ª´a t√¨m ƒë∆∞·ª£c ƒë∆°n x·ª≠ l√Ω nh∆∞ng ch∆∞a b·∫•m "G·∫Øn l√†m ƒë∆°n x·ª≠ l√Ω"
        // th√¨ t·ª± ƒë·ªông g·∫Øn ƒë∆°n x·ª≠ l√Ω tr∆∞·ªõc khi l∆∞u ticket
        if (processOrderResult && processOrderResult.dataset.orderId) {
            const orderId = processOrderResult.dataset.orderId;
            const orderCode = processOrderResult.dataset.orderCode || '';
            const referenceNumber = processOrderResult.dataset.referenceNumber || '';

            fetch(`{% url 'cskh:api_update_process_order' ticket.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId,
                    order_code: orderCode,
                    reference_number: referenceNumber,
                }),
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert('L·ªói g·∫Øn ƒë∆°n x·ª≠ l√Ω: ' + (data.error || ''));
                    return;
                }
                // Sau khi g·∫Øn ƒë∆°n x·ª≠ l√Ω th√†nh c√¥ng th√¨ m·ªõi l∆∞u ticket
                doSaveTicket();
            })
            .catch(err => {
                alert('L·ªói g·∫Øn ƒë∆°n x·ª≠ l√Ω: ' + err);
            });
        } else {
            // Kh√¥ng c√≥ ƒë∆°n x·ª≠ l√Ω ƒëang ch·ªù g·∫Øn -> ch·ªâ l∆∞u ticket nh∆∞ b√¨nh th∆∞·ªùng
            doSaveTicket();
        }
    });
    
    // Modal add cost
    const modal = document.getElementById('modalAddCost');
    const btnAddCost = document.getElementById('btnAddCost');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const formAddCost = document.getElementById('formAddCost');
    const damageProductSection = document.getElementById('damage_product_section');
    const costVariantSelect = document.getElementById('cost_variant_id');
    const costQuantityInput = document.getElementById('cost_quantity');
    const costUnitPriceInput = document.getElementById('cost_unit_price');
    const costPaymentDateInput = document.getElementById('cost_payment_date');

    const costImagesInput = document.getElementById('costImagesInput');
    const costImagesPreview = document.getElementById('costImagesPreview');
    let activeCostIdForUpload = null;
    let lastDamageVariantId = null;
    
    btnAddCost.addEventListener('click', () => {
        modal.classList.remove('hidden');

        // M·∫∑c ƒë·ªãnh lo·∫°i chi ph√≠ ƒë·∫ßu ti√™n, reset form
        formAddCost.reset();
        if (costPaymentDateInput) {
            const today = new Date().toISOString().slice(0, 10);
            costPaymentDateInput.value = today;
        }

        // ·∫®n/hi·ªán section s·∫£n ph·∫©m theo lo·∫°i chi ph√≠
        if (damageProductSection) {
            damageProductSection.classList.add('hidden');
        }
    });
    btnCloseModal.addEventListener('click', () => modal.classList.add('hidden'));
    
    // Khi ch·ªçn lo·∫°i chi ph√≠ -> hi·ªÉn th·ªã section ch·ªçn s·∫£n ph·∫©m cho "H√†ng h·ªèng v·ª°"
    if (document.getElementById('cost_type')) {
        document.getElementById('cost_type').addEventListener('change', function() {
            const val = this.value || '';
            if (val === 'H√†ng h·ªèng v·ª°') {
                if (damageProductSection) {
                    damageProductSection.classList.remove('hidden');
                }

                // Build danh s√°ch s·∫£n ph·∫©m t·ª´ DOM n·∫øu ch∆∞a c√≥ options
                if (costVariantSelect && costVariantSelect.options.length <= 1) {
                    const variantItems = document.querySelectorAll('.variant-item');
                    variantItems.forEach(item => {
                        const vid = item.dataset.variantId;
                        if (!vid) return;
                        const name = item.dataset.productName || item.dataset.variantName || '';
                        const sku = item.dataset.sku || '';
                        const price = parseFloat(item.dataset.price || '0') || 0;
                        const qty = parseFloat(item.dataset.quantity || '0') || 0;

                        const opt = document.createElement('option');
                        opt.value = vid;
                        // Hi·ªÉn th·ªã theo y√™u c·∫ßu: SKU - S·ªë l∆∞·ª£ng - Gi√° (kh√¥ng c·∫ßn t√™n)
                        const skuText = sku || 'Ch∆∞a c√≥ SKU';
                        const qtyText = qty ? `SL: ${qty}` : 'SL: ?';
                        const priceText = price ? `Gi√°: ${price.toLocaleString('vi-VN')} ƒë` : 'Gi√°: ?';
                        opt.textContent = `${skuText} - ${qtyText} - ${priceText}`;
                        opt.dataset.productName = name;
                        opt.dataset.variantName = item.dataset.variantName || '';
                        opt.dataset.sku = sku;
                        opt.dataset.price = String(price);
                        opt.dataset.quantity = String(qty);
                        costVariantSelect.appendChild(opt);
                    });
                }
            } else if (damageProductSection) {
                damageProductSection.classList.add('hidden');
            }
        });
    }

    function recalcDamageAmount() {
        if (!costVariantSelect || !costQuantityInput || !document.getElementById('cost_amount')) return;
        const opt = costVariantSelect.selectedOptions[0];
        if (!opt) return;

        const price = parseFloat(opt.dataset.price || '0') || 0;
        let qty = parseInt(costQuantityInput.value || '0', 10) || 0;
        const maxQty = parseInt(opt.dataset.quantity || '0', 10) || 0;

        if (maxQty && qty > maxQty) {
            qty = maxQty;
            if (costQuantityInput) {
                costQuantityInput.value = String(maxQty);
            }
            alert(`S·ªë l∆∞·ª£ng h·ªèng v·ª° kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng trong ƒë∆°n (${maxQty}).`);
        }

        // N·∫øu ƒë·ªïi sang s·∫£n ph·∫©m kh√°c -> lu√¥n auto-fill l·∫°i ƒë∆°n gi√° theo s·∫£n ph·∫©m
        const currentVariantId = opt.value;
        if (currentVariantId !== lastDamageVariantId) {
            if (costUnitPriceInput) {
                costUnitPriceInput.value = price > 0 ? Math.round(price) : '';
            }
            lastDamageVariantId = currentVariantId;
        }

        if (price > 0 && qty > 0) {
            const unit = costUnitPriceInput && parseFloat(costUnitPriceInput.value || '0') > 0
                ? parseFloat(costUnitPriceInput.value || '0')
                : price;
            const amount = unit * qty;
            const amountInput = document.getElementById('cost_amount');
            if (amountInput) {
                amountInput.value = Math.round(amount);
            }
        }
    }

    if (costVariantSelect) {
        costVariantSelect.addEventListener('change', recalcDamageAmount);
    }
    if (costQuantityInput) {
        costQuantityInput.addEventListener('input', recalcDamageAmount);
    }
    if (costUnitPriceInput) {
        costUnitPriceInput.addEventListener('input', recalcDamageAmount);
    }

    formAddCost.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const costType = document.getElementById('cost_type').value;
        const amount = document.getElementById('cost_amount').value;
        const note = document.getElementById('cost_note').value;

        let payload = {cost_type: costType, amount: amount, note: note};

        // G·ª≠i th√™m th√¥ng tin s·∫£n ph·∫©m + ng√†y thanh to√°n n·∫øu l√† H√†ng h·ªèng v·ª°
        if (costType === 'H√†ng h·ªèng v·ª°' && costVariantSelect && costVariantSelect.value) {
            const opt = costVariantSelect.selectedOptions[0];
            const maxQty = parseInt(opt.dataset.quantity || '0', 10) || 0;
            const currentQty = costQuantityInput ? parseInt(costQuantityInput.value || '0', 10) : 0;
            if (maxQty && currentQty > maxQty) {
                alert(`S·ªë l∆∞·ª£ng h·ªèng v·ª° kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng trong ƒë∆°n (${maxQty}).`);
                return;
            }

            payload.variant_id = opt.value;
            payload.product_name = opt.dataset.productName || '';
            payload.variant_name = opt.dataset.variantName || '';
            payload.sku = opt.dataset.sku || '';
            payload.quantity = costQuantityInput ? costQuantityInput.value : null;
            payload.unit_price = costUnitPriceInput ? costUnitPriceInput.value : null;
        }

        if (costPaymentDateInput && costPaymentDateInput.value) {
            payload.payment_date = costPaymentDateInput.value;
        }
        
        fetch(`{% url 'cskh:api_add_cost' ticket.id %}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Th√™m thi·ªát h·∫°i th√†nh c√¥ng');
                location.reload();
            } else {
                alert('L·ªói: ' + (data.error || ''));
            }
        });
    });
    
    // Visual feedback khi tick/untick checkbox s·∫£n ph·∫©m
    document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const item = this.closest('.variant-item');
            if (this.checked) {
                item.classList.add('bg-blue-50', 'border-blue-200');
                item.classList.remove('hover:bg-gray-50', 'variant-not-selected');
            } else {
                item.classList.remove('bg-blue-50', 'border-blue-200');
                item.classList.add('hover:bg-gray-50', 'variant-not-selected');
            }
        });
    });
    
    // G√°n costId cho n√∫t upload ch·ª©ng t·ª´
    document.querySelectorAll('.cost-upload-trigger').forEach(btn => {
        btn.addEventListener('click', function() {
            const cid = this.dataset.costId;
            if (!cid) return;
            activeCostIdForUpload = cid;
            if (costImagesInput) {
                costImagesInput.click();
            }
        });
    });

    // X·ª≠ l√Ω s·ª≠a thi·ªát h·∫°i
    const modalEditCost = document.getElementById('modalEditCost');
    const formEditCost = document.getElementById('formEditCost');
    const editCostVariantSelect = document.getElementById('edit_cost_variant_id');
    const editCostQuantityInput = document.getElementById('edit_cost_quantity');
    const editCostUnitPriceInput = document.getElementById('edit_cost_unit_price');
    const editCostPaymentDateInput = document.getElementById('edit_cost_payment_date');
    const editDamageProductSection = document.getElementById('edit_damage_product_section');
    let editingCostId = null;
    
    // Chuy·ªÉn ng·ªØ c·∫£nh paste gi·ªØa upload ·∫£nh ticket & upload ·∫£nh thi·ªát h·∫°i
    let uploadPasteContext = 'ticket'; // 'ticket' | 'cost'

    // M·ªü modal s·ª≠a khi click n√∫t S·ª≠a - d√πng event delegation
    const costsListEl = document.getElementById('costsList');
    if (costsListEl) {
        costsListEl.addEventListener('click', function(e) {
            // X·ª≠ l√Ω n√∫t S·ª≠a
            const editBtn = e.target.closest('.cost-edit-trigger');
            
            if (editBtn) {
                e.preventDefault();
                e.stopPropagation();
                
                const costId = editBtn.dataset.costId;
                if (!costId) {
                    return;
                }
                
                // T√¨m cost item - t√¨m div con c·ªßa costsList c√≥ data-cost-id tr√πng v·ªõi costId
                if (!costsListEl) {
                    return;
                }
                
                // T√¨m div con c√≥ data-cost-id tr√πng v·ªõi costId
                const costItem = costsListEl.querySelector(`div[data-cost-id="${costId}"]`);
                if (!costItem) {
                    return;
                }
            
            editingCostId = costId;
            
            // L·∫•y t·ª´ data attributes - d√πng getAttribute ƒë·ªÉ ƒë·∫£m b·∫£o l·∫•y ƒë∆∞·ª£c gi√° tr·ªã
            const costType = costItem.getAttribute('data-cost-type') || '';
            const costAmount = costItem.getAttribute('data-cost-amount') || '0';
            const costNote = costItem.getAttribute('data-cost-note') || '';
            const costVariantId = costItem.getAttribute('data-cost-variant-id') || '';
            const costQuantity = costItem.getAttribute('data-cost-quantity') || '';
            const costUnitPrice = costItem.getAttribute('data-cost-unit-price') || '';
            const costPaymentDate = costItem.getAttribute('data-cost-payment-date') || '';
            
            // Set c√°c gi√° tr·ªã c∆° b·∫£n
            const editCostIdInput = document.getElementById('edit_cost_id');
            const editCostTypeSelect = document.getElementById('edit_cost_type');
            const editCostAmountInput = document.getElementById('edit_cost_amount');
            const editCostNoteInput = document.getElementById('edit_cost_note');
            
            if (!editCostIdInput || !editCostTypeSelect || !editCostAmountInput || !editCostNoteInput) {
                return;
            }
            
            editCostIdInput.value = costId;
            editCostTypeSelect.value = costType;
            editCostAmountInput.value = costAmount;
            editCostNoteInput.value = costNote;
            
            // Set payment date (∆∞u ti√™n t·ª´ data, n·∫øu kh√¥ng c√≥ th√¨ d√πng h√¥m nay)
            if (editCostPaymentDateInput) {
                editCostPaymentDateInput.value = costPaymentDate || new Date().toISOString().slice(0, 10);
            }
            
            // Populate variants n·∫øu ch∆∞a c√≥ (lu√¥n populate ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ s·∫µn)
            if (editCostVariantSelect && editCostVariantSelect.options.length <= 1) {
                try {
                    const variantsData = JSON.parse('{{ variants_json|safe }}' || '[]');
                    editCostVariantSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>';
                    if (Array.isArray(variantsData)) {
                        variantsData.forEach(v => {
                            const opt = document.createElement('option');
                            opt.value = v.variant_id;
                            opt.textContent = `${v.product_name || v.variant_name || ''} - ${v.sku || ''}`;
                            opt.dataset.price = v.price || '0';
                            opt.dataset.quantity = v.quantity || '0';
                            editCostVariantSelect.appendChild(opt);
                        });
                    }
                } catch (e) {
                    // Error parsing variants
                }
            }
            
            // Trigger change event ƒë·ªÉ hi·ªÉn th·ªã/·∫©n section s·∫£n ph·∫©m
            if (editCostTypeSelect) {
                const changeEvent = new Event('change', { bubbles: true });
                editCostTypeSelect.dispatchEvent(changeEvent);
            }
            
            // Sau khi section ƒë∆∞·ª£c hi·ªÉn th·ªã, set c√°c gi√° tr·ªã s·∫£n ph·∫©m n·∫øu c√≥
            setTimeout(() => {
                if (costType === 'H√†ng h·ªèng v·ª°') {
                    // Set variant, quantity, unit_price n·∫øu c√≥
                    if (costVariantId && editCostVariantSelect) {
                        editCostVariantSelect.value = costVariantId;
                        // Trigger change ƒë·ªÉ t√≠nh l·∫°i amount n·∫øu c·∫ßn
                        if (editCostVariantSelect) {
                            const variantChangeEvent = new Event('change', { bubbles: true });
                            editCostVariantSelect.dispatchEvent(variantChangeEvent);
                        }
                    }
                    if (costQuantity && editCostQuantityInput) {
                        editCostQuantityInput.value = costQuantity;
                        // Trigger input ƒë·ªÉ t√≠nh l·∫°i amount
                        if (editCostQuantityInput) {
                            const qtyInputEvent = new Event('input', { bubbles: true });
                            editCostQuantityInput.dispatchEvent(qtyInputEvent);
                        }
                    }
                    if (costUnitPrice && editCostUnitPriceInput) {
                        editCostUnitPriceInput.value = costUnitPrice;
                        // Trigger input ƒë·ªÉ t√≠nh l·∫°i amount
                        if (editCostUnitPriceInput) {
                            const priceInputEvent = new Event('input', { bubbles: true });
                            editCostUnitPriceInput.dispatchEvent(priceInputEvent);
                        }
                    }
                }
            }, 50);
            
                // M·ªü modal
                if (modalEditCost) {
                    modalEditCost.classList.remove('hidden');
                }
                return;
            }
            
            // X·ª≠ l√Ω upload context cho paste
            if (e.target.closest('.cost-upload-trigger') || e.target.closest('[data-cost-id]')) {
                uploadPasteContext = 'cost';
            }
        });
    }
    
    // Fallback: g·∫Øn listener tr·ª±c ti·∫øp cho c√°c n√∫t hi·ªán c√≥ (n·∫øu costsListEl kh√¥ng t·ªìn t·∫°i)
    document.querySelectorAll('.cost-edit-trigger').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const costId = this.dataset.costId;
            if (!costId) {
                return;
            }
            
            // T√¨m cost item - t√¨m div con c·ªßa costsList c√≥ data-cost-id tr√πng v·ªõi costId
            const costsListElFallback = document.getElementById('costsList');
            if (!costsListElFallback) {
                return;
            }
            
            // T√¨m div con c√≥ data-cost-id tr√πng v·ªõi costId
            const costItem = costsListElFallback.querySelector(`div[data-cost-id="${costId}"]`);
            if (!costItem) {
                return;
            }
            
            editingCostId = costId;
            
            // L·∫•y t·ª´ data attributes - d√πng getAttribute ƒë·ªÉ ƒë·∫£m b·∫£o l·∫•y ƒë∆∞·ª£c gi√° tr·ªã
            const costType = costItem.getAttribute('data-cost-type') || '';
            const costAmount = costItem.getAttribute('data-cost-amount') || '0';
            const costNote = costItem.getAttribute('data-cost-note') || '';
            const costVariantId = costItem.getAttribute('data-cost-variant-id') || '';
            const costQuantity = costItem.getAttribute('data-cost-quantity') || '';
            const costUnitPrice = costItem.getAttribute('data-cost-unit-price') || '';
            const costPaymentDate = costItem.getAttribute('data-cost-payment-date') || '';
            
            // Set c√°c gi√° tr·ªã c∆° b·∫£n
            const editCostIdInput = document.getElementById('edit_cost_id');
            const editCostTypeSelect = document.getElementById('edit_cost_type');
            const editCostAmountInput = document.getElementById('edit_cost_amount');
            const editCostNoteInput = document.getElementById('edit_cost_note');
            
            if (!editCostIdInput || !editCostTypeSelect || !editCostAmountInput || !editCostNoteInput) {
                return;
            }
            
            editCostIdInput.value = costId;
            editCostTypeSelect.value = costType;
            editCostAmountInput.value = costAmount;
            editCostNoteInput.value = costNote;
            
            // Set payment date (∆∞u ti√™n t·ª´ data, n·∫øu kh√¥ng c√≥ th√¨ d√πng h√¥m nay)
            if (editCostPaymentDateInput) {
                editCostPaymentDateInput.value = costPaymentDate || new Date().toISOString().slice(0, 10);
            }
            
            // Populate variants n·∫øu ch∆∞a c√≥ (lu√¥n populate ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ s·∫µn)
            if (editCostVariantSelect && editCostVariantSelect.options.length <= 1) {
                try {
                    const variantsData = JSON.parse('{{ variants_json|safe }}' || '[]');
                    editCostVariantSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>';
                    if (Array.isArray(variantsData)) {
                        variantsData.forEach(v => {
                            const opt = document.createElement('option');
                            opt.value = v.variant_id;
                            opt.textContent = `${v.product_name || v.variant_name || ''} - ${v.sku || ''}`;
                            opt.dataset.price = v.price || '0';
                            opt.dataset.quantity = v.quantity || '0';
                            editCostVariantSelect.appendChild(opt);
                        });
                    }
                } catch (e) {
                    // Error parsing variants
                }
            }
            
            // Trigger change event ƒë·ªÉ hi·ªÉn th·ªã/·∫©n section s·∫£n ph·∫©m
            if (editCostTypeSelect) {
                const changeEvent = new Event('change', { bubbles: true });
                editCostTypeSelect.dispatchEvent(changeEvent);
            }
            
            // Sau khi section ƒë∆∞·ª£c hi·ªÉn th·ªã, set c√°c gi√° tr·ªã s·∫£n ph·∫©m n·∫øu c√≥
            setTimeout(() => {
                if (costType === 'H√†ng h·ªèng v·ª°') {
                    // Set variant, quantity, unit_price n·∫øu c√≥
                    if (costVariantId && editCostVariantSelect) {
                        editCostVariantSelect.value = costVariantId;
                        // Trigger change ƒë·ªÉ t√≠nh l·∫°i amount n·∫øu c·∫ßn
                        if (editCostVariantSelect) {
                            const variantChangeEvent = new Event('change', { bubbles: true });
                            editCostVariantSelect.dispatchEvent(variantChangeEvent);
                        }
                    }
                    if (costQuantity && editCostQuantityInput) {
                        editCostQuantityInput.value = costQuantity;
                        // Trigger input ƒë·ªÉ t√≠nh l·∫°i amount
                        if (editCostQuantityInput) {
                            const qtyInputEvent = new Event('input', { bubbles: true });
                            editCostQuantityInput.dispatchEvent(qtyInputEvent);
                        }
                    }
                    if (costUnitPrice && editCostUnitPriceInput) {
                        editCostUnitPriceInput.value = costUnitPrice;
                        // Trigger input ƒë·ªÉ t√≠nh l·∫°i amount
                        if (editCostUnitPriceInput) {
                            const priceInputEvent = new Event('input', { bubbles: true });
                            editCostUnitPriceInput.dispatchEvent(priceInputEvent);
                        }
                    }
                }
            }, 50);
            
            // M·ªü modal
            if (modalEditCost) {
                modalEditCost.classList.remove('hidden');
            }
        });
    });

    // X·ª≠ l√Ω x√≥a thi·ªát h·∫°i
    document.querySelectorAll('.cost-delete-trigger').forEach(btn => {
        btn.addEventListener('click', function() {
            const costId = this.dataset.costId;
            if (!costId) return;
            
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a thi·ªát h·∫°i n√†y?')) {
                return;
            }
            
            fetch(`{% url 'cskh:api_delete_cost' ticket.id 0 %}`.replace('/0/delete/', `/${costId}/delete/`), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('ƒê√£ x√≥a thi·ªát h·∫°i th√†nh c√¥ng');
                    location.reload();
                } else {
                    alert('L·ªói: ' + (data.error || ''));
                }
            })
            .catch(err => {
                alert('L·ªói khi x√≥a thi·ªát h·∫°i: ' + err);
            });
        });
    });

    // X·ª≠ l√Ω form s·ª≠a thi·ªát h·∫°i
    if (formEditCost) {
        // Hi·ªÉn th·ªã/·∫©n section s·∫£n ph·∫©m khi ch·ªçn lo·∫°i chi ph√≠
        const editCostTypeSelect = document.getElementById('edit_cost_type');
        if (editCostTypeSelect) {
            editCostTypeSelect.addEventListener('change', function() {
                if (this.value === 'H√†ng h·ªèng v·ª°' && editDamageProductSection) {
                    editDamageProductSection.classList.remove('hidden');
                    if (editCostVariantSelect && editCostVariantSelect.options.length <= 1) {
                        const variantsData = JSON.parse('{{ variants_json|safe }}' || '[]');
                        editCostVariantSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>';
                        if (Array.isArray(variantsData)) {
                            variantsData.forEach(v => {
                                const opt = document.createElement('option');
                                opt.value = v.variant_id;
                                opt.textContent = `${v.product_name || v.variant_name || ''} - ${v.sku || ''}`;
                                opt.dataset.price = v.price || '0';
                                opt.dataset.quantity = v.quantity || '0';
                                editCostVariantSelect.appendChild(opt);
                            });
                        }
                    }
                } else if (editDamageProductSection) {
                    editDamageProductSection.classList.add('hidden');
                }
            });
        }

        // T√≠nh l·∫°i s·ªë ti·ªÅn khi thay ƒë·ªïi variant/quantity/unit_price
        function recalcEditDamageAmount() {
            if (!editCostVariantSelect || !editCostQuantityInput || !document.getElementById('edit_cost_amount')) return;
            const opt = editCostVariantSelect.selectedOptions[0];
            if (!opt) return;

            const price = parseFloat(opt.dataset.price || '0') || 0;
            let qty = parseInt(editCostQuantityInput.value || '0', 10) || 0;
            const maxQty = parseInt(opt.dataset.quantity || '0', 10) || 0;

            if (maxQty && qty > maxQty) {
                qty = maxQty;
                if (editCostQuantityInput) {
                    editCostQuantityInput.value = String(maxQty);
                }
                alert(`S·ªë l∆∞·ª£ng h·ªèng v·ª° kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng trong ƒë∆°n (${maxQty}).`);
            }

            const currentVariantId = opt.value;
            if (currentVariantId !== lastDamageVariantId) {
                if (editCostUnitPriceInput) {
                    editCostUnitPriceInput.value = price > 0 ? Math.round(price) : '';
                }
                lastDamageVariantId = currentVariantId;
            }

            if (price > 0 && qty > 0) {
                const unit = editCostUnitPriceInput && parseFloat(editCostUnitPriceInput.value || '0') > 0
                    ? parseFloat(editCostUnitPriceInput.value || '0')
                    : price;
                const amount = unit * qty;
                const amountInput = document.getElementById('edit_cost_amount');
                if (amountInput) {
                    amountInput.value = Math.round(amount);
                }
            }
        }

        if (editCostVariantSelect) {
            editCostVariantSelect.addEventListener('change', recalcEditDamageAmount);
        }
        if (editCostQuantityInput) {
            editCostQuantityInput.addEventListener('input', recalcEditDamageAmount);
        }
        if (editCostUnitPriceInput) {
            editCostUnitPriceInput.addEventListener('input', recalcEditDamageAmount);
        }

        formEditCost.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const costId = document.getElementById('edit_cost_id').value;
            if (!costId) {
                alert('Kh√¥ng t√¨m th·∫•y ID thi·ªát h·∫°i');
                return;
            }
            
            const costType = document.getElementById('edit_cost_type').value;
            const amount = document.getElementById('edit_cost_amount').value;
            const note = document.getElementById('edit_cost_note').value;
            
            let payload = {cost_type: costType, amount: amount, note: note};
            
            if (costType === 'H√†ng h·ªèng v·ª°' && editCostVariantSelect && editCostVariantSelect.value) {
                const opt = editCostVariantSelect.selectedOptions[0];
                payload.variant_id = editCostVariantSelect.value;
                payload.product_name = opt.textContent.split(' - ')[0] || '';
                payload.variant_name = payload.product_name;
                payload.sku = opt.textContent.split(' - ')[1] || '';
                payload.quantity = editCostQuantityInput ? editCostQuantityInput.value : null;
                payload.unit_price = editCostUnitPriceInput ? editCostUnitPriceInput.value : null;
            }
            
            if (editCostPaymentDateInput && editCostPaymentDateInput.value) {
                payload.payment_date = editCostPaymentDateInput.value;
            }
            
            fetch(`{% url 'cskh:api_update_cost' ticket.id 0 %}`.replace('/0/update/', `/${costId}/update/`), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('S·ª≠a thi·ªát h·∫°i th√†nh c√¥ng');
                    location.reload();
                } else {
                    alert('L·ªói: ' + (data.error || ''));
                }
            })
            .catch(err => {
                alert('L·ªói khi s·ª≠a thi·ªát h·∫°i: ' + err);
            });
        });
    }

    // ƒê√≥ng modal s·ª≠a
    const btnCancelEditCost = document.getElementById('btnCancelEditCost');
    if (btnCancelEditCost) {
        btnCancelEditCost.addEventListener('click', function() {
            if (modalEditCost) {
                modalEditCost.classList.add('hidden');
            }
        });
    }
    if (modalEditCost) {
        modalEditCost.addEventListener('click', function(e) {
            if (e.target === modalEditCost) {
                modalEditCost.classList.add('hidden');
            }
        });
    }

    function uploadCostFiles(files) {
        if (!files || !files.length || !activeCostIdForUpload) {
            alert('Vui l√≤ng ch·ªçn kho·∫£n thi·ªát h·∫°i v√† √≠t nh·∫•t m·ªôt file ƒë·ªÉ upload');
            return;
        }
        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('images', file);
        });

        fetch(`{% url 'cskh:api_upload_cost_files' ticket.id 0 %}`.replace('/0/upload-files/', `/${activeCostIdForUpload}/upload-files/`), {
            method: 'POST',
            body: formData,
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Upload ·∫£nh ch·ª©ng t·ª´ th√†nh c√¥ng');
                if (costImagesPreview) {
                    costImagesPreview.innerHTML = '';
                }
                location.reload();
            } else {
                alert('L·ªói upload: ' + (data.error || ''));
            }
        })
        .catch(err => {
            alert('L·ªói upload: ' + err);
        });
    }

    if (costImagesInput) {
        costImagesInput.addEventListener('change', function(e) {
            uploadCostFiles(e.target.files);
        });
    }

    // H√†m chung ƒë·ªÉ th√™m preview file (·∫£nh/video) khi ch·ªçn t·∫°i ch·ªó
    function addPreviewFileDetail(file, imagePath = null) {
        const div = document.createElement('div');
        div.className = 'relative ticket-media-item cursor-pointer group w-20 h-20';
        
        if (file && file.type && file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = imagePath ? `/static/${imagePath}` : URL.createObjectURL(file);
            img.className = 'w-full h-full object-cover rounded border border-gray-200';
            div.appendChild(img);
            div.dataset.mediaType = 'image';
            div.dataset.mediaSrc = imagePath ? `/static/${imagePath}` : img.src;
        } else if (file && file.type && file.type.startsWith('video/')) {
            const video = document.createElement('video');
            video.src = imagePath ? `/static/${imagePath}` : URL.createObjectURL(file);
            video.className = 'w-full h-full object-cover rounded border border-gray-200 bg-black';
            video.controls = true;
            video.muted = true;
            video.preload = 'metadata';
            div.appendChild(video);
            div.dataset.mediaType = 'video';
            div.dataset.mediaSrc = imagePath ? `/static/${imagePath}` : video.src;

            // Overlay label "Video"
            const badge = document.createElement('div');
            badge.className = 'absolute inset-0 flex items-center justify-center';
            badge.innerHTML = '<span class="px-1.5 py-0.5 text-[10px] bg-black/60 text-white rounded">Video</span>';
            div.appendChild(badge);
        } else if (imagePath) {
            // Tr∆∞·ªùng h·ª£p hi·ªÉn th·ªã ·∫£nh ƒë√£ c√≥ s·∫µn t·ª´ server
            const pathLower = imagePath.toLowerCase();
            const isVideo = pathLower.includes('.mp4') || pathLower.includes('.mov') || pathLower.includes('.webm');
            
            if (isVideo) {
                const video = document.createElement('video');
                video.src = `/static/${imagePath}`;
                video.className = 'w-full h-full object-cover rounded border border-gray-200 bg-black';
                video.muted = true;
                video.preload = 'metadata';
                div.appendChild(video);
                div.dataset.mediaType = 'video';
                div.dataset.mediaSrc = `/static/${imagePath}`;
                
                const badge = document.createElement('div');
                badge.className = 'absolute inset-0 flex items-center justify-center';
                badge.innerHTML = '<span class="px-1.5 py-0.5 text-[10px] bg-black/60 text-white rounded">Video</span>';
                div.appendChild(badge);
            } else {
                const img = document.createElement('img');
                img.src = `/static/${imagePath}`;
                img.className = 'w-full h-full object-cover rounded border border-gray-200';
                div.appendChild(img);
                div.dataset.mediaType = 'image';
                div.dataset.mediaSrc = `/static/${imagePath}`;
            }
        }
        
        // N√∫t x√≥a (ch·ªâ hi·ªán khi hover) - ch·ªâ cho preview ch∆∞a upload
        if (!imagePath) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = function(e) {
                e.stopPropagation();
                div.remove();
            };
            div.appendChild(removeBtn);
        }
        imagePreview.appendChild(div);
    }
    
    // T·ª± ƒë·ªông upload khi ch·ªçn file
    imagesInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        
        // Hi·ªÉn th·ªã preview ngay
        files.forEach(file => {
            addPreviewFileDetail(file);
        });
        
        // T·ª± ƒë·ªông upload
        const formData = new FormData();
        files.forEach(file => {
            formData.append('images', file);
        });
        
        fetch(`{% url 'cskh:api_upload_ticket_files' ticket.id %}`, {
            method: 'POST',
            body: formData,
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Reload ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh t·ª´ server
                location.reload();
            } else {
                alert('L·ªói upload: ' + (data.error || ''));
                // X√≥a preview n·∫øu upload l·ªói
                imagePreview.querySelectorAll('.ticket-media-item').forEach(item => {
                    if (!item.dataset.imagePath) {
                        item.remove();
                    }
                });
            }
        })
        .catch(err => {
            alert('L·ªói upload: ' + err);
            // X√≥a preview n·∫øu upload l·ªói
            imagePreview.querySelectorAll('.ticket-media-item').forEach(item => {
                if (!item.dataset.imagePath) {
                    item.remove();
                }
            });
        });
        
        // Reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i file
        imagesInput.value = '';
    });
    
    if (imagePreview && imagePreview.parentElement) {
        imagePreview.parentElement.addEventListener('click', function() {
            uploadPasteContext = 'ticket';
        });
    }
    // costsListEl ƒë√£ ƒë∆∞·ª£c khai b√°o ·ªü tr√™n, kh√¥ng c·∫ßn khai b√°o l·∫°i

    // H·ªó tr·ª£ d√°n (Ctrl+V) ·∫£nh t·ª´ clipboard v√†o upload (ticket images ho·∫∑c cost images)
    document.addEventListener('paste', function(e) {
        // Kh√¥ng can thi·ªáp khi ƒëang g√µ trong input/textarea
        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) {
            return;
        }

        const clipboardData = e.clipboardData || window.clipboardData;
        if (!clipboardData || !clipboardData.items) return;

        const items = Array.from(clipboardData.items);
        const imageItems = items.filter(item => item.kind === 'file' && item.type.startsWith('image/'));
        if (!imageItems.length) return;

        e.preventDefault();

        if (uploadPasteContext === 'cost' && costImagesInput) {
            const dt = new DataTransfer();
            imageItems.forEach(item => {
                const file = item.getAsFile();
                if (file) {
                    dt.items.add(file);
                }
            });
            uploadCostFiles(dt.files);
        } else if (imagesInput) {
            // T·ª± ƒë·ªông upload khi paste ·∫£nh
            const files = imageItems.map(item => item.getAsFile()).filter(f => f);
            if (files.length) {
                const formData = new FormData();
                files.forEach(file => {
                    formData.append('images', file);
                });
                
                fetch(`{% url 'cskh:api_upload_ticket_files' ticket.id %}`, {
                    method: 'POST',
                    body: formData,
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('L·ªói upload: ' + (data.error || ''));
                    }
                })
                .catch(err => {
                    alert('L·ªói upload: ' + err);
                });
            }
        }
    });
    
    // X√≥a t·∫•t c·∫£ ·∫£nh - t·∫°m th·ªùi b·ªè v√¨ ch∆∞a c√≥ API
    // const btnDeleteAllImages = document.getElementById('btnDeleteAllImages');
    // if (btnDeleteAllImages) {
    //     btnDeleteAllImages.addEventListener('click', function() {
    //         // TODO: Implement API to delete all images
    //     });
    // }

    // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám
    if (btnSaveResponsible) {
        btnSaveResponsible.addEventListener('click', function() {
            const responsibleUserId = responsibleUserSelect ? responsibleUserSelect.value : '';
            const responsibleDepartment = responsibleDepartmentSelect ? responsibleDepartmentSelect.value : '';
            const responsibleNote = responsibleNoteTextarea ? responsibleNoteTextarea.value.trim() : '';
            
            fetch(`{% url 'cskh:api_update_responsible' ticket.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    responsible_user_id: responsibleUserId || null,
                    responsible_department: responsibleDepartment,
                    responsible_note: responsibleNote,
                }),
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('C·∫≠p nh·∫≠t th√¥ng tin tr√°ch nhi·ªám th√†nh c√¥ng');
                    location.reload();
                } else {
                    alert('L·ªói c·∫≠p nh·∫≠t: ' + (data.error || ''));
                }
            })
            .catch(err => {
                alert('L·ªói c·∫≠p nh·∫≠t: ' + err);
            });
        });
    }

    // Expand/Collapse l·ªãch s·ª≠ x·ª≠ l√Ω
    if (logsContainer && btnToggleLogs && btnToggleLogsText && btnToggleLogsIcon) {
        let logsExpanded = false;

        function updateLogsState() {
            if (logsExpanded) {
                logsContainer.classList.remove('max-h-64', 'overflow-y-hidden');
                logsContainer.classList.add('max-h-[480px]', 'overflow-y-auto');
                btnToggleLogsText.textContent = 'Thu g·ªçn';
                btnToggleLogsIcon.textContent = '‚ñ≤';
            } else {
                logsContainer.classList.remove('max-h-[480px]', 'overflow-y-auto');
                logsContainer.classList.add('max-h-64', 'overflow-y-hidden');
                btnToggleLogsText.textContent = 'Xem th√™m';
                btnToggleLogsIcon.textContent = '‚ñº';
            }
        }

        btnToggleLogs.addEventListener('click', function() {
            logsExpanded = !logsExpanded;
            updateLogsState();
        });

        // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu (thu g·ªçn)
        updateLogsState();
    }
    
    // Th√™m Trouble & Event m·ªõi
    if (btnAddEvent) {
        btnAddEvent.addEventListener('click', function() {
            const content = (eventContentInput.value || '').trim();
            
            // Thu th·∫≠p tags t·ª´ checkbox preset
            const selectedTags = [];
            document.querySelectorAll('.event-tag-option:checked').forEach(cb => {
                if (cb.value) selectedTags.push(cb.value);
            });
            
            const tags = selectedTags.join(', ');
            
            if (!content) {
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung event');
                return;
            }
            
            fetch(`{% url 'cskh:api_add_event' ticket.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: content, tags: tags }),
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    eventContentInput.value = '';
                    document.querySelectorAll('.event-tag-option').forEach(cb => cb.checked = false);
                    location.reload();
                } else {
                    alert('L·ªói th√™m event: ' + (data.error || ''));
                }
            })
            .catch(err => {
                alert('L·ªói th√™m event: ' + err);
            });
        });
    }

    // Th√™m / s·ª≠a h∆∞·ªõng x·ª≠ l√Ω (sugget_process)
    if (btnToggleSuggetForm && suggetFormContainer) {
        btnToggleSuggetForm.addEventListener('click', function () {
            const isHidden = suggetFormContainer.classList.contains('hidden');
            if (isHidden) {
                suggetFormContainer.classList.remove('hidden');
            } else {
                suggetFormContainer.classList.add('hidden');
            }
        });
    }

    if (btnSaveSuggetProcess && suggetMainSelect && suggetDescriptionInput) {
        btnSaveSuggetProcess.addEventListener('click', function () {
            const mainValue = (suggetMainSelect.value || '').trim();
            const descValue = (suggetDescriptionInput.value || '').trim();

            if (!mainValue) {
                alert('Vui l√≤ng ch·ªçn h∆∞·ªõng x·ª≠ l√Ω ch√≠nh');
                return;
            }

            fetch(`{% url 'cskh:api_update_sugget_process' ticket.id %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sugget_main: mainValue,
                    description: descValue,
                }),
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('ƒê√£ l∆∞u h∆∞·ªõng x·ª≠ l√Ω cho ticket');
                        location.reload();
                    } else {
                        alert('L·ªói l∆∞u h∆∞·ªõng x·ª≠ l√Ω: ' + (data.error || ''));
                    }
                })
                .catch(err => {
                    alert('L·ªói l∆∞u h∆∞·ªõng x·ª≠ l√Ω: ' + err);
                });
        });
    }

    // Lightbox xem ·∫£nh / video
    const lightbox = document.getElementById('mediaLightbox');
    const mediaContent = document.getElementById('mediaContent');
    const btnClose = document.getElementById('mediaCloseBtn');
    const btnPrev = document.getElementById('mediaPrevBtn');
    const btnNext = document.getElementById('mediaNextBtn');
    
    let mediaItems = [];
    let currentIndex = 0;
    
    function collectMediaItems() {
        // L·∫•y t·∫•t c·∫£ ticket-media-item (·∫£nh/v√≠deo c·ªßa ticket + thi·ªát h·∫°i)
        mediaItems = Array.from(document.querySelectorAll('.ticket-media-item'));
        mediaItems.forEach((el, idx) => {
            el.dataset.index = idx;
        });
    }
    
    function openLightbox(index) {
        if (!lightbox || !mediaContent) return;
        collectMediaItems();
        if (!mediaItems.length) return;
        
        currentIndex = ((index % mediaItems.length) + mediaItems.length) % mediaItems.length;
        const el = mediaItems[currentIndex];
        const type = el.dataset.mediaType || 'image';
        const src = el.dataset.mediaSrc || el.querySelector('img,video')?.src;
        if (!src) return;
        
        mediaContent.innerHTML = '';
        
        if (type === 'video') {
            const video = document.createElement('video');
            video.src = src;
            video.controls = true;
            video.autoplay = true;
            video.className = 'max-h-[90vh] max-w-full rounded bg-black';
            mediaContent.appendChild(video);
        } else {
            const img = document.createElement('img');
            img.src = src;
            img.className = 'max-h-[90vh] max-w-full rounded';
            mediaContent.appendChild(img);
        }
        
        lightbox.classList.remove('hidden');
    }
    
    function closeLightbox() {
        if (!lightbox || !mediaContent) return;
        lightbox.classList.add('hidden');
        mediaContent.innerHTML = '';
    }
    
    function showNext(delta) {
        if (!mediaItems.length) return;
        currentIndex = (currentIndex + delta + mediaItems.length) % mediaItems.length;
        openLightbox(currentIndex);
    }
    
    // G√°n click cho c√°c media item hi·ªán c√≥
    function attachMediaClickHandlers() {
        collectMediaItems();
        mediaItems.forEach((el) => {
            el.onclick = function() {
                const idx = parseInt(this.dataset.index || '0', 10) || 0;
                openLightbox(idx);
            };
        });
    }
    
    attachMediaClickHandlers();
    
    // ƒê√≥ng khi click n√∫t X ho·∫∑c n·ªÅn ƒëen
    if (btnClose) {
        btnClose.addEventListener('click', closeLightbox);
    }
    if (lightbox) {
        lightbox.addEventListener('click', function(e) {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });
    }
    
    if (btnPrev) {
        btnPrev.addEventListener('click', function(e) {
            e.stopPropagation();
            showNext(-1);
        });
    }
    
    if (btnNext) {
        btnNext.addEventListener('click', function(e) {
            e.stopPropagation();
            showNext(1);
        });
    }
    
    // ƒêi·ªÅu khi·ªÉn b·∫±ng ph√≠m ‚Üê ‚Üí v√† Esc khi lightbox m·ªü
    document.addEventListener('keydown', function(e) {
        if (!lightbox || lightbox.classList.contains('hidden')) {
            return;
        }
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            showNext(1);
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            showNext(-1);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            closeLightbox();
        }
    });
});
</script>
{% endblock extra_scripts %}
