{% extends "cskh/base_cskh.html" %}
{% load humanize %}

{% block title %}Feedback Sync Status – CSKH{% endblock %}

{% block overview %}
<section class="px-4 mb-4">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl md:text-lg font-semibold text-slate-800">Feedback Sync Status</h1>
            <p class="text-sm md:text-xs text-gray-500 mt-1">Theo dõi tiến trình sync feedbacks từ Shopee API</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'cskh:feedback_list' %}" 
               class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm font-semibold">
                ← Quay lại
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block main_content %}
<div class="flex-1 min-w-0 overflow-x-hidden">
    
    <!-- Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
        <div class="bg-white border rounded-lg p-4 shadow-sm">
            <div class="text-xs text-gray-500 mb-1">Tổng số jobs</div>
            <div class="text-2xl font-bold text-gray-900">{{ stats.total_jobs|intcomma }}</div>
        </div>
        <div class="bg-white border rounded-lg p-4 shadow-sm">
            <div class="text-xs text-gray-500 mb-1">Đang chạy</div>
            <div class="text-2xl font-bold text-blue-600">{{ stats.running_jobs|intcomma }}</div>
        </div>
        <div class="bg-white border rounded-lg p-4 shadow-sm">
            <div class="text-xs text-gray-500 mb-1">Hoàn thành</div>
            <div class="text-2xl font-bold text-green-600">{{ stats.completed_jobs|intcomma }}</div>
        </div>
        <div class="bg-white border rounded-lg p-4 shadow-sm">
            <div class="text-xs text-gray-500 mb-1">Thất bại</div>
            <div class="text-2xl font-bold text-red-600">{{ stats.failed_jobs|intcomma }}</div>
        </div>
        <div class="bg-white border rounded-lg p-4 shadow-sm">
            <div class="text-xs text-gray-500 mb-1">Chờ xử lý</div>
            <div class="text-2xl font-bold text-yellow-600">{{ stats.pending_jobs|intcomma }}</div>
        </div>
    </div>
    
    <!-- Jobs List -->
    <div class="bg-white border rounded-xl shadow-sm overflow-hidden">
        <div class="p-4 border-b bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900">Danh sách Sync Jobs</h2>
        </div>
        
        <div class="divide-y">
            {% for job in jobs %}
            <div class="p-4 hover:bg-gray-50 transition" id="job-{{ job.id }}">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded
                                {% if job.sync_type == 'full' %}bg-blue-100 text-blue-700{% else %}bg-green-100 text-green-700{% endif %}">
                                {{ job.get_sync_type_display }}
                            </span>
                            <span class="px-2 py-1 text-xs font-semibold rounded
                                {% if job.status == 'running' %}bg-blue-100 text-blue-700
                                {% elif job.status == 'completed' %}bg-green-100 text-green-700
                                {% elif job.status == 'failed' %}bg-red-100 text-red-700
                                {% elif job.status == 'paused' %}bg-yellow-100 text-yellow-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {{ job.get_status_display }}
                            </span>
                            <span class="text-xs text-gray-500">Job #{{ job.id }}</span>
                        </div>
                        
                        {% if job.status == 'running' and job.total_feedbacks > 0 %}
                        <div class="mb-2">
                            <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                                <span>Tiến trình: {{ job.processed_feedbacks|intcomma }}/{{ job.total_feedbacks|intcomma }}</span>
                                <span>{% widthratio job.processed_feedbacks job.total_feedbacks 100 %}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                     style="width: {% widthratio job.processed_feedbacks job.total_feedbacks 100 %}%"></div>
                            </div>
                        </div>
                        {% elif job.status == 'running' %}
                        <div class="mb-2 text-xs text-gray-500">
                            Đang xử lý... (chưa có tổng số feedbacks)
                        </div>
                        {% endif %}
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Đã sync:</span>
                                <span class="font-semibold text-gray-900 ml-1" data-field="synced">{{ job.synced_feedbacks|intcomma }}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Đã update:</span>
                                <span class="font-semibold text-gray-900 ml-1" data-field="updated">{{ job.updated_feedbacks|intcomma }}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Lỗi:</span>
                                <span class="font-semibold text-red-600 ml-1" data-field="errors">{{ job.error_count|intcomma }}</span>
                            </div>
                            {% if job.current_shop_name %}
                            <div>
                                <span class="text-gray-500">Shop hiện tại:</span>
                                <span class="font-semibold text-gray-900 ml-1">{{ job.current_shop_name }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="text-right text-xs text-gray-500">
                        {% if job.started_at %}
                        <div>Bắt đầu: {{ job.started_at|date:"d/m/Y H:i" }}</div>
                        {% endif %}
                        {% if job.completed_at %}
                        <div>Hoàn thành: {{ job.completed_at|date:"d/m/Y H:i" }}</div>
                        {% endif %}
                        {% if job.duration %}
                        <div>Thời gian: {{ job.duration.total_seconds|stringformat:"d" }}s</div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Logs và Errors (collapsible) -->
                <div class="mt-3 space-y-2">
                    <button onclick="toggleJobDetails({{ job.id }})" 
                            class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                        <span id="toggle-{{ job.id }}">▼</span> Xem chi tiết
                    </button>
                    
                    <div id="details-{{ job.id }}" class="hidden mt-2 space-y-2">
                        {% if job.logs %}
                        <div>
                            <div class="text-xs font-semibold text-gray-700 mb-1">Logs ({{ job.logs|length }} dòng):</div>
                            <div class="bg-gray-50 rounded p-2 max-h-40 overflow-y-auto text-xs font-mono text-gray-700">
                                {% for log in job.logs|slice:":20" %}
                                <div>{{ log }}</div>
                                {% endfor %}
                                {% if job.logs|length > 20 %}
                                <div class="text-gray-500">... và {% widthratio job.logs|length 1 1|add:"-20" %} dòng khác</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if job.errors %}
                        <div>
                            <div class="text-xs font-semibold text-red-700 mb-1">Errors ({{ job.errors|length }} lỗi):</div>
                            <div class="bg-red-50 rounded p-2 max-h-40 overflow-y-auto text-xs font-mono text-red-700">
                                {% for error in job.errors|slice:":10" %}
                                <div>{{ error }}</div>
                                {% endfor %}
                                {% if job.errors|length > 10 %}
                                <div class="text-gray-500">... và {{ job.errors|length|add:"-10" }} lỗi khác</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="p-8 text-center text-gray-500">
                Chưa có sync job nào.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function toggleJobDetails(jobId) {
    const details = document.getElementById(`details-${jobId}`);
    const toggle = document.getElementById(`toggle-${jobId}`);
    
    if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        toggle.textContent = '▲';
    } else {
        details.classList.add('hidden');
        toggle.textContent = '▼';
    }
}

// Auto-refresh cho các jobs đang chạy
{% for job in jobs %}
    {% if job.status == 'running' %}
    (function() {
        const jobId = {{ job.id }};
        let refreshCount = 0;
        const maxRefreshes = 300; // 5 phút (mỗi 1 giây)
        
        function refreshJobStatus() {
            if (refreshCount >= maxRefreshes) return;
            refreshCount++;
            
            fetch(`/cskh/api/feedback/sync/status/${jobId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching job status:', data.error);
                        return;
                    }
                    
                    // Update progress bar
                    const progressBar = document.querySelector(`#job-${jobId} .bg-blue-600`);
                    if (progressBar && data.progress_percentage !== undefined) {
                        progressBar.style.width = `${data.progress_percentage}%`;
                    }
                    
                    // Update numbers
                    const jobElement = document.getElementById(`job-${jobId}`);
                    if (jobElement) {
                        // Update synced count
                        const syncedEl = jobElement.querySelector('[data-field="synced"]');
                        if (syncedEl) syncedEl.textContent = data.synced_feedbacks.toLocaleString();
                        
                        // Update updated count
                        const updatedEl = jobElement.querySelector('[data-field="updated"]');
                        if (updatedEl) updatedEl.textContent = data.updated_feedbacks.toLocaleString();
                        
                        // Update error count
                        const errorEl = jobElement.querySelector('[data-field="errors"]');
                        if (errorEl) errorEl.textContent = data.error_count.toLocaleString();
                    }
                    
                    // Nếu job đã completed hoặc failed, dừng refresh
                    if (data.status === 'completed' || data.status === 'failed') {
                        // Reload page sau 2 giây
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                        return;
                    }
                    
                    // Tiếp tục refresh sau 1 giây
                    setTimeout(refreshJobStatus, 1000);
                })
                .catch(error => {
                    console.error('Error refreshing job status:', error);
                    setTimeout(refreshJobStatus, 5000); // Retry sau 5 giây nếu lỗi
                });
        }
        
        // Bắt đầu refresh sau 1 giây
        setTimeout(refreshJobStatus, 1000);
    })();
    {% endif %}
{% endfor %}
</script>
{% endblock %}

