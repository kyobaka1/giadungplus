{% extends "cskh/base_cskh.html" %}
{% load humanize %}

{% block title %}Feedback Center ‚Äì Danh s√°ch Reviews{% endblock %}

{% block overview %}
<section class="flex items-center justify-between">
    <div>
        <h1 class="text-xl md:text-lg font-semibold text-slate-800">Feedback Center ‚Äì Danh s√°ch Reviews</h1>
        <p class="text-sm md:text-xs text-gray-500 mt-1">T·ªïng s·ªë: {{ total_count }} reviews</p>
    </div>
    <button onclick="syncFeedbacks()" 
        class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm font-semibold">
        üîÑ Sync t·ª´ Sapo MP
    </button>
</section>
{% endblock %}

{% block main_content %}
<div class="flex-1 min-w-0 overflow-x-hidden">

    <!-- Filters -->
    <div class="bg-white border rounded-xl p-4 shadow-sm mb-4">
        <form method="GET" id="filterForm" class="space-y-4">
            <!-- Status Filters (Tr·∫°ng th√°i) -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-2">Tr·∫°ng th√°i:</label>
                <div class="flex flex-wrap gap-2">
                    <button type="button" onclick="setStatusFilter('all')" 
                        class="px-3 py-1.5 text-xs rounded-lg border {% if current_status == 'all' or not current_status %}bg-brand text-white border-brand{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %} transition">
                        T·∫•t c·∫£ <span class="ml-1 font-semibold">({{ filter_counts.all|intcomma }})</span>
                    </button>
                    <button type="button" onclick="setStatusFilter('pending')" 
                        class="px-3 py-1.5 text-xs rounded-lg border {% if current_status == 'pending' %}bg-brand text-white border-brand{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %} transition">
                        C·∫ßn ph·∫£n h·ªìi <span class="ml-1 font-semibold">({{ filter_counts.pending|intcomma }})</span>
                    </button>
                    <button type="button" onclick="setStatusFilter('replied')" 
                        class="px-3 py-1.5 text-xs rounded-lg border {% if current_status == 'replied' %}bg-brand text-white border-brand{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %} transition">
                        ƒê√£ tr·∫£ l·ªùi <span class="ml-1 font-semibold">({{ filter_counts.replied|intcomma }})</span>
                    </button>
                    <input type="hidden" name="status" id="statusInput" value="{{ current_status }}">
                </div>
            </div>

            <!-- Star Rating Filters (S·ªë sao ƒë√°nh gi√°) -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-2">S·ªë sao ƒë√°nh gi√°:</label>
                <div class="flex flex-wrap gap-3 items-center">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="rating" value="all" 
                            onchange="toggleRatingFilter('all', this)"
                            {% if 'all' in current_ratings or not current_ratings %}checked{% endif %}
                            class="w-4 h-4 text-brand border-gray-300 rounded focus:ring-brand">
                        <span class="text-xs text-gray-700">T·∫•t c·∫£</span>
                    </label>
                    {% for rating_num in "54321" %}
                        {% with rating=rating_num|add:0 %}
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="rating" value="{{ rating }}" 
                                onchange="toggleRatingFilter('{{ rating }}', this)"
                                {% if rating|stringformat:"s" in current_ratings %}checked{% endif %}
                                class="w-4 h-4 text-brand border-gray-300 rounded focus:ring-brand">
                            <span class="text-xs text-gray-700">{{ rating }} Sao</span>
                            <span class="text-xs text-gray-500">
                                ({% if rating == 5 %}{{ filter_counts.ratings.5|intcomma }}{% elif rating == 4 %}{{ filter_counts.ratings.4|intcomma }}{% elif rating == 3 %}{{ filter_counts.ratings.3|intcomma }}{% elif rating == 2 %}{{ filter_counts.ratings.2|intcomma }}{% elif rating == 1 %}{{ filter_counts.ratings.1|intcomma }}{% endif %})
                            </span>
                        </label>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>

            <!-- Search Input -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-2">T√¨m ki·∫øm:</label>
                <input type="text" name="search" value="{{ current_search }}" 
                    placeholder="T√™n S·∫£n Ph·∫©m, M√£ ƒê∆°n H√†ng, T√™n ƒëƒÉng nh·∫≠p ng∆∞·ªùi mua"
                    class="w-full px-3 py-2 text-xs border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand">
            </div>

            <!-- Review Time Filter (Th·ªùi gian ƒë√°nh gi√°) -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-2">Th·ªùi gian ƒë√°nh gi√°:</label>
                <div class="flex flex-wrap gap-2 items-center">
                    <input type="date" name="date_from" value="{{ current_date_from }}" 
                        class="px-3 py-1.5 text-xs border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand"
                        placeholder="T·ª´ ng√†y">
                    <span class="text-xs text-gray-500">ƒë·∫øn</span>
                    <input type="date" name="date_to" value="{{ current_date_to }}" 
                        class="px-3 py-1.5 text-xs border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand"
                        placeholder="ƒê·∫øn ng√†y">
                    <div class="flex gap-2 ml-2">
                        <button type="button" onclick="setQuickDate('today')" 
                            class="px-2 py-1 text-xs border rounded hover:bg-gray-50">H√¥m nay</button>
                        <button type="button" onclick="setQuickDate('yesterday')" 
                            class="px-2 py-1 text-xs border rounded hover:bg-gray-50">H√¥m qua</button>
                        <button type="button" onclick="setQuickDate('last7d')" 
                            class="px-2 py-1 text-xs border rounded hover:bg-gray-50">7 ng√†y</button>
                        <button type="button" onclick="setQuickDate('last30d')" 
                            class="px-2 py-1 text-xs border rounded hover:bg-gray-50">30 ng√†y</button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2 pt-2">
                <button type="submit" 
                    class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm font-semibold">
                    T√¨m ki·∫øm
                </button>
                <a href="{% url 'cskh:feedback_list' %}" 
                    class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-sm font-semibold">
                    ƒê·∫∑t l·∫°i
                </a>
            </div>
        </form>
    </div>

    <!-- Feedback List -->
    <div class="bg-white border rounded-xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm table-fixed" style="table-layout: fixed;">
                <thead class="bg-slate-50 border-b sticky top-0 z-10">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap" style="width: 120px;">Ng√†y ƒë√°nh gi√°</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap" style="width: 120px;">ƒê∆°n h√†ng</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap" style="width: 120px;">Kh√°ch h√†ng</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap" style="width: 100px;">S·∫£n ph·∫©m</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap" style="width: 80px;">ƒê√°nh gi√°</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap" style="width: 250px;">N·ªôi dung (H√¨nh ·∫£nh)</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 uppercase whitespace-nowrap" style="width: 150px;">Ph·∫£n h·ªìi</th>
                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-700 uppercase whitespace-nowrap" style="width: 100px;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for feedback in feedbacks %}
                    <tr class="hover:bg-slate-50 {% if feedback.is_bad_review %}bg-red-50{% elif feedback.is_good_review %}bg-green-50{% endif %}">
                        <!-- Ng√†y ƒë√°nh gi√° -->
                        <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-600">
                            <script>
                                document.write(new Date({{ feedback.create_time }} * 1000).toLocaleString('vi-VN', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}));
                            </script>
                        </td>

                        <!-- ƒê∆°n h√†ng -->
                        <td class="px-3 py-2">
                            {% if feedback.channel_order_number %}
                            <div class="font-mono text-xs text-sky-700">{{ feedback.channel_order_number }}</div>
                            {% if feedback.sapo_order_id %}
                            <a href="https://sisapsan.mysapogo.com/admin/orders/{{ feedback.sapo_order_id }}" 
                               target="_blank" 
                               class="text-xs text-sky-600 hover:underline">Xem ƒë∆°n</a>
                            {% endif %}
                            {% else %}
                            <span class="text-gray-400 text-xs">-</span>
                            {% endif %}
                        </td>

                        <!-- Kh√°ch h√†ng -->
                        <td class="px-3 py-2">
                            <div class="font-medium text-gray-900 text-xs">{{ feedback.buyer_user_name|default:"-" }}</div>
                            <div class="text-xs text-gray-500">{{ feedback.shop_name }}</div>
                        </td>

                        <!-- S·∫£n ph·∫©m (ch·ªâ hi·ªÉn th·ªã SKU) -->
                        <td class="px-3 py-2">
                            {% if feedback.variant_sku %}
                            <div class="font-mono text-xs text-gray-900">{{ feedback.variant_sku }}</div>
                            {% else %}
                            <span class="text-gray-400 text-xs">-</span>
                            {% endif %}
                        </td>

                        <!-- ƒê√°nh gi√° -->
                        <td class="px-3 py-2">
                            <div class="flex items-center gap-1">
                                {% if feedback.rating == 5 %}
                                <span class="text-yellow-500 text-base">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                {% elif feedback.rating == 4 %}
                                <span class="text-yellow-500 text-base">‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                {% elif feedback.rating == 3 %}
                                <span class="text-yellow-500 text-base">‚≠ê‚≠ê‚≠ê</span>
                                {% elif feedback.rating == 2 %}
                                <span class="text-yellow-500 text-base">‚≠ê‚≠ê</span>
                                {% elif feedback.rating == 1 %}
                                <span class="text-yellow-500 text-base">‚≠ê</span>
                                {% endif %}
                            </div>
                        </td>

                        <!-- N·ªôi dung (H√¨nh ·∫£nh) -->
                        <td class="px-3 py-2 max-w-xs">
                            <div class="text-xs text-gray-700 line-clamp-2 mb-1">{{ feedback.comment|default:"(Kh√¥ng c√≥ b√¨nh lu·∫≠n)"|truncatewords:15 }}</div>
                            {% if feedback.images %}
                            <div class="flex gap-1 flex-wrap mt-1">
                                {% for img_url in feedback.images|slice:":2" %}
                                <img src="{{ img_url }}" alt="Review image" 
                                     class="w-8 h-8 object-cover rounded cursor-pointer hover:opacity-75"
                                     onclick="openImageModal('{{ img_url }}')">
                                {% endfor %}
                                {% with img_count=feedback.images|length %}
                                    {% if img_count > 2 %}
                                    <div class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center text-xs text-gray-600 cursor-pointer"
                                         onclick="openImageModal('{{ feedback.images.0 }}')"
                                         title="Xem th√™m {{ img_count|add:'-2' }} ·∫£nh">
                                        +{{ img_count|add:"-2" }}
                                    </div>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            {% endif %}
                        </td>

                        <!-- Ph·∫£n h·ªìi -->
                        <td class="px-3 py-2">
                            {% if feedback.reply and feedback.status_reply %}
                            <div class="text-xs">
                                <div class="text-green-700 font-medium">‚úì ƒê√£ ph·∫£n h·ªìi</div>
                                <div class="text-gray-600 mt-1 line-clamp-2">{{ feedback.reply|truncatewords:8 }}</div>
                                {% if feedback.user_reply %}
                                <div class="text-gray-500 text-[10px] mt-1">B·ªüi: {{ feedback.user_reply }}</div>
                                {% endif %}
                                {% if feedback.reply_time %}
                                <div class="text-gray-400 text-[10px] mt-0.5">
                                    {{ feedback.reply_time|date:"d/m/Y H:i" }}
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-orange-600 text-xs">‚è≥ Ch∆∞a ph·∫£n h·ªìi</span>
                            {% endif %}
                        </td>

                        <!-- Thao t√°c -->
                        <td class="px-3 py-2 whitespace-nowrap text-right">
                            <div class="flex items-center gap-1 justify-end">
                                {% if feedback.is_good_review %}
                                <button onclick="replyFeedback({{ feedback.id }})" 
                                    class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition">
                                    üí¨
                                </button>
                                {% elif feedback.is_bad_review %}
                                <button onclick="createTicketFromFeedback({{ feedback.id }})" 
                                    class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition">
                                    üé´
                                </button>
                                <button onclick="replyFeedback({{ feedback.id }})" 
                                    class="px-2 py-1 text-xs bg-orange-100 text-orange-700 rounded hover:bg-orange-200 transition">
                                    üí¨
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            Kh√¥ng c√≥ feedback n√†o.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if feedbacks.has_other_pages %}
        <div class="px-4 py-3 border-t bg-slate-50 flex items-center justify-between">
            <div class="text-xs text-gray-600">
                Trang {{ feedbacks.number }} / {{ feedbacks.paginator.num_pages }}
            </div>
            <div class="flex gap-2">
                {% if feedbacks.has_previous %}
                <a href="?page={{ feedbacks.previous_page_number }}{% if current_shop %}&shop={{ current_shop }}{% endif %}{% if current_rating %}&rating={{ current_rating }}{% endif %}{% if current_replied %}&replied={{ current_replied }}{% endif %}" 
                   class="px-3 py-1 text-xs border rounded hover:bg-white transition">‚Üê Tr∆∞·ªõc</a>
                {% endif %}
                {% if feedbacks.has_next %}
                <a href="?page={{ feedbacks.next_page_number }}{% if current_shop %}&shop={{ current_shop }}{% endif %}{% if current_rating %}&rating={{ current_rating }}{% endif %}{% if current_replied %}&replied={{ current_replied }}{% endif %}" 
                   class="px-3 py-1 text-xs border rounded hover:bg-white transition">Sau ‚Üí</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

</div>

<!-- Reply Modal -->
<div id="replyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-semibold mb-4">Ph·∫£n h·ªìi ƒë√°nh gi√°</h3>
        <textarea id="replyContent" rows="5" 
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-sm"
            placeholder="Nh·∫≠p n·ªôi dung ph·∫£n h·ªìi..."></textarea>
        <div class="mt-4 flex gap-2 justify-end">
            <button onclick="closeReplyModal()" 
                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm">
                H·ªßy
            </button>
            <button onclick="submitReply()" 
                class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm">
                G·ª≠i ph·∫£n h·ªìi
            </button>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center" onclick="closeImageModal()">
    <div class="relative max-w-full max-h-full p-4">
        <button onclick="closeImageModal()" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75">
            ‚úï
        </button>
        <img id="modalImage" src="" alt="Review image" class="max-w-full max-h-full object-contain rounded-lg">
    </div>
</div>

<!-- Video Modal -->
<div id="videoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center" onclick="closeVideoModal()">
    <div class="relative max-w-full max-h-full p-4">
        <button onclick="closeVideoModal()" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75">
            ‚úï
        </button>
        <video id="modalVideo" src="" controls class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
            Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
        </video>
    </div>
</div>

<!-- Sync Progress Modal -->
<div id="syncProgressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-3xl w-full mx-4 max-h-[80vh] flex flex-col">
        <h3 class="text-lg font-semibold mb-4">Ti·∫øn tr√¨nh Sync Feedbacks</h3>
        <div id="progressLogs" class="flex-1 overflow-y-auto border rounded-lg p-4 bg-gray-50 space-y-1 max-h-[60vh]">
            <!-- Logs will be displayed here -->
        </div>
        <div class="mt-4 flex justify-end">
            <button onclick="document.getElementById('syncProgressModal').classList.add('hidden')" 
                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm">
                ƒê√≥ng
            </button>
        </div>
    </div>
</div>

<script>
let currentFeedbackId = null;

async function syncFeedbacks() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën sync feedbacks t·ª´ Sapo MP? Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.\n\nTest mode: Gi·ªõi h·∫°n 200 ƒë√°nh gi√° v·ªõi 5 threads.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'üîÑ ƒêang sync...';
    
    // Show progress modal
    const progressModal = document.getElementById('syncProgressModal');
    const progressLogs = document.getElementById('progressLogs');
    progressModal.classList.remove('hidden');
    progressLogs.innerHTML = '<div class="text-sm text-gray-600">ƒêang kh·ªüi ƒë·ªông sync...</div>';
    
    try {
        const response = await fetch('/cskh/api/feedback/sync/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                tenant_id: 1262,  // TODO: L·∫•y t·ª´ config ho·∫∑c input
                connection_ids: null,  // L·∫•y t·∫•t c·∫£
                rating: "1,2,3,4,5",
                max_feedbacks: 200,  // Test v·ªõi 200 ƒë√°nh gi√°
                num_threads: 5  // 5 threads
            })
        });
        
        const data = await response.json();
        
        console.log('Sync response:', data);  // Debug
        
        // Display logs
        if (data.logs && Array.isArray(data.logs) && data.logs.length > 0) {
            progressLogs.innerHTML = data.logs.map(log => 
                `<div class="text-sm text-gray-700 py-1 border-b">${escapeHtml(log)}</div>`
            ).join('');
            progressLogs.scrollTop = progressLogs.scrollHeight;
        } else {
            // N·∫øu kh√¥ng c√≥ logs, hi·ªÉn th·ªã th√¥ng tin t·ª´ response
            progressLogs.innerHTML = `<div class="text-sm text-yellow-700 py-2">Kh√¥ng c√≥ logs chi ti·∫øt. K·∫øt qu·∫£: ${JSON.stringify(data)}</div>`;
        }
        
        if (data.success) {
            const message = `Sync th√†nh c√¥ng!\n` +
                `- T·ªïng s·ªë: ${data.total_feedbacks}\n` +
                `- ƒê√£ x·ª≠ l√Ω: ${data.synced}\n` +
                `- ƒê√£ c·∫≠p nh·∫≠t: ${data.updated}` +
                (data.errors && data.errors.length > 0 ? `\n- L·ªói: ${data.errors.length}` : '');
            
            // Add final message to logs
            progressLogs.innerHTML += `<div class="text-sm text-green-700 font-semibold py-2 mt-2">${message.replace(/\n/g, '<br>')}</div>`;
            
            setTimeout(() => {
                progressModal.classList.add('hidden');
                alert(message);
                // Reload page ƒë·ªÉ hi·ªÉn th·ªã data m·ªõi
                window.location.reload();
            }, 2000);
        } else {
            const errorMsg = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
            progressLogs.innerHTML += `<div class="text-sm text-red-700 font-semibold py-2 mt-2">L·ªói: ${errorMsg}</div>`;
            if (data.errors && data.errors.length > 0) {
                progressLogs.innerHTML += data.errors.slice(0, 10).map(err => 
                    `<div class="text-xs text-red-600 py-1">- ${err}</div>`
                ).join('');
            }
            
            setTimeout(() => {
                progressModal.classList.add('hidden');
                alert(`L·ªói: ${errorMsg}`);
            }, 3000);
        }
    } catch (error) {
        progressLogs.innerHTML += `<div class="text-sm text-red-700 font-semibold py-2 mt-2">L·ªói khi sync: ${error.message}</div>`;
        setTimeout(() => {
            progressModal.classList.add('hidden');
            alert('L·ªói khi sync: ' + error.message);
        }, 2000);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function replyFeedback(feedbackId) {
    currentFeedbackId = feedbackId;
    document.getElementById('replyModal').classList.remove('hidden');
    document.getElementById('replyContent').value = '';
}

function closeReplyModal() {
    document.getElementById('replyModal').classList.add('hidden');
    currentFeedbackId = null;
}

async function submitReply() {
    const content = document.getElementById('replyContent').value.trim();
    if (!content) {
        alert('Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'ƒêang g·ª≠i...';
    
    try {
        const response = await fetch(`/cskh/api/feedback/${currentFeedbackId}/reply/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                reply_content: content,
                tenant_id: 1262  // TODO: L·∫•y t·ª´ config
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ƒê√£ g·ª≠i ph·∫£n h·ªìi th√†nh c√¥ng!');
            closeReplyModal();
            // Reload page ƒë·ªÉ hi·ªÉn th·ªã reply m·ªõi
            window.location.reload();
        } else {
            alert('L·ªói: ' + (data.message || data.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
        }
    } catch (error) {
        alert('L·ªói khi g·ª≠i ph·∫£n h·ªìi: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

async function createTicketFromFeedback(feedbackId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o ticket t·ª´ ƒë√°nh gi√° x·∫•u n√†y?')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'ƒêang t·∫°o...';
    
    try {
        const response = await fetch(`/cskh/api/feedback/${feedbackId}/create-ticket/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`ƒê√£ t·∫°o ticket th√†nh c√¥ng!\nTicket: ${data.ticket_number}`);
            // Reload page ƒë·ªÉ hi·ªÉn th·ªã ticket link
            window.location.reload();
        } else {
            if (data.ticket_id) {
                alert(`Ticket ƒë√£ t·ªìn t·∫°i: ${data.ticket_number}`);
            } else {
                alert('L·ªói: ' + (data.message || data.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
            }
        }
    } catch (error) {
        alert('L·ªói khi t·∫°o ticket: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function openImageModal(imgUrl) {
    document.getElementById('modalImage').src = imgUrl;
    document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    document.getElementById('modalImage').src = '';
}

function openVideoModal(videoUrl) {
    document.getElementById('modalVideo').src = videoUrl;
    document.getElementById('videoModal').classList.remove('hidden');
}

function closeVideoModal() {
    document.getElementById('videoModal').classList.add('hidden');
    const video = document.getElementById('modalVideo');
    video.pause();
    video.src = '';
}

// Filter functions
function setStatusFilter(status) {
    document.getElementById('statusInput').value = status;
    document.getElementById('filterForm').submit();
}

function toggleRatingFilter(rating, checkbox) {
    const form = document.getElementById('filterForm');
    const allCheckbox = form.querySelector('input[name="rating"][value="all"]');
    
    if (rating === 'all') {
        // If "T·∫•t c·∫£" is checked, uncheck all others
        if (checkbox.checked) {
            form.querySelectorAll('input[name="rating"]:not([value="all"])').forEach(cb => {
                cb.checked = false;
            });
        }
    } else {
        // If a specific rating is checked, uncheck "T·∫•t c·∫£"
        if (checkbox.checked && allCheckbox) {
            allCheckbox.checked = false;
        }
        // If all specific ratings are unchecked, check "T·∫•t c·∫£"
        const specificChecked = Array.from(form.querySelectorAll('input[name="rating"]:not([value="all"])')).some(cb => cb.checked);
        if (!specificChecked && allCheckbox) {
            allCheckbox.checked = true;
        }
    }
}

function setQuickDate(option) {
    const today = new Date();
    const dateFrom = document.querySelector('input[name="date_from"]');
    const dateTo = document.querySelector('input[name="date_to"]');
    
    let fromDate, toDate;
    
    switch(option) {
        case 'today':
            fromDate = today;
            toDate = today;
            break;
        case 'yesterday':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 1);
            toDate = fromDate;
            break;
        case 'last7d':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 7);
            toDate = today;
            break;
        case 'last30d':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 30);
            toDate = today;
            break;
    }
    
    if (fromDate && toDate) {
        dateFrom.value = fromDate.toISOString().split('T')[0];
        dateTo.value = toDate.toISOString().split('T')[0];
    }
}
</script>
{% endblock %}

