{% extends "cskh/base_cskh.html" %}
{% load humanize %}

{% block title %}Feedback Center ‚Äì Danh s√°ch Reviews{% endblock %}

{% block overview %}
<section class="px-4 mb-4">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl md:text-lg font-semibold text-slate-800">Feedback Center ‚Äì Danh s√°ch Reviews</h1>
            <p class="text-sm md:text-xs text-gray-500 mt-1">T·ªïng s·ªë: {{ total_count }} reviews</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'cskh:feedback_sync_status' %}" 
               class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm font-semibold">
                üìä Sync Status
            </a>
            <button onclick="syncFeedbacksFromShopee()" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-semibold">
                üõçÔ∏è Sync t·ª´ Shopee API
            </button>
        </div>
    </div>
</section>
{% endblock %}

{% block main_content %}
<div class="flex-1 min-w-0 overflow-x-hidden">

    <!-- B·ªô l·ªçc -->
    <form method="GET" id="filterForm" class="bg-white border rounded-xl p-4 shadow-sm mb-4">
        <!-- Main Filter Row -->
        <div class="flex flex-wrap items-end gap-3">
            <!-- T√¨m ki·∫øm -->
            <div class="flex-1 min-w-[200px]">
                <label class="block text-xs font-semibold text-gray-700 mb-1">T√¨m ki·∫øm</label>
                <input type="text" name="search" value="{{ current_search }}" 
                       placeholder="T√™n s·∫£n ph·∫©m, m√£ ƒë∆°n h√†ng, t√™n ng∆∞·ªùi mua..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-sm">
            </div>
            
            <!-- Ng√†y ƒë√°nh gi√° -->
            <div class="w-[150px]">
                <label class="block text-xs font-semibold text-gray-700 mb-1">T·ª´ ng√†y</label>
                <input type="date" name="date_from" value="{{ current_date_from }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-sm">
            </div>
            
            <!-- ƒê·∫øn ng√†y -->
            <div class="w-[150px]">
                <label class="block text-xs font-semibold text-gray-700 mb-1">ƒê·∫øn ng√†y</label>
                <input type="date" name="date_to" value="{{ current_date_to }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-sm">
            </div>
            
            <!-- Tr·∫°ng th√°i -->
            <div class="w-[150px]">
                <label class="block text-xs font-semibold text-gray-700 mb-1">Tr·∫°ng th√°i</label>
                <select name="status" id="statusSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-sm">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>C·∫ßn ph·∫£n h·ªìi</option>
                    <option value="replied" {% if current_status == 'replied' %}selected{% endif %}>ƒê√£ tr·∫£ l·ªùi</option>
                </select>
            </div>
            
            <!-- Shop -->
            <div class="w-[180px]">
                <label class="block text-xs font-semibold text-gray-700 mb-1">Shop</label>
                <select name="shop" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-sm">
                    <option value="">T·∫•t c·∫£ shop</option>
                    {% for shop in shops_list %}
                    <option value="{{ shop.connection_id }}" {% if current_shop|stringformat:"s" == shop.connection_id|stringformat:"s" %}selected{% endif %}>
                        {{ shop.display_name }}{% for shop_count in filter_counts.shops %}{% if shop_count.connection_id == shop.connection_id %} ({{ shop_count.count|intcomma }}){% endif %}{% endfor %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- S·ªë sao ƒë√°nh gi√° -->
            <div class="w-[200px]">
                <label class="block text-xs font-semibold text-gray-700 mb-1">S·ªë sao</label>
                <div class="flex flex-wrap gap-1.5 items-center">
                    {% for rating_num in "54321" %}
                        {% with rating=rating_num|add:0 %}
                        <label class="flex items-center gap-1 cursor-pointer">
                            <input type="checkbox" name="rating" value="{{ rating }}" 
                                {% if rating|stringformat:"s" in current_ratings %}checked{% endif %}
                                class="w-3.5 h-3.5 text-brand border-gray-300 rounded focus:ring-brand">
                            <span class="text-xs text-gray-700">{{ rating }}‚≠ê</span>
                        </label>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-2">
                <button type="submit" class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm font-semibold">
                    L·ªçc
                </button>
                <a href="{% url 'cskh:feedback_list' %}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm text-center">
                    X√≥a b·ªô l·ªçc
                </a>
            </div>
        </div>
    </form>

    <!-- Feedback List -->
    <div class="space-y-4">
        {% for feedback in feedbacks %}
        <div class="bg-white border rounded-lg shadow-sm overflow-hidden {% if feedback.rating <= 2 %}border-red-200 bg-red-50{% elif feedback.rating >= 4 %}border-green-200 bg-green-50{% endif %}">
            <!-- Header: Avatar - T√™n user - ID ƒë∆°n h√†ng -->
            <div class="px-4 py-3 border-b bg-gray-50 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <!-- Avatar -->
                    {% if feedback.user_portrait %}
                        {% if feedback.user_portrait|slice:":4" == "http" %}
                            {# ƒê√£ c√≥ full URL #}
                            <img src="{{ feedback.user_portrait }}" 
                                 alt="Avatar" 
                                 class="w-10 h-10 rounded-full object-cover border border-gray-200">
                        {% else %}
                            {# Ch·ªâ c√≥ ID, c·∫ßn th√™m prefix #}
                            <img src="https://cf.shopee.vn/file/{{ feedback.user_portrait }}" 
                                 alt="Avatar" 
                                 class="w-10 h-10 rounded-full object-cover border border-gray-200">
                        {% endif %}
                    {% else %}
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-sm font-semibold">
                        {{ feedback.buyer_user_name|first|upper|default:"?" }}
                    </div>
                    {% endif %}
                    
                    <!-- T√™n user -->
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900 text-sm">{{ feedback.buyer_user_name|default:"Kh√°ch h√†ng" }}</div>
                        <div class="text-xs text-gray-500">
                            <script>
                                document.write(new Date({{ feedback.create_time }} * 1000).toLocaleString('vi-VN', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}));
                            </script>
                        </div>
                    </div>
                </div>
                
                <!-- Shop logo + t√™n shop + ID ƒë∆°n h√†ng -->
                <div class="flex items-center gap-3">
                    <!-- Shop logo v√† t√™n -->
                    <div class="flex items-center gap-2">
                        <img src="{{ feedback.shop_logo }}" 
                             alt="{{ feedback.shop_name }}" 
                             class="h-5 w-auto rounded-sm border border-slate-200 object-contain bg-white">
                        <span class="px-2 py-0.5 text-[11px] font-medium rounded border bg-sky-50 border-sky-300 text-sky-700">
                            {{ feedback.shop_name }}
                        </span>
                    </div>
                    
                    <!-- ID ƒë∆°n h√†ng (c√≥ th·ªÉ click v√† copy) -->
                    {% if feedback.channel_order_number %}
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-600">ID ƒë∆°n h√†ng</span>
                        <div class="flex items-center gap-1 bg-white px-2 py-1 rounded border border-gray-300">
                            <a href="{% if feedback.sapo_order_id %}https://sisapsan.mysapogo.com/admin/orders/{{ feedback.sapo_order_id }}{% else %}#{% endif %}" 
                               target="_blank"
                               class="font-mono text-xs text-blue-600 hover:underline">
                                {{ feedback.channel_order_number }}
                            </a>
                            <button onclick="copyToClipboard('{{ feedback.channel_order_number }}')" 
                                    class="text-gray-400 hover:text-gray-600 transition cursor-pointer"
                                    title="Copy">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Content: 2 c·ªôt -->
            <div class="px-4 py-4 grid grid-cols-12 gap-4">
                <!-- C·ªôt 1: ·∫¢nh s·∫£n ph·∫©m / T√™n s·∫£n ph·∫©m / Ph√¢n lo·∫°i -->
                <div class="col-span-12 md:col-span-4">
                    <div class="flex gap-3">
                        <!-- ·∫¢nh s·∫£n ph·∫©m -->
                        {% if feedback.product_image %}
                        <img src="{{ feedback.product_image }}" 
                             alt="Product" 
                             class="w-20 h-20 object-cover rounded border border-gray-200 flex-shrink-0">
                        {% else %}
                        <div class="w-20 h-20 bg-gray-100 rounded border border-gray-200 flex items-center justify-center text-gray-400 text-xs flex-shrink-0">
                            No Image
                        </div>
                        {% endif %}
                        
                        <!-- T√™n s·∫£n ph·∫©m v√† ph√¢n lo·∫°i -->
                        <div class="flex-1 min-w-0 max-w-xs">
                            <div class="font-medium text-gray-900 text-sm line-clamp-2 mb-1 break-words">
                                {{ feedback.product_name|default:"S·∫£n ph·∫©m" }}
                            </div>
                            <!-- SKU -->
                            {% if feedback.variant_sku %}
                            <div class="text-xs text-gray-600 font-mono mb-1">SKU: {{ feedback.variant_sku }}</div>
                            {% endif %}
                            <!-- Ph√¢n lo·∫°i (opt1) -->
                            {% if feedback.variant_opt1 %}
                            <div class="text-xs text-gray-500 line-clamp-2">
                                {{ feedback.variant_opt1 }}
                            </div>
                            {% elif feedback.model_name %}
                            <div class="text-xs text-gray-500 line-clamp-2" title="{{ feedback.model_name }}">
                                {{ feedback.model_name|truncatewords:10 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- C·ªôt 2: S·ªë sao / N·ªôi dung ƒë√°nh gi√° / H√¨nh ·∫£nh ƒë√°nh gi√° -->
                <div class="col-span-12 md:col-span-7">
                    <!-- S·ªë sao -->
                    <div class="flex items-center gap-2 mb-2">
                        <span class="flex items-center gap-0.5">
                            {% for i in "12345" %}
                                {% with star_num=i|add:0 %}
                                    {% if feedback.rating|default:0 >= star_num %}
                                        <svg class="w-5 h-5 text-yellow-500 fill-current" viewBox="0 0 24 24">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 text-gray-300 fill-current" viewBox="0 0 24 24">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </span>
                        <span class="text-xs text-gray-500">{{ feedback.rating|default:0 }} sao</span>
                    </div>
                    
                    <!-- N·ªôi dung ƒë√°nh gi√° -->
                    <div class="text-sm text-gray-700 mb-3 break-words" style="text-indent: 0; padding-left: 0; margin-left: 0;">
                        {{ feedback.comment|default:"(Kh√¥ng c√≥ b√¨nh lu·∫≠n)"|striptags }}
                    </div>
                    
                    <!-- Ph·∫£n h·ªìi c·ªßa shop (n·∫øu c√≥) -->
                    {% if feedback.reply %}
                    <div class="mt-3 mb-3 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs text-blue-700 font-semibold">
                                üí¨ Ph·∫£n h·ªìi c·ªßa shop
                                {% if feedback.reply_duration %}
                                <span class="text-gray-600 font-normal">(sau {{ feedback.reply_duration }})</span>
                                {% endif %}
                                {% if feedback.reply_time %}
                                <span class="text-gray-500 font-normal text-[10px] ml-1">
                                    <script>
                                        document.write(new Date({{ feedback.reply_time }} * 1000).toLocaleString('vi-VN', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}));
                                    </script>
                                </span>
                                {% endif %}
                                :
                            </div>
                        </div>
                        <div class="text-sm text-gray-700 break-words whitespace-pre-wrap">{{ feedback.reply|striptags }}</div>
                    </div>
                    {% endif %}
                    
                    <!-- H√¨nh ·∫£nh ƒë√°nh gi√° -->
                    {% if feedback.images %}
                    <div class="flex gap-2 flex-wrap">
                        {% for img_url in feedback.images %}
                            {% if img_url|slice:":4" == "http" %}
                                {# ƒê√£ c√≥ full URL #}
                                <img src="{{ img_url }}" 
                                     alt="Review image" 
                                     class="w-20 h-20 object-cover rounded border border-gray-200 cursor-pointer hover:opacity-75 transition"
                                     onclick="openImageModal('{{ img_url }}')">
                            {% else %}
                                {# Ch·ªâ c√≥ ID, th√™m prefix #}
                                <img src="https://cf.shopee.vn/file/{{ img_url }}" 
                                     alt="Review image" 
                                     class="w-20 h-20 object-cover rounded border border-gray-200 cursor-pointer hover:opacity-75 transition"
                                     onclick="openImageModal('https://cf.shopee.vn/file/{{ img_url }}')">
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- C·ªôt thao t√°c -->
                <div class="col-span-12 md:col-span-1 flex flex-col items-start md:items-end gap-2">
                    {% if feedback.is_replied or feedback.reply %}
                    <div class="text-xs text-green-600 font-medium">‚úì ƒê√£ tr·∫£ l·ªùi</div>
                    {% else %}
                    <button onclick="replyFeedback({{ feedback.id }})" 
                            class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-sm font-medium whitespace-nowrap">
                        Tr·∫£ l·ªùi
                    </button>
                    {% endif %}
                    
                    {% if feedback.rating <= 2 %}
                    <button onclick="createTicketFromFeedback({{ feedback.id }})" 
                            class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-xs font-medium whitespace-nowrap">
                        T·∫°o Ticket
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="bg-white border rounded-lg p-8 text-center text-gray-500">
            Kh√¥ng c√≥ feedback n√†o.
        </div>
        {% endfor %}
    </div>

        <!-- Pagination -->
        {% if feedbacks.has_other_pages %}
        <div class="px-4 py-3 border-t bg-slate-50 flex items-center justify-between">
            <div class="text-xs text-gray-600">
                Trang {{ feedbacks.number }} / {{ feedbacks.paginator.num_pages }}
                {% if sapo_total_customers %}
                <span class="text-gray-400 ml-2">(T·ª´ {{ sapo_total_customers }} kh√°ch h√†ng c√≥ tag COMMENT_SHOPEE)</span>
                {% endif %}
            </div>
            <div class="flex gap-2">
                {% if feedbacks.has_previous %}
                <a href="?page={{ feedbacks.previous_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}{% for r in current_ratings %}{% if r != 'all' %}&rating={{ r }}{% endif %}{% endfor %}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_date_from %}&date_from={{ current_date_from }}{% endif %}{% if current_date_to %}&date_to={{ current_date_to }}{% endif %}" 
                   class="px-3 py-1 text-xs border rounded hover:bg-white transition">‚Üê Tr∆∞·ªõc</a>
                {% endif %}
                {% if feedbacks.has_next %}
                <a href="?page={{ feedbacks.next_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}{% for r in current_ratings %}{% if r != 'all' %}&rating={{ r }}{% endif %}{% endfor %}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_date_from %}&date_from={{ current_date_from }}{% endif %}{% if current_date_to %}&date_to={{ current_date_to }}{% endif %}" 
                   class="px-3 py-1 text-xs border rounded hover:bg-white transition">Sau ‚Üí</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

</div>

<!-- Reply Modal -->
<div id="replyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-semibold mb-4">Ph·∫£n h·ªìi ƒë√°nh gi√°</h3>
        <textarea id="replyContent" rows="5" 
            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-brand text-sm"
            placeholder="Nh·∫≠p n·ªôi dung ph·∫£n h·ªìi..."></textarea>
        <div class="mt-4 flex gap-2 justify-end">
            <button onclick="closeReplyModal()" 
                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm">
                H·ªßy
            </button>
            <button onclick="submitReply()" 
                class="px-4 py-2 bg-brand text-white rounded-lg hover:bg-red-700 transition text-sm">
                G·ª≠i ph·∫£n h·ªìi
            </button>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center" onclick="closeImageModal()">
    <div class="relative max-w-full max-h-full p-4">
        <button onclick="closeImageModal()" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75">
            ‚úï
        </button>
        <img id="modalImage" src="" alt="Review image" class="max-w-full max-h-full object-contain rounded-lg">
    </div>
</div>

<!-- Video Modal -->
<div id="videoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center" onclick="closeVideoModal()">
    <div class="relative max-w-full max-h-full p-4">
        <button onclick="closeVideoModal()" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75">
            ‚úï
        </button>
        <video id="modalVideo" src="" controls class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
            Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
        </video>
    </div>
</div>

<!-- Sync Progress Modal -->
<div id="syncProgressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-3xl w-full mx-4 max-h-[80vh] flex flex-col">
        <h3 class="text-lg font-semibold mb-4">Ti·∫øn tr√¨nh Sync Feedbacks</h3>
        <div id="progressLogs" class="flex-1 overflow-y-auto border rounded-lg p-4 bg-gray-50 space-y-1 max-h-[60vh]">
            <!-- Logs will be displayed here -->
        </div>
        <div class="mt-4 flex justify-end">
            <button onclick="document.getElementById('syncProgressModal').classList.add('hidden')" 
                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm">
                ƒê√≥ng
            </button>
        </div>
    </div>
</div>

<script>
let currentFeedbackId = null;

async function syncFeedbacks() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën sync feedbacks t·ª´ customer notes tr√™n Sapo? Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.\n\nH·ªá th·ªëng s·∫Ω l·∫•y t·∫•t c·∫£ ƒë√°nh gi√° t·ª´ customers c√≥ tag COMMENT_SHOPEE.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'üîÑ ƒêang sync...';
    
    // Show progress modal
    const progressModal = document.getElementById('syncProgressModal');
    const progressLogs = document.getElementById('progressLogs');
    progressModal.classList.remove('hidden');
    progressLogs.innerHTML = '<div class="text-sm text-gray-600">ƒêang kh·ªüi ƒë·ªông sync t·ª´ customer notes...</div>';
    
    try {
        const response = await fetch('/cskh/api/feedback/sync/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                // Sync t·ª´ customer notes tr√™n Sapo API
                use_customer_notes: true,
                num_threads: 10  // S·ªë thread ƒë·ªÉ x·ª≠ l√Ω nhanh h∆°n
            })
        });
        
        const data = await response.json();
        
        // TODO: Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng/th·∫•t b·∫°i n·∫øu c·∫ßn
        if (data.logs && Array.isArray(data.logs) && data.logs.length > 0) {
            progressLogs.innerHTML = data.logs.map(log => 
                `<div class="text-sm text-gray-700 py-1 border-b">${escapeHtml(log)}</div>`
            ).join('');
            progressLogs.scrollTop = progressLogs.scrollHeight;
        } else {
            // N·∫øu kh√¥ng c√≥ logs, hi·ªÉn th·ªã th√¥ng tin t·ª´ response
            progressLogs.innerHTML = `<div class="text-sm text-yellow-700 py-2">Kh√¥ng c√≥ logs chi ti·∫øt. K·∫øt qu·∫£: ${JSON.stringify(data)}</div>`;
        }
        
        if (data.success) {
            const message = `Sync th√†nh c√¥ng!\n` +
                `- T·ªïng s·ªë: ${data.total_feedbacks}\n` +
                `- ƒê√£ x·ª≠ l√Ω: ${data.synced}\n` +
                `- ƒê√£ c·∫≠p nh·∫≠t: ${data.updated}` +
                (data.errors && data.errors.length > 0 ? `\n- L·ªói: ${data.errors.length}` : '');
            
            // Add final message to logs
            progressLogs.innerHTML += `<div class="text-sm text-green-700 font-semibold py-2 mt-2">${message.replace(/\n/g, '<br>')}</div>`;
            
            setTimeout(() => {
                progressModal.classList.add('hidden');
                alert(message);
                // Reload page ƒë·ªÉ hi·ªÉn th·ªã data m·ªõi
                window.location.reload();
            }, 2000);
        } else {
            const errorMsg = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
            progressLogs.innerHTML += `<div class="text-sm text-red-700 font-semibold py-2 mt-2">L·ªói: ${errorMsg}</div>`;
            if (data.errors && data.errors.length > 0) {
                progressLogs.innerHTML += data.errors.slice(0, 10).map(err => 
                    `<div class="text-xs text-red-600 py-1">- ${err}</div>`
                ).join('');
            }
            
            setTimeout(() => {
                progressModal.classList.add('hidden');
                alert(`L·ªói: ${errorMsg}`);
            }, 3000);
        }
    } catch (error) {
        progressLogs.innerHTML += `<div class="text-sm text-red-700 font-semibold py-2 mt-2">L·ªói khi sync: ${error.message}</div>`;
        setTimeout(() => {
            progressModal.classList.add('hidden');
            alert('L·ªói khi sync: ' + error.message);
        }, 2000);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function syncFeedbacksFromShopee() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën sync feedbacks t·ª´ Shopee API? Qu√° tr√¨nh n√†y s·∫Ω l·∫•y 100 ƒë√°nh gi√° m·ªói shop trong 30 ng√†y g·∫ßn nh·∫•t.\n\nQu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'üîÑ ƒêang sync...';
    
    // Show progress modal
    const progressModal = document.getElementById('syncProgressModal');
    const progressLogs = document.getElementById('progressLogs');
    progressModal.classList.remove('hidden');
    progressLogs.innerHTML = '<div class="text-sm text-gray-600">ƒêang kh·ªüi ƒë·ªông sync t·ª´ Shopee API...</div>';
    
    try {
        const response = await fetch('/cskh/api/feedback/sync/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                // Sync t·ª´ Shopee API
                use_shopee_api: true,
                days: 30,  // 30 ng√†y g·∫ßn nh·∫•t
                page_size: 50  // Maximum page size
            })
        });
        
        const data = await response.json();
        
        // Hi·ªÉn th·ªã logs n·∫øu c√≥
        if (data.logs && Array.isArray(data.logs) && data.logs.length > 0) {
            progressLogs.innerHTML = data.logs.map(log => 
                `<div class="text-sm text-gray-700 py-1 border-b">${escapeHtml(log)}</div>`
            ).join('');
            progressLogs.scrollTop = progressLogs.scrollHeight;
        } else {
            // N·∫øu kh√¥ng c√≥ logs, hi·ªÉn th·ªã th√¥ng tin t·ª´ response
            progressLogs.innerHTML = `<div class="text-sm text-yellow-700 py-2">Kh√¥ng c√≥ logs chi ti·∫øt. K·∫øt qu·∫£: ${JSON.stringify(data)}</div>`;
        }
        
        if (data.success) {
            const message = `Sync t·ª´ Shopee API th√†nh c√¥ng!\n` +
                `- T·ªïng s·ªë ƒë√°nh gi√°: ${data.total_feedbacks}\n` +
                `- ƒê√£ x·ª≠ l√Ω: ${data.synced}\n` +
                `- ƒê√£ c·∫≠p nh·∫≠t: ${data.updated}` +
                (data.errors && data.errors.length > 0 ? `\n- L·ªói: ${data.errors.length}` : '');
            
            // Add final message to logs
            progressLogs.innerHTML += `<div class="text-sm text-green-700 font-semibold py-2 mt-2">${message.replace(/\n/g, '<br>')}</div>`;
            
            setTimeout(() => {
                progressModal.classList.add('hidden');
                alert(message);
                // Reload page ƒë·ªÉ hi·ªÉn th·ªã data m·ªõi
                window.location.reload();
            }, 2000);
        } else {
            const errorMsg = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
            progressLogs.innerHTML += `<div class="text-sm text-red-700 font-semibold py-2 mt-2">L·ªói: ${errorMsg}</div>`;
            if (data.errors && data.errors.length > 0) {
                progressLogs.innerHTML += data.errors.slice(0, 10).map(err => 
                    `<div class="text-xs text-red-600 py-1">- ${err}</div>`
                ).join('');
            }
            
            setTimeout(() => {
                progressModal.classList.add('hidden');
                alert(`L·ªói: ${errorMsg}`);
            }, 3000);
        }
    } catch (error) {
        progressLogs.innerHTML += `<div class="text-sm text-red-700 font-semibold py-2 mt-2">L·ªói khi sync: ${error.message}</div>`;
        setTimeout(() => {
            progressModal.classList.add('hidden');
            alert('L·ªói khi sync: ' + error.message);
        }, 2000);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function replyFeedback(feedbackId) {
    currentFeedbackId = feedbackId;
    document.getElementById('replyModal').classList.remove('hidden');
    document.getElementById('replyContent').value = '';
}

function closeReplyModal() {
    document.getElementById('replyModal').classList.add('hidden');
    currentFeedbackId = null;
}

async function submitReply() {
    const content = document.getElementById('replyContent').value.trim();
    if (!content) {
        alert('Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi');
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'ƒêang g·ª≠i...';
    
    try {
        const response = await fetch(`/cskh/api/feedback/${currentFeedbackId}/reply/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                reply_content: content,
                tenant_id: 1262  // TODO: L·∫•y t·ª´ config
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ƒê√£ g·ª≠i ph·∫£n h·ªìi th√†nh c√¥ng!');
            closeReplyModal();
            // Reload page ƒë·ªÉ hi·ªÉn th·ªã reply m·ªõi
            window.location.reload();
        } else {
            alert('L·ªói: ' + (data.message || data.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
        }
    } catch (error) {
        alert('L·ªói khi g·ª≠i ph·∫£n h·ªìi: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

async function createTicketFromFeedback(feedbackId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o ticket t·ª´ ƒë√°nh gi√° x·∫•u n√†y?')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'ƒêang t·∫°o...';
    
    try {
        const response = await fetch(`/cskh/api/feedback/${feedbackId}/create-ticket/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`ƒê√£ t·∫°o ticket th√†nh c√¥ng!\nTicket: ${data.ticket_number}`);
            // Reload page ƒë·ªÉ hi·ªÉn th·ªã ticket link
            window.location.reload();
        } else {
            if (data.ticket_id) {
                alert(`Ticket ƒë√£ t·ªìn t·∫°i: ${data.ticket_number}`);
            } else {
                alert('L·ªói: ' + (data.message || data.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
            }
        }
    } catch (error) {
        alert('L·ªói khi t·∫°o ticket: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

function openImageModal(imgUrl) {
    document.getElementById('modalImage').src = imgUrl;
    document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    document.getElementById('modalImage').src = '';
}

function openVideoModal(videoUrl) {
    document.getElementById('modalVideo').src = videoUrl;
    document.getElementById('videoModal').classList.remove('hidden');
}

function closeVideoModal() {
    document.getElementById('videoModal').classList.add('hidden');
    const video = document.getElementById('modalVideo');
    video.pause();
    video.src = '';
}

// Filter functions

function toggleRatingFilter(rating, checkbox) {
    const form = document.getElementById('filterForm');
    const allCheckbox = form.querySelector('input[name="rating"][value="all"]');
    
    if (rating === 'all') {
        // If "T·∫•t c·∫£" is checked, uncheck all others
        if (checkbox.checked) {
            form.querySelectorAll('input[name="rating"]:not([value="all"])').forEach(cb => {
                cb.checked = false;
            });
        }
    } else {
        // If a specific rating is checked, uncheck "T·∫•t c·∫£"
        if (checkbox.checked && allCheckbox) {
            allCheckbox.checked = false;
        }
        // If all specific ratings are unchecked, check "T·∫•t c·∫£"
        const specificChecked = Array.from(form.querySelectorAll('input[name="rating"]:not([value="all"])')).some(cb => cb.checked);
        if (!specificChecked && allCheckbox) {
            allCheckbox.checked = true;
        }
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
        }, 1000);
    }).catch(function(err) {
        console.error('Failed to copy: ', err);
    });
}

function setQuickDate(option) {
    const today = new Date();
    const dateFrom = document.querySelector('input[name="date_from"]');
    const dateTo = document.querySelector('input[name="date_to"]');
    
    let fromDate, toDate;
    
    switch(option) {
        case 'today':
            fromDate = today;
            toDate = today;
            break;
        case 'yesterday':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 1);
            toDate = fromDate;
            break;
        case 'last7d':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 7);
            toDate = today;
            break;
        case 'last30d':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 30);
            toDate = today;
            break;
    }
    
    if (fromDate && toDate) {
        dateFrom.value = fromDate.toISOString().split('T')[0];
        dateTo.value = toDate.toISOString().split('T')[0];
    }
}
</script>
{% endblock %}

